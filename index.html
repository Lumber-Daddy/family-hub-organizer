<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub Organizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Poppins Font (Updated) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Poppins', sans-serif; /* Poppins applied */
            background-color: #f8fafc; /* Lighter background for contrast */
            /* Subtle background pattern to make it pop */
            background-image: radial-gradient(#dbeafe 0.5px, transparent 0.5px);
            background-size: 10px 10px;
        }
        /* Custom scrollbar for better mobile feel */
        .scroll-area::-webkit-scrollbar {
            width: 4px;
        }
        .scroll-area::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        .scroll-area {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .calendar-grid > div:nth-child(7n), 
        .calendar-grid > div:nth-child(7n-6) {
            border-left: none;
            border-right: none;
        }

        /* Bolder Header Style */
        #main-header {
            /* Vibrant Indigo Gradient */
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%); 
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); 
        }

        /* Tabs Nav Style */
        #tabs-nav {
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.05);
        }

        /* Chore Item and Card Enhancements (Elevated Look) */
        .chore-item, .member-card {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Stronger shadow */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        /* Item hover/tap interaction */
        .chore-item:hover:not(.drag-hover) {
            transform: translateY(-3px) scale(1.005); /* Slight lift and scale */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        /* Button Press Effect */
        .action-btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Checkbox enhancement for touch target and visual pop */
        .completion-btn {
            border-width: 3px !important;
            transition: all 0.2s ease-out; /* Add transition for smoothness */
        }
        
        /* Drag and Drop Styles */
        .drag-target {
            min-height: 5rem; /* Ensure drop area is visible */
            transition: all 0.2s;
        }
        .drag-hover {
            outline: 3px dashed #6366f1; /* Indigo */
            background-color: #e0e7ff; /* Indigo-100 */
        }
        .chore-item {
            cursor: grab;
        }
        /* Responsive tweaks for the tab bar on wide screens */
        #tabs-nav button {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        /* Pulse animation for microphone */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .mic-pulse {
            animation: pulse 1.5s infinite;
        }
        
        /* --- NEW ANIMATION STYLES (Entrance & Completion) --- */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animated-item {
            animation: fadeInSlideUp 0.5s ease-out backwards;
        }

        /* Completion Confetti Effect */
        .confetti-burst {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffeb3b, #f44336);
            transform: translate(-50%, -50%);
            animation: burst 0.5s ease-out forwards;
            z-index: 10;
        }
        @keyframes burst {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(10); opacity: 0; }
        }

        /* Styling for the collapsible ad-hoc form container */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, margin-top 0.4s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            border-color: transparent !important;
        }
        .collapsible-content.open {
            max-height: 500px; /* Large enough for content */
            padding-top: 1rem;
            padding-bottom: 1rem;
            margin-top: 1rem;
        }
        /* Apply shadow directly to the content inside the collapsible wrapper */
        #adhoc-form-inner {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); 
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="w-full max-w-6xl mx-auto bg-white shadow-xl min-h-screen">

        <!-- Header (Bolder Gradient) -->
        <header id="main-header" class="p-4 sticky top-0 z-10">
            <h1 class="text-2xl font-extrabold text-center text-white">
                Family Hub Organizer
            </h1>
        </header>

        <!-- Tabs -->
        <nav class="flex bg-gray-50 border-b border-gray-200 sticky top-[65px] z-10" id="tabs-nav">
            <button data-tab="chores" class="flex-1 p-3 text-center text-sm font-semibold transition-colors">
                Daily List
            </button>
            <button data-tab="weekly" class="flex-1 p-3 text-center text-sm font-semibold transition-colors">
                Weekly Schedule
            </button>
            <button data-tab="rewards" class="flex-1 p-3 text-center text-sm font-semibold transition-colors">
                Points & Rewards
            </button>
            <button data-tab="setup" class="flex-1 p-3 text-center text-sm font-semibold transition-colors">
                Setup
            </button>
            <button data-tab="calendar" class="flex-1 p-3 text-center text-sm font-semibold transition-colors">
                Calendar
            </button>
        </nav>
        
        <!-- Main Content Area -->
        <main id="content-area" class="p-4"></main>

    </div>

    <!-- Voice Command Button (Floating Action Button) -->
    <button id="voice-btn" onclick="window.toggleVoiceCommand()" 
        class="action-btn fixed bottom-6 right-6 w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-2xl transition-all duration-300 hover:bg-indigo-700 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7v-7a7 7 0 017-7z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v3m4 0h-8" />
        </svg>
    </button>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            setPersistence, browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, collection, query, onSnapshot, setDoc, updateDoc, 
            deleteDoc, serverTimestamp, runTransaction, where, setLogLevel, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level for debugging
        setLogLevel('debug');

        // --- GLOBAL STATE ---
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let members = [];
        let choreDefs = [];      
        let choreAssignments = [];
        let rewards = [];
        let currentDate = new Date(); 
        let activeTab = 'chores';
        let isListening = false; // New state for voice command
        let isAdhocFormOpen = false; // NEW STATE for the collapsible form

        // --- VOICE API SETUP ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        const synth = window.speechSynthesis;
        const voiceButton = document.getElementById('voice-btn');

        if (recognition) {
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                voiceButton.classList.add('mic-pulse', 'bg-red-600');
                voiceButton.classList.remove('bg-indigo-600');
                showToast("Listening...", false);
            };

            recognition.onend = () => {
                isListening = false;
                voiceButton.classList.remove('mic-pulse', 'bg-red-600');
                voiceButton.classList.add('bg-indigo-600');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Voice Command Received:', transcript);
                handleVoiceCommand(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error !== 'no-speech') {
                    speak("Sorry, I didn't catch that. Please try again.");
                }
                isListening = false;
                voiceButton.classList.remove('mic-pulse', 'bg-red-600');
                voiceButton.classList.add('bg-indigo-600');
            };
        }


        // Mappings for color and days
        const MEMBER_COLORS = {
            'blue': {bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-500'},
            'red': {bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-500'},
            'green': {bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-500'},
            'purple': {bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-500'},
            'pink': {bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-500'},
            'yellow': {bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-500'},
            'indigo': {bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-500'},
        };
        const WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' 
            ? __initial_auth_token 
            : null;

        // --- UTILITY FUNCTIONS ---

        /** Formats a Date object to YYYY-MM-DD string */
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const todayDateString = formatDate(new Date());
        const todayDayOfWeek = WEEKDAYS[new Date().getDay()];

        // Function to toggle the ad-hoc form state
        window.toggleAdhocForm = () => {
            isAdhocFormOpen = !isAdhocFormOpen;
            renderApp();
        };

        /** Provides voice feedback */
        const speak = (text) => {
            if (synth && text) {
                const utterance = new SpeechSynthesisUtterance(text);
                // Attempt to select a neutral US voice if available
                utterance.voice = synth.getVoices().find(v => v.lang === 'en-US' && (v.name.includes('Google') || v.name.includes('Zira'))) || synth.getVoices()[0];
                synth.speak(utterance);
            }
        };

        /** Generates a simple success/error message modal/toast */
        const showToast = (message, isError = false) => {
            const container = document.getElementById('app-container');
            let toast = container.querySelector('#app-toast');

            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'app-toast';
                toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 transition-opacity duration-300 pointer-events-none';
                container.appendChild(toast);
            }
            
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.className = `p-3 rounded-xl shadow-lg font-semibold text-sm ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'} opacity-0 translate-y-4 transition-all duration-300`;
            
            toast.appendChild(messageElement);

            // Animate in
            setTimeout(() => {
                messageElement.classList.remove('opacity-0', 'translate-y-4');
                messageElement.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                messageElement.classList.remove('opacity-100', 'translate-y-0');
                messageElement.classList.add('opacity-0', 'translate-y-4');
                
                setTimeout(() => {
                    messageElement.remove();
                }, 300);
            }, 3000);
        };

        /** Gets all days in a month for calendar display. */
        const getDaysInMonth = (date) => {
            const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            const startDate = new Date(startOfMonth);
            startDate.setDate(startOfMonth.getDate() - startOfMonth.getDay());
            
            const days = [];
            let currentDate = new Date(startDate);
            
            for (let i = 0; i < 42; i++) {
                days.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return days;
        };

        // --- FIREBASE INITIALIZATION & AUTH ---

        const initializeFirebase = async () => {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing or invalid.");
                showToast("Initialization failed: Firebase config missing.", true);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await setPersistence(auth, browserSessionPersistence);

                return new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                                showToast("Authentication failed.", true);
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showToast(`Firebase Init Error: ${error.message}`, true);
            }
        };


        // --- FIRESTORE LISTENERS ---

        const startDataListeners = () => {
            if (!db || !isAuthReady) return;

            const publicDataPath = ['artifacts', appId, 'public', 'data'];

            // 1. Members Listener
            onSnapshot(query(collection(db, ...publicDataPath, 'members')), (snapshot) => {
                members = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const colorKey = data.colorKey || 'indigo';
                    return {
                        id: doc.id,
                        ...data,
                        points: data.points || 0,
                        emoji: data.emoji || 'üë§',
                        colorKey: colorKey,
                        color: MEMBER_COLORS[colorKey] || MEMBER_COLORS['indigo']
                    };
                });
                members.sort((a, b) => a.name.localeCompare(b.name));
                renderApp();
            }, (error) => { console.error("Error fetching members:", error); showToast("Error loading members.", true); });

            // 2. Chore Definitions Listener (Reusable Chores)
            onSnapshot(query(collection(db, ...publicDataPath, 'choreDefs')), (snapshot) => {
                choreDefs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    pointValue: doc.data().pointValue || 0,
                    schedule: doc.data().schedule || {},
                    emoji: doc.data().emoji || 'üìù',
                    isAdhoc: doc.data().isAdhoc || false, // Flag for one-time chores
                    createdAt: doc.data().createdAt // Firebase Timestamp
                }));
                choreDefs.sort((a, b) => a.name.localeCompare(b.name));
                renderApp();
            }, (error) => { console.error("Error fetching chore definitions:", error); showToast("Error loading chore definitions.", true); });

            // 3. Chore Assignments Listener (Today's Completion Status)
            // Filter to only get today's status for the daily view
            const qAssignments = query(collection(db, ...publicDataPath, 'choreAssignments'), where('date', '==', todayDateString));

            onSnapshot(qAssignments, (snapshot) => {
                choreAssignments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    isCompleted: !!doc.data().isCompleted,
                }));
                renderApp();
            }, (error) => { console.error("Error fetching assignments:", error); showToast("Error loading assignments.", true); });
            
            // 4. Rewards Listener
            onSnapshot(query(collection(db, ...publicDataPath, 'rewards'), where('claimed', '==', false)), (snapshot) => {
                rewards = snapshot.docs.map(doc => ({
                    id: doc.id,
                    cost: doc.data().cost || 0,
                    emoji: doc.data().emoji || 'üéÅ',
                    ...doc.data()
                }));
                rewards.sort((a, b) => a.cost - b.cost);
                renderApp();
            }, (error) => { console.error("Error fetching rewards:", error); showToast("Error loading rewards.", true); });
        };

        // --- DATA SEEDING FUNCTION ---
        const seedData = async () => {
            if (!db) return;

            const publicDataPath = ['artifacts', appId, 'public', 'data'];
            const membersRef = collection(db, ...publicDataPath, 'members');
            const choreDefsRef = collection(db, ...publicDataPath, 'choreDefs');
            const rewardsRef = collection(db, ...publicDataPath, 'rewards');

            // 1. Check if members collection is empty
            const memberSnapshot = await getDocs(membersRef);
            if (!memberSnapshot.empty) {
                console.log("Database already contains members. Skipping seed data.");
                return;
            }

            console.log("Seeding initial data...");

            const memberData = [
                { id: 'member_mom', name: 'Mom', emoji: 'üë©‚Äçü¶±', colorKey: 'purple', points: 50 },
                { id: 'member_dad', name: 'Dad', emoji: 'üë®‚Äçü¶±', colorKey: 'blue', points: 50 },
                { id: 'member_lyra', name: 'Lyra', emoji: 'üëß', colorKey: 'pink', points: 0 },
                { id: 'member_cora', name: 'Cora', emoji: 'üëßüèª', colorKey: 'red', points: 0 },
            ];

            // Add Members
            for (const m of memberData) {
                await setDoc(doc(membersRef, m.id), {
                    id: m.id,
                    name: m.name,
                    points: m.points,
                    emoji: m.emoji,
                    colorKey: m.colorKey,
                    initials: m.name.charAt(0).toUpperCase(),
                    createdAt: serverTimestamp()
                });
            }

            // Add Chore Definitions
            const choreDefsData = [
                { 
                    id: 'chore_empty_dish', name: 'Empty Dishwasher', emoji: 'üçΩÔ∏è', pointValue: 20, assignedToId: 'member_mom', assignedToName: 'Mom', 
                    schedule: { 'Mon': true, 'Wed': true, 'Fri': true }, isAdhoc: false
                },
                { 
                    id: 'chore_load_dish', name: 'Load Dishwasher', emoji: 'ü•Ñ', pointValue: 20, assignedToId: 'member_dad', assignedToName: 'Dad', 
                    schedule: { 'Tue': true, 'Thu': true, 'Sat': true }, isAdhoc: false
                },
                { 
                    id: 'chore_feed_dog', name: 'Feed Dog', emoji: 'üêï', pointValue: 20, assignedToId: 'member_lyra', assignedToName: 'Lyra', 
                    schedule: { 'Sun': true, 'Mon': true, 'Tue': true, 'Wed': true, 'Thu': true, 'Fri': true, 'Sat': true }, isAdhoc: false
                },
                { 
                    id: 'chore_feed_cat', name: 'Feed Cat', emoji: 'üêà', pointValue: 20, assignedToId: 'member_cora', assignedToName: 'Cora', 
                    schedule: { 'Sun': true, 'Mon': true, 'Tue': true, 'Wed': true, 'Thu': true, 'Fri': true, 'Sat': true }, isAdhoc: false
                },
                { 
                    id: 'chore_laundry', name: 'Laundry', emoji: 'üß∫', pointValue: 50, assignedToId: 'member_mom', assignedToName: 'Mom', 
                    schedule: { 'Sun': true, 'Wed': true }, isAdhoc: false
                },
            ];

            for (const c of choreDefsData) {
                await setDoc(doc(choreDefsRef, c.id), { ...c, createdAt: serverTimestamp() });
            }

            // Add Rewards
            const rewardData = [
                { id: 'reward_movie', name: 'Movie Night', emoji: 'üé¨', cost: 150, claimed: false },
                { id: 'reward_pizza', name: 'Pizza Dinner', emoji: 'üçï', cost: 100, claimed: false },
            ];

            for (const r of rewardData) {
                 await setDoc(doc(rewardsRef, r.id), { ...r, createdAt: serverTimestamp() });
            }

            showToast("Initial family data loaded successfully!");
        };


        // --- CHORE & MEMBER ACTIONS ---

        window.addFamilyMember = async () => {
            if (!db) return;
            const input = document.getElementById('new-member-name');
            const memberName = input.value.trim();

            if (!memberName) { showToast("Please enter a name.", true); return; }

            const newId = crypto.randomUUID();
            const membersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            
            const memberColorKey = Object.keys(MEMBER_COLORS)[members.length % Object.keys(MEMBER_COLORS).length];

            try {
                await setDoc(doc(membersRef, newId), { 
                    id: newId, 
                    name: memberName,
                    points: 0,
                    emoji: 'üë§', 
                    colorKey: memberColorKey,
                    initials: memberName.charAt(0).toUpperCase(),
                    createdAt: serverTimestamp()
                });
                input.value = '';
                showToast(`Added ${memberName} to the family!`);
            } catch (error) {
                console.error("Error adding family member:", error);
                showToast("Failed to add member.", true);
            }
        };

        window.updateFamilyMember = async (memberId) => {
            if (!db) return;

            const member = members.find(m => m.id === memberId);
            if (!member) return;

            const nameInput = document.getElementById(`edit-member-name-${memberId}`);
            const emojiInput = document.getElementById(`edit-member-emoji-${memberId}`);
            const colorSelect = document.getElementById(`edit-member-color-${memberId}`);

            const newName = nameInput.value.trim();
            const newEmoji = emojiInput.value.trim().substring(0, 2) || 'üë§';
            const newColorKey = colorSelect.value;
            
            if (!newName) { showToast("Name cannot be empty.", true); return; }

            const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', memberId);

            try {
                await updateDoc(memberRef, { 
                    name: newName,
                    emoji: newEmoji,
                    colorKey: newColorKey,
                    initials: newName.charAt(0).toUpperCase(),
                });
                showToast(`Updated ${newName}'s details!`);
            } catch (error) {
                console.error("Error updating member:", error);
                showToast("Failed to update member.", true);
            }
        };

        window.addChoreDefinition = async (isAdhoc = false) => {
            if (!db) return;
            const prefix = isAdhoc ? 'adhoc' : 'new-chore-def';

            const nameInput = document.getElementById(`${prefix}-name`);
            const memberSelect = document.getElementById(`${prefix}-member`);
            const pointValueInput = document.getElementById(`${prefix}-points`);
            const emojiInput = document.getElementById(`${prefix}-emoji`);
            
            const choreName = nameInput.value.trim();
            const assignedToId = memberSelect.value || null; // Optional Assignment
            const pointValue = parseInt(pointValueInput.value, 10);
            const emoji = emojiInput.value.trim().substring(0, 2) || 'üìù';

            let schedule = {};
            if (!isAdhoc) {
                schedule = WEEKDAYS.reduce((acc, day) => {
                    const checkbox = document.getElementById(`schedule-day-${day}`);
                    if (checkbox && checkbox.checked) {
                        acc[day] = true;
                    }
                    return acc;
                }, {});

                if (Object.keys(schedule).length === 0) {
                    showToast("Please schedule at least one day for a recurring chore.", true);
                    return;
                }
            }


            if (!choreName || !assignedToId || isNaN(pointValue) || pointValue < 1) {
                showToast(`Please complete all fields for the ${isAdhoc ? 'one-time' : 'recurring'} chore: name, assigned member, and points (> 0).`, true);
                return;
            }

            const assignedMember = assignedToId ? members.find(m => m.id === assignedToId) : null;
            const newId = crypto.randomUUID();
            const defsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'choreDefs');

            try {
                await setDoc(doc(defsCollectionRef, newId), {
                    id: newId,
                    name: choreName,
                    assignedToId: assignedToId,
                    assignedToName: assignedMember ? assignedMember.name : null,
                    pointValue: pointValue,
                    emoji: emoji,
                    schedule: schedule,
                    isAdhoc: isAdhoc, // Flag ad-hoc chores
                    createdAt: serverTimestamp() // Required for adhoc filtering in weekly view
                });
                nameInput.value = '';
                memberSelect.value = '';
                pointValueInput.value = '10';
                emojiInput.value = '';
                if (!isAdhoc) {
                    WEEKDAYS.forEach(day => {
                        const checkbox = document.getElementById(`schedule-day-${day}`);
                        if (checkbox) checkbox.checked = false;
                    });
                } else {
                    // Close the form after adding an ad-hoc chore
                    isAdhocFormOpen = false;
                }
                showToast(`${isAdhoc ? 'One-time' : 'Recurring'} chore '${choreName}' created!`);
            } catch (error) {
                console.error("Error adding chore definition:", error);
                showToast("Failed to create chore.", true);
            }
        };

        window.assignChore = async (choreDefId, newMemberId) => {
            if (!db) return;

            const choreRef = doc(db, 'artifacts', appId, 'public', 'data', 'choreDefs', choreDefId);
            
            let newMember = null;
            if (newMemberId) {
                newMember = members.find(m => m.id === newMemberId);
                if (!newMember) {
                    showToast("New member not found.", true);
                    return;
                }
            }

            try {
                await updateDoc(choreRef, {
                    assignedToId: newMemberId || null,
                    assignedToName: newMember ? newMember.name : null,
                });
                showToast(`Chore reassigned to ${newMember ? newMember.name : 'the Unassigned Pool'}!`);
            } catch (error) {
                console.error("Error assigning chore:", error);
                showToast("Failed to assign chore.", true);
            }
        };
        
        // --- GEMINI AI EMOJI PICKER ---
        window.pickEmoji = async (inputId, name) => {
            if (!name) {
                showToast("Please enter a name first.", true);
                return;
            }
            
            const emojiInput = document.getElementById(inputId);
            if (!emojiInput) return;
            
            emojiInput.placeholder = '...Thinking...';
            emojiInput.disabled = true;

            const systemPrompt = "You are an emoji suggestion AI. Based on the user's name, provide only a single, highly relevant emoji character. Do not provide any text, explanation, or punctuation, just the emoji.";
            const userQuery = `Name: ${name}`;
            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            let currentDelay = 1000;
            let resultText = 'üìù'; // Default fallback

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    
                    if (text && text.length > 0) {
                        resultText = text.substring(0, 2); // Take first character(s)
                    }
                    break; // Success, exit loop

                } catch (error) {
                    console.error(`AI Emoji Fetch attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2; // Exponential backoff
                    }
                }
            }

            emojiInput.value = resultText;
            emojiInput.placeholder = 'Emoji';
            emojiInput.disabled = false;
        };


        // --- DRAG-AND-DROP HANDLERS (Unchanged) ---
        window.dragStart = (event) => {
            event.dataTransfer.setData("text/plain", event.target.dataset.choreid);
            event.dataTransfer.effectAllowed = "move";
        };

        window.dragOver = (event) => {
            event.preventDefault(); // Allows drop
            event.dataTransfer.dropEffect = "move";
            const targetList = event.currentTarget.querySelector('.chore-list-container');
            if (targetList) targetList.classList.add('drag-hover');
        };

        window.dragLeave = (event) => {
            const targetList = event.currentTarget.querySelector('.chore-list-container');
            if (targetList) targetList.classList.remove('drag-hover');
        };

        window.dropHandler = (event) => {
            event.preventDefault();
            
            const choreDefId = event.dataTransfer.getData("text/plain");
            const targetMemberId = event.currentTarget.dataset.memberid || null; // Null for Unassigned Pool
            
            const targetList = event.currentTarget.querySelector('.chore-list-container');
            if (targetList) targetList.classList.remove('drag-hover');

            if (choreDefId) {
                window.assignChore(choreDefId, targetMemberId);
            }
        };

        // --- VOICE COMMAND HANDLER ---
        
        window.toggleVoiceCommand = () => {
            if (!recognition) {
                showToast("Voice commands are not supported by your browser.", true);
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    speak("Ready. What can I help you with?");
                } catch (e) {
                    console.error("Recognition start error:", e);
                    showToast("Error starting microphone. Check permissions.", true);
                }
            }
        };

        const findItemByPartialMatch = (items, speech, keyName) => {
            const normalizedSpeech = speech.toLowerCase();
            return items.find(item => {
                const normalizedItemName = item[keyName].toLowerCase();
                // Match if the spoken text contains the item name, or if the item name contains the spoken text
                return normalizedItemName.includes(normalizedSpeech) || normalizedSpeech.includes(normalizedItemName);
            });
        };


        const handleVoiceCommand = async (transcript) => {
            const normalizedTranscript = transcript.toLowerCase();
            let commandExecuted = false;

            // --- 1. Navigation Commands ---
            const tabCommands = {
                'daily list': 'chores', 'daily chores': 'chores', 'show today': 'chores',
                'weekly schedule': 'weekly', 'show week': 'weekly',
                'points and rewards': 'rewards', 'go to rewards': 'rewards', 'show points': 'rewards',
                'setup': 'setup', 'open settings': 'setup',
                'calendar': 'calendar', 'show calendar': 'calendar'
            };
            
            for (const key in tabCommands) {
                if (normalizedTranscript.includes(key)) {
                    activeTab = tabCommands[key];
                    renderApp();
                    speak(`Going to ${key}.`);
                    commandExecuted = true;
                    break;
                }
            }
            if (commandExecuted) return;

            // --- 2. Chore Completion Commands (Mark X done, finish X) ---
            const choreCompleteMatch = normalizedTranscript.match(/(mark|finish|complete|i did|i finished|done with|done) (.+)/);
            if (choreCompleteMatch) {
                const choreName = choreCompleteMatch[2].trim();
                const chore = findItemByPartialMatch(choreDefs, choreName, 'name');
                
                if (chore) {
                    const assignment = choreAssignments.find(a => a.choreDefId === chore.id);
                    if (!assignment || !assignment.isCompleted) {
                        // Note: toggleChoreCompletion handles the transaction and points
                        await toggleChoreCompletion(chore.id); 
                        // Speak feedback is inside toggleChoreCompletion
                    } else {
                        speak(`${chore.name} is already done for today.`);
                    }
                } else {
                    speak(`Sorry, I couldn't find a chore named ${choreName}.`);
                }
                commandExecuted = true;
            }
            if (commandExecuted) return;


            // --- 3. Reward Redemption Commands (Mom redeem movie night, Lyra wants pizza) ---
            const redeemMatch = normalizedTranscript.match(/(.+) (redeem|want|buy|claims) (.+)/);
            if (redeemMatch) {
                const memberSpeech = redeemMatch[1].trim();
                const rewardSpeech = redeemMatch[3].trim();
                
                const member = findItemByPartialMatch(members, memberSpeech, 'name');
                const reward = findItemByPartialMatch(rewards, rewardSpeech, 'name');

                if (member && reward) {
                    await redeemReward(reward.id, member.id);
                    // Speak feedback is inside redeemReward
                } else {
                    speak(`I need both a family member and a reward. I heard member: ${memberSpeech} and reward: ${rewardSpeech}.`);
                    showToast(`Failed: Heard "${memberSpeech}" and "${rewardSpeech}"`, true);
                }
                commandExecuted = true;
            }
            if (commandExecuted) return;


            // --- 4. Default Failure ---
            if (!commandExecuted) {
                speak("I didn't understand that command. Please try a simple action like 'I finished empty dishwasher' or 'Lyra redeem movie night'.");
                showToast("Command not recognized.", true);
            }
        };


        // --- REUSED ACTIONS (Points, Rewards, Calendar) ---

        window.toggleChoreCompletion = async (choreDefId) => {
            if (!db) return;

            const choreDef = choreDefs.find(def => def.id === choreDefId);
            if (!choreDef) { showToast("Chore not found.", true); speak("Chore not found."); return; }
            if (!choreDef.assignedToId) { showToast("Chore must be assigned before completion can be tracked.", true); speak("Chore must be assigned before completion can be tracked."); return; }

            const assignmentRef = doc(db, 'artifacts', appId, 'public', 'data', 'choreAssignments', `${choreDefId}-${todayDateString}`);
            const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', choreDef.assignedToId);
            const choreItemElement = document.querySelector(`[data-choreid="${choreDefId}"]`);

            try {
                await runTransaction(db, async (transaction) => {
                    const assignmentDoc = await transaction.get(assignmentRef);
                    const memberDoc = await transaction.get(memberRef);
                    
                    const isCompleted = assignmentDoc.exists ? assignmentDoc.data().isCompleted : false;
                    const pointValue = choreDef.pointValue || 0;
                    const currentPoints = memberDoc.exists ? (memberDoc.data().points || 0) : 0;
                    
                    if (!isCompleted) {
                        // Completing the chore: ADD points
                        const newPoints = currentPoints + pointValue;
                        
                        transaction.set(assignmentRef, {
                            choreDefId: choreDefId,
                            date: todayDateString,
                            assignedToId: choreDef.assignedToId,
                            isCompleted: true,
                            completedAt: serverTimestamp()
                        }, { merge: true });

                        transaction.update(memberRef, { points: newPoints });

                        // --- NEW: Confetti burst animation ---
                        if (choreItemElement) {
                            const confetti = document.createElement('div');
                            confetti.className = 'confetti-burst';
                            choreItemElement.appendChild(confetti);
                            // Clean up the confetti element after the animation
                            setTimeout(() => confetti.remove(), 600);
                        }
                        // --- END Confetti ---

                        const msg = `+${pointValue} points awarded to ${memberDoc.data().name}!`;
                        showToast(msg);
                        speak(`${choreDef.name} done. ${msg}`);
                    } else {
                        // Uncompleting the chore: SUBTRACT points
                        const newPoints = Math.max(0, currentPoints - pointValue);

                        // Delete the assignment to reset state
                        transaction.delete(assignmentRef);

                        transaction.update(memberRef, { points: newPoints });
                        const msg = `-${pointValue} points removed from ${memberDoc.data().name}.`;
                        showToast(msg);
                        speak(`${choreDef.name} completion undone.`);
                    }
                });
            } catch (error) {
                console.error("Transaction failed:", error.message);
                showToast(`Update Failed: ${error.message}`, true);
                speak(`Chore update failed due to a system error.`);
            }
        };

        window.deleteChoreDefinition = async (defId, defName) => {
            if (!db) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'choreDefs', defId));
                showToast(`Chore definition '${defName}' deleted.`);
            } catch (error) {
                console.error("Error deleting chore definition:", error);
                showToast("Failed to delete chore definition.", true);
            }
        };

        window.addReward = async () => {
            if (!db) return;
            const nameInput = document.getElementById('new-reward-name');
            const costInput = document.getElementById('new-reward-cost');
            const emojiInput = document.getElementById('new-reward-emoji');
            
            const rewardName = nameInput.value.trim();
            const cost = parseInt(costInput.value, 10);
            const emoji = emojiInput.value.trim().substring(0, 2) || 'üéÅ';

            if (!rewardName || isNaN(cost) || cost <= 0) {
                showToast("Please enter a name and a positive point cost.", true);
                return;
            }

            const newId = crypto.randomUUID();
            const rewardsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'rewards');

            try {
                await setDoc(doc(rewardsCollectionRef, newId), {
                    id: newId,
                    name: rewardName,
                    cost: cost,
                    emoji: emoji,
                    claimed: false,
                    createdAt: serverTimestamp()
                });
                nameInput.value = '';
                costInput.value = '';
                emojiInput.value = '';
                showToast(`Reward '${rewardName}' created!`);
            } catch (error) {
                console.error("Error adding reward:", error);
                showToast("Failed to create reward.", true);
            }
        };

        window.redeemReward = async (rewardId, memberId) => {
            if (!db || !memberId) { showToast("Please select a family member to redeem for.", true); speak("Please select a family member."); return; }

            const rewardRef = doc(db, 'artifacts', appId, 'public', 'data', 'rewards', rewardId);
            const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', memberId);
            const rewardName = rewards.find(r => r.id === rewardId)?.name || 'the reward';
            const memberName = members.find(m => m.id === memberId)?.name || 'a member';
            
            try {
                await runTransaction(db, async (transaction) => {
                    const rewardDoc = await transaction.get(rewardRef);
                    const memberDoc = await transaction.get(memberRef);

                    if (!rewardDoc.exists()) { throw new Error("Reward not found."); }
                    if (!memberDoc.exists()) { throw new Error("Member not found."); }
                    
                    const rewardCost = rewardDoc.data().cost || 0;
                    const memberPoints = memberDoc.data().points || 0;

                    if (rewardDoc.data().claimed) { throw new Error("Reward already claimed."); }
                    if (memberPoints < rewardCost) { 
                        const needed = rewardCost - memberPoints;
                        const errorMsg = `${memberName} needs ${needed} more points to redeem ${rewardName}.`;
                        showToast(errorMsg, true);
                        speak(errorMsg);
                        throw new Error("Insufficient points.");
                    }

                    // 1. Deduct points from member
                    transaction.update(memberRef, { points: memberPoints - rewardCost });
                    
                    // 2. Mark reward as claimed
                    transaction.update(rewardRef, {
                        claimed: true,
                        claimedBy: memberName,
                        claimedById: memberId,
                        claimedAt: serverTimestamp()
                    });
                    
                    const successMsg = `Success! ${rewardName} redeemed by ${memberName} for ${rewardCost} points!`;
                    showToast(successMsg);
                    speak(successMsg);
                });
                return true;
            } catch (error) {
                console.error("Redemption failed:", error.message);
                // If it's a custom error message (Insufficient points), it's already spoken.
                if (!error.message.includes('points')) {
                    showToast(`Redemption Failed: ${error.message}`, true);
                    speak(`Redemption failed due to a system error.`);
                }
                return false;
            }
        };

        window.deleteReward = async (rewardId, rewardName) => {
            if (!db) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rewards', rewardId));
                showToast(`Reward '${rewardName}' deleted.`);
            } catch (error) {
                console.error("Error deleting reward:", error);
                showToast("Failed to delete reward.", true);
            }
        };

        window.changeMonth = (direction) => {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderApp();
        };

        // --- UI RENDERING ---

        const getActiveChoresForToday = () => {
            const choresByMember = { 'unassigned': [] }; 

            choreDefs.forEach(def => {
                // Check if it's scheduled for today OR is an ad-hoc chore created today
                const isScheduledToday = def.schedule && def.schedule[todayDayOfWeek];
                const isOneTimeChoreToday = def.isAdhoc && def.createdAt && def.createdAt.toDate && formatDate(def.createdAt.toDate()) === todayDateString;

                if (isScheduledToday || isOneTimeChoreToday) {
                    const id = def.assignedToId || 'unassigned';
                    
                    const assignment = choreAssignments.find(a => a.choreDefId === def.id);
                    const isCompleted = assignment ? assignment.isCompleted : false;
                    
                    const member = members.find(m => m.id === def.assignedToId);
                    
                    if (!choresByMember[id]) { choresByMember[id] = []; }
                    
                    choresByMember[id].push({
                        ...def,
                        isCompleted: isCompleted,
                        member: member || { name: 'Unassigned', color: MEMBER_COLORS['indigo'], initials: '?' }
                    });
                }
            });
            return choresByMember;
        };

        // Added index for staggering animations
        const renderChoreItem = (chore, isCompleted, isUnassigned = false, index = 0) => {
            const memberColor = isUnassigned ? MEMBER_COLORS['gray'] : chore.member.color;

            let completionButton = '';
            let dragClasses = '';
            
            if (!isUnassigned && chore.assignedToId) {
                completionButton = `
                    <button 
                        onclick="toggleChoreCompletion('${chore.id}')"
                        class="completion-btn w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0 transition-all duration-300 transform hover:scale-105 
                        ${isCompleted ? 'bg-green-500 border-green-700 shadow-md' : 'bg-white border-gray-300 hover:bg-green-100 shadow-inner'}"
                    >
                        ${isCompleted ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>' : chore.emoji}
                    </button>
                `;
                dragClasses = 'chore-item';
            } else {
                completionButton = `<span class="w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0 text-2xl">${chore.emoji}</span>`;
                dragClasses = 'chore-item';
            }

            return `
                <li 
                    class="animated-item flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-2 transition-all duration-200 ${dragClasses} ${isCompleted ? 'opacity-70 border-l-4 border-green-300' : ''} relative"
                    draggable="true"
                    data-choreid="${chore.id}"
                    ondragstart="dragStart(event)"
                    style="animation-delay: ${index * 0.05}s;"
                >
                    <div class="flex items-center flex-grow">
                        ${completionButton}
                        
                        <div class="flex flex-col text-left">
                            <span class="text-base font-semibold ${isCompleted ? 'line-through text-gray-500' : 'text-gray-800'}">
                                ${chore.name}
                                ${chore.isAdhoc ? '<span class="text-xs ml-1 text-red-500">(One-Time)</span>' : ''}
                            </span>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <span class="text-sm font-bold text-indigo-600 flex-shrink-0 bg-indigo-50 px-2 py-1 rounded-full">
                            +${chore.pointValue || 0}
                        </span>
                    </div>
                </li>
            `;
        };
        
        // Renamed and modified to only return form structure (no outer div)
        const getAdhocChoreFormHTML = () => {
             const memberOptions = members.map(m => 
                `<option value="${m.id}">${m.name}</option>`
            ).join('');

            return `
                <div id="adhoc-form-inner" class="bg-indigo-50 p-4 rounded-xl shadow-inner border border-indigo-200">
                    <h3 class="text-xl font-bold text-indigo-800 mb-3 border-b border-indigo-200 pb-2">One-Time Chore Details</h3>
                    <div class="space-y-3">
                        <div class="flex space-x-2">
                            <input id="adhoc-emoji" type="text" placeholder="üìù" maxlength="2" class="w-1/6 p-3 border border-gray-300 rounded-xl text-center shadow-inner" />
                            <input id="adhoc-name" type="text" placeholder="Chore Name (e.g., Water the plants)" class="flex-grow p-3 border border-gray-300 rounded-xl shadow-inner" />
                             <button onclick="pickEmoji('adhoc-emoji', document.getElementById('adhoc-name').value)" class="p-3 bg-gray-200 rounded-xl text-sm font-semibold hover:bg-gray-300 transition-colors shadow-sm action-btn">AI</button>
                        </div>
                         <div class="flex space-x-2">
                            <select id="adhoc-member" class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" ${members.length === 0 ? 'disabled' : ''}>
                                <option value="" selected disabled>Assign To Member...</option>
                                ${memberOptions}
                            </select>
                            <input id="adhoc-points" type="number" min="1" value="10" placeholder="Points" class="w-24 p-3 border border-gray-300 rounded-xl text-center shadow-sm" />
                        </div>
                        <button onclick="window.addChoreDefinition(true)" class="w-full bg-red-600 text-white p-3 rounded-xl font-extrabold hover:bg-red-700 transition-colors shadow-lg active:shadow-sm transform hover:scale-[1.01] action-btn">
                            Add Today's Chore (No Repeat)
                        </button>
                    </div>
                </div>
            `;
        }

        const renderChoreChartView = () => {
            const choresByMember = getActiveChoresForToday();
            const unassignedChores = choresByMember['unassigned'] || [];
            
            
            // --- Member Lists ---
            let itemIndex = 0;
            const memberListsHtml = members.map(member => {
                const memberChores = choresByMember[member.id] || [];
                const totalPoints = member.points || 0;
                
                const choreListHtml = memberChores.length > 0 ? memberChores.map(chore => {
                    const html = renderChoreItem(chore, chore.isCompleted, false, itemIndex);
                    itemIndex++;
                    return html;
                }).join('')
                : `<p class="text-gray-500 italic p-4 text-center text-sm">Drag a chore here for ${member.name}!</p>`;

                const memberColorClasses = member.color;

                return `
                    <div 
                        class="${memberColorClasses.bg} p-4 rounded-xl shadow-xl border-t-8 ${memberColorClasses.border} drag-target member-card"
                        ondragover="dragOver(event)"
                        ondragleave="dragLeave(event)"
                        ondrop="dropHandler(event)"
                        data-memberid="${member.id}"
                    >
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-300">
                            <h4 class="text-xl font-extrabold ${memberColorClasses.text} flex items-center">
                                <span class="text-2xl mr-2">${member.emoji}</span> ${member.name}'s List
                            </h4>
                            <div class="flex items-center bg-yellow-300 text-yellow-900 px-3 py-1 rounded-full font-extrabold text-lg shadow-inner">
                                ${totalPoints} Pts
                            </div>
                        </div>
                        <ul class="space-y-2 chore-list-container">
                            ${choreListHtml}
                        </ul>
                    </div>
                `;
            }).join('');
            
            // --- Unassigned Pool (with embedded button and form) ---
            const unassignedListHtml = unassignedChores.length > 0 ? unassignedChores.map((chore, index) => 
                renderChoreItem(chore, false, true, index)
            ).join('')
            : '<p class="text-gray-500 italic p-4 text-center text-sm">Pool is empty! Drag an assigned chore back here to unassign it.</p>';
            
            const unassignedPoolHtml = `
                <div 
                    class="bg-yellow-50 p-4 rounded-xl shadow-xl border-2 border-dashed border-yellow-400 drag-target md:col-span-full"
                    ondragover="dragOver(event)"
                    ondragleave="dragLeave(event)"
                    ondrop="dropHandler(event)"
                    data-memberid="" 
                >
                    <div class="flex justify-between items-center mb-3 border-b border-yellow-300 pb-2">
                        <h3 class="text-xl font-extrabold text-yellow-800 flex items-center">
                            <span class="text-2xl mr-2">üì•</span> Unassigned Chores Pool (${unassignedChores.length} today)
                        </h3>
                        <!-- NEW: Toggle Button within the header area -->
                        <button onclick="window.toggleAdhocForm()" 
                            class="action-btn w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center shadow-lg hover:bg-red-700 transition-colors transform hover:scale-105"
                            title="${isAdhocFormOpen ? 'Hide form' : 'Add one-time chore'}"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform transition-transform duration-300 ${isAdhocFormOpen ? 'rotate-45' : 'rotate-0'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>

                    <!-- Collapsible Form Content embedded inside the pool -->
                    <div id="adhoc-form-content" class="collapsible-content ${isAdhocFormOpen ? 'open' : ''}">
                        ${getAdhocChoreFormHTML()}
                    </div>
                    
                    <h4 class="text-sm font-bold text-yellow-800 mt-4 mb-2">Drag from here to assign:</h4>
                    <ul class="space-y-2 chore-list-container">
                        ${unassignedListHtml}
                    </ul>
                </div>
            `;
            
            // --- Final render output ---
            return `
                <div class="space-y-6 pb-20">
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-lg border border-indigo-200">
                        <h3 class="text-xl font-bold text-indigo-800 mb-1">üìÖ Today is ${todayDayOfWeek}, ${todayDateString}</h3>
                        <p class="text-sm text-indigo-700">Drag chores between the pool and member lists to assign them.</p>
                    </div>
                    
                    <!-- Concurrent Chore Lists: Responsive Grid -->
                    <h3 class="text-2xl font-extrabold text-gray-800 mt-6 mb-3 border-b pb-2">Active Assignments</h3>
                    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        ${members.length > 0 ? memberListsHtml : '<p class="text-gray-500 italic p-4 text-center md:col-span-2 lg:col-span-3">Go to the "Setup" tab to add family members and define chores!</p>'}
                    </div>

                    <!-- Unassigned Pool (Now at the bottom) -->
                    ${unassignedPoolHtml}

                    <!-- User ID Display (footer) -->
                    <div class="mt-4 p-3 text-xs text-gray-600 bg-gray-100 rounded-xl shadow-inner">
                        <p class="font-bold text-sm text-gray-800 mb-1">Collaboration Info:</p>
                        <p class="break-all font-mono">User ID: ${userId || "Authenticating..."}</p>
                    </div>
                </div>
            `;
        };

        const renderWeeklyView = () => {
            // Helper to get the YYYY-MM-DD date string for a specific day of the current week
            const getDayDateString = (dayIndex) => {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 for Sun, 1 for Mon...
                const diff = dayIndex - dayOfWeek;
                
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + diff);
                
                return formatDate(targetDate);
            };

            const scheduleHtml = WEEKDAYS.map((day, dayIndex) => {
                const dayDateString = getDayDateString(dayIndex);
                const isToday = dayDateString === todayDateString;

                // Filter for both recurring and ad-hoc chores for this specific day
                const dayChores = choreDefs.filter(def => {
                    const isRecurringMatch = !def.isAdhoc && def.schedule[day];
                    
                    // Ad-hoc chores are filtered by matching their creation date (due date) to the day in the loop
                    let isAdhocMatch = false;
                    if (def.isAdhoc && def.createdAt && def.createdAt.toDate) {
                         isAdhocMatch = formatDate(def.createdAt.toDate()) === dayDateString;
                    }
                    
                    return isRecurringMatch || isAdhocMatch;
                });
                
                const choreBlocks = dayChores.map(chore => {
                    const member = members.find(m => m.id === chore.assignedToId);
                    // Default to gray for unassigned/unknown members
                    const memberColor = member ? member.color : MEMBER_COLORS.indigo; 
                    const memberEmoji = member ? member.emoji : '‚ùì';
                    const memberName = member ? member.name : 'Unassigned';

                    return `
                        <div class="flex items-center p-2 rounded-lg ${memberColor.bg} text-${memberColor.text.split('-')[1]}-800 shadow-sm mb-1 text-sm font-medium">
                            <span class="text-lg mr-2">${chore.emoji}</span>
                            <div class="flex flex-col flex-grow">
                                <span class="font-bold">${chore.name}</span>
                                <span class="text-xs ${memberColor.text}">
                                    ${memberEmoji} ${memberName} (+${chore.pointValue} Pts)
                                    ${chore.isAdhoc ? '<span class="text-red-600 font-bold ml-1">(One-Time)</span>' : ''}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="p-3 bg-white rounded-xl shadow-xl border-t-4 ${isToday ? 'border-red-500' : 'border-indigo-400'}">
                        <h3 class="text-xl font-extrabold ${isToday ? 'text-red-800' : 'text-indigo-800'} mb-1">${day}</h3>
                        <p class="text-xs text-gray-500 mb-3">${dayDateString}</p>
                        <div class="min-h-[50px]">
                            ${dayChores.length > 0 ? choreBlocks : '<p class="text-gray-400 italic text-sm">No scheduled chores.</p>'}
                        </div>
                    </div>
                `;
            }).join('');


            return `
                <div class="space-y-6 pb-20">
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-lg border border-indigo-200">
                        <h3 class="text-xl font-bold text-indigo-800 mb-1">Weekly Chore Schedule</h3>
                        <p class="text-sm text-indigo-700">This view shows all recurring and one-time chores for the week, color-coded by the assigned member.</p>
                    </div>

                    <!-- Responsive Grid for Weekly Schedule -->
                    <div class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7">
                        ${scheduleHtml}
                    </div>
                </div>
            `;
        };
        
        const renderRewardsView = () => {
            const selectedRedeemMemberId = document.getElementById('redeem-member-select')?.value || members[0]?.id || '';
            const selectedMember = members.find(m => m.id === selectedRedeemMemberId);

            const rewardsListHtml = rewards.map(reward => {
                const memberPoints = selectedMember?.points || 0;
                const canRedeem = memberPoints >= reward.cost;
                const redeemText = canRedeem ? 'Redeem' : 'Need ' + (reward.cost - memberPoints) + ' Pts';

                return `
                    <li class="flex justify-between items-center bg-white p-3 rounded-xl shadow-md border border-gray-100 mb-3 hover:shadow-lg transform hover:scale-[1.005] transition-all">
                        <div class="flex items-center flex-grow">
                            <span class="text-3xl mr-3">${reward.emoji}</span>
                            <div class="flex flex-col text-left">
                                <span class="text-lg font-bold text-gray-800">${reward.name}</span>
                                <span class="text-sm font-extrabold text-red-600">Cost: ${reward.cost} Pts</span>
                            </div>
                        </div>
                        <div class="flex space-x-2 items-center flex-shrink-0">
                            <button 
                                onclick="redeemReward('${reward.id}', document.getElementById('redeem-member-select').value)"
                                class="action-btn bg-red-500 text-white p-3 text-sm rounded-xl font-extrabold hover:bg-red-600 transition-colors shadow-lg active:shadow-sm transform hover:scale-105 ${!canRedeem || !selectedRedeemMemberId ? 'opacity-50 cursor-not-allowed shadow-none' : ''}"
                                ${!canRedeem || !selectedRedeemMemberId ? 'disabled' : ''}
                            >
                                ${redeemText}
                            </button>
                            <button 
                                onclick="deleteReward('${reward.id}', '${reward.name.replace(/'/g, "\\'")}')"
                                class="action-btn p-2 text-gray-400 hover:text-red-600 rounded-full transition-colors ml-2 flex-shrink-0"
                                title="Delete Reward"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </li>
                `;
            }).join('');
            
            return `
                <div class="space-y-6 pb-20">
                    <h3 class="text-2xl font-extrabold text-gray-800 mb-3 border-b pb-2">üåü Point Summary</h3>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${members.map(member => `
                            <div class="${member.color.bg} p-4 rounded-xl shadow-xl flex flex-col items-center member-card">
                                <span class="text-4xl font-extrabold ${member.color.text}">${member.emoji}</span>
                                <span class="text-sm ${member.color.text} font-bold mt-1">${member.name}</span>
                                <span class="text-2xl font-extrabold text-yellow-700 mt-2 bg-yellow-100 px-3 py-1 rounded-full shadow-inner">${member.points} Pts</span>
                            </div>
                        `).join('')}
                    </div>

                    <h3 class="text-2xl font-extrabold text-gray-800 mb-3 border-b pb-2">üéÅ Available Rewards</h3>
                    
                    <!-- Redemption Section -->
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-lg border border-indigo-200">
                        <div class="flex items-center space-x-3 mb-4">
                            <label class="font-bold text-gray-700 whitespace-nowrap text-lg">Redeem for:</label>
                            <select id="redeem-member-select" onchange="renderApp()" class="flex-grow p-3 border border-gray-300 rounded-xl bg-white text-md shadow-sm">
                                <option value="" selected disabled>Select Member...</option>
                                ${members.map(m => `<option value="${m.id}" ${m.id === selectedRedeemMemberId ? 'selected' : ''}>${m.name} (${m.points || 0} Pts)</option>`).join('')}
                            </select>
                        </div>
                        <ul class="space-y-2 max-h-60 overflow-y-auto scroll-area">
                            ${rewards.length > 0 ? rewardsListHtml : '<p class="text-gray-500 italic text-center p-4 text-md">No rewards set yet! Go to Setup to add some.</p>'}
                        </ul>
                    </div>
                </div>
            `;
        };
        
        const renderSetupView = () => {
            const memberOptions = members.map(m => 
                `<option value="${m.id}">${m.name}</option>`
            ).join('');

            const memberEditListHtml = members.map(member => `
                <div class="bg-white p-4 rounded-xl shadow-md border-l-4 ${member.color.border} mb-3 member-card">
                    <h4 class="text-lg font-bold text-gray-800 flex items-center mb-2">
                        <span class="text-xl mr-2">${member.emoji}</span> ${member.name}
                    </h4>
                    <div class="space-y-2">
                        <input id="edit-member-name-${member.id}" type="text" value="${member.name}" placeholder="Name" class="w-full p-2 border border-gray-300 rounded-lg text-sm shadow-inner" />
                        <div class="flex space-x-2">
                            <input id="edit-member-emoji-${member.id}" type="text" value="${member.emoji}" placeholder="Emoji" maxlength="2" class="w-1/3 p-2 border border-gray-300 rounded-lg text-sm text-center shadow-inner" />
                            <select id="edit-member-color-${member.id}" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white text-sm shadow-inner">
                                ${Object.keys(MEMBER_COLORS).map(key => 
                                    `<option value="${key}" ${member.colorKey === key ? 'selected' : ''}>${key.charAt(0).toUpperCase() + key.slice(1)}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <button onclick="updateFamilyMember('${member.id}')" class="action-btn w-full bg-indigo-500 text-white p-2 rounded-xl font-semibold hover:bg-indigo-600 transition-colors shadow-lg active:shadow-sm">
                            Save Changes
                        </button>
                    </div>
                </div>
            `).join('');


            const choreDefListHtml = choreDefs.filter(def => !def.isAdhoc).map(def => {
                const member = def.assignedToId ? (members.find(m => m.id === def.assignedToId) || { name: 'Unknown' }) : { name: 'Unassigned' };
                const scheduleDays = WEEKDAYS.filter(day => def.schedule[day]).join(', ');
                
                return `
                    <li class="flex justify-between items-center bg-white p-3 rounded-xl shadow-md border border-gray-100 mb-2 hover:shadow-lg transform hover:scale-[1.005] transition-all">
                        <div class="flex flex-col text-left flex-grow">
                            <div class="text-lg font-bold text-gray-800">${def.emoji} ${def.name}</div>
                            <div class="text-sm text-indigo-600 font-medium">Default Assign: ${member.name} | Points: ${def.pointValue}</div>
                            <div class="text-xs text-gray-500 mt-1">Schedule: ${scheduleDays}</div>
                        </div>
                        <button 
                            onclick="deleteChoreDefinition('${def.id}', '${def.name.replace(/'/g, "\\'")}')"
                            class="action-btn p-2 text-gray-400 hover:text-red-600 rounded-full transition-colors ml-4 flex-shrink-0"
                            title="Delete Chore Definition"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </li>
                `;
            }).join('');


            const rewardAddForm = `
                <div class="bg-white p-4 rounded-xl shadow-xl border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Add New Reward</h3>
                    <div class="space-y-3">
                        <div class="flex space-x-2">
                            <!-- UPDATED: AI Emoji Integration -->
                            <input id="new-reward-emoji" type="text" placeholder="üç¶" maxlength="2" class="w-1/6 p-3 border border-gray-300 rounded-xl text-center shadow-sm" />
                            <input id="new-reward-name" type="text" placeholder="Reward name (e.g., Pizza Night)" class="flex-grow p-3 border border-gray-300 rounded-xl shadow-sm" />
                            <button onclick="pickEmoji('new-reward-emoji', document.getElementById('new-reward-name').value)" class="action-btn p-3 bg-gray-200 rounded-xl text-sm font-semibold hover:bg-gray-300 transition-colors shadow-sm">AI</button>
                            <input id="new-reward-cost" type="number" min="1" value="50" placeholder="Cost" class="w-20 p-3 border border-gray-300 rounded-xl text-center shadow-sm" />
                        </div>
                        <button onclick="window.addReward()" class="action-btn w-full bg-indigo-600 text-white p-3 rounded-xl font-extrabold hover:bg-indigo-700 transition-colors shadow-lg active:shadow-sm transform hover:scale-[1.01]">
                            Create Reward
                        </button>
                    </div>
                </div>
            `;

            return `
                <div class="space-y-6 pb-20">
                    
                    <!-- Member Management Section: Responsive Grid -->
                    <div class="grid gap-6 md:grid-cols-2">
                        <div class="bg-indigo-50 p-4 rounded-xl shadow-lg border border-indigo-200">
                            <h3 class="text-xl font-bold text-indigo-800 mb-3 border-b border-indigo-200 pb-2">Add New Member</h3>
                            <div class="flex space-x-2">
                                <input
                                    id="new-member-name"
                                    type="text"
                                    placeholder="New member name (e.g., Dad)"
                                    class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-inner"
                                    onkeydown="if(event.key === 'Enter') { window.addFamilyMember(); }"
                                />
                                <button
                                    onclick="window.addFamilyMember()"
                                    class="action-btn bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 disabled:opacity-50 transition-colors shadow-lg active:shadow-sm transform hover:scale-[1.01]"
                                >
                                    Add
                                </button>
                            </div>
                        </div>

                        ${rewardAddForm}
                    </div>
                    
                    <!-- Existing Member Customization -->
                    <div class="bg-white p-4 rounded-xl shadow-xl border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Edit Members & Customization (${members.length})</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${members.length > 0 ? memberEditListHtml : '<p class="text-gray-500 italic p-4 text-center">No members added yet.</p>'}
                        </div>
                    </div>

                    <!-- Chore Definitions Section: Responsive Grid -->
                    <div class="grid gap-6 md:grid-cols-2">
                        <div class="bg-white p-4 rounded-xl shadow-xl border border-gray-100">
                            <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Create New Recurring Chore</h3>
                            <div class="space-y-3">
                                <!-- Name, Emoji, Points -->
                                <div class="flex space-x-2">
                                    <input id="new-chore-def-emoji" type="text" placeholder="üß∫" maxlength="2" class="w-1/6 p-3 border border-gray-300 rounded-xl text-center shadow-inner" />
                                    <input id="new-chore-def-name" type="text" placeholder="Chore Name" class="flex-grow p-3 border border-gray-300 rounded-xl shadow-inner" />
                                     <button onclick="pickEmoji('new-chore-def-emoji', document.getElementById('new-chore-def-name').value)" class="action-btn p-3 bg-gray-200 rounded-xl text-sm font-semibold hover:bg-gray-300 transition-colors shadow-sm">AI</button>
                                </div>
                                <div class="flex space-x-2">
                                    <select id="new-chore-def-member" class="flex-grow p-3 border border-gray-300 rounded-xl bg-white focus:ring-indigo-500 focus:border-indigo-500 shadow-inner" ${members.length === 0 ? 'disabled' : ''}>
                                        <option value="" selected>Set Default Assignment (Optional)</option>
                                        ${memberOptions}
                                    </select>
                                    <input id="new-chore-def-points" type="number" min="1" value="10" placeholder="Pts" class="w-20 p-3 border border-gray-300 rounded-xl text-center shadow-inner" />
                                </div>

                                <!-- Schedule -->
                                <div class="border border-gray-200 p-3 rounded-xl bg-gray-50 shadow-inner">
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Schedule Repeating Days:</label>
                                    <div class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                                        ${WEEKDAYS.map(day => `
                                            <div class="flex items-center">
                                                <input type="checkbox" id="schedule-day-${day}" class="rounded text-indigo-600 focus:ring-indigo-500">
                                                <label for="schedule-day-${day}" class="ml-1.5 text-xs font-medium text-gray-700">${day}</label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <button onclick="window.addChoreDefinition()" class="action-btn w-full bg-green-600 text-white p-3 rounded-xl font-extrabold hover:bg-green-700 transition-colors shadow-lg active:shadow-sm transform hover:scale-[1.01]">
                                    Save Chore Definition
                                </button>
                            </div>
                        </div>
                        
                        <!-- Existing Chore Definitions List -->
                        <div class="bg-white p-4 rounded-xl shadow-xl border border-gray-100">
                            <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">All Recurring Chores (${choreDefs.filter(def => !def.isAdhoc).length})</h3>
                            <ul class="space-y-3 max-h-96 overflow-y-auto scroll-area">
                                ${choreDefs.filter(def => !def.isAdhoc).length > 0 ? choreDefListHtml : '<p class="text-gray-500 italic p-4 text-center">No recurring chores defined yet.</p>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderCalendarView = () => {
            const daysInMonth = getDaysInMonth(currentDate);
            const today = new Date().toDateString();

            // Mock Events 
            const calendarEvents = [
                { date: new Date(currentDate.getFullYear(), currentDate.getMonth(), 15).toDateString(), title: "Family Movie Night" },
                { date: new Date(currentDate.getFullYear(), currentDate.getMonth(), 22).toDateString(), title: "School Play" },
                { date: new Date(currentDate.getFullYear(), currentDate.getMonth(), 5).toDateString(), title: "Dentist" },
            ];

            const weekDayNames = WEEKDAYS.map(day => 
                `<div class="p-2 border-b border-gray-200">${day}</div>`
            ).join('');

            const dayCells = daysInMonth.map(date => {
                const day = date.getDate();
                const isToday = date.toDateString() === today;
                const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                const cellEvents = calendarEvents.filter(e => e.date === date.toDateString());

                const dayClasses = isCurrentMonth ? 'text-gray-900 bg-white' : 'text-gray-400 bg-gray-50';
                const todayClasses = isToday ? 'ring-2 ring-indigo-500 ring-offset-2 rounded-lg' : '';

                const eventHtml = cellEvents.map((event, index) => 
                    `<div class="truncate bg-red-100 text-red-700 font-medium px-1 rounded-sm my-0.5 text-[10px] sm:text-xs">
                        ${event.title}
                    </div>`
                ).join('');

                return `
                    <div class="h-24 p-1 text-xs border border-gray-100 transition duration-150 ease-in-out hover:bg-blue-50 relative overflow-hidden ${dayClasses} ${todayClasses}">
                        <span class="absolute top-1 right-1 font-semibold ${isToday ? 'text-indigo-600' : 'text-gray-800'}">
                            ${day}
                        </span>
                        <div class="mt-5 space-y-0.5 max-h-16 overflow-y-auto scroll-area">
                            ${eventHtml}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="pb-20">
                    <div class="bg-white shadow-xl rounded-xl border border-gray-100">
                        <!-- Calendar Header -->
                        <div class="flex justify-between items-center p-4 bg-indigo-50 rounded-t-xl border-b border-gray-200">
                            <button 
                                onclick="window.changeMonth(-1)" 
                                class="action-btn p-2 rounded-full hover:bg-indigo-100 transition text-indigo-700"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <h2 class="text-xl font-extrabold text-indigo-800">
                                ${currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}
                            </h2>
                            <button 
                                onclick="window.changeMonth(1)" 
                                class="action-btn p-2 rounded-full hover:bg-indigo-100 transition text-indigo-700"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                        
                        <!-- Weekday Names -->
                        <div class="grid grid-cols-7 text-center font-bold text-sm text-gray-600 border-t border-gray-200">
                            ${weekDayNames}
                        </div>
                        
                        <!-- Day Cells -->
                        <div class="grid grid-cols-7 auto-rows-fr calendar-grid rounded-b-xl overflow-hidden">
                            ${dayCells}
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-sm text-yellow-800 shadow-md">
                        <h3 class="font-bold mb-1">Integration Notice:</h3>
                        <p>
                            Direct, secure Google Calendar syncing requires complex server authentication (OAuth 2.0) which is not possible in this single-file structure. 
                            This calendar displays **mock events** to show the layout. In a real Android app, this view would be replaced with your official Google Calendar API implementation.
                        </p>
                    </div>
                </div>
            `;
        };


        const renderApp = () => {
            const contentArea = document.getElementById('content-area');
            const tabsNav = document.getElementById('tabs-nav');

            // Render content based on active tab
            if (activeTab === 'chores') {
                contentArea.innerHTML = renderChoreChartView();
            } else if (activeTab === 'weekly') {
                contentArea.innerHTML = renderWeeklyView();
            } else if (activeTab === 'rewards') {
                contentArea.innerHTML = renderRewardsView();
            } else if (activeTab === 'setup') {
                contentArea.innerHTML = renderSetupView();
            } else if (activeTab === 'calendar') {
                contentArea.innerHTML = renderCalendarView();
            }
            
            // Update tab styles
            tabsNav.querySelectorAll('button').forEach(button => {
                const tab = button.getAttribute('data-tab');
                if (tab === activeTab) {
                    // Active style: Indigo text, white background, thick bottom border
                    button.className = 'flex-1 p-3 text-center text-sm font-extrabold transition-colors text-indigo-700 bg-white border-b-4 border-indigo-600 shadow-inner';
                } else {
                    // Inactive style
                    button.className = 'flex-1 p-3 text-center text-sm font-semibold transition-colors text-gray-500 hover:text-indigo-600 hover:bg-gray-100';
                }
            });

            // Show loading overlay if not ready
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = isAuthReady ? 'none' : 'flex';
            }
        };


        // --- MAIN INITIALIZATION ---

        const main = async () => {
            // Add a simple loading overlay
            const container = document.getElementById('app-container');
            const loadingHtml = `
                <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-gray-50 z-50">
                    <div class="flex flex-col items-center text-indigo-600 font-semibold text-lg p-8 rounded-xl shadow-2xl bg-white">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading Family Organizer...
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', loadingHtml);


            await initializeFirebase();
            // --- Call the seeding function after initialization
            await seedData();
            
            startDataListeners();

            // Setup tab switching listener
            document.getElementById('tabs-nav').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (target) {
                    activeTab = target.getAttribute('data-tab');
                    renderApp();
                }
            });
            
            // Initial render (will be updated immediately by listeners)
            renderApp();
        };

        window.addEventListener('load', main);

    </script>
</body>
</html>
