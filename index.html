<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Hub Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh */
        }
        .app-bg {
            background-color: #f0f2f5;
            background-image:
                radial-gradient(at 0% 0%, hsla(213, 20%, 25%, 0.03) 0px, transparent 50%),
                radial-gradient(at 98% 1%, hsla(213, 20%, 25%, 0.03) 0px, transparent 50%);
        }
        .header-gradient {
            background: linear-gradient(90deg, rgba(63,81,181,1) 0%, rgba(86,103,203,1) 100%);
        }
        .tab {
            @apply px-3 py-4 text-sm font-medium text-center text-indigo-200 border-b-4 border-transparent;
            @apply md:px-6 md:text-base;
        }
        .tab-active {
            @apply border-white text-white;
        }
        .chore-item, .reward-item {
            @apply bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4 transition-all duration-150;
        }
        .chore-item-completed {
            @apply opacity-50 line-through;
        }
        .drag-ghost {
            position: absolute;
            pointer-events: none;
            opacity: 0.8;
            transform: scale(1.05);
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .drop-target-active {
            @apply ring-4 ring-indigo-400 ring-dashed;
        }
    </style>
</head>
<body class="h-full w-full overflow-hidden flex flex-col app-bg">

    <!-- Main Header -->
    <header class="header-gradient text-white shadow-md z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <h1 class="text-2xl md:text-3xl font-bold">Family Hub Organizer</h1>
                <div id="loading-indicator" class="hidden items-center space-x-2">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm font-medium">Syncing...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-indigo-700 shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-around -mb-px">
            <button id="tab-daily-list" class="tab tab-active" onclick="changeTab('daily-list')">Daily List</button>
            <button id="tab-weekly-schedule" class="tab" onclick="changeTab('weekly-schedule')">Weekly Schedule</button>
            <button id="tab-points" class="tab" onclick="changeTab('points')">Points & Rewards</button>
            <button id="tab-setup" class="tab" onclick="changeTab('setup')">Setup</button>
            <button id="tab-calendar" class="tab" onclick="changeTab('calendar')">Calendar</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Daily List Tab -->
            <div id="content-daily-list" class="tab-content space-y-8">
                <!-- Active Assignments -->
                <div id="daily-assignments-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Member cards will be injected here -->
                </div>

                <!-- Unassigned Chores Pool -->
                <div id="unassigned-pool" class="bg-yellow-100 border-2 border-yellow-300 rounded-xl p-4 drop-zone">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-yellow-800">Unassigned Chores Pool</h3>
                        <button id="toggle-adhoc-form" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
                            <span class="text-2xl font-light">Ôºã</span>
                        </button>
                    </div>

                    <!-- Adhoc Form (collapsible) -->
                    <form id="adhoc-chore-form" class="hidden space-y-4 p-4 bg-white rounded-lg shadow-inner">
                        <h4 class="text-lg font-medium text-gray-700">Add One-Time Chore</h4>
                        <div>
                            <label for="adhoc-chore-name" class="block text-sm font-medium text-gray-700">Chore Name</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="adhoc-chore-name" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Take out recycling">
                                <button type="button" id="adhoc-ai-emoji-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">AI</button>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="adhoc-chore-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                <input type="text" id="adhoc-chore-emoji" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="‚ùì">
                            </div>
                            <div class="flex-1">
                                <label for="adhoc-chore-points" class="block text-sm font-medium text-gray-700">Points</label>
                                <input type="number" id="adhoc-chore-points" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10">
                            </div>
                        </div>
                        <div>
                            <label for="adhoc-chore-assignee" class="block text-sm font-medium text-gray-700">Assign To</label>
                            <select id="adhoc-chore-assignee" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="unassigned">Unassigned</option>
                                <!-- Member options will be injected here -->
                            </select>
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Chore
                        </button>
                    </form>

                    <!-- Unassigned Chores List -->
                    <div id="unassigned-chores-list" class="space-y-3 mt-4 min-h-[50px]">
                        <!-- Unassigned chores will be injected here -->
                    </div>
                </div>

            </div>

            <!-- Weekly Schedule Tab -->
            <div id="content-weekly-schedule" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Weekly Schedule</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4" id="weekly-schedule-grid">
                        <!-- Weekly schedule cards will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Points & Rewards Tab -->
            <div id="content-points" class="tab-content hidden space-y-8">
                <!-- Member Point Totals -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Point Totals</h2>
                    <div id="point-totals-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Member point cards will be injected here -->
                    </div>
                </div>

                <!-- Redeem Rewards -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Redeem Rewards</h2>
                    <form id="redeem-reward-form" class="space-y-4 max-w-lg mx-auto">
                        <div>
                            <label for="redeem-member" class="block text-sm font-medium text-gray-700">Redeem For</label>
                            <select id="redeem-member" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <!-- Member options injected here -->
                            </select>
                        </div>
                        <div>
                            <label for="redeem-reward" class="block text-sm font-medium text-gray-700">Available Rewards</label>
                            <select id="redeem-reward" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <!-- Reward options injected here -->
                            </select>
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Redeem Reward
                        </button>
                    </form>
                    <div id="redeem-feedback" class="mt-4 text-center font-medium"></div>
                </div>
            </div>

            <!-- Setup Tab -->
            <div id="content-setup" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Family Members Management -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Add Family Member</h2>
                            <form id="add-member-form" class="space-y-4">
                                <div>
                                    <label for="member-name" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" id="member-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                                </div>
                                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Add Member
                                </button>
                            </form>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Members</h2>
                            <div id="edit-members-list" class="space-y-4">
                                <!-- Edit member cards injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Chores & Rewards Management -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Reusable Chore</h2>
                            <form id="add-chore-form" class="space-y-4">
                                <!-- Chore Name & AI Emoji -->
                                <div>
                                    <label for="chore-name" class="block text-sm font-medium text-gray-700">Chore Name</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="chore-name" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Feed Dog" required>
                                        <button type="button" id="chore-ai-emoji-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">AI</button>
                                    </div>
                                </div>
                                <!-- Emoji & Points -->
                                <div class="flex space-x-4">
                                    <div class="flex-1">
                                        <label for="chore-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                        <input type="text" id="chore-emoji" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="‚ùì" required>
                                    </div>
                                    <div class="flex-1">
                                        <label for="chore-points" class="block text-sm font-medium text-gray-700">Points</label>
                                        <input type="number" id="chore-points" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10" required>
                                    </div>
                                </div>
                                <!-- Schedule -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Repeat on</label>
                                    <div class="mt-2 grid grid-cols-4 sm:grid-cols-7 gap-2">
                                        <!-- Day checkboxes -->
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="1"> <span>Mon</span></label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="2"> <span>Tue</span></label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="3"> <span>Wed</span></label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="4"> <span>Thu</span></label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="5"> <span>Fri</span></label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="6"> <span>Sat</span></label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="0"> <span>Sun</span></label>
                                    </div>
                                </div>
                                <!-- Default Assignee -->
                                <div>
                                    <label for="chore-assignee" class="block text-sm font-medium text-gray-700">Set Default Assignment</label>
                                    <select id="chore-assignee" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="unassigned">Unassigned</option>
                                        <!-- Member options will be injected here -->
                                    </select>
                                </div>
                                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Create Chore
                                </button>
                            </form>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Reward</h2>
                            <form id="add-reward-form" class="space-y-4">
                                <!-- Reward Name & AI Emoji -->
                                <div>
                                    <label for="reward-name" class="block text-sm font-medium text-gray-700">Reward Name</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="reward-name" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Movie Night" required>
                                        <button type="button" id="reward-ai-emoji-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">AI</button>
                                    </div>
                                </div>
                                <!-- Emoji & Cost -->
                                <div class="flex space-x-4">
                                    <div class="flex-1">
                                        <label for="reward-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                        <input type="text" id="reward-emoji" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="üéâ" required>
                                    </div>
                                    <div class="flex-1">
                                        <label for="reward-cost" class="block text-sm font-medium text-gray-700">Point Cost</label>
                                        <input type="number" id="reward-cost" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="100" required>
                                    </div>
                                </div>
                                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Create Reward
                                </button>
                            </form>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Data</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div id="manage-chores-list" class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-700">Reusable Chores</h3>
                                    <!-- Chores with delete buttons injected here -->
                                </div>
                                <div id="manage-rewards-list" class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-700">Available Rewards</h3>
                                    <!-- Rewards with delete buttons injected here -->
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="content-calendar" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <button id="calendar-prev-month" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 id="calendar-month-year" class="text-2xl font-bold text-gray-800"></h2>
                        <button id="calendar-next-month" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar header -->
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Mon</div>
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Tue</div>
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Wed</div>
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Thu</div>
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Fri</div>
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Sat</div>
                        <div class="text-center font-semibold text-gray-600 text-sm py-2">Sun</div>
                        <!-- Calendar days will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Global Feedback Snackbar -->
    <div id="snackbar" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium z-50">
        Feedback message
    </div>

    <!-- FATAL ERROR MODAL -->
    <div id="fatal-error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full">
            <h2 class="text-3xl font-bold text-red-600 mb-4">FATAL ERROR</h2>
            <p class="text-lg text-gray-700 mb-2">Could not connect to Firebase.</p>
            <p class="text-sm text-gray-600 mb-6">This usually means your network is down, or the API keys in the code are incorrect, or you haven't enabled Authentication/Firestore in your Firebase Console.</p>
            <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm font-semibold text-gray-800">Error details:</p>
                <pre id="fatal-error-details" class="text-xs text-red-700 whitespace-pre-wrap font-mono mt-2"></pre>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs, 
            runTransaction,
            arrayUnion,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START: PRE-CONFIGURED FIREBASE KEYS ---
        // Your Firebase configuration has been inserted here.
        const firebaseConfig = {
          apiKey: "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M",
          authDomain: "family-hub-organizer.firebaseapp.com",
          projectId: "family-hub-organizer",
          storageBucket: "family-hub-organizer.firebasestorage.app",
          messagingSenderId: "468888595189",
          appId: "1:468888595189:web:eb6f33ee8e62cdc489b3bc"
        };
        const FIREBASE_APP_ID = "family-hub-organizer";
        // This is the Google Cloud API Key for the Gemini API (AI Emoji Picker)
        // IMPORTANT: This key MUST be enabled for the "Gemini API" in your Google Cloud Console.
        const GEMINI_API_KEY = "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M"; // Using your Firebase API key
        // --- END: PRE-CONFIGURED FIREBASE KEYS ---


        // --- Global State ---
        let db;
        let auth;
        let userId;
        let currentTab = 'daily-list';
        let membersUnsubscribe = () => {};
        let choresUnsubscribe = () => {};
        let rewardsUnsubscribe = () => {};
        let completionsUnsubscribe = () => {};
        let memberColors = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#d946ef'
        ];
        let appData = {
            members: [],
            chores: [],
            rewards: [],
            completions: []
        };
        let calendarDate = new Date();

        // --- DOM Elements ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const snackbar = document.getElementById('snackbar');

        // --- Utility Functions ---
        
        function showLoading(label = 'Syncing...') {
            loadingIndicator.querySelector('span').textContent = label;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('flex');
        }

        function showSnackbar(message, isError = false) {
            snackbar.textContent = message;
            snackbar.classList.remove('hidden', 'bg-red-600', 'bg-gray-900');
            snackbar.classList.add(isError ? 'bg-red-600' : 'bg-gray-900');
            setTimeout(() => {
                snackbar.classList.add('hidden');
            }, 3000);
        }

        function showFatalError(message, error) {
            console.error(message, error);
            document.getElementById('fatal-error-details').textContent = error.toString();
            document.getElementById('fatal-error-modal').classList.remove('hidden');
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        // --- AI Emoji Function ---
        async function getEmojiFromAI(prompt, buttonElement) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("YOUR-API-KEY")) {
                console.warn("AI Emoji: GEMINI_API_KEY is not set.");
                showSnackbar("AI Emoji feature is not configured.", true);
                return '‚ùì';
            }

            const originalText = buttonElement.textContent;
            buttonElement.textContent = '...';
            buttonElement.disabled = true;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const systemPrompt = "You are an emoji expert. Given a household chore or reward, return ONLY a single, appropriate emoji. Do not use any other text, just the emoji.";
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                const emoji = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '‚ùì';
                return emoji.length > 3 ? '‚ùì' : emoji; // Basic validation

            } catch (error) {
                console.error("AI Emoji request failed:", error);
                showSnackbar(`AI Emoji request failed: ${error.message}`, true);
                return '‚ùì';
            } finally {
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            }
        }


        // --- Firestore Initialization ---
        async function initializeFirebase() {
            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Success. UserID:", userId);
                        setupFirestoreListeners();
                        seedData(); // Seed data if database is empty
                    } else {
                        console.log("No user signed in, signing in anonymously...");
                        signInAnonymously(auth).catch((error) => {
                            showFatalError("Anonymous sign-in failed.", error);
                        });
                    }
                });

            } catch (error) {
                showFatalError("Could not connect to Firebase. Check your network or your API key configuration in the code.", error);
            }
        }

        // --- Firestore Data Paths ---
        const paths = {
            members: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/members`),
            member: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/members`, id),
            chores: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/chores`),
            chore: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/chores`, id),
            rewards: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/rewards`),
            reward: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/rewards`, id),
            completions: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/completions`),
            completion: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/completions`, id),
        };

        // --- Firestore Listeners ---
        function setupFirestoreListeners() {
            showLoading('Loading data...');

            try {
                // Members
                membersUnsubscribe = onSnapshot(paths.members(), (snapshot) => {
                    appData.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Members updated:", appData.members);
                    renderAll();
                    hideLoading();
                }, (error) => console.error("Error listening to members:", error));

                // Chores
                choresUnsubscribe = onSnapshot(paths.chores(), (snapshot) => {
                    appData.chores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Chores updated:", appData.chores);
                    renderAll();
                }, (error) => console.error("Error listening to chores:", error));

                // Rewards
                rewardsUnsubscribe = onSnapshot(paths.rewards(), (snapshot) => {
                    appData.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Rewards updated:", appData.rewards);
                    renderAll();
                }, (error) => console.error("Error listening to rewards:", error));

                // Completions (for today)
                const today = getTodayString();
                const q = query(paths.completions(), where("date", "==", today));
                completionsUnsubscribe = onSnapshot(q, (snapshot) => {
                    appData.completions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Completions updated:", appData.completions);
                    renderAll();
                }, (error) => console.error("Error listening to completions:", error));
            
            } catch (error) {
                showFatalError("Failed to set up Firestore listeners.", error);
                hideLoading();
            }
        }

        // --- Seeding Initial Data ---
        async function seedData() {
            const membersSnapshot = await getDocs(paths.members());
            if (membersSnapshot.empty) {
                console.log("Database is empty. Seeding initial data...");
                showLoading('Seeding initial data...');
                
                const seedMembers = [
                    { name: "Mom", points: 100, color: memberColors[0], emoji: "üëë" },
                    { name: "Dad", points: 100, color: memberColors[1], emoji: "üí™" },
                    { name: "Lyra", points: 50, color: memberColors[2], emoji: "ü¶Ñ" },
                    { name: "Cora", points: 50, color: memberColors[3], emoji: "ü¶ä" }
                ];

                const memberIds = {};
                for (const member of seedMembers) {
                    const docRef = await addDoc(paths.members(), member);
                    memberIds[member.name] = docRef.id;
                }

                const seedChores = [
                    { name: "Empty Dishwasher", emoji: "üßº", points: 20, schedule: ["1", "3", "5"], defaultAssignee: memberIds["Lyra"] || "unassigned" },
                    { name: "Load Dishwasher", emoji: "üçΩÔ∏è", points: 20, schedule: ["2", "4", "6"], defaultAssignee: memberIds["Cora"] || "unassigned" },
                    { name: "Feed Dog", emoji: "üê∂", points: 10, schedule: ["0", "1", "2", "3", "4", "5", "6"], defaultAssignee: memberIds["Lyra"] || "unassigned" },
                    { name: "Feed Cat", emoji: "üê±", points: 10, schedule: ["0", "1", "2", "3", "4", "5", "6"], defaultAssignee: memberIds["Cora"] || "unassigned" },
                    { name: "Laundry", emoji: "üß∫", points: 50, schedule: ["0", "4"], defaultAssignee: memberIds["Mom"] || "unassigned" }
                ];
                for (const chore of seedChores) {
                    await addDoc(paths.chores(), chore);
                }

                const seedRewards = [
                    { name: "Movie Night", emoji: "üé¨", cost: 200, claimed: false },
                    { name: "Pizza Dinner", emoji: "üçï", cost: 300, claimed: false }
                ];
                for (const reward of seedRewards) {
                    await addDoc(paths.rewards(), reward);
                }
                
                console.log("Seeding complete.");
                hideLoading();
            } else {
                console.log("Database already contains data. Skipping seed.");
            }
        }


        // --- Render Functions ---
        
        function renderAll() {
            if (!db) return; // Don't render if Firebase isn't ready
            
            try {
                renderMemberOptions();
                renderDailyList();
                renderWeeklySchedule();
                renderPointsAndRewards();
                renderSetup();
                renderCalendar();
            } catch (error) {
                console.error("RenderAll failed:", error);
                showSnackbar("Error updating the view. Check console.", true);
            }
        }

        // Render <select> options
        function renderMemberOptions() {
            const selects = document.querySelectorAll('select[id$="-assignee"], select[id$="-member"]');
            const sortedMembers = [...appData.members].sort((a, b) => a.name.localeCompare(b.name));
            
            selects.forEach(select => {
                const currentValue = select.value;
                let options = '';
                if (select.id.includes('adhoc') || select.id.includes('chore')) {
                    options = '<option value="unassigned">Unassigned</option>';
                }
                sortedMembers.forEach(member => {
                    options += `<option value="${member.id}" ${member.id === currentValue ? 'selected' : ''}>
                        ${member.emoji || ''} ${member.name}
                    </option>`;
                });
                select.innerHTML = options;
            });
        }

        // --- Daily List Tab ---
        function renderDailyList() {
            const grid = document.getElementById('daily-assignments-grid');
            const unassignedList = document.getElementById('unassigned-chores-list');
            grid.innerHTML = '';
            unassignedList.innerHTML = '';

            const today = new Date().getDay().toString(); // 0 = Sun, 1 = Mon, ...
            const todayStr = getTodayString();
            
            // Get today's completions
            const todaysCompletions = appData.completions.filter(c => c.date === todayStr);

            // Get recurring chores for today
            const recurringChores = appData.chores.filter(chore => chore.schedule.includes(today));
            
            // Combine recurring chores and one-time chores from completions
            const allTasksForToday = [];

            // Add recurring
            recurringChores.forEach(chore => {
                const completion = todaysCompletions.find(c => c.choreDefId === chore.id);
                allTasksForToday.push({
                    id: completion ? completion.id : `temp_${chore.id}`,
                    choreDefId: chore.id,
                    name: chore.name,
                    emoji: chore.emoji,
                    points: chore.points,
                    assigneeId: completion ? completion.assigneeId : chore.defaultAssignee,
                    isComplete: completion ? completion.isComplete : false,
                    isAdhoc: false,
                    completionDocId: completion ? completion.id : null
                });
            });

            // Add ad-hoc
            todaysCompletions.forEach(completion => {
                if (completion.isAdhoc && !allTasksForToday.find(t => t.id === completion.id)) {
                    allTasksForToday.push({
                        id: completion.id,
                        choreDefId: null,
                        name: completion.name,
                        emoji: completion.emoji,
                        points: completion.points,
                        assigneeId: completion.assigneeId,
                        isComplete: completion.isComplete,
                        isAdhoc: true,
                        completionDocId: completion.id
                    });
                }
            });

            // Create member cards
            appData.members.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'bg-white rounded-xl shadow-lg p-4 drop-zone transition-all duration-150';
                memberCard.dataset.memberId = member.id;
                memberCard.style.borderColor = member.color || '#ccc';
                memberCard.style.borderWidth = '3px';
                memberCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" style="color: ${member.color || '#111'}">
                            ${member.emoji || ''} ${member.name}
                        </h3>
                        <span class="font-bold text-lg" style="color: ${member.color || '#111'}">
                            ${member.points || 0} pts
                        </span>
                    </div>
                    <div class="space-y-3 min-h-[50px]"></div>
                `;
                grid.appendChild(memberCard);
            });

            // Populate chores
            allTasksForToday.forEach(task => {
                const choreHTML = createChoreItemHTML(task);
                let targetList;
                
                if (task.assigneeId && task.assigneeId !== 'unassigned') {
                    const memberCard = grid.querySelector(`[data-member-id="${task.assigneeId}"]`);
                    targetList = memberCard ? memberCard.querySelector('.space-y-3') : null;
                }
                
                if (!targetList) {
                    targetList = unassignedList;
                }
                
                targetList.innerHTML += choreHTML;
            });

            // Add drag/drop listeners after rendering
            addTouchDragListeners();
        }

        function createChoreItemHTML(task) {
            const completedClass = task.isComplete ? 'chore-item-completed' : '';
            return `
                <div class="chore-item ${completedClass} cursor-grab" 
                     draggable="true" 
                     data-task-id="${task.id}" 
                     data-chore-def-id="${task.choreDefId || 'null'}"
                     data-completion-doc-id="${task.completionDocId || 'null'}"
                     data-is-adhoc="${task.isAdhoc}"
                     data-is-complete="${task.isComplete}"
                     data-name="${task.name}"
                     data-emoji="${task.emoji}"
                     data-points="${task.points}"
                     data-current-assignee="${task.assigneeId || 'unassigned'}">
                    
                    <button class="chore-complete-btn text-3xl p-2 -ml-2 rounded-full transition-transform transform hover:scale-125"
                            data-task-id="${task.id}"
                            data-is-complete="${task.isComplete}"
                            data-points="${task.points}"
                            data-assignee-id="${task.assigneeId}">
                        ${task.isComplete ? '‚úÖ' : task.emoji}
                    </button>
                    <div class="flex-1">
                        <span class="font-medium">${task.name}</span>
                        <span class="block text-sm text-gray-500">${task.points} points</span>
                    </div>
                </div>
            `;
        }

        // --- Weekly Schedule Tab ---
        async function renderWeeklySchedule() {
            const grid = document.getElementById('weekly-schedule-grid');
            grid.innerHTML = '';
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date().getDay();
            
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - today);
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            // Fetch adhoc completions for the whole week
            const q = query(paths.completions(), 
                where("isAdhoc", "==", true),
                where("date", ">=", startOfWeek.toISOString().split('T')[0]),
                where("date", "<=", endOfWeek.toISOString().split('T')[0])
            );
            const adhocSnapshot = await getDocs(q);
            const adhocCompletions = adhocSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            for (let i = 0; i < 7; i++) {
                const dayIndexStr = i.toString();
                const dayCard = document.createElement('div');
                const isToday = i === today;
                dayCard.className = `rounded-lg p-3 ${isToday ? 'bg-indigo-100 border-2 border-indigo-400' : 'bg-gray-50 border'}`;
                
                let choresHTML = '';
                
                // Recurring
                appData.chores
                    .filter(c => c.schedule.includes(dayIndexStr))
                    .forEach(c => choresHTML += getScheduleChoreHTML(c));
                
                // Ad-hoc
                const dayDateStr = new Date(startOfWeek);
                dayDateStr.setDate(startOfWeek.getDate() + i);
                
                adhocCompletions
                    .filter(c => c.date === dayDateStr.toISOString().split('T')[0])
                    .forEach(c => choresHTML += getScheduleChoreHTML(c, true));

                dayCard.innerHTML = `
                    <h4 class="font-bold text-center text-gray-700 mb-3 ${isToday ? 'text-indigo-700' : ''}">${days[i]}</h4>
                    <div class="space-y-2">
                        ${choresHTML || '<div class="text-xs text-center text-gray-400">No chores</div>'}
                    </div>
                `;
                grid.appendChild(dayCard);
            }
        }

        function getScheduleChoreHTML(chore, isAdhoc = false) {
            const assigneeId = isAdhoc ? chore.assigneeId : chore.defaultAssignee;
            const member = appData.members.find(m => m.id === assigneeId);
            const color = member ? member.color : '#9ca3af';
            const name = member ? member.name.split(' ')[0] : 'Un...';

            return `
                <div class="rounded-md p-2 text-xs" style="background-color: ${color}20; border-left: 4px solid ${color};">
                    <div class="font-medium text-gray-800">${chore.name} ${isAdhoc ? '(One-Time)' : ''}</div>
                    <div class="text-gray-600" style="color: ${color};">
                        ${chore.emoji} 
                        <span class="font-semibold">${name}</span>
                    </div>
                </div>
            `;
        }

        // --- Points & Rewards Tab ---
        function renderPointsAndRewards() {
            const grid = document.getElementById('point-totals-grid');
            const rewardSelect = document.getElementById('redeem-reward');
            grid.innerHTML = '';
            
            [...appData.members].sort((a,b) => b.points - a.points).forEach(member => {
                grid.innerHTML += `
                    <div class="rounded-xl p-4 shadow-lg text-center" style="background-color: ${member.color}20; border: 2px solid ${member.color};">
                        <div class="text-2xl mb-1">${member.emoji || 'üë§'}</div>
                        <div class="font-semibold text-lg" style="color: ${member.color};">${member.name}</div>
                        <div class="font-bold text-3xl text-gray-800">${member.points}</div>
                        <div class="text-sm text-gray-600">points</div>
                    </div>
                `;
            });

            const availableRewards = appData.rewards.filter(r => !r.claimed);
            rewardSelect.innerHTML = availableRewards.map(reward => `
                <option value="${reward.id}" data-cost="${reward.cost}">
                    ${reward.emoji} ${reward.name} (${reward.cost} pts)
                </option>
            `).join('');
        }

        // --- Setup Tab ---
        function renderSetup() {
            const editList = document.getElementById('edit-members-list');
            const manageChoresList = document.getElementById('manage-chores-list');
            const manageRewardsList = document.getElementById('manage-rewards-list');

            editList.innerHTML = appData.members.map(member => `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex items-center space-x-3 mb-4">
                        <input type="text" value="${member.emoji || 'üë§'}" class="member-edit-emoji w-12 text-center text-2xl p-1 border rounded" data-member-id="${member.id}">
                        <input type="text" value="${member.name}" class="member-edit-name flex-1 p-1 border rounded" data-member-id="${member.id}">
                        <select class="member-edit-color p-1 border rounded" data-member-id="${member.id}">
                            ${memberColors.map(color => `<option value="${color}" ${member.color === color ? 'selected' : ''} style="background: ${color}; color: ${color};">Color</option>`).join('')}
                            <option value="#888888" ${!memberColors.includes(member.color) ? 'selected' : ''}>Default</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button class="member-save-btn flex-1 text-sm py-1 px-2 rounded bg-green-500 text-white hover:bg-green-600" data-member-id="${member.id}">Save</button>
                        <button class="member-delete-btn flex-1 text-sm py-1 px-2 rounded bg-red-500 text-white hover:bg-red-600" data-member-id="${member.id}">Delete</button>
                    </div>
                </div>
            `).join('');

            manageChoresList.innerHTML = '<h3 class="text-lg font-medium text-gray-700 mb-2">Reusable Chores</h3>' + 
                appData.chores.map(chore => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <span>${chore.emoji} ${chore.name}</span>
                    <button class="chore-delete-btn text-red-500 hover:text-red-700 font-bold" data-id="${chore.id}">&times;</button>
                </div>
            `).join('');
            
            manageRewardsList.innerHTML = '<h3 class="text-lg font-medium text-gray-700 mb-2">Available Rewards</h3>' + 
                appData.rewards.filter(r => !r.claimed).map(reward => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <span>${reward.emoji} ${reward.name}</span>
                    <button class="reward-delete-btn text-red-500 hover:text-red-700 font-bold" data-id="${reward.id}">&times;</button>
                </div>
            `).join('');
        }

        // --- Calendar Tab ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('calendar-month-year');
            
            // Clear grid except for headers
            while (grid.children.length > 7) {
                grid.removeChild(grid.lastChild);
            }

            const now = calendarDate;
            const month = now.getMonth();
            const year = now.getFullYear();
            
            monthYearEl.textContent = now.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Adjust for Mon-first week
            const startOffset = (firstDay === 0) ? 6 : firstDay - 1; 

            // Add blank cells for start
            for (let i = 0; i < startOffset; i++) {
                grid.innerHTML += `<div class="border border-gray-100 bg-gray-50"></div>`;
            }

            // Add day cells
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === todayDate && month === todayMonth && year === todayYear;
                const dayEl = document.createElement('div');
                dayEl.className = `border border-gray-200 h-20 md:h-28 p-1.5 overflow-hidden ${isToday ? 'bg-blue-100' : 'bg-white'}`;
                dayEl.innerHTML = `<div class="font-semibold text-sm ${isToday ? 'text-blue-700' : 'text-gray-700'}">${day}</div>`;
                // Add events later
                grid.appendChild(dayEl);
            }
        }


        // --- Event Handlers ---

        // Tab Navigation
        function changeTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('tab-active'));
            
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('tab-active');
            
            // Re-render specific content if needed
            if(tabId === 'daily-list') renderDailyList();
            if(tabId === 'weekly-schedule') renderWeeklySchedule();
        }

        // Toggle Adhoc Form
        document.getElementById('toggle-adhoc-form').addEventListener('click', (e) => {
            const form = document.getElementById('adhoc-chore-form');
            const icon = e.currentTarget.querySelector('span');
            form.classList.toggle('hidden');
            if (form.classList.contains('hidden')) {
                icon.textContent = 'Ôºã';
                e.currentTarget.classList.remove('rotate-45');
            } else {
                icon.textContent = 'Ôºã';
                e.currentTarget.classList.add('rotate-45');
            }
        });

        // Add Member
        document.getElementById('add-member-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('member-name').value.trim();
            if (!name) return;

            showLoading('Adding member...');
            const newColor = memberColors[appData.members.length % memberColors.length] || '#888888';
            try {
                await addDoc(paths.members(), {
                    name: name,
                    points: 0,
                    color: newColor,
                    emoji: "üë§"
                });
                showSnackbar("Member added!");
                document.getElementById('member-name').value = '';
            } catch (error) {
                console.error("Error adding member:", error);
                showSnackbar("Failed to add member.", true);
            }
            hideLoading();
        });

        // Edit/Delete Member
        document.getElementById('edit-members-list').addEventListener('click', async (e) => {
            const memberId = e.target.dataset.memberId;
            if (!memberId) return;

            if (e.target.classList.contains('member-save-btn')) {
                showLoading('Saving...');
                try {
                    const name = document.querySelector(`.member-edit-name[data-member-id="${memberId}"]`).value;
                    const emoji = document.querySelector(`.member-edit-emoji[data-member-id="${memberId}"]`).value;
                    const color = document.querySelector(`.member-edit-color[data-member-id="${memberId}"]`).value;
                    await updateDoc(paths.member(memberId), { name, emoji, color });
                    showSnackbar("Member updated!");
                } catch (error) {
                    console.error("Error saving member:", error);
                    showSnackbar("Failed to save member.", true);
                }
                hideLoading();
            }

            if (e.target.classList.contains('member-delete-btn')) {
                if (!confirm("Are you sure you want to delete this member? This cannot be undone.")) return;
                showLoading('Deleting...');
                try {
                    await deleteDoc(paths.member(memberId));
                    showSnackbar("Member deleted.");
                } catch (error) {
                    console.error("Error deleting member:", error);
                    showSnackbar("Failed to delete member.", true);
                }
                hideLoading();
            }
        });

        // Add Reusable Chore
        document.getElementById('add-chore-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('chore-name').value.trim();
            const emoji = document.getElementById('chore-emoji').value.trim();
            const points = parseInt(document.getElementById('chore-points').value);
            const defaultAssignee = document.getElementById('chore-assignee').value;
            const schedule = Array.from(document.querySelectorAll('.chore-day:checked')).map(cb => cb.value);

            if (!name || !emoji || isNaN(points)) {
                showSnackbar("Please fill out all chore fields.", true);
                return;
            }

            showLoading('Adding chore...');
            try {
                await addDoc(paths.chores(), {
                    name, emoji, points, schedule, defaultAssignee
                });
                showSnackbar("Reusable chore created!");
                e.target.reset();
            } catch (error) {
                console.error("Error adding chore:", error);
                showSnackbar("Failed to create chore.", true);
            }
            hideLoading();
        });

        // Add One-Time (Adhoc) Chore
        document.getElementById('adhoc-chore-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('adhoc-chore-name').value.trim();
            const emoji = document.getElementById('adhoc-chore-emoji').value.trim();
            const points = parseInt(document.getElementById('adhoc-chore-points').value);
            const assigneeId = document.getElementById('adhoc-chore-assignee').value;

            if (!name || !emoji || isNaN(points)) {
                showSnackbar("Please fill out all chore fields.", true);
                return;
            }

            showLoading('Adding one-time chore...');
            try {
                await addDoc(paths.completions(), {
                    name,
                    emoji,
                    points,
                    assigneeId: assigneeId || 'unassigned',
                    date: getTodayString(),
                    isComplete: false,
                    isAdhoc: true,
                    choreDefId: null
                });
                showSnackbar("One-time chore added!");
                e.target.reset();
                document.getElementById('adhoc-chore-form').classList.add('hidden');
                document.getElementById('toggle-adhoc-form').classList.remove('rotate-45');
                document.getElementById('toggle-adhoc-form').querySelector('span').textContent = 'Ôºã';
            } catch (error) {
                console.error("Error adding adhoc chore:", error);
                showSnackbar("Failed to add chore.", true);
            }
            hideLoading();
        });

        // Delete Chore/Reward
        document.getElementById('content-setup').addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;

            let path;
            let type;
            if (e.target.classList.contains('chore-delete-btn')) {
                path = paths.chore(id);
                type = "Chore";
            } else if (e.target.classList.contains('reward-delete-btn')) {
                path = paths.reward(id);
                type = "Reward";
            } else {
                return;
            }

            if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
            showLoading(`Deleting ${type}...`);
            try {
                await deleteDoc(path);
                showSnackbar(`${type} deleted.`);
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                showSnackbar(`Failed to delete ${type}.`, true);
            }
            hideLoading();
        });

        // Add Reward
        document.getElementById('add-reward-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reward-name').value.trim();
            const emoji = document.getElementById('reward-emoji').value.trim();
            const cost = parseInt(document.getElementById('reward-cost').value);

            if (!name || !emoji || isNaN(cost) || cost <= 0) {
                showSnackbar("Please fill out all reward fields correctly.", true);
                return;
            }
            
            showLoading('Adding reward...');
            try {
                await addDoc(paths.rewards(), {
                    name, emoji, cost, claimed: false
                });
                showSnackbar("Reward created!");
                e.target.reset();
            } catch (error) {
                console.error("Error adding reward:", error);
                showSnackbar("Failed to create reward.", true);
            }
            hideLoading();
        });

        // Redeem Reward
        document.getElementById('redeem-reward-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberId = document.getElementById('redeem-member').value;
            const rewardId = document.getElementById('redeem-reward').value;
            const feedbackEl = document.getElementById('redeem-feedback');

            if (!memberId || !rewardId) {
                feedbackEl.textContent = "Please select a member and a reward.";
                feedbackEl.className = "mt-4 text-center font-medium text-red-600";
                return;
            }

            const member = appData.members.find(m => m.id === memberId);
            const reward = appData.rewards.find(r => r.id === rewardId);
            const cost = reward.cost;

            if (member.points < cost) {
                feedbackEl.textContent = "Not enough points!";
                feedbackEl.className = "mt-4 text-center font-medium text-red-600";
                return;
            }

            showLoading('Redeeming...');
            try {
                await runTransaction(db, async (transaction) => {
                    const memberRef = paths.member(memberId);
                    const rewardRef = paths.reward(rewardId);
                    
                    const memberDoc = await transaction.get(memberRef);
                    const rewardDoc = await transaction.get(rewardRef);
                    
                    if (!memberDoc.exists() || !rewardDoc.exists()) {
                        throw new Error("Member or Reward not found.");
                    }
                    
                    if (rewardDoc.data().claimed) {
                        throw new Error("This reward has already been claimed.");
                    }
                    
                    const newPoints = memberDoc.data().points - cost;
                    if (newPoints < 0) {
                        throw new Error("Not enough points (transaction check).");
                    }
                    
                    transaction.update(memberRef, { points: newPoints });
                    transaction.update(rewardRef, { 
                        claimed: true, 
                        claimedBy: memberId, 
                        claimedByName: member.name,
                        claimedAt: Timestamp.now()
                    });
                });

                feedbackEl.textContent = `${member.name} successfully redeemed ${reward.name}!`;
                feedbackEl.className = "mt-4 text-center font-medium text-green-600";
                showSnackbar("Reward redeemed!");

            } catch (error) {
                console.error("Reward transaction failed:", error);
                feedbackEl.textContent = `Redemption failed: ${error.message}`;
                feedbackEl.className = "mt-4 text-center font-medium text-red-600";
                showSnackbar("Redemption failed.", true);
            }
            hideLoading();
        });

        // AI Emoji Button Handlers
        document.getElementById('chore-ai-emoji-btn').addEventListener('click', async (e) => {
            const name = document.getElementById('chore-name').value.trim();
            if (!name) {
                showSnackbar("Enter a chore name first.", true);
                return;
            }
            const emoji = await getEmojiFromAI(`Chore: ${name}`, e.currentTarget);
            document.getElementById('chore-emoji').value = emoji;
        });

        document.getElementById('reward-ai-emoji-btn').addEventListener('click', async (e) => {
            const name = document.getElementById('reward-name').value.trim();
            if (!name) {
                showSnackbar("Enter a reward name first.", true);
                return;
            }
            const emoji = await getEmojiFromAI(`Reward: ${name}`, e.currentTarget);
            document.getElementById('reward-emoji').value = emoji;
        });
        
        document.getElementById('adhoc-ai-emoji-btn').addEventListener('click', async (e) => {
            const name = document.getElementById('adhoc-chore-name').value.trim();
            if (!name) {
                showSnackbar("Enter a chore name first.", true);
                return;
            }
            const emoji = await getEmojiFromAI(`Chore: ${name}`, e.currentTarget);
            document.getElementById('adhoc-chore-emoji').value = emoji;
        });


        // Complete Chore
        document.getElementById('daily-assignments-grid').addEventListener('click', (e) => {
            const button = e.target.closest('.chore-complete-btn');
            if (button) {
                handleChoreCompletion(button);
            }
        });
        document.getElementById('unassigned-chores-list').addEventListener('click', (e) => {
             const button = e.target.closest('.chore-complete-btn');
            if (button) {
                handleChoreCompletion(button);
            }
        });

        async function handleChoreCompletion(button) {
            const isComplete = button.dataset.isComplete === 'true';
            const points = parseInt(button.dataset.points);
            const assigneeId = button.dataset.assigneeId;
            
            const choreItem = button.closest('.chore-item');
            const taskId = choreItem.dataset.taskId;
            const completionDocId = choreItem.dataset.completionDocId;
            const isAdhoc = choreItem.dataset.isAdhoc === 'true';

            if (isComplete) {
                // Already done, do nothing
                showSnackbar("Chore already completed.", true);
                return;
            }
            if (!assigneeId || assigneeId === 'unassigned') {
                showSnackbar("Assign chore to a member to complete it.", true);
                return;
            }

            showLoading('Completing chore...');
            try {
                await runTransaction(db, async (transaction) => {
                    let completionRef;
                    
                    // 1. Find or Create Completion Doc
                    if (completionDocId && completionDocId !== 'null') {
                        completionRef = paths.completion(completionDocId);
                    } else {
                        // This is a recurring chore being completed for the first time today
                        completionRef = doc(collection(db, paths.completions().path)); // Create new doc ref
                    }
                    
                    // 2. Add/Update Completion Doc
                    const choreData = {
                        name: choreItem.dataset.name,
                        emoji: choreItem.dataset.emoji,
                        points: parseInt(choreItem.dataset.points),
                        assigneeId: assigneeId,
                        date: getTodayString(),
                        isComplete: true,
                        isAdhoc: isAdhoc,
                        choreDefId: choreItem.dataset.choreDefId === 'null' ? null : choreItem.dataset.choreDefId
                    };
                    transaction.set(completionRef, choreData, { merge: true }); // Use set with merge to create or update

                    // 3. Update Member Points
                    const memberRef = paths.member(assigneeId);
                    const memberDoc = await transaction.get(memberRef);
                    if (!memberDoc.exists()) {
                        throw new Error("Member not found.");
                    }
                    const newPoints = (memberDoc.data().points || 0) + points;
                    transaction.update(memberRef, { points: newPoints });
                });
                
                showSnackbar("Chore completed! Points awarded!");

            } catch (error) {
                console.error("Chore completion transaction failed:", error);
                showSnackbar(`Completion failed: ${error.message}`, true);
            }
            hideLoading();
        }

        // --- Touch Drag and Drop Logic ---
        let dragElement = null;
        let ghostElement = null;

        function addTouchDragListeners() {
            const items = document.querySelectorAll('.chore-item');
            items.forEach(item => {
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                // Prevent native drag on touch devices
                item.addEventListener('dragstart', (e) => e.preventDefault());
            });

            document.body.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.body.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchStart(e) {
            // e.preventDefault(); // This is handled by passive: false
            dragElement = e.target.closest('.chore-item');
            if (!dragElement) return;

            // Create ghost
            ghostElement = dragElement.cloneNode(true);
            ghostElement.classList.add('drag-ghost');
            document.body.appendChild(ghostElement);
            
            // Position ghost
            const touch = e.touches[0];
            ghostElement.style.width = `${dragElement.offsetWidth}px`;
            ghostElement.style.left = `${touch.pageX - dragElement.offsetWidth / 2}px`;
            ghostElement.style.top = `${touch.pageY - dragElement.offsetHeight / 2}px`;

            dragElement.style.opacity = '0.4';
        }

        function handleTouchMove(e) {
            if (!ghostElement) return;
            e.preventDefault(); // Prevent scrolling while dragging

            const touch = e.touches[0];
            ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
            ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;

            // Highlight drop target
            ghostElement.style.display = 'none'; // Hide ghost to check element underneath
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            ghostElement.style.display = 'block';

            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drop-target-active'));
            
            const validDropZone = dropTarget ? dropTarget.closest('.drop-zone') : null;
            if (validDropZone) {
                validDropZone.classList.add('drop-target-active');
            }
        }

        function handleTouchEnd(e) {
            if (!ghostElement) return;

            // Find drop target
            ghostElement.style.display = 'none';
            const dropTargetEl = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            ghostElement.style.display = 'block';

            const validDropZone = dropTargetEl ? dropTargetEl.closest('.drop-zone') : null;

            if (validDropZone) {
                let newAssigneeId = validDropZone.dataset.memberId;
                if (!newAssigneeId) {
                    newAssigneeId = 'unassigned'; // It's the unassigned pool
                }
                
                // Update Firestore
                handleChoreAssignment(dragElement, newAssigneeId);
            }

            // Cleanup
            document.body.removeChild(ghostElement);
            ghostElement = null;
            dragElement.style.opacity = '1';
            dragElement = null;
            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drop-target-active'));
        }
        
        async function handleChoreAssignment(choreItem, newAssigneeId) {
            const completionDocId = choreItem.dataset.completionDocId;
            const choreDefId = choreItem.dataset.choreDefId;
            const currentAssigneeId = choreItem.dataset.currentAssignee;
            const isAdhoc = choreItem.dataset.isAdhoc === 'true';

            if (newAssigneeId === currentAssigneeId) return; // No change

            showLoading('Reassigning...');
            try {
                // This is a chore that already exists in the 'completions' collection for today
                if (completionDocId && completionDocId !== 'null') {
                    await updateDoc(paths.completion(completionDocId), {
                        assigneeId: newAssigneeId
                    });
                
                // This is a recurring chore that hasn't been touched today
                } else if (!isAdhoc && choreDefId !== 'null') {
                    // We must create a new completion doc for it
                    await addDoc(paths.completions(), {
                        name: choreItem.dataset.name,
                        emoji: choreItem.dataset.emoji,
                        points: parseInt(choreItem.dataset.points),
                        assigneeId: newAssigneeId,
                        date: getTodayString(),
                        isComplete: false,
                        isAdhoc: false,
                        choreDefId: choreDefId
                    });
                } else {
                    throw new Error("Cannot reassign this item.");
                }
                showSnackbar("Chore reassigned!");

            } catch (error) {
                console.error("Failed to reassign chore:", error);
                showSnackbar("Failed to reassign chore.", true);
            }
            hideLoading();
        }

        // Calendar Navigation
        document.getElementById('calendar-prev-month').addEventListener('click', () => {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('calendar-next-month').addEventListener('click', () => {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            renderCalendar();
        });

        // --- Global Error Handlers ---
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled Promise Rejection:', event.reason);
            showSnackbar(`An unexpected error occurred: ${event.reason.message}`, true);
        });

        window.addEventListener('error', (event) => {
            console.error('Unhandled Error:', event.error);
            showSnackbar(`A critical error occurred: ${event.error.message}`, true);
        });

        // --- App Initialization ---
        // Make functions globally accessible for inline HTML onclick attributes
        window.changeTab = changeTab;
        
        // Start the app
        initializeFirebase();

    </script>
</body>
</html>

