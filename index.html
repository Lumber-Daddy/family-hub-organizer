<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
<script type="module">
// Load Firebase modules required for the application
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    signInAnonymously, 
    onAuthStateChanged,
    signInWithCustomToken
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    setDoc, 
    onSnapshot, 
    collection, 
    query, 
    where, 
    writeBatch, 
    serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Added getDocs

// --- START: USER-EDITABLE FIREBASE CONFIGURATION ---
// IMPORTANT: You MUST replace the dummy values below with your actual config from the Firebase Console (Step 1).

// Your Firebase Web App Config Values (from Firebase console -> Project Settings -> Web App)
const YOUR_API_KEY = "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M"; 
const YOUR_AUTH_DOMAIN = "family-hub-organizer.firebaseapp.com"; 
const YOUR_PROJECT_ID = "family-hub-organizer";
const YOUR_STORAGE_BUCKET = "family-hub-organizer.firebasestorage.app"; 
const YOUR_MESSAGING_SENDER_ID = "468888595189";
const YOUR_APP_ID = "1:468888595189:web:eb6f33ee8e62cdc489b3bc";

// This is a custom App ID used for organizing data in Firestore (use your projectId)
const FIREBASE_APP_ID = YOUR_PROJECT_ID || 'default-app-id'; 

// --- END: USER-EDITABLE FIREBASE CONFIGURATION ---

const firebaseConfig = {
    apiKey: YOUR_API_KEY,
    authDomain: YOUR_AUTH_DOMAIN,
    projectId: YOUR_PROJECT_ID,
    storageBucket: YOUR_STORAGE_BUCKET,
    messagingSenderId: YOUR_MESSAGING_SENDER_ID,
    appId: YOUR_APP_ID
};

const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
const GEMINI_API_KEY = YOUR_API_KEY; // Reusing the same API Key

// Global Variables
let app, db, auth;
let currentTab = 'daily';
let userId = null;
let familyMembers = []; // Stores member objects
let choreDefinitions = []; // Stores recurring chore definitions
let rewardsList = []; // Stores reward definitions
let dailyChores = []; // Stores the actual list of chores for today's rendering
let isAuthReady = false;
let adHocFormVisible = false;

// --- Helper Functions ---

/** Converts the current date to a YYYY-MM-DD string key */
const getCurrentDateKey = () => {
    return new Date().toISOString().split('T')[0];
};

/** Converts YYYY-MM-DD to a more readable format */
const formatDisplayDate = (dateKey) => {
    const date = new Date(dateKey + 'T00:00:00'); // Use 'T00:00:00' to avoid timezone issues
    return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

/** Converts a day index (0=Sun, 1=Mon, etc.) to a short weekday string */
const dayIndexToName = (index) => {
    return ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][index];
};

/** Converts a short weekday string to a day index (0=Sun, 1=Mon, etc.) */
const dayNameToIndex = (name) => {
    return ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].indexOf(name);
};

// --- Firebase Paths ---
const getFamilyMembersPath = () => `artifacts/${FIREBASE_APP_ID}/public/data/members`;
const getChoreDefinitionsPath = () => `artifacts/${FIREBASE_APP_ID}/public/data/choreDefs`;
const getRewardsPath = () => `artifacts/${FIREBASE_APP_ID}/public/data/rewards`;
const getChoreCompletionsPath = () => `artifacts/${FIREBASE_APP_ID}/public/data/completions`;

// --- Core API Calls (Handles exponential backoff) ---

/** Fetches data from Gemini API with exponential backoff for reliability. */
const fetchWithBackoff = async (url, options, maxRetries = 5) => {
    let lastError = null;
    for (let i = 0; i < maxRetries; i++) {
        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000; // 1s, 2s, 4s, 8s, 16s + jitter
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
            }
            return await response.json();
        } catch (error) {
            lastError = error;
            console.error(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`, error);
            if (i < maxRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    throw new Error(`Gemini API call failed after ${maxRetries} attempts: ${lastError.message}`);
};

/** Calls Gemini to pick an emoji based on text input */
const getEmojiFromAI = async (text) => {
    if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("YOUR-API-KEY-HERE")) {
        console.error("Gemini API Key is missing or default. Cannot call AI.");
        return 'â“';
    }

    const systemPrompt = "Analyze the user's text which is a chore or reward name. Respond with ONLY the single, most relevant emoji character. Do not use any text, explanations, or quotes. Example: 'take out trash' -> 'ðŸ—‘ï¸'";
    const userQuery = text;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    const apiUrl = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;

    try {
        const result = await fetchWithBackoff(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const emojiText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'â“';
        // Clean the output to ensure it's just a single emoji
        return emojiText.replace(/['"]/g, '').trim().substring(0, 4); 

    } catch (error) {
        console.error("AI Emoji failed:", error);
        return 'â“';
    }
};


// --- Voice Command Handlers (Web Speech API) ---

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = SpeechRecognition ? new SpeechRecognition() : null;
if (recognition) {
    recognition.continuous = false;
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
}

const speak = (text) => {
    if (!('speechSynthesis' in window)) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = speechSynthesis.getVoices().find(v => v.name.includes('Google') || v.default);
    utterance.rate = 1.1;
    speechSynthesis.speak(utterance);
};

const processVoiceCommand = (transcript) => {
    const lowerTranscript = transcript.toLowerCase();
    
    speak(`Processing: ${transcript}.`);
    
    // 1. Navigation Commands
    if (lowerTranscript.includes('daily list') || lowerTranscript.includes('show today')) {
        speak('Navigating to the Daily List.');
        changeTab('daily');
        return;
    }
    if (lowerTranscript.includes('go to rewards') || lowerTranscript.includes('show points')) {
        speak('Opening the Points and Rewards Center.');
        changeTab('rewards');
        return;
    }
    if (lowerTranscript.includes('open setup') || lowerTranscript.includes('go to setup')) {
        speak('Opening the Setup panel.');
        changeTab('setup');
        return;
    }
    if (lowerTranscript.includes('show weekly') || lowerTranscript.includes('weekly schedule')) {
        speak('Displaying the weekly schedule.');
        changeTab('weekly');
        return;
    }
    
    // 2. Chore Completion Commands
    const choreCompletionMatch = lowerTranscript.match(/(mark|i finished|i completed|i did|done with|done) (.+?)( done| complete| finished)?$/);
    if (choreCompletionMatch) {
        const choreNameRaw = choreCompletionMatch[2].trim();
        const memberName = familyMembers.find(m => lowerTranscript.includes(m.name.toLowerCase()))?.name;
        
        // Find the chore by name (case-insensitive, partial match for flexibility)
        const choreToComplete = dailyChores.find(chore => 
            !chore.completed && 
            chore.name.toLowerCase().includes(choreNameRaw) &&
            (memberName ? chore.assignedTo === memberName : true)
        );

        if (choreToComplete) {
            // Find the chore element in the DOM to trigger the click
            const choreElement = document.getElementById(`chore-item-${choreToComplete.id}`);
            if (choreElement) {
                // Find the completion circle inside the chore item
                const completionCircle = choreElement.querySelector('[data-action="complete"]');
                if (completionCircle) {
                    completionCircle.click(); // Simulate click to trigger completion logic
                    speak(`Marking ${choreToComplete.name} as complete for ${choreToComplete.assignedTo}.`);
                    return;
                }
            }
        }
        speak(`Sorry, I couldn't find an incomplete chore matching ${choreNameRaw}.`);
        return;
    }

    // 3. Reward Redemption Commands
    const redemptionMatch = lowerTranscript.match(/(|i want to |can i |)redeem (.+?) for (.+?)$/);
    if (redemptionMatch) {
        const memberNameRaw = redemptionMatch[4]?.trim();
        const rewardNameRaw = redemptionMatch[2]?.trim();
        
        const member = familyMembers.find(m => m.name.toLowerCase() === memberNameRaw.toLowerCase());
        const reward = rewardsList.find(r => r.name.toLowerCase().includes(rewardNameRaw.toLowerCase()));

        if (!member) {
            speak(`I couldn't find a family member named ${memberNameRaw}.`);
            return;
        }
        if (!reward) {
            speak(`I couldn't find a reward called ${rewardNameRaw}.`);
            return;
        }

        if (member.points >= reward.cost) {
            // Simulate redemption by finding the form and submitting it
            document.getElementById('redeem-member-select').value = member.id;
            document.getElementById('redeem-reward-select').value = reward.id;
            document.getElementById('redeem-button').click();
            // The redemption function will handle the success speaking.
            return;
        } else {
            speak(`${member.name} only has ${member.points} points, but ${reward.name} costs ${reward.cost}.`);
            return;
        }
    }
    
    // Fallback
    speak('Sorry, I did not understand that command. Please try saying the chore name, or asking to redeem a reward.');
};

const handleVoiceToggle = () => {
    if (!recognition) {
        speak("Voice recognition is not supported in this browser.");
        return;
    }

    const micButton = document.getElementById('voice-toggle-fab');

    if (micButton.classList.contains('listening')) {
        recognition.stop();
        micButton.classList.remove('listening');
        speak('Voice commands deactivated.');
        return;
    }

    micButton.classList.add('listening');
    speak('Listening for command...');

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        console.log('Voice Command:', transcript);
        processVoiceCommand(transcript);
        micButton.classList.remove('listening');
    };

    recognition.onerror = (event) => {
        micButton.classList.remove('listening');
        if (event.error !== 'no-speech') {
             console.error('Recognition error:', event.error);
             speak(`Voice command error: ${event.error}`);
        }
    };

    recognition.onend = () => {
        micButton.classList.remove('listening');
    };

    recognition.start();
};


// --- Data Seeding (Initial Data Population) ---

const seedData = async () => {
    const memberCollection = collection(db, getFamilyMembersPath());
    const memberDocs = await getDocs(memberCollection);

    if (memberDocs.empty) {
        console.log("Seeding initial data...");
        const batch = writeBatch(db);

        // Members (Mom, Dad, Lyra, Cora)
        const initialMembers = [
            { id: crypto.randomUUID(), name: 'Mom', emoji: 'ðŸ‘‘', color: 'indigo', points: 200 },
            { id: crypto.randomUUID(), name: 'Dad', emoji: 'ðŸ”¨', color: 'blue', points: 150 },
            { id: crypto.randomUUID(), name: 'Lyra', emoji: 'ðŸ¦„', color: 'pink', points: 50 },
            { id: crypto.randomUUID(), name: 'Cora', emoji: 'ðŸŒŸ', color: 'teal', points: 75 },
        ];
        initialMembers.forEach(member => {
            batch.set(doc(memberCollection, member.id), member);
        });

        // Recurring Chores (Empty Dishwasher, Load Dishwasher, Feed Dog, Feed Cat, Laundry)
        const choreDefCollection = collection(db, getChoreDefinitionsPath());
        const momId = initialMembers.find(m => m.name === 'Mom').name;
        const dadId = initialMembers.find(m => m.name === 'Dad').name;
        
        const initialChoreDefs = [
            // id is optional here, Firestore will assign one
            { id: crypto.randomUUID(), name: 'Empty Dishwasher', emoji: 'ðŸ½ï¸', days: ['Mon', 'Wed', 'Fri'], points: 15, assignedTo: momId },
            { id: crypto.randomUUID(), name: 'Load Dishwasher', emoji: 'ðŸ§º', days: ['Tue', 'Thu', 'Sat'], points: 10, assignedTo: dadId },
            { id: crypto.randomUUID(), name: 'Feed Dog', emoji: 'ðŸ¶', days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], points: 20, assignedTo: initialMembers.find(m => m.name === 'Lyra').name },
            { id: crypto.randomUUID(), name: 'Feed Cat', emoji: 'ðŸˆ', days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], points: 20, assignedTo: initialMembers.find(m => m.name === 'Cora').name },
            { id: crypto.randomUUID(), name: 'Laundry', emoji: 'ðŸ‘•', days: ['Sat', 'Sun'], points: 50, assignedTo: momId },
        ];
        initialChoreDefs.forEach(choreDef => {
            batch.set(doc(choreDefCollection, choreDef.id), choreDef);
        });

        // Rewards (Movie Night, Pizza Dinner)
        const rewardsCollection = collection(db, getRewardsPath());
        const initialRewards = [
            { id: crypto.randomUUID(), name: 'Movie Night', emoji: 'ðŸ¿', cost: 100 },
            { id: crypto.randomUUID(), name: 'Pizza Dinner', emoji: 'ðŸ•', cost: 150 },
        ];
        initialRewards.forEach(reward => {
            batch.set(doc(rewardsCollection, reward.id), reward);
        });

        await batch.commit();
        console.log("Seeding complete.");
    }
};

// --- CRUD Operations ---

const saveMember = async (memberData) => {
    try {
        await setDoc(doc(db, getFamilyMembersPath(), memberData.id), memberData);
        speak(`${memberData.name} profile updated.`);
    } catch (e) {
        console.error("Error saving member: ", e);
        speak("Error saving member profile.");
    }
};

const saveChoreDefinition = async (choreDefData) => {
    try {
        await setDoc(doc(db, getChoreDefinitionsPath(), choreDefData.id), choreDefData);
        speak(`Chore ${choreDefData.name} saved successfully.`);
    } catch (e) {
        console.error("Error saving chore definition: ", e);
        speak("Error saving chore definition.");
    }
};

const saveReward = async (rewardData) => {
    try {
        await setDoc(doc(db, getRewardsPath(), rewardData.id), rewardData);
        speak(`Reward ${rewardData.name} saved successfully.`);
    } catch (e) {
        console.error("Error saving reward: ", e);
        speak("Error saving reward.");
    }
};

/**
 * Handles the completion of a chore, updates points, and records the completion log.
 * Uses a batch write for atomicity (points update only if completion log succeeds).
 */
const completeChore = async (chore) => {
    if (!db || !userId) return;

    // Check if the chore is already completed for today
    if (chore.completed) return;

    const batch = writeBatch(db);
    const memberRef = doc(db, getFamilyMembersPath(), familyMembers.find(m => m.name === chore.assignedTo).id);
    const completionRef = doc(collection(db, getChoreCompletionsPath()));

    const member = familyMembers.find(m => m.name === chore.assignedTo);
    if (!member) {
        console.error("Member not found for chore completion.");
        return;
    }

    // 1. Update Member Points
    const newPoints = (member.points || 0) + (chore.points || 0);
    batch.update(memberRef, { points: newPoints });

    // 2. Record Completion Log
    const completionLog = {
        choreId: chore.defId, // Use the definition ID for recurring chores or the unique ID for ad-hoc
        name: chore.name,
        emoji: chore.emoji,
        assignedTo: chore.assignedTo,
        points: chore.points,
        date: getCurrentDateKey(),
        timestamp: serverTimestamp(),
        isAdHoc: chore.isAdHoc || false,
    };
    batch.set(completionRef, completionLog);

    try {
        await batch.commit();
        speak(`Success! ${chore.name} complete. ${chore.assignedTo} earned ${chore.points} points.`);
        // Brief, satisfying confetti/animation effect on the completed item
        const choreElement = document.getElementById(`chore-item-${chore.id}`);
        if(choreElement) {
            choreElement.classList.add('completed-success');
            setTimeout(() => choreElement.classList.remove('completed-success'), 1000);
        }
    } catch (e) {
        console.error("Transaction failed: ", e);
        speak(`Failed to mark ${chore.name} complete.`);
    }
};

/**
 * Handles reward redemption, updating member points and logging the transaction.
 * Uses a batch write for atomicity.
 */
const redeemReward = async (memberId, rewardId) => {
    if (!db || !userId) return;

    const member = familyMembers.find(m => m.id === memberId);
    const reward = rewardsList.find(r => r.id === rewardId);

    if (!member || !reward) {
        speak("Error: Member or Reward not found.");
        return;
    }

    if (member.points < reward.cost) {
        speak(`${member.name} doesn't have enough points. Needs ${reward.cost} points.`);
        return false;
    }

    const batch = writeBatch(db);
    const memberRef = doc(db, getFamilyMembersPath(), member.id);

    // 1. Deduct Points
    const newPoints = member.points - reward.cost;
    batch.update(memberRef, { points: newPoints });

    // 2. Log Redemption (re-using completions collection for simple logging, use 'cost' for negative points)
    const redemptionLog = {
        choreId: 'REWARD_REDEMPTION',
        name: `Redeemed: ${reward.name}`,
        emoji: reward.emoji,
        assignedTo: member.name,
        points: -reward.cost, // Log as a negative value
        date: getCurrentDateKey(),
        timestamp: serverTimestamp(),
        isRedemption: true,
    };
    batch.set(doc(collection(db, getChoreCompletionsPath())), redemptionLog);

    try {
        await batch.commit();
        speak(`${member.name} successfully redeemed ${reward.name} for ${reward.cost} points!`);
        return true;
    } catch (e) {
        console.error("Redemption transaction failed: ", e);
        speak(`Failed to redeem ${reward.name}.`);
        return false;
    }
};

// --- Renderer & State Update ---

/** Rerenders the entire application UI based on current state */
const renderApp = () => {
    const appContainer = document.getElementById('app');
    if (!appContainer) return;

    // Determine the current view content based on the active tab
    let viewContent = '';
    let headerTitle = 'Family Hub Organizer';
    const today = new Date();
    const todayDayName = dayIndexToName(today.getDay());
    const todayDateKey = getCurrentDateKey();

    switch (currentTab) {
        case 'daily':
            headerTitle = `Daily Chores (${todayDayName}, ${todayDateKey})`;
            viewContent = renderDailyListView(todayDayName);
            break;
        case 'weekly':
            headerTitle = 'Weekly Schedule Overview';
            viewContent = renderWeeklyScheduleView();
            break;
        case 'rewards':
            headerTitle = 'Points & Rewards Center';
            viewContent = renderRewardsView();
            break;
        case 'setup':
            headerTitle = 'Family & Chore Setup';
            viewContent = renderSetupView();
            break;
        case 'calendar':
            headerTitle = 'Calendar (Manual Events)';
            viewContent = renderCalendarView();
            break;
    }

    appContainer.innerHTML = `
        <div class="h-full flex flex-col bg-gray-50 font-sans shadow-2xl">
            <!-- Header -->
            <header class="p-4 shadow-xl bg-gradient-to-r from-indigo-600 to-blue-500 text-white sticky top-0 z-10">
                <h1 class="text-2xl font-bold tracking-tight">${headerTitle}</h1>
            </header>
            
            <!-- Navigation -->
            <nav class="flex justify-around p-0.5 bg-gray-100 shadow-md sticky top-[64px] z-10">
                ${renderTabButton('daily', 'Daily List', 'M6 18L18 6M6 6l12 12')}
                ${renderTabButton('weekly', 'Weekly Schedule', 'M8 7V3m8 4V3m-9 8h.01M13 11h.01M17 11h.01M8 15h.01M12 15h.01M16 15h.01M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z')}
                ${renderTabButton('rewards', 'Points & Rewards', 'M11 11h2v-2h2.5L12 6.5 6.5 9h2.5v2H5l7 7 7-7h-4z')}
                ${renderTabButton('setup', 'Setup', 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.562.342 1.25.043 1.066-.714z')}
                ${renderTabButton('calendar', 'Calendar', 'M8 7V3m8 4V3m-9 8h.01M13 11h.01M17 11h.01M8 15h.01M12 15h.01M16 15h.01M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z')}
            </nav>
            
            <!-- Main Content Area -->
            <main class="flex-grow p-4 overflow-y-auto bg-grid-pattern">
                ${isAuthReady ? viewContent : renderLoading()}
            </main>

            <!-- Voice FAB -->
            <button id="voice-toggle-fab" onclick="handleVoiceToggle()" class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-red-500 shadow-xl flex items-center justify-center text-white transition duration-300 ease-in-out hover:bg-red-600 active:scale-95 z-50 transform hover:scale-110 pulse-animation" title="Activate Voice Commands">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5v3m-3-3h6m-9-6.75h9a2.25 2.25 0 1 1 0 4.5h-9a2.25 2.25 0 1 1 0-4.5Z" />
                </svg>
            </button>
        </div>
    `;
    
    // Add the slide-up animation effect to new content
    const mainContent = document.querySelector('main');
    mainContent.classList.add('animate-slide-up-fade');
    setTimeout(() => mainContent.classList.remove('animate-slide-up-fade'), 500);

    // After rendering, ensure event listeners are attached for drag and drop
    if (currentTab === 'daily') {
        setupDragAndDrop();
        // Force the ad-hoc form to be visible/hidden based on state
        const formContainer = document.getElementById('ad-hoc-form-container');
        if (formContainer) {
             formContainer.style.maxHeight = adHocFormVisible ? '300px' : '0';
        }
    }

    // Update redemption form options if we are on the rewards tab
    if (currentTab === 'rewards') {
        populateRedemptionOptions();
    }
};

const renderTabButton = (tabName, label, svgPath) => {
    const isActive = currentTab === tabName;
    const baseClasses = "flex flex-col items-center p-2 text-sm font-medium transition duration-150 ease-in-out transform hover:scale-105";
    const activeClasses = `text-${isActive ? 'indigo-600' : 'gray-500'} border-b-2 border-${isActive ? 'indigo-600' : 'transparent'} active:scale-95`;

    return `
        <button onclick="changeTab('${tabName}')" class="${baseClasses} ${activeClasses}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="${svgPath}" />
            </svg>
            <span class="text-xs mt-1 hidden sm:inline">${label}</span>
        </button>
    `;
};

const changeTab = (tabName) => {
    currentTab = tabName;
    renderApp();
};

const renderLoading = () => `
    <div class="flex flex-col items-center justify-center h-full space-y-4 pt-20">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-lg text-gray-700 font-medium">Connecting to Family Cloud Data...</p>
        <p class="text-sm text-gray-500">Ensure your Firebase configuration is correct if this takes too long.</p>
    </div>
`;


// --- Daily List View (Tab 'daily') ---

const renderChoreCard = (chore, memberColor, isUnassigned = false) => {
    const isCompleted = chore.completed;
    const itemClasses = isCompleted 
        ? "bg-white shadow-md border-l-4 border-green-500 opacity-60 line-through transition duration-300"
        : `bg-white shadow-lg border-l-4 border-${memberColor}-500 transition duration-300 hover:shadow-xl hover:scale-[1.01] active:scale-[0.99] cursor-grab`;
        
    return `
        <div id="chore-item-${chore.id}" draggable="${!isCompleted}" data-chore-id="${chore.id}" 
             class="chore-item p-4 rounded-lg flex items-center justify-between mb-3 ${itemClasses}"
             data-assigned-to="${chore.assignedTo || 'Unassigned'}"
             data-def-id="${chore.defId || chore.id}"
             data-is-adhoc="${chore.isAdHoc || false}">
            
            <div class="flex-grow flex items-center min-w-0">
                <!-- Completion/Emoji Circle -->
                <button 
                    class="w-8 h-8 rounded-full border-2 border-gray-300 mr-4 flex items-center justify-center flex-shrink-0
                           ${isCompleted ? 'bg-green-500 border-green-500 text-white' : 'hover:bg-gray-100'}"
                    onclick="${isCompleted ? 'return false;' : `completeChore(dailyChores.find(c => c.id === '${chore.id}'))`}"
                    data-action="complete"
                    ${isCompleted ? 'disabled' : ''}
                    title="${isCompleted ? 'Completed' : 'Mark Complete'}">
                    ${isCompleted ? `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>` 
                        : `<span class="text-xl">${chore.emoji}</span>`
                    }
                </button>
                
                <div class="min-w-0">
                    <p class="text-lg font-semibold truncate ${isCompleted ? 'text-gray-500' : 'text-gray-800'}">${chore.name}</p>
                    <p class="text-sm text-gray-500">
                        ${isUnassigned ? 'Unassigned' : `Value: ${chore.points} Points`}
                        ${chore.isAdHoc ? ' â€¢ (One-Time)' : ''}
                    </p>
                </div>
            </div>

        </div>
    `;
};


const renderMemberChoreList = (member) => {
    const memberChores = dailyChores.filter(chore => chore.assignedTo === member.name);
    const completedCount = memberChores.filter(c => c.completed).length;
    const totalCount = memberChores.length;
    
    // Member Points Card
    const pointsCard = `
        <div class="flex items-center justify-between p-4 mb-4 rounded-xl shadow-lg bg-white border-t-4 border-${member.color}-600 transform transition duration-300 hover:shadow-2xl">
            <div class="flex items-center">
                <span class="text-3xl mr-3">${member.emoji}</span>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${member.name}</h3>
                    <p class="text-sm text-gray-500">Tasks: ${completedCount}/${totalCount} done</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-2xl font-extrabold text-${member.color}-600">${member.points || 0}</p>
                <p class="text-sm text-gray-500">Points</p>
            </div>
        </div>
    `;

    const choreList = memberChores.length > 0
        ? memberChores.map(chore => renderChoreCard(chore, member.color)).join('')
        : `<p class="text-center text-gray-500 p-6 bg-white rounded-xl shadow-inner">Nothing assigned today! ðŸŽ‰</p>`;

    return `
        <div class="drop-zone border-2 border-dashed border-transparent p-4 rounded-xl space-y-3" data-member-id="${member.name}">
            ${pointsCard}
            <div class="min-h-[100px] space-y-3">
                ${choreList}
            </div>
        </div>
    `;
};

const renderAdHocForm = () => {
    return `
        <div class="p-4 bg-white rounded-b-xl shadow-inner transition-all duration-300 overflow-hidden" id="ad-hoc-form-container" style="max-height:0; padding:0; ${adHocFormVisible ? 'padding: 1rem;' : ''}">
            <form id="ad-hoc-chore-form" class="space-y-4">
                <div>
                    <label for="adhoc-name" class="block text-sm font-medium text-gray-700">Chore Name</label>
                    <input type="text" id="adhoc-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g., Water the plants">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="adhoc-points" class="block text-sm font-medium text-gray-700">Points (Value)</label>
                        <input type="number" id="adhoc-points" required min="1" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="adhoc-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" id="adhoc-emoji" value="âœ¨" required maxlength="2" class="block w-full rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <button type="button" onclick="handleAIEmoji('adhoc-name', 'adhoc-emoji')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-600 text-sm hover:bg-gray-200 transition duration-150 active:scale-95">AI</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="adhoc-assign" class="block text-sm font-medium text-gray-700">Assign To (Optional)</label>
                    <select id="adhoc-assign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        <option value="">Unassigned</option>
                        ${familyMembers.map(m => `<option value="${m.name}">${m.name} ${m.emoji}</option>`).join('')}
                    </select>
                </div>
                <button type="submit" class="w-full justify-center py-2 px-4 border border-transparent shadow-md text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 active:scale-[0.98]">
                    Create One-Time Chore
                </button>
            </form>
        </div>
    `;
}

const renderDailyListView = (todayDayName) => {
    // 1. Filter daily chores into assigned and unassigned
    const unassignedChores = dailyChores.filter(chore => !chore.assignedTo);
    const assignedMembers = familyMembers.filter(m => dailyChores.some(c => c.assignedTo === m.name));
    const allMembers = familyMembers.sort((a, b) => a.points > b.points ? -1 : 1); // Sort by points

    return `
        <!-- Assigned Chores -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            ${allMembers.map(renderMemberChoreList).join('')}
        </div>
        
        <!-- Unassigned Chores Pool -->
        <div class="unassigned-pool rounded-xl shadow-2xl overflow-hidden bg-yellow-50 border-t-8 border-yellow-400">
            <div class="p-4 flex items-center justify-between bg-yellow-100/70 border-b border-yellow-200">
                <h2 class="text-xl font-bold text-yellow-800">Unassigned Chores Pool</h2>
                <!-- Ad-Hoc Chore Toggle Button -->
                <button onclick="toggleAdHocForm(event)" class="w-8 h-8 rounded-full bg-red-500 shadow-lg text-white flex items-center justify-center transform transition duration-300 hover:bg-red-600 active:scale-95" title="Add One-Time Chore">
                    <svg id="adhoc-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="${adHocFormVisible ? 'M6 18L18 6M6 6l12 12' : 'M12 4v16m-8-8h16'}" />
                    </svg>
                </button>
            </div>
            
            ${renderAdHocForm()}

            <!-- Drag and Drop Target for Unassigned Chores -->
            <div class="drop-zone border-2 border-dashed border-transparent p-4 min-h-[100px] space-y-3" data-member-id="Unassigned">
                ${unassignedChores.length > 0 
                    ? unassignedChores.map(chore => renderChoreCard(chore, 'yellow', true)).join('')
                    : `<p class="text-center text-gray-500 p-6 rounded-xl shadow-inner">Drag chores here to unassign them, or leave them here for anyone to grab!</p>`
                }
            </div>
        </div>
    `;
};

const toggleAdHocForm = (event) => {
    event.preventDefault();
    adHocFormVisible = !adHocFormVisible;
    const formContainer = document.getElementById('ad-hoc-form-container');
    const toggleIcon = document.getElementById('adhoc-toggle-icon');
    
    if (formContainer) {
        if (adHocFormVisible) {
            formContainer.style.maxHeight = '300px'; // Expand
            formContainer.style.padding = '1rem';
            toggleIcon.setAttribute('d', 'M6 18L18 6M6 6l12 12'); // Change icon to 'X'
        } else {
            formContainer.style.maxHeight = '0'; // Collapse
            formContainer.style.padding = '0';
            toggleIcon.setAttribute('d', 'M12 4v16m-8-8h16'); // Change icon to '+'
        }
    }
    // Update the state of the local UI elements
};


// --- Weekly Schedule View (Tab 'weekly') ---

const renderWeeklyScheduleView = () => {
    const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const todayIndex = new Date().getDay();
    const todayDateKey = getCurrentDateKey();
    
    // Combine recurring and ad-hoc chores for the week
    const weeklyChoresMap = daysOfWeek.map(() => []);

    // 1. Add Recurring Chores
    choreDefinitions.forEach(chore => {
        chore.days.forEach(dayName => {
            const index = dayNameToIndex(dayName);
            const member = familyMembers.find(m => m.name === chore.assignedTo);
            if (member) {
                weeklyChoresMap[index].push({ 
                    name: chore.name, 
                    emoji: chore.emoji, 
                    color: member.color, 
                    assignedTo: member.name 
                });
            }
        });
    });

    // 2. Add Ad-Hoc Chores (Only for the current day for simplicity, as past ad-hocs are completed/archived)
    dailyChores.filter(c => c.isAdHoc).forEach(adhoc => {
        const index = new Date().getDay(); // They only appear on the day they are created
        const member = familyMembers.find(m => m.name === adhoc.assignedTo);
        if (member) {
             weeklyChoresMap[index].push({ 
                name: `${adhoc.name} (One-Time)`, 
                emoji: adhoc.emoji, 
                color: member.color, 
                assignedTo: member.name
            });
        }
    });


    const dayCards = daysOfWeek.map((dayName, index) => {
        const isToday = index === todayIndex;
        const chores = weeklyChoresMap[index];
        const baseClasses = "rounded-xl p-4 shadow-xl transform transition duration-300";
        const colorClasses = isToday ? "bg-red-50 border-4 border-red-400" : "bg-white border-2 border-gray-200 hover:shadow-2xl";

        return `
            <div class="${baseClasses} ${colorClasses}">
                <h3 class="text-lg font-bold mb-3 ${isToday ? 'text-red-700' : 'text-gray-800'}">${dayName} ${isToday ? '(Today)' : ''}</h3>
                <div class="space-y-2">
                    ${chores.length > 0 
                        ? chores.map(chore => `
                            <div class="flex items-center p-2 rounded-lg bg-${chore.color}-50 border-l-4 border-${chore.color}-400">
                                <span class="text-xl mr-2 flex-shrink-0">${chore.emoji}</span>
                                <div class="truncate text-sm">
                                    <p class="font-medium text-gray-800 truncate">${chore.name}</p>
                                    <p class="text-xs text-gray-600">Assigned to: ${chore.assignedTo}</p>
                                </div>
                            </div>
                        `).join('')
                        : `<p class="text-gray-500 text-sm italic">Free day!</p>`
                    }
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            ${dayCards}
        </div>
    `;
};


// --- Rewards View (Tab 'rewards') ---

const populateRedemptionOptions = () => {
    const memberSelect = document.getElementById('redeem-member-select');
    const rewardSelect = document.getElementById('redeem-reward-select');

    if (memberSelect) {
        memberSelect.innerHTML = familyMembers.map(m => `<option value="${m.id}">${m.name} (${m.points} pts)</option>`).join('');
    }
    
    if (rewardSelect) {
        rewardSelect.innerHTML = rewardsList.map(r => `<option value="${r.id}">${r.name} (${r.cost} pts)</option>`).join('');
    }
};

const handleRedeemSubmit = async (event) => {
    event.preventDefault();
    const memberId = document.getElementById('redeem-member-select').value;
    const rewardId = document.getElementById('redeem-reward-select').value;
    
    if (!memberId || !rewardId) {
        speak("Please select both a member and a reward.");
        return;
    }
    
    await redeemReward(memberId, rewardId);
    // Redraw the app to update points and redemption options
    renderApp(); 
};


const renderRewardsView = () => {
    
    const memberCards = familyMembers.map(member => `
        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-${member.color}-600 flex items-center justify-between transform transition duration-300 hover:shadow-2xl">
            <div class="flex items-center">
                <span class="text-4xl mr-4">${member.emoji}</span>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${member.name}</h3>
                    <p class="text-sm text-gray-500">Current Points</p>
                </div>
            </div>
            <p class="text-4xl font-extrabold text-${member.color}-600">${member.points || 0}</p>
        </div>
    `).join('');
    
    const rewardCards = rewardsList.map(reward => `
        <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between border-l-4 border-green-500 transition duration-300 hover:shadow-lg">
            <div class="flex items-center">
                <span class="text-2xl mr-3">${reward.emoji}</span>
                <h3 class="text-lg font-medium text-gray-800">${reward.name}</h3>
            </div>
            <p class="text-xl font-bold text-green-600">${reward.cost} pts</p>
        </div>
    `).join('');


    return `
        <!-- Point Summary -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Family Point Totals</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            ${memberCards}
        </div>

        <!-- Redemption Form -->
        <div class="bg-white p-6 rounded-xl shadow-2xl border-t-8 border-indigo-500 mb-8">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-4">Redeem Rewards</h2>
            <form onsubmit="handleRedeemSubmit(event)" id="redeem-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="redeem-member-select" class="block text-sm font-medium text-gray-700">Redeem For</label>
                        <select id="redeem-member-select" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select>
                    </div>
                    <div>
                        <label for="redeem-reward-select" class="block text-sm font-medium text-gray-700">Select Reward</label>
                        <select id="redeem-reward-select" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select>
                    </div>
                    <div class="flex items-end">
                        <button id="redeem-button" type="submit" class="w-full justify-center py-2 px-4 border border-transparent shadow-md text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 active:scale-[0.98]">
                            REDEEM NOW
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Available Rewards List -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Available Rewards</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${rewardCards.length > 0 ? rewardCards : '<p class="text-gray-500 p-4 bg-white rounded-xl shadow-inner">No rewards have been defined yet. Go to Setup!</p>'}
        </div>
    `;
};


// --- Setup View (Tab 'setup') ---

const handleAIEmoji = async (nameInputId, emojiInputId) => {
    const nameInput = document.getElementById(nameInputId);
    const emojiInput = document.getElementById(emojiInputId);
    
    if (nameInput.value.trim() === '') {
        speak('Please enter a name first.');
        return;
    }
    
    // Simple visual loading state
    emojiInput.value = 'â³'; 
    const emoji = await getEmojiFromAI(nameInput.value);
    emojiInput.value = emoji;
};

// Member Management
const handleAddMember = async (event) => {
    event.preventDefault();
    const name = document.getElementById('member-name').value.trim();
    if (!name) return;

    // Assign a default random color
    const colors = ['red', 'green', 'blue', 'indigo', 'pink', 'teal', 'purple', 'orange'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    const newMember = {
        id: crypto.randomUUID(),
        name: name,
        emoji: 'ðŸ™‚',
        color: randomColor,
        points: 0,
    };
    await saveMember(newMember);
    document.getElementById('member-name').value = '';
    renderApp();
};

const handleMemberEditSave = async (memberId, event) => {
    event.preventDefault();
    const form = document.getElementById(`edit-member-form-${memberId}`);
    const member = familyMembers.find(m => m.id === memberId);
    
    if (member) {
        const newName = form.querySelector('input[name="name"]').value.trim();
        const newEmoji = form.querySelector('input[name="emoji"]').value.trim();
        const newColor = form.querySelector('select[name="color"]').value;

        if (!newName) {
            speak("Name cannot be empty.");
            return;
        }

        const updatedMember = {
            ...member,
            name: newName,
            emoji: newEmoji,
            color: newColor
        };
        await saveMember(updatedMember);
        renderApp();
    }
};

const renderMemberEditor = (member) => {
    const colorOptions = ['red', 'green', 'blue', 'indigo', 'pink', 'teal', 'purple', 'orange'];
    
    return `
        <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-${member.color}-600 transform transition duration-300 hover:shadow-xl">
            <h3 class="text-lg font-bold mb-3 flex items-center">${member.name} <span class="ml-2 text-xl">${member.emoji}</span></h3>
            <form id="edit-member-form-${member.id}" onsubmit="handleMemberEditSave('${member.id}', event)" class="space-y-3">
                <div>
                    <label for="member-edit-name-${member.id}" class="block text-xs font-medium text-gray-700">Name</label>
                    <input type="text" name="name" id="member-edit-name-${member.id}" value="${member.name}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm border">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="member-edit-emoji-${member.id}" class="block text-xs font-medium text-gray-700">Emoji</label>
                        <input type="text" name="emoji" id="member-edit-emoji-${member.id}" value="${member.emoji}" required maxlength="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm border">
                    </div>
                    <div>
                        <label for="member-edit-color-${member.id}" class="block text-xs font-medium text-gray-700">Color</label>
                        <select name="color" id="member-edit-color-${member.id}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm border">
                            ${colorOptions.map(color => `
                                <option value="${color}" ${member.color === color ? 'selected' : ''} class="capitalize">${color}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600 transition duration-150 active:scale-[0.98]">
                    Save Changes
                </button>
            </form>
        </div>
    `;
};

// Chore Definition Management
const handleAddChoreDefinition = async (event) => {
    event.preventDefault();
    const form = event.target;
    const name = form.querySelector('#def-name').value.trim();
    const emoji = form.querySelector('#def-emoji').value.trim();
    const points = parseInt(form.querySelector('#def-points').value, 10);
    const assignedTo = form.querySelector('#def-assign').value;
    const days = Array.from(form.querySelectorAll('input[name="def-day"]:checked')).map(cb => cb.value);

    if (!name || isNaN(points) || points <= 0 || days.length === 0) {
        speak("Please fill in the name, positive points, and select at least one day.");
        return;
    }

    const newChoreDef = {
        id: crypto.randomUUID(),
        name,
        emoji,
        points,
        assignedTo: assignedTo || null, // Can be unassigned
        days,
    };

    await saveChoreDefinition(newChoreDef);
    form.reset();
    renderApp();
};

// Reward Definition Management
const handleAddReward = async (event) => {
    event.preventDefault();
    const form = event.target;
    const name = form.querySelector('#reward-name').value.trim();
    const emoji = form.querySelector('#reward-emoji').value.trim();
    const cost = parseInt(form.querySelector('#reward-cost').value, 10);
    
    if (!name || isNaN(cost) || cost <= 0) {
        speak("Please fill in the reward name and a positive point cost.");
        return;
    }

    const newReward = {
        id: crypto.randomUUID(),
        name,
        emoji,
        cost,
    };
    
    await saveReward(newReward);
    form.reset();
    renderApp();
};


const renderSetupView = () => {
    const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    return `
        <div class="space-y-8">
            
            <!-- Member Management -->
            <div class="bg-white p-6 rounded-xl shadow-2xl border-t-8 border-purple-500">
                <h2 class="text-2xl font-bold text-purple-700 mb-4">Family Members</h2>
                
                <form onsubmit="handleAddMember(event)" class="mb-6 flex space-x-2">
                    <input type="text" id="member-name" placeholder="New Member Name" required class="flex-grow rounded-md border-gray-300 shadow-sm p-2 border">
                    <button type="submit" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-500 hover:bg-purple-600 transition duration-150 active:scale-95">
                        Add Member
                    </button>
                </form>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${familyMembers.map(renderMemberEditor).join('')}
                </div>
            </div>

            <!-- Chore Definitions -->
            <div class="bg-white p-6 rounded-xl shadow-2xl border-t-8 border-green-500">
                <h2 class="text-2xl font-bold text-green-700 mb-4">Recurring Chore Definitions</h2>
                <form onsubmit="handleAddChoreDefinition(event)" class="space-y-4">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="def-name" class="block text-sm font-medium text-gray-700">Chore Name</label>
                            <input type="text" id="def-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="e.g., Take out trash">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label for="def-points" class="block text-sm font-medium text-gray-700">Points</label>
                                <input type="number" id="def-points" required min="1" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div class="col-span-2">
                                <label for="def-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="def-emoji" value="âœ…" required maxlength="2" class="block w-full rounded-l-md border-gray-300 p-2 border">
                                    <button type="button" onclick="handleAIEmoji('def-name', 'def-emoji')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-600 text-sm hover:bg-gray-200 transition duration-150 active:scale-95">AI</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Schedule (Days of the Week)</label>
                        <div class="flex flex-wrap gap-2">
                            ${daysOfWeek.map(day => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="day-${day}" name="def-day" value="${day}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="day-${day}" class="ml-2 text-sm text-gray-700">${day}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label for="def-assign" class="block text-sm font-medium text-gray-700">Set Default Assignment (Optional)</label>
                        <select id="def-assign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="">Unassigned Pool</option>
                            ${familyMembers.map(m => `<option value="${m.name}">${m.name} ${m.emoji}</option>`).join('')}
                        </select>
                    </div>

                    <button type="submit" class="w-full justify-center py-2 px-4 border border-transparent shadow-md text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600 transition duration-150 active:scale-[0.98]">
                        Save Chore Definition
                    </button>
                </form>

                <div class="mt-8 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Defined Chores (${choreDefinitions.length})</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${choreDefinitions.map(def => `
                            <div class="bg-gray-50 p-3 rounded-lg shadow-sm border-l-4 border-green-400">
                                <p class="text-sm font-semibold flex items-center">${def.emoji} ${def.name} <span class="ml-auto text-xs font-normal text-gray-500">${def.points} pts</span></p>
                                <p class="text-xs text-gray-600">Days: ${def.days.join(', ')}</p>
                                <p class="text-xs text-gray-600">Default: ${def.assignedTo || 'Unassigned'}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <!-- Reward Definitions -->
            <div class="bg-white p-6 rounded-xl shadow-2xl border-t-8 border-red-500">
                <h2 class="text-2xl font-bold text-red-700 mb-4">Reward Definitions</h2>
                <form onsubmit="handleAddReward(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="reward-name" class="block text-sm font-medium text-gray-700">Reward Name</label>
                            <input type="text" id="reward-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="e.g., Pizza Night">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label for="reward-cost" class="block text-sm font-medium text-gray-700">Point Cost</label>
                                <input type="number" id="reward-cost" required min="1" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div class="col-span-2">
                                <label for="reward-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="reward-emoji" value="ðŸŽ" required maxlength="2" class="block w-full rounded-l-md border-gray-300 p-2 border">
                                    <button type="button" onclick="handleAIEmoji('reward-name', 'reward-emoji')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-600 text-sm hover:bg-gray-200 transition duration-150 active:scale-95">AI</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="w-full justify-center py-2 px-4 border border-transparent shadow-md text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600 transition duration-150 active:scale-[0.98]">
                        Save Reward Definition
                    </button>
                </form>
            </div>
        </div>
    `;
};


// --- Calendar View (Tab 'calendar') ---
const renderCalendarView = () => {
    // NOTE: This remains a functional mock-up. Full Google Calendar integration 
    // requires a backend server for OAuth 2.0 and API key management, which is 
    // not possible in this single-file, client-side application.

    const date = new Date();
    const year = date.getFullYear();
    const month = date.getMonth(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
    
    const monthName = date.toLocaleDateString('en-US', { month: 'long' });
    const today = new Date().getDate();

    let daysHtml = '';
    // Empty cells for padding
    for (let i = 0; i < firstDayIndex; i++) {
        daysHtml += '<div class="day-cell p-2"></div>';
    }

    // Mock Events for visual purposes
    const mockEvents = {
        5: [{ text: 'Lyra B-day!', color: 'pink' }],
        12: [{ text: 'Soccer Game', color: 'indigo' }],
        21: [{ text: 'Mom & Dad Date', color: 'purple' }],
        28: [{ text: 'Dr. Appt', color: 'blue' }],
    };

    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = day === today && month === new Date().getMonth();
        const events = mockEvents[day] || [];

        daysHtml += `
            <div class="day-cell p-2 rounded-lg transition duration-150 ${isToday ? 'bg-indigo-100 border-2 border-indigo-500 shadow-md' : 'bg-white hover:bg-gray-50'}">
                <div class="font-bold ${isToday ? 'text-indigo-700' : 'text-gray-800'}">${day}</div>
                <div class="mt-1 space-y-0.5">
                    ${events.map(event => `
                        <div class="text-xs p-1 rounded-md bg-${event.color}-50 text-${event.color}-700 truncate" title="${event.text}">
                            ${event.text}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }


    return `
        <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl border-t-8 border-indigo-500">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">${monthName} ${year}</h2>
            <p class="text-sm text-red-500 mb-4 font-medium">NOTE: This is a static view. For live Google Calendar sync, you need a server-side OAuth implementation.</p>

            <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-500 mb-2">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="grid grid-cols-7 gap-1">
                ${daysHtml}
            </div>
        </div>
    `;
};


// --- Drag and Drop Logic ---

let draggedChore = null;

const setupDragAndDrop = () => {
    // Remove existing listeners to prevent duplication
    document.querySelectorAll('.chore-item').forEach(item => {
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragend', handleDragEnd);
    });
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.removeEventListener('dragover', handleDragOver);
        zone.removeEventListener('dragleave', handleDragLeave);
        zone.removeEventListener('drop', handleDrop);
    });

    // Add listeners to chore items (draggables)
    document.querySelectorAll('.chore-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });

    // Add listeners to member lists (drop targets)
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('drop', handleDrop);
    });
};

function handleDragStart(e) {
    draggedChore = dailyChores.find(c => c.id === e.target.dataset.choreId);
    e.dataTransfer.setData('text/plain', draggedChore.id);
    e.target.classList.add('opacity-40');
}

function handleDragEnd(e) {
    e.target.classList.remove('opacity-40');
    draggedChore = null;
    document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('border-indigo-500'));
}

function handleDragOver(e) {
    e.preventDefault(); // Necessary to allow drop
    if (draggedChore) {
        e.currentTarget.classList.add('border-indigo-500');
    }
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('border-indigo-500');
}

async function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('border-indigo-500');

    if (!draggedChore) return;

    const targetMemberName = e.currentTarget.dataset.memberId; // "Mom", "Dad", or "Unassigned"

    // If target member is the same as current assignment, do nothing
    if ((draggedChore.assignedTo || 'Unassigned') === targetMemberName) return;

    // Determine the new assignment name
    const newAssignment = targetMemberName === 'Unassigned' ? null : targetMemberName;
    
    // The chore to update might be a recurring definition or an ad-hoc chore.
    let docRef;

    if (draggedChore.isAdHoc) {
        // Update the ad-hoc chore in the completions collection (as a log entry)
        docRef = doc(db, getChoreCompletionsPath(), draggedChore.logId);
        
        // Note: Ad-hoc chores are logs, but for D&D, we track them live in the dailyChores array
        // The persistence model here is a bit stretched, but for simplicity, we update the log's 'assignedTo' field
    } else {
        // Update the recurring chore definition
        docRef = doc(db, getChoreDefinitionsPath(), draggedChore.defId);
    }
    
    try {
        // Update the assignedTo field
        await setDoc(docRef, { assignedTo: newAssignment }, { merge: true });
        speak(`${draggedChore.name} assigned to ${newAssignment || 'Unassigned Pool'}.`);
    } catch (error) {
        console.error("Error updating chore assignment: ", error);
        speak("Failed to update chore assignment.");
    }
}


// --- Data Listeners (Real-time Sync) ---

const startDataListeners = () => {
    if (!db) return;

    // Listener 1: Family Members
    onSnapshot(collection(db, getFamilyMembersPath()), (snapshot) => {
        familyMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Ensure points are numbers
        familyMembers.forEach(m => m.points = m.points || 0);
        renderApp();
    });

    // Listener 2: Chore Definitions
    onSnapshot(collection(db, getChoreDefinitionsPath()), (snapshot) => {
        choreDefinitions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateDailyChores();
    });

    // Listener 3: Reward Definitions
    onSnapshot(collection(db, getRewardsPath()), (snapshot) => {
        rewardsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderApp(); // Only need to re-render rewards/setup views
    });

    // Listener 4: Chore Completions (Crucial for determining TODAY's list status)
    const todayKey = getCurrentDateKey();
    const completionsQuery = query(collection(db, getChoreCompletionsPath()), where('date', '==', todayKey));
    
    onSnapshot(completionsQuery, (snapshot) => {
        const completedToday = snapshot.docs.map(doc => ({ logId: doc.id, ...doc.data() }));
        updateDailyChores(completedToday);
    });
};

/** * Combines recurring definitions, ad-hoc logs, and completion logs 
 * to generate the final list of chores for TODAY.
 */
const updateDailyChores = (completedToday = null) => {
    // If we only have completions data, ensure defs are loaded first
    if (!completedToday) {
        completedToday = dailyChores.filter(c => c.completed).map(c => ({ choreId: c.defId || c.id })); // Use existing completion data
    }
    
    const today = new Date();
    const todayDayName = dayIndexToName(today.getDay());
    const newDailyChores = [];
    
    // 1. Recurring Chores scheduled for today
    choreDefinitions.forEach(def => {
        if (def.days.includes(todayDayName)) {
            const isCompleted = completedToday.some(log => log.choreId === def.id && !log.isRedemption);
            
            // If the chore has an updated assignment from D&D, use the updated value.
            const currentAssignment = def.assignedTo;
            
            newDailyChores.push({
                id: def.id,         // Unique ID for rendering/D&D target
                defId: def.id,      // Links to the definition
                name: def.name,
                emoji: def.emoji,
                points: def.points,
                assignedTo: currentAssignment, 
                completed: isCompleted,
                isAdHoc: false,
            });
        }
    });

    // 2. Ad-Hoc Chores created today (these are stored as completion *logs* but represent uncompleted tasks until they are finished)
    completedToday.filter(log => log.isAdHoc && !log.isRedemption).forEach(adhocLog => {
        // Treat ad-hoc logs as uncompleted tasks IF they don't have a final completion log for today.
        // For simplicity and D&D functionality, we track them as "live" daily chores
        const isCompleted = adhocLog.completed || false; 
        
        newDailyChores.push({
            id: adhocLog.logId, // Use the log ID as the unique ID for D&D/completion
            logId: adhocLog.logId, // Link to the original log entry
            defId: adhocLog.logId, // Use log ID as defId for ad-hoc logic
            name: adhocLog.name,
            emoji: adhocLog.emoji,
            points: adhocLog.points,
            assignedTo: adhocLog.assignedTo,
            completed: isCompleted,
            isAdHoc: true,
        });
    });

    // Update the global state and re-render
    dailyChores = newDailyChores.sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1; // Incomplete first
        return (a.assignedTo || 'Unassigned') < (b.assignedTo || 'Unassigned') ? -1 : 1;
    });

    renderApp();
};


// --- Initialization ---

window.onload = async () => {
    try {
        // --- IMPORTANT: Ensure the config values are NOT the default placeholders ---
        // The error check has been updated to use the new placeholder string.
        if (YOUR_API_KEY.includes("YOUR-API-KEY-HERE")) {
            document.getElementById('app').innerHTML = `
                <div class="p-8 bg-red-100 border-4 border-red-500 rounded-xl max-w-xl mx-auto mt-10">
                    <h2 class="text-2xl font-bold text-red-700 mb-4">Initialization Failed: Firebase Config missing</h2>
                    <p class="text-gray-700">You must replace the placeholder text in the <code>&lt;script&gt;</code> block 
                    with your actual keys from the Firebase Console before this app can run.</p>
                    <p class="mt-4 text-sm font-medium">Please review the configuration guide and update the 
                    <code>index.html</code> file on GitHub. The required keys are:</p>
                    <ul class="list-disc list-inside mt-2 text-sm text-red-600 font-semibold">
                        <li>YOUR_API_KEY</li>
                        <li>YOUR_AUTH_DOMAIN</li>
                        <li>YOUR_PROJECT_ID</li>
                        <li>YOUR_STORAGE_BUCKET</li>
                        <li>YOUR_MESSAGING_SENDER_ID</li>
                        <li>YOUR_APP_ID</li>
                    </ul>
                </div>
            `;
            console.error("Firebase config is using default placeholders.");
            return;
        }

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Log in
        if (typeof __initial_auth_token !== 'undefined') {
             // Use custom token if available (from development environment)
             await signInWithCustomToken(auth, __initial_auth_token);
        } else {
             // Otherwise, sign in anonymously (required for deployment on GitHub Pages)
             await signInAnonymously(auth);
        }

        // Set up Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                seedData(); // Populate data if database is empty
                startDataListeners(); // Start real-time syncing
            } else {
                userId = null;
                isAuthReady = false;
                renderApp(); // Show loading/login screen
            }
        });

    } catch (e) {
        console.error("Firebase Initialization Error:", e);
        document.getElementById('app').innerHTML = `
            <div class="p-8 bg-red-100 border-4 border-red-500 rounded-xl max-w-xl mx-auto mt-10">
                <h2 class="text-2xl font-bold text-red-700 mb-4">FATAL ERROR</h2>
                <p class="text-gray-700">Could not connect to Firebase. Check your network or your API key configuration in the code.</p>
                <p class="mt-4 text-sm font-medium">Error details: ${e.message}</p>
            </div>
        `;
    }
};

const handleAdHocSubmit = async (event) => {
    event.preventDefault();
    const name = document.getElementById('adhoc-name').value.trim();
    const emoji = document.getElementById('adhoc-emoji').value.trim();
    const points = parseInt(document.getElementById('adhoc-points').value, 10);
    const assignedTo = document.getElementById('adhoc-assign').value;

    if (!name || isNaN(points) || points <= 0 || !db) {
        speak("Please enter a valid chore name and point value.");
        return;
    }

    const adhocData = {
        name,
        emoji,
        points,
        assignedTo: assignedTo || null,
        date: getCurrentDateKey(),
        timestamp: serverTimestamp(),
        isAdHoc: true,
        completed: false, // Initial state is false
    };

    try {
        // Ad-hoc chores are created directly as an uncompleted log entry
        await setDoc(doc(collection(db, getChoreCompletionsPath())), adhocData);
        speak(`${name} added as a one-time chore.`);
        document.getElementById('ad-hoc-chore-form').reset();
        toggleAdHocForm(event); // Collapse the form
    } catch (e) {
        console.error("Error adding ad-hoc chore: ", e);
        speak("Failed to add one-time chore.");
    }
}
document.addEventListener('submit', function(e) {
    if (e.target.id === 'ad-hoc-chore-form') {
        handleAdHocSubmit(e);
    }
});
</script>

<style>
/* Load Poppins Font */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');

body, html, #app {
    height: 100%;
    margin: 0;
    font-family: 'Poppins', sans-serif;
}

/* Background Pattern for 'Pop' */
.bg-grid-pattern {
    background-color: #f3f4f6;
    background-image: radial-gradient(#d1d5db 0.5px, transparent 0.5px);
    background-size: 10px 10px;
}

/* Custom Loader */
.loader {
    border-top-color: #3b82f6; /* Tailwind blue-500 */
    -webkit-animation: spinner 1.5s linear infinite;
    animation: spinner 1.5s linear infinite;
}

@-webkit-keyframes spinner {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
}

@keyframes spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Pulse Animation for Voice FAB */
.pulse-animation {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); /* Tailwind red-500 */
    animation: pulse-fab 2s infinite;
}

.pulse-animation.listening {
    animation: pulse-fab-active 1.5s infinite;
}

@keyframes pulse-fab {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

@keyframes pulse-fab-active {
    0% { transform: scale(1.0); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1.0); }
}

/* UI Animations */
.animate-slide-up-fade {
    animation: slideUpFade 0.5s ease-out;
}
@keyframes slideUpFade {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* Chore Item Interactions */
.chore-item:not(.opacity-60):hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    transform: scale(1.01);
}
.chore-item:not(.opacity-60):active {
    transform: scale(0.99);
}

.chore-item.completed-success {
    animation: successFlash 1s ease-out;
}
@keyframes successFlash {
    0% { background-color: #d1fae5; } /* green-100 */
    50% { background-color: #f0fdf4; } /* green-50 */
    100% { background-color: #ffffff; } /* white */
}


/* Drag and Drop Zone Highlighting */
.drop-zone {
    min-height: 50px;
}
.drop-zone.border-indigo-500 {
    border-color: #6366f1; /* Indigo-500 */
    background-color: #e0f2fe; /* Light blue tint for visual cue */
    transition: all 0.2s ease-in-out;
}

/* Form Container for Add Ad-Hoc Chore */
#ad-hoc-form-container {
    transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
}
</style>

<div id="app" class="h-full">
    <!-- Content rendered by JavaScript -->
</div>
