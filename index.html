<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Hub Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overscroll-behavior: none;
        }
        .app-bg {
            background-color: #f4f4f5; /* Light zinc background */
        }
        
        /* Sidebar Navigation */
        .nav-btn {
            @apply flex items-center p-3 md:p-4 w-full text-sm md:text-base font-medium text-slate-200 rounded-lg;
            @apply hover:bg-slate-700 hover:text-white transition-colors duration-150;
        }
        .nav-btn svg {
             /* Make icons white and slightly transparent when inactive */
            @apply w-6 h-6 text-white opacity-75 transition-colors duration-150; 
        }
        .nav-btn:hover svg, .nav-btn-active svg {
            @apply opacity-100; /* Fully opaque on hover/active */
        }
        .nav-btn-active {
            @apply bg-indigo-600 text-white shadow-inner;
        }
        .nav-btn-active svg {
             @apply opacity-100;
        }
        .nav-btn span {
            @apply ml-4 hidden md:inline;
        }

        /* Chore/Card Items */
        .chore-item {
            @apply bg-white rounded-lg shadow-sm p-4 flex items-center space-x-4 transition-all duration-150 cursor-grab;
        }
         /* Reward Item Styling */
        .reward-item {
            @apply bg-white rounded-lg shadow-sm p-4 flex flex-col items-center text-center transition-all duration-150 border-t-4;
            border-color: #f59e0b; /* Amber color for rewards */
        }
         .reward-item-affordable {
            @apply opacity-100;
        }
        .reward-item-unaffordable {
            @apply opacity-50 cursor-not-allowed;
        }
        .reward-item:hover {
             @apply shadow-md;
        }
        .chore-item:hover {
             @apply shadow-md;
        }
        .chore-item-completed {
            @apply opacity-50 line-through; 
        }
        .drag-ghost {
            position: absolute;
            pointer-events: none;
            opacity: 0.8;
            transform: scale(1.05);
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .drop-target-active {
            @apply ring-4 ring-indigo-400 ring-dashed;
        }

        /* Adhoc Form */
        #adhoc-chore-form {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            padding-top: 0; padding-bottom: 0; margin-top: 0;
        }
        #adhoc-chore-form.form-open {
            max-height: 500px; 
            @apply p-4 mt-4; 
        }

        /* Animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* Confetti */
        .confetti-particle {
            position: fixed; width: 10px; height: 10px; border-radius: 50%;
            pointer-events: none; z-index: 1000; opacity: 1;
            transition: transform 1s ease-out, opacity 1s ease-out;
        }

        /* Modals */
        .modal {
            @apply fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden; /* Ensure hidden initially */
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-xl p-6 max-w-sm w-full;
        }
        .assign-option {
            @apply block w-full text-left px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-indigo-100 hover:text-indigo-700;
        }
        /* Emoji Select */
        .emoji-select, .member-edit-emoji { /* Apply style to member emoji input too */
             @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-lg;
             padding-top: 0.3rem; padding-bottom: 0.3rem;
             text-align: center;
        }
        .member-edit-emoji { @apply w-16; } /* Specific width for member emoji input */

         /* Setup Sub-Navigation */
        .setup-subnav-btn {
            /* Added border for better button appearance */
            @apply px-4 py-2 rounded-md text-sm font-medium transition-colors duration-150 border border-transparent; 
        }
        .setup-subnav-btn-active {
            @apply bg-indigo-600 text-white border-indigo-700 shadow-sm;
        }
        .setup-subnav-btn-inactive {
             /* Added explicit border color for inactive */
            @apply text-gray-600 hover:bg-gray-200 border border-gray-300;
        }
         .setup-subnav-btn-inactive:hover {
             @apply border-gray-400; /* Darker border on hover */
         }
        .setup-subpage { @apply hidden; }
        .setup-subpage-active { @apply block; } /* Use block instead of removing hidden */

        /* Claimed Rewards */
        .claimed-reward-item {
            @apply flex justify-between items-center bg-slate-100 p-3 rounded-lg shadow-sm animate-fade-in-up;
        }
        /* Weekly schedule completed chore */
        .schedule-chore-completed {
             @apply line-through opacity-60;
        }

    </style>
</head>
<body class="h-full w-full overflow-hidden flex app-bg">

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="w-20 md:w-48 bg-slate-800 flex flex-col p-4 space-y-2 overflow-y-auto shadow-lg z-20">
        <!-- Logo/Title -->
        <div class="flex items-center justify-center md:justify-start p-2 md:p-4 mb-4">
             <span class="text-white text-3xl md:text-2xl font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 md:w-6 md:h-6 md:mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                </svg>              
            </span>
            <span class="hidden md:inline text-white text-xl font-bold">Family Hub</span>
        </div>

        <!-- Nav Buttons -->
        <button id="nav-daily-list" class="nav-btn nav-btn-active" onclick="changeTab('daily-list', 'Daily List & Assignments')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.375c.495 0 .742.656.375 1.007l-4.34 3.16a.563.563 0 0 0-.182.658l1.625 5.111a.563.563 0 0 1-.812.622l-4.34-3.16a.563.563 0 0 0-.658 0l-4.34 3.16a.563.563 0 0 1-.812-.622l1.625-5.111a.563.563 0 0 0-.182-.658l-4.34-3.16a.563.563 0 0 1 .375-1.007h5.375a.563.563 0 0 0 .475-.31l2.125-5.11Z" /></svg>
            <span>Daily List</span>
        </button>
        <button id="nav-weekly-schedule" class="nav-btn" onclick="changeTab('weekly-schedule', 'Weekly Schedule')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
            <span>Weekly Schedule</span>
        </button>
        <button id="nav-points" class="nav-btn" onclick="changeTab('points', 'Points & Rewards')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a2.25 2.25 0 0 1-2.25-2.25v-9A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 12.75h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5Z" /></svg>
            <span>Points & Rewards</span>
        </button>
        <button id="nav-setup" class="nav-btn" onclick="changeTab('setup', 'App Setup & Management')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>
            <span>Setup</span>
        </button>
        <!-- Calendar Button Removed -->

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden items-center space-x-2 mt-auto p-4">
            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm font-medium text-slate-300">Syncing...</span>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto">
        <div class="p-6 md:p-10">
            <!-- Content Header -->
            <h1 id="content-title" class="text-3xl font-bold text-slate-800 mb-8">Daily List & Assignments</h1>

            <!-- Daily List Tab -->
            <div id="content-daily-list" class="tab-content space-y-8">
                <!-- Date/Time Header -->
                <div id="daily-list-header" class="text-center mb-6 p-4 bg-white rounded-lg shadow-sm">
                    <div id="current-time" class="text-4xl font-bold text-indigo-600">--:-- --</div>
                    <div id="current-date" class="text-lg text-gray-600">Loading date...</div>
                </div>

                <!-- Active Assignments -->
                <div id="daily-assignments-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Member cards will be injected here -->
                </div>

                <!-- Unassigned Chores Pool -->
                <div id="unassigned-pool" class="bg-white rounded-lg shadow-sm border-t-4 border-yellow-400 p-4 drop-zone">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-yellow-800">Unassigned Chores Pool</h3>
                        <button id="toggle-adhoc-form" class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
                            <span class="text-2xl font-light">＋</span>
                        </button>
                    </div>

                    <!-- Adhoc Form (collapsible) -->
                    <form id="adhoc-chore-form" class="space-y-4 bg-slate-50 rounded-lg shadow-inner">
                        <h4 class="text-lg font-medium text-gray-700">Add One-Time Chore</h4>
                        <div>
                            <label for="adhoc-chore-name" class="block text-sm font-medium text-gray-700">Chore Name</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="adhoc-chore-name" class="flex-1 block w-full rounded-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Take out recycling">
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="adhoc-chore-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                <select id="adhoc-chore-emoji" class="emoji-select">
                                    <!-- Chore emoji options -->
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="adhoc-chore-points" class="block text-sm font-medium text-gray-700">Points</label>
                                <input type="number" id="adhoc-chore-points" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10">
                            </div>
                        </div>
                        <div>
                            <label for="adhoc-chore-assignee" class="block text-sm font-medium text-gray-700">Assign To</label>
                            <select id="adhoc-chore-assignee" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="unassigned">Unassigned</option>
                                <!-- Member options -->
                            </select>
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Chore
                        </button>
                    </form>

                    <!-- Unassigned Chores List -->
                    <div id="unassigned-chores-list" class="space-y-3 mt-4 min-h-[50px]">
                        <!-- Unassigned chores -->
                    </div>
                </div>

            </div>

            <!-- Weekly Schedule Tab -->
            <div id="content-weekly-schedule" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4" id="weekly-schedule-grid">
                        <!-- Weekly schedule cards -->
                    </div>
                </div>
            </div>

            <!-- Points & Rewards Tab -->
            <div id="content-points" class="tab-content hidden space-y-8">
                <!-- Member Point Totals -->
                <div>
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">Point Totals</h2>
                    <div id="point-totals-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Member point cards will be injected here -->
                    </div>
                </div>

                <!-- Redeem Rewards Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-slate-700 mb-6">Redeem Rewards</h2>
                    <div class="mb-6 max-w-sm mx-auto">
                        <label for="redeem-member-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Member to Redeem For:</label>
                        <select id="redeem-member-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="">-- Select Member --</option>
                            <!-- Member options -->
                        </select>
                    </div>
                    <div id="rewards-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Reward cards will be dynamically inserted here -->
                        <p id="no-rewards-msg" class="hidden col-span-full text-center text-gray-500">No rewards available.</p>
                    </div>
                    <div id="redeem-feedback" class="mt-6 text-center font-medium"></div>
                </div>

                <!-- Recently Claimed Rewards -->
                 <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-slate-700 mb-6">Recently Claimed (Pending Delivery)</h2>
                    <div id="claimed-rewards-list" class="space-y-3">
                         <p id="no-claimed-rewards-msg" class="text-center text-gray-500">No rewards have been claimed recently.</p>
                        <!-- Claimed rewards list items will be injected here -->
                    </div>
                </div>
            </div>


            <!-- Setup Tab -->
            <div id="content-setup" class="tab-content hidden">
                 <!-- Sub Navigation -->
                 <div class="mb-6 flex justify-center space-x-2 border-b pb-2">
                    <button id="setup-subnav-members" class="setup-subnav-btn setup-subnav-btn-active" onclick="changeSetupSubPage('members')">Members</button>
                    <button id="setup-subnav-chores" class="setup-subnav-btn setup-subnav-btn-inactive" onclick="changeSetupSubPage('chores')">Chores</button>
                    <button id="setup-subnav-rewards" class="setup-subnav-btn setup-subnav-btn-inactive" onclick="changeSetupSubPage('rewards')">Rewards</button>
                </div>

                <!-- Members Sub-Page -->
                 <div id="setup-subpage-members" class="setup-subpage setup-subpage-active space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-slate-700 mb-6">Add Family Member</h2>
                        <form id="add-member-form" class="space-y-4">
                            <div>
                                <label for="member-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="member-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                            </div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Add Member
                            </button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-slate-700 mb-6">Edit Members</h2>
                        <div id="edit-members-list" class="space-y-4">
                            <!-- Edit member cards -->
                        </div>
                    </div>
                </div>

                <!-- Chores Sub-Page -->
                 <div id="setup-subpage-chores" class="setup-subpage space-y-6">
                     <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-slate-700 mb-6">Create Reusable Chore</h2>
                        <form id="add-chore-form" class="space-y-4">
                            <div>
                                <label for="chore-name" class="block text-sm font-medium text-gray-700">Chore Name</label>
                                <input type="text" id="chore-name" class="mt-1 flex-1 block w-full rounded-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Feed Dog" required>
                            </div>
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label for="chore-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                    <select id="chore-emoji" class="emoji-select">
                                        <!-- Chore emoji options -->
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="chore-points" class="block text-sm font-medium text-gray-700">Points</label>
                                    <input type="number" id="chore-points" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Repeat on</label>
                                <div class="mt-2 grid grid-cols-4 sm:grid-cols-7 gap-2">
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="1"> <span>Mon</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="2"> <span>Tue</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="3"> <span>Wed</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="4"> <span>Thu</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="5"> <span>Fri</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="6"> <span>Sat</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" class="chore-day rounded text-indigo-600" value="0"> <span>Sun</span></label>
                                </div>
                            </div>
                            <div>
                                <label for="chore-assignee" class="block text-sm font-medium text-gray-700">Set Default Assignment</label>
                                <select id="chore-assignee" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="unassigned">Unassigned</option>
                                    <!-- Member options -->
                                </select>
                            </div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Create Chore
                            </button>
                        </form>
                    </div>
                     <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-slate-700 mb-6">Manage Reusable Chores</h2>
                        <div id="manage-chores-list" class="space-y-3">
                            <!-- Chores with delete buttons -->
                        </div>
                    </div>
                </div>

                 <!-- Rewards Sub-Page -->
                 <div id="setup-subpage-rewards" class="setup-subpage space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-slate-700 mb-6">Create Reward</h2>
                        <form id="add-reward-form" class="space-y-4">
                            <div>
                                <label for="reward-name" class="block text-sm font-medium text-gray-700">Reward Name</label>
                                <input type="text" id="reward-name" class="mt-1 flex-1 block w-full rounded-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Movie Night" required>
                            </div>
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label for="reward-emoji" class="block text-sm font-medium text-gray-700">Emoji</label>
                                    <select id="reward-emoji" class="emoji-select">
                                        <!-- Chore/Reward emoji options, default 🎉 -->
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="reward-cost" class="block text-sm font-medium text-gray-700">Point Cost</label>
                                    <input type="number" id="reward-cost" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="100" required>
                                </div>
                            </div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Create Reward
                            </button>
                        </form>
                    </div>
                     <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-slate-700 mb-6">Manage Available Rewards</h2>
                        <div id="manage-rewards-list" class="space-y-3">
                            <!-- Rewards with delete buttons -->
                        </div>
                    </div>
                </div>
            </div>

             <!-- Calendar Tab Content Removed -->
        </div>
    </main>

    <!-- Global Feedback Snackbar -->
    <div id="snackbar" class="hidden fixed bottom-10 right-10 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium z-50">
        Feedback message
    </div>

    <!-- FATAL ERROR MODAL -->
    <div id="fatal-error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full">
            <h2 class="text-3xl font-bold text-red-600 mb-4">FATAL ERROR</h2>
            <p class="text-lg text-gray-700 mb-2">Could not connect to Firebase.</p>
            <p class="text-sm text-gray-600 mb-6">This usually means your network is down, or the API keys in the code are incorrect, or you haven't enabled Authentication/Firestore in your Firebase Console.</p>
            <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm font-semibold text-gray-800">Error details:</p>
                <pre id="fatal-error-details" class="text-xs text-red-700 whitespace-pre-wrap font-mono mt-2"></pre>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="modal"> <!-- Added hidden class back -->
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Assign Chore To:</h3>
            <div id="assignment-options" class="space-y-1">
                <!-- Member options -->
            </div>
            <div class="mt-4 flex justify-end">
                <button id="cancel-assignment" type="button" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs, 
            runTransaction,
            arrayUnion,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START: PRE-CONFIGURED FIREBASE KEYS ---
        const firebaseConfig = {
          apiKey: "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M",
          authDomain: "family-hub-organizer.firebaseapp.com",
          projectId: "family-hub-organizer",
          storageBucket: "family-hub-organizer.firebasestorage.app",
          messagingSenderId: "468888595189",
          appId: "1:468888595189:web:eb6f33ee8e62cdc489b3bc"
        };
        const FIREBASE_APP_ID = "family-hub-organizer";
        // --- END: PRE-CONFIGURED FIREBASE KEYS ---


        // --- Global State ---
        let db;
        let auth;
        let userId;
        let currentTab = 'daily-list';
        let currentSetupSubPage = 'members'; // State for setup sub-page
        const ADMIN_PASSWORD = "3281555"; // Password for points modification
        let membersUnsubscribe = () => {};
        let choresUnsubscribe = () => {};
        let rewardsUnsubscribe = () => {};
        let completionsUnsubscribe = () => {}; // Now listens for the whole week
        let dateTimeInterval = null; // Interval for updating time display
        let synth; // Tone.js synth
        let paths; // Declare paths globally
        let audioContextStarted = false; // Flag for audio context

        let memberColors = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#d946ef'
        ];
        
        const choreEmojis = [
            '❓', '🧹', '🗑️', '🍽️', '🐶', '🐱', '🧺', '🛏️', '📚', '🌱', 
            '🚗', '📦', '✏️', '🧑‍🍳', '🛒', '♻️', '💡', '📫', '🧸', '🖥️', 
            '💧', '👟', '🧥', '🍁'
        ];
        const memberEmojis = [ // Keep this separate for member context if needed later
            '👤', '👑', '🦸', '🚀', '🦄', '🎨', '🎸', '⚽', '🧩', '🧠', 
            '🧑‍🔬', '🧑‍🚀', '🧑‍💻', '🧑‍🎨', '🧑‍🚒', '👮', '👷', '💡', '🌟', '❤️', 
            '🦖', '🦋', '🤖', '🎮' 
        ];

        let appData = {
            members: [],
            chores: [],
            rewards: [],
            completions: [], // Will now hold completions for the current week
            claimedRewards: [] // Store claimed rewards
        };
        // calendarDate removed
        let touchListenersAdded = false; 
        let currentChoreToAssign = null; 

        // --- DOM Elements ---
        // Add checks within functions using these to ensure they exist
        const loadingIndicator = document.getElementById('loading-indicator');
        const snackbar = document.getElementById('snackbar');
        const contentTitle = document.getElementById('content-title');
        const assignmentModal = document.getElementById('assignment-modal');
        const assignmentOptionsContainer = document.getElementById('assignment-options');
        const cancelAssignmentButton = document.getElementById('cancel-assignment');
        const redeemMemberSelector = document.getElementById('redeem-member-selector'); 
        const rewardsGrid = document.getElementById('rewards-grid'); 
        const noRewardsMsg = document.getElementById('no-rewards-msg');
        const redeemFeedbackEl = document.getElementById('redeem-feedback');
        const claimedRewardsList = document.getElementById('claimed-rewards-list');
        const noClaimedRewardsMsg = document.getElementById('no-claimed-rewards-msg');
        // Daily list elements might not exist immediately, get them inside render/update functions


        // --- Utility & Sound Functions ---
        
        function showLoading(label = 'Syncing...') {
            try {
                if (!loadingIndicator) return;
                loadingIndicator.querySelector('span').textContent = label;
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
            } catch (e) { console.error("showLoading failed:", e); }
        }

        function hideLoading() {
            try {
                if (!loadingIndicator) return;
                loadingIndicator.classList.add('hidden');
                loadingIndicator.classList.remove('flex');
            } catch (e) { console.error("hideLoading failed:", e); }
        }

        function showSnackbar(message, isError = false) {
            try {
                if (!snackbar) return;
                snackbar.textContent = message;
                snackbar.classList.remove('hidden', 'bg-red-600', 'bg-gray-900');
                snackbar.classList.add(isError ? 'bg-red-600' : 'bg-gray-900');
                setTimeout(() => {
                    snackbar.classList.add('hidden');
                }, 3000);
            } catch (e) { console.error("showSnackbar failed:", e); }
        }

        function showFatalError(message, error) {
            console.error(message, error);
            try {
                const detailsEl = document.getElementById('fatal-error-details');
                const modalEl = document.getElementById('fatal-error-modal');
                 if (detailsEl) detailsEl.textContent = error.toString();
                 if (modalEl) modalEl.classList.remove('hidden');
            } catch (e) { console.error("showFatalError failed:", e); }
        }

        // More robust date string function (YYYY-MM-DD)
        function getDateString(date) {
            try {
                // Use UTC methods to avoid timezone shifts affecting the date itself
                const year = date.getUTCFullYear();
                const month = (date.getUTCMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
                const day = date.getUTCDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                 console.error("getDateString failed:", e);
                 // Fallback using current local date if UTC fails
                 const localDate = new Date();
                 const year = localDate.getFullYear();
                 const month = (localDate.getMonth() + 1).toString().padStart(2, '0');
                 const day = localDate.getDate().toString().padStart(2, '0');
                 return `${year}-${month}-${day}`;
            }
        }
        function getTodayString() {
             return getDateString(new Date());
        }


        function createConfetti(x, y, color) { /* ... unchanged ... */ }

        async function startAudioContext() {
            if (!audioContextStarted && typeof Tone !== 'undefined' && Tone.context && Tone.context.state !== 'running') {
                 try {
                     await Tone.start();
                     audioContextStarted = true;
                     console.log("AudioContext started by user interaction.");
                 } catch (e) { console.error("Error starting AudioContext:", e); }
            } else if (typeof Tone === 'undefined' || !Tone.context) {
                 console.warn("Tone.js or AudioContext not available.");
            }
        }

        function initializeSounds() {
            try {
                if (typeof Tone !== 'undefined' && Tone.Synth) {
                    synth = new Tone.Synth().toDestination();
                    console.log("Tone.js synth initialized.");
                    document.body.addEventListener('click', startAudioContext, { once: true, capture: true }); 
                    document.body.addEventListener('touchend', startAudioContext, { once: true, capture: true }); 
                } else { console.warn("Tone.js not loaded. Sound effects disabled."); }
            } catch (e) { console.error("initializeSounds failed:", e); }
        }

        function playSound(note = 'C4', duration = '8n') {
             if (synth && audioContextStarted && Tone.context.state === 'running') {
                try {
                    synth.triggerAttackRelease(note, duration, Tone.now()); 
                } catch (error) { console.error("Error playing sound:", error); }
            } else {
                 console.warn("Cannot play sound - Synth not ready or AudioContext not running.", {synth, audioContextStarted, state: Tone?.context?.state});
                 if (!audioContextStarted && typeof Tone !== 'undefined') { startAudioContext(); }
            }
        }
        
         function playSoundSequence(notes = ['C4', 'E4', 'G4', 'C5'], duration = '8n', delayBetween = 0.1) {
            if (synth && audioContextStarted && Tone.context.state === 'running') {
                try {
                    const now = Tone.now();
                    notes.forEach((note, index) => {
                         synth.triggerAttackRelease(note, duration, now + index * delayBetween);
                    });
                } catch (error) { console.error("Error playing sound sequence:", error); }
            } else {
                 console.warn("Cannot play sound sequence - Synth not ready or AudioContext not running.");
                  if (!audioContextStarted && typeof Tone !== 'undefined') { startAudioContext(); }
            }
        }


        // --- Emoji Select Populator ---
        function populateEmojiSelect(selectElement, emojis, defaultEmoji = '❓') {
             try {
                if (!selectElement) {
                     // console.warn("populateEmojiSelect: Element not found."); // Reduce noise
                     return;
                }
                let optionsList = emojis.includes(defaultEmoji) ? [...emojis] : [defaultEmoji, ...emojis];
                if (emojis.includes(defaultEmoji)) {
                    optionsList = [defaultEmoji, ...emojis.filter(e => e !== defaultEmoji)];
                }
                
                selectElement.innerHTML = optionsList.map(emoji => 
                    `<option value="${emoji}">${emoji}</option>`
                ).join('');
                selectElement.value = defaultEmoji;
             } catch (e) { console.error("populateEmojiSelect failed:", e, selectElement?.id); }
        }

        // --- Date/Time Header Update ---
        function updateDateTimeHeader() {
            try {
                // Get elements *inside* the function for robustness
                const timeEl = document.getElementById('current-time');
                const dateEl = document.getElementById('current-date');
                if (currentTab !== 'daily-list' || !timeEl || !dateEl) return; 
                
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) { console.error("updateDateTimeHeader failed:", e); }
        }


        // --- Firestore Initialization ---
        async function initializeFirebase() {
             console.log("Initializing Firebase..."); // Log start
            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                 // *** Define paths object HERE, after db is initialized ***
                 paths = {
                    members: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/members`),
                    member: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/members`, id),
                    chores: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/chores`),
                    chore: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/chores`, id),
                    rewards: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/rewards`),
                    reward: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/rewards`, id),
                    completions: () => collection(db, `artifacts/${FIREBASE_APP_ID}/public/data/completions`),
                    completion: (id) => doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/completions`, id),
                };
                 console.log("Paths object defined:", paths); // Log paths definition
                // *** End paths definition ***

                initializeSounds(); 

                console.log("Setting up Auth listener..."); // Log before listener
                onAuthStateChanged(auth, (user) => {
                    console.log("Auth state changed. User:", user ? user.uid : 'null'); // Log auth change
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Success. UserID:", userId);
                        setupFirestoreListeners(); 
                        
                        updateDateTimeHeader();
                        if (dateTimeInterval) clearInterval(dateTimeInterval);
                        dateTimeInterval = setInterval(updateDateTimeHeader, 1000); 

                    } else {
                        console.log("No user signed in, signing in anonymously...");
                        signInAnonymously(auth).catch((error) => {
                            showFatalError("Anonymous sign-in failed.", error);
                        });
                    }
                });

            } catch (error) {
                showFatalError("Firebase initialization failed.", error);
            }
        }

        // --- Firestore Data Paths (REMOVED - defined in initializeFirebase) ---

        // --- Firestore Listeners (Updated Completions Listener) ---
        function setupFirestoreListeners() {
            console.log("Setting up Firestore listeners..."); // Log start
            // Wrap the entire function body for safety
             try {
                showLoading('Loading data...');
                // Unsubscribe previous listeners if they exist
                if (typeof membersUnsubscribe === 'function') membersUnsubscribe();
                if (typeof choresUnsubscribe === 'function') choresUnsubscribe();
                if (typeof rewardsUnsubscribe === 'function') rewardsUnsubscribe();
                if (typeof completionsUnsubscribe === 'function') completionsUnsubscribe();

                // *** Defensive Check for paths object ***
                if (typeof paths !== 'object' || paths === null || typeof paths.members !== 'function') {
                     throw new Error("Internal Error: paths object not correctly defined before setting listeners.");
                }
                console.log("Paths object confirmed before listeners."); // Log confirmation

                // Members
                membersUnsubscribe = onSnapshot(paths.members(), (snapshot) => {
                    appData.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Members updated:", appData.members);
                    renderAll();
                    hideLoading(); 
                }, (error) => { console.error("Error listening to members:", error); hideLoading(); });

                // Chores
                choresUnsubscribe = onSnapshot(paths.chores(), (snapshot) => {
                    appData.chores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Chores updated:", appData.chores);
                    renderAll();
                }, (error) => console.error("Error listening to chores:", error));

                // Rewards
                rewardsUnsubscribe = onSnapshot(paths.rewards(), (snapshot) => {
                    appData.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Rewards updated:", appData.rewards);
                    appData.claimedRewards = appData.rewards.filter(r => r.claimed === true && r.delivered !== true);
                    renderAll();
                }, (error) => console.error("Error listening to rewards:", error));

                // Completions (Listen for the CURRENT WEEK)
                 const todayJsDayIndex = new Date().getDay(); // 0 for Sunday
                 const startOfWeek = new Date();
                 startOfWeek.setUTCDate(startOfWeek.getUTCDate() - todayJsDayIndex); // Use UTC days
                 startOfWeek.setUTCHours(0, 0, 0, 0); // Use UTC hours
                 const startOfWeekStr = getDateString(startOfWeek); 

                 const endOfWeek = new Date(startOfWeek);
                 endOfWeek.setUTCDate(endOfWeek.getUTCDate() + 6); // Use UTC days
                 endOfWeek.setUTCHours(23, 59, 59, 999); // Use UTC hours
                 const endOfWeekStr = getDateString(endOfWeek); 

                 console.log(`Listening for completions between ${startOfWeekStr} and ${endOfWeekStr}`); 

                const qCompletions = query(paths.completions(), 
                    where("date", ">=", startOfWeekStr),
                    where("date", "<=", endOfWeekStr) 
                );
                completionsUnsubscribe = onSnapshot(qCompletions, (snapshot) => {
                    appData.completions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Weekly Completions updated via listener:", appData.completions);
                    renderAll(); // Re-render everything that depends on completions
                }, (error) => console.error("Error listening to weekly completions:", error));

            } catch (error) {
                showFatalError("Failed to set up Firestore listeners.", error);
                hideLoading();
            }
        }

        // --- Render Functions ---
        
        function renderAll() {
             console.log("renderAll called. Current Tab:", currentTab); // Log start
            // Added check for DOM elements readiness
            if (!db || !document.getElementById('daily-assignments-grid') || !document.getElementById('content-setup')) {
                 console.warn("renderAll called before DOM ready or Firebase init.");
                 return; 
            }
            
            // Wrap in try...catch
            try {
                renderMemberOptions(); 
                if (appData.members.length > 0) {
                     console.log("Rendering tab content for:", currentTab); // Log tab render
                     if (currentTab === 'daily-list') renderDailyList();
                     else if (currentTab === 'weekly-schedule') renderWeeklyScheduleWithCurrentData(); 
                     else if (currentTab === 'points') renderPointsAndRewards();
                     else if (currentTab === 'setup') renderSetup(); 
                     // Calendar rendering removed
                } else if (currentTab !== 'setup') {
                    console.log("No members, forcing setup tab.");
                    changeTab('setup', 'App Setup & Management'); 
                    showSnackbar("Add family members to get started!", false);
                } else {
                     console.log("Rendering setup tab (no members).");
                     renderSetup(); // Render setup even if no members
                }
                 console.log("renderAll finished."); // Log end
            } catch (error) {
                console.error("RenderAll failed:", error);
                showSnackbar("Error updating the view. Check console.", true);
            }
        }

        function renderMemberOptions() {
             try {
                const selects = document.querySelectorAll('select[id$="-assignee"], select#redeem-member-selector'); 
                const sortedMembers = [...appData.members].sort((a, b) => a.name.localeCompare(b.name));
                
                selects.forEach(select => {
                    if (!select) return; // Add check for element
                    const currentValue = select.value;
                    let options = '';
                    
                    if (select.id === 'redeem-member-selector') {
                        options += '<option value="">-- Select Member --</option>';
                    } else if (select.id.includes('adhoc') || select.id.includes('chore')) {
                        options = '<option value="unassigned">Unassigned</option>';
                    }

                    sortedMembers.forEach(member => {
                        options += `<option value="${member.id}" ${member.id === currentValue ? 'selected' : ''}>
                            ${member.emoji || ''} ${member.name}
                        </option>`;
                    });
                    select.innerHTML = options;

                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                });
             } catch (e) { console.error("renderMemberOptions failed:", e); }
        }

        // --- Daily List Tab ---
        function renderDailyList() {
             console.log("Rendering Daily List..."); // Log start
            try {
                const grid = document.getElementById('daily-assignments-grid');
                const unassignedList = document.getElementById('unassigned-chores-list');
                if (!grid || !unassignedList) {
                     console.warn("Daily list elements not found.");
                     return; 
                }
                grid.innerHTML = '';
                unassignedList.innerHTML = '';

                const todayJsDay = new Date().getDay(); // 0 = Sun
                const todayStr = getTodayString();
                
                // Use appData.completions filtered for today
                const todaysCompletions = appData.completions.filter(c => c.date === todayStr); 
                const recurringChores = appData.chores.filter(chore => chore.schedule.includes(todayJsDay.toString()));
                const allTasksForToday = [];

                // Add recurring
                recurringChores.forEach(chore => {
                    const completion = todaysCompletions
                        .filter(c => c.choreDefId === chore.id)
                        .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0]; 

                    allTasksForToday.push({
                        id: completion ? completion.id : `temp_${chore.id}`,
                        choreDefId: chore.id, name: chore.name, emoji: chore.emoji, points: chore.points,
                        assigneeId: completion ? completion.assigneeId : chore.defaultAssignee,
                        isComplete: completion ? completion.isComplete : false,
                        isAdhoc: false,
                        completionDocId: completion ? completion.id : null
                    });
                });

                // Add ad-hoc (from today's completions only)
                todaysCompletions.forEach(completion => {
                    if (completion.isAdhoc && !allTasksForToday.find(t => t.id === completion.id)) {
                        allTasksForToday.push({
                            id: completion.id, choreDefId: null, name: completion.name, emoji: completion.emoji,
                            points: completion.points, assigneeId: completion.assigneeId, 
                            isComplete: completion.isComplete, isAdhoc: true, completionDocId: completion.id
                        });
                    }
                });

                // Create member cards
                appData.members.forEach(member => {
                    const memberCard = document.createElement('div');
                    memberCard.className = 'bg-white rounded-lg shadow-sm border-t-4 p-4 drop-zone transition-all duration-150 animate-fade-in-up';
                    memberCard.dataset.memberId = member.id;
                    memberCard.style.borderColor = member.color || '#ccc';
                    
                    memberCard.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-slate-700">
                                ${member.emoji || ''} ${member.name}
                            </h3>
                            <span class="font-bold text-lg" style="color: ${member.color || '#111'}">
                                ${member.points || 0} pts
                            </span>
                        </div>
                        <div class="space-y-3 min-h-[50px]"></div>
                    `;
                     if (grid) grid.appendChild(memberCard);
                });

                // Populate chores
                allTasksForToday.forEach(task => {
                    const choreHTML = createChoreItemHTML(task);
                    let targetList;
                    
                    if (task.assigneeId && task.assigneeId !== 'unassigned') {
                        const memberCard = grid?.querySelector(`[data-member-id="${task.assigneeId}"]`);
                        targetList = memberCard ? memberCard.querySelector('.space-y-3') : null;
                    }
                    
                    if (!targetList) {
                        targetList = unassignedList;
                    }
                     if (targetList) {
                        targetList.insertAdjacentHTML('beforeend', choreHTML);
                     } else {
                         console.warn("Could not find target list for chore:", task);
                     }
                });

                addTouchDragListeners();
                 console.log("Daily List rendering finished."); // Log end
            } catch (e) { console.error("renderDailyList failed:", e); }
        }

        function createChoreItemHTML(task) {
             try {
                const completedClass = task.isComplete ? 'chore-item-completed' : '';
                 const currentAssignee = task.assigneeId || 'unassigned'; 
                return `
                    <div class="chore-item ${completedClass} animate-fade-in-up" 
                         draggable="true" 
                         data-task-id="${task.id}" 
                         data-chore-def-id="${task.choreDefId || 'null'}"
                         data-completion-doc-id="${task.completionDocId || 'null'}"
                         data-is-adhoc="${task.isAdhoc}"
                         data-is-complete="${task.isComplete}"
                         data-name="${task.name}"
                         data-emoji="${task.emoji}"
                         data-points="${task.points}"
                         data-current-assignee="${currentAssignee}"> 
                        
                        <div class="flex items-center space-x-4 flex-1">
                            <button class="chore-complete-btn text-3xl p-2 -ml-2 rounded-full transition-transform transform hover:scale-125"
                                    data-is-complete="${task.isComplete}" 
                                    data-points="${task.points}">
                                ${task.isComplete ? '✅' : task.emoji}
                            </button>
                            <div class="flex-1">
                                <span class="font-medium">${task.name}</span>
                                <span class="block text-sm text-gray-500">${task.points} points</span>
                            </div>
                        </div>
                        
                        <button class="assign-chore-btn p-2 text-slate-400 hover:text-indigo-600 rounded-full hover:bg-indigo-100">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                            </svg>
                        </button>
                    </div>
                `;
             } catch (e) { 
                 console.error("createChoreItemHTML failed:", e, task); 
                 return '<div class="text-red-500">Error rendering chore</div>'; // Fallback
             }
        }

        // --- Weekly Schedule Tab (Uses UPDATED appData.completions) ---
        function renderWeeklyScheduleWithCurrentData() {
             console.log("Rendering Weekly Schedule..."); // Log start
             try {
                const grid = document.getElementById('weekly-schedule-grid');
                 if (!grid) {
                     console.warn("Weekly schedule grid not found.");
                     return;
                 }
                grid.innerHTML = '';
                 const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                 const todayJsDayIndex = new Date().getDay(); // 0 for Sunday
                
                const startOfWeek = new Date();
                 startOfWeek.setUTCDate(startOfWeek.getUTCDate() - todayJsDayIndex); // Use UTC days
                 startOfWeek.setUTCHours(0, 0, 0, 0); // Use UTC hours

                // Use the appData.completions array which now holds the whole week's data
                const weeklyCompletionsFromAppData = appData.completions; 
                console.log("Weekly Schedule using Completions from AppData:", weeklyCompletionsFromAppData); 

                for (let i = 0; i < 7; i++) { // Loop Sunday (0) to Saturday (6)
                    const dayIndexStr = i.toString(); // Day index for schedule check (0-6)
                    const dayDate = new Date(startOfWeek);
                    dayDate.setUTCDate(startOfWeek.getUTCDate() + i); // Use UTC days
                     const dayDateStr = getDateString(dayDate); // UTC YYYY-MM-DD
                    
                    const dayCard = document.createElement('div');
                    const isToday = i === todayJsDayIndex;
                    dayCard.className = `rounded-lg p-3 animate-fade-in-up ${isToday ? 'bg-indigo-100 border-2 border-indigo-400' : 'bg-slate-50 border'}`;
                    
                    let choresHTML = '';
                    const completionsForThisDay = weeklyCompletionsFromAppData.filter(c => c.date === dayDateStr) || []; 
                    console.log(`Rendering Day ${i} (${days[i]}, ${dayDateStr}), Completions:`, completionsForThisDay.length); // Log day rendering

                    // --- Recurring Chores for this day ---
                    appData.chores
                        .filter(c => c.schedule.includes(dayIndexStr))
                        .forEach(c => {
                            const completion = completionsForThisDay
                                .filter(comp => comp.choreDefId === c.id)
                                .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0]; 
                             console.log(` - Recurring: ${c.name}, Completion found:`, !!completion); // Log recurring check
                            choresHTML += getScheduleChoreHTML(c, false, completion); 
                        });
                    
                    // --- Ad-hoc Chores for this day (from the filtered list) ---
                    completionsForThisDay
                        .filter(c => c.isAdhoc) 
                        .forEach(c => {
                             console.log(` - Adhoc: ${c.name}, Date: ${c.date}`); // Log adhoc check
                            choresHTML += getScheduleChoreHTML(c, true, c); 
                        });

                    dayCard.innerHTML = `
                        <h4 class="font-bold text-center text-gray-700 mb-3 ${isToday ? 'text-indigo-700' : ''}">${days[i]}</h4>
                        <div class="space-y-2">
                            ${choresHTML || '<div class="text-xs text-center text-gray-400">No chores</div>'}
                        </div>
                    `;
                    grid.appendChild(dayCard);
                }
                 console.log("Weekly Schedule rendering finished."); // Log end
            } catch (e) { console.error("renderWeeklyScheduleWithCurrentData failed:", e); }
        }

        // --- getScheduleChoreHTML (no changes needed) ---
        function getScheduleChoreHTML(choreData, isAdhoc = false, completion = null) {
            try {
                const assigneeId = isAdhoc ? choreData.assigneeId : choreData.defaultAssignee;
                const member = appData.members.find(m => m.id === assigneeId);
                const color = member ? member.color : '#9ca3af';
                const memberName = member ? member.name.split(' ')[0] : (assigneeId === 'unassigned' ? 'Un...' : '???'); 
                const memberEmoji = member ? member.emoji : '⚪'; 
                const isComplete = completion?.isComplete; 
                const completedClass = isComplete ? 'schedule-chore-completed' : ''; 

                return `
                    <div class="rounded-md p-2 text-xs ${completedClass}" style="background-color: ${color}20; border-left: 4px solid ${color};">
                        <div class="font-medium text-gray-800">${choreData.emoji} ${choreData.name} ${isAdhoc ? '(One-Time)' : ''}</div>
                        <div class="text-gray-600 flex justify-end items-center" style="color: ${color};">
                            <span class="font-semibold mr-1">${memberName}</span>
                            ${memberEmoji}
                        </div>
                    </div>
                `;
            } catch(e) {
                 console.error("getScheduleChoreHTML failed:", e, choreData);
                 return '<div class="text-red-500 text-xs">Error</div>';
            }
        }


       // --- Points & Rewards Tab ---
        function renderPointsAndRewards() { 
             console.log("Rendering Points & Rewards..."); // Log start
             try {
                const pointsGrid = document.getElementById('point-totals-grid');
                // Check elements before proceeding
                if (!pointsGrid || !rewardsGrid || !claimedRewardsList || !noRewardsMsg || !noClaimedRewardsMsg) {
                    console.warn("Points & Rewards elements not found.");
                    return;
                }
                
                pointsGrid.innerHTML = ''; 
                rewardsGrid.innerHTML = ''; 
                if(redeemFeedbackEl) redeemFeedbackEl.textContent = ''; 
                claimedRewardsList.innerHTML = ''; 

                // Render Member Point Totals
                [...appData.members].sort((a,b) => b.points - a.points).forEach(member => {
                    pointsGrid.innerHTML += `
                        <div class="rounded-lg p-4 shadow-sm text-center animate-fade-in-up bg-white border-t-4" style="border-color: ${member.color};">
                            <div class="text-3xl mb-2">${member.emoji || '👤'}</div>
                            <div class="font-semibold text-lg text-slate-700">${member.name}</div>
                            <div class="font-bold text-3xl" style="color: ${member.color};">${member.points}</div>
                            <div class="text-sm text-gray-500">points</div>
                        </div>
                    `;
                });

                // Render Redeemable Reward Cards
                const availableRewards = appData.rewards.filter(r => !r.claimed && !r.delivered); 
                const selectedMemberId = redeemMemberSelector?.value; // Null check
                const selectedMember = appData.members.find(m => m.id === selectedMemberId);
                const memberPoints = selectedMember ? selectedMember.points : -1;

                if (availableRewards.length === 0) {
                    noRewardsMsg.classList.remove('hidden');
                } else {
                    noRewardsMsg.classList.add('hidden');
                    availableRewards.forEach(reward => {
                        const canAfford = selectedMember && memberPoints >= reward.cost;
                        const cardClass = canAfford ? 'reward-item-affordable' : 'reward-item-unaffordable';
                        
                        rewardsGrid.innerHTML += `
                            <div class="reward-item ${cardClass} animate-fade-in-up" data-reward-id="${reward.id}" data-cost="${reward.cost}">
                                <div class="text-4xl mb-2">${reward.emoji}</div>
                                <div class="font-medium text-sm text-slate-700 mb-1">${reward.name}</div>
                                <div class="font-bold text-amber-600 mb-3">${reward.cost} pts</div>
                                <button class="redeem-btn text-xs py-1 px-3 rounded-full ${canAfford ? 'bg-green-500 hover:bg-green-600 text-white cursor-pointer' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}" 
                                        ${!canAfford ? 'disabled' : ''}
                                        data-reward-id="${reward.id}"
                                        data-cost="${reward.cost}">
                                    Redeem
                                </button>
                            </div>
                        `;
                    });
                }
                 if(rewardsGrid) attachRedeemButtonListeners(); // Attach only if grid exists

                // Render Claimed (but not delivered) Rewards List
                 // Use the filtered appData.claimedRewards
                if (appData.claimedRewards.length === 0) {
                     noClaimedRewardsMsg.classList.remove('hidden');
                 } else {
                     noClaimedRewardsMsg.classList.add('hidden');
                     const sortedClaimed = [...appData.claimedRewards].sort((a, b) => (b.claimedAt?.seconds || 0) - (a.claimedAt?.seconds || 0));
                     sortedClaimed.forEach(reward => {
                         const claimedByMember = appData.members.find(m => m.id === reward.claimedBy);
                         claimedRewardsList.innerHTML += `
                             <div class="claimed-reward-item">
                                 <div>
                                     <span class="text-xl mr-2">${reward.emoji}</span>
                                     <span class="font-medium">${reward.name}</span>
                                     <span class="text-sm text-gray-600 ml-2">(Claimed by: ${claimedByMember?.name || 'Unknown'})</span>
                                 </div>
                                 <button class="mark-delivered-btn text-xs py-1 px-3 rounded-full bg-blue-500 hover:bg-blue-600 text-white" 
                                         data-reward-id="${reward.id}">
                                     Mark Delivered
                                 </button>
                             </div>
                         `;
                     });
                 }
                 if (claimedRewardsList) attachDeliveredButtonListeners(); // Attach only if list exists
                  console.log("Points & Rewards rendering finished."); // Log end
            } catch (e) { console.error("renderPointsAndRewards failed:", e); }
        }

        // --- Setup Tab ---
        function renderSetup() { 
             console.log("Rendering Setup Tab for subpage:", currentSetupSubPage); // Log start
             try {
                const editList = document.getElementById('edit-members-list');
                const manageChoresList = document.getElementById('manage-chores-list');
                const manageRewardsList = document.getElementById('manage-rewards-list');

                // Sub-page Visibility (Corrected Logic)
                 const pages = ['members', 'chores', 'rewards'];
                 pages.forEach(pageId => {
                     const pageEl = document.getElementById(`setup-subpage-${pageId}`);
                     const navBtnEl = document.getElementById(`setup-subnav-${pageId}`);
                     if (pageEl && navBtnEl) {
                         if (pageId === currentSetupSubPage) {
                             pageEl.classList.add('setup-subpage-active');
                             pageEl.classList.remove('hidden'); 
                             navBtnEl.classList.add('setup-subnav-btn-active');
                             navBtnEl.classList.remove('setup-subnav-btn-inactive');
                         } else {
                             pageEl.classList.remove('setup-subpage-active');
                             pageEl.classList.add('hidden'); 
                             navBtnEl.classList.remove('setup-subnav-btn-active');
                             navBtnEl.classList.add('setup-subnav-btn-inactive');
                         }
                     } else {
                          console.warn(`Missing elements for setup subpage or nav button: ${pageId}`);
                     }
                 });

                // Render Content based on Sub-page
                if (currentSetupSubPage === 'members') {
                    if (!editList) return; 
                    editList.innerHTML = appData.members.map(member => `
                        <div class="bg-slate-50 p-4 rounded-lg border-t-4 animate-fade-in-up" style="border-color: ${member.color};">
                            <div class="flex items-center space-x-3 mb-4">
                                <input type="text" value="${member.emoji || '👤'}" class="member-edit-emoji emoji-select w-16" data-member-id="${member.id}">
                                <input type="text" value="${member.name}" class="member-edit-name flex-1 p-1 border rounded" data-member-id="${member.id}">
                                <select class="member-edit-color p-1 border rounded" data-member-id="${member.id}">
                                    ${memberColors.map(color => `<option value="${color}" ${member.color === color ? 'selected' : ''} style="background: ${color}; color: ${color};">Color</option>`).join('')}
                                    <option value="#888888" ${!memberColors.includes(member.color) ? 'selected' : ''}>Default</option>
                                </select>
                            </div>
                             <!-- Points Modification (Password Protected) -->
                             <div class="mt-4 pt-4 border-t border-gray-200">
                                 <label class="block text-sm font-medium text-gray-700">Current Points: ${member.points}</label>
                                 <div class="flex items-center space-x-2 mt-1">
                                    <input type="number" placeholder="New points" class="member-edit-points p-1 border rounded w-24" data-member-id="${member.id}">
                                    <button class="member-save-points-btn text-xs py-1 px-2 rounded bg-orange-500 text-white hover:bg-orange-600" data-member-id="${member.id}">Set Points (Admin)</button>
                                 </div>
                             </div>
                            <div class="flex space-x-2 mt-4">
                                <button class="member-save-btn flex-1 text-sm py-1 px-2 rounded bg-green-500 text-white hover:bg-green-600" data-member-id="${member.id}">Save Changes</button>
                                <button class="member-delete-btn flex-1 text-sm py-1 px-2 rounded bg-red-500 text-white hover:bg-red-600" data-member-id="${member.id}">Delete Member</button>
                            </div>
                        </div>
                    `).join('');
                } else if (currentSetupSubPage === 'chores') {
                     if (!manageChoresList) return; 
                     manageChoresList.innerHTML = '<h3 class="text-lg font-medium text-gray-700 mb-2">Reusable Chores</h3>' + 
                        appData.chores.map(chore => {
                            const scheduleDays = chore.schedule.map(d => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]).join(', ');
                            const assignee = appData.members.find(m => m.id === chore.defaultAssignee);
                            const assigneeText = assignee ? `${assignee.emoji} ${assignee.name}` : 'Unassigned';
                            return `
                                <div class="flex justify-between items-center bg-slate-50 p-3 rounded shadow-sm animate-fade-in-up border-l-4 border-gray-300">
                                    <div>
                                        <span class="text-xl mr-2">${chore.emoji}</span>
                                        <span class="font-medium">${chore.name}</span>
                                        <span class="block text-xs text-gray-500 ml-8">
                                            ${chore.points} pts | ${scheduleDays || 'Not scheduled'} | Default: ${assigneeText}
                                        </span>
                                    </div>
                                    <button class="chore-delete-btn text-red-500 hover:text-red-700 p-1" data-id="${chore.id}">
                                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                    </button>
                                </div>
                            `;
                        }).join('');
                     if(appData.chores.length === 0) manageChoresList.innerHTML += '<p class="text-sm text-gray-500">No reusable chores created yet.</p>';
                } else if (currentSetupSubPage === 'rewards') {
                    if (!manageRewardsList) return; 
                    manageRewardsList.innerHTML = '<h3 class="text-lg font-medium text-gray-700 mb-2">Available Rewards</h3>' + 
                        appData.rewards.filter(r => !r.claimed && !r.delivered).map(reward => `
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded shadow-sm animate-fade-in-up border-l-4 border-amber-400">
                            <div>
                                <span class="text-xl mr-2">${reward.emoji}</span>
                                <span class="font-medium">${reward.name}</span>
                                <span class="block text-xs text-amber-600 font-semibold ml-8">${reward.cost} points</span>
                            </div>
                            <button class="reward-delete-btn text-red-500 hover:text-red-700 p-1" data-id="${reward.id}">
                                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                            </button>
                        </div>
                    `).join('');
                    if(appData.rewards.filter(r => !r.claimed && !r.delivered).length === 0) manageRewardsList.innerHTML += '<p class="text-sm text-gray-500">No rewards created yet.</p>';
                }
                 console.log("Setup tab rendering finished."); // Log end
            } catch (e) { console.error("renderSetup failed:", e); }
        }

        // --- Calendar Tab Function Removed ---


        // --- Event Handlers ---

        // Tab Navigation
        function changeTab(tabId, title) {
             console.log("Changing tab to:", tabId); // Log tab change
             // Wrap in try...catch
            try {
                 // Check if the sidebar button exists before proceeding
                 const navBtnEl = document.getElementById(`nav-${tabId}`);
                 if (!navBtnEl) {
                      console.error(`Nav button element not found for tab: ${tabId}`);
                      return; // Prevent changing if button doesn't exist
                 }

                currentTab = tabId;
                // Hide all content tabs first
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                // Show the selected one
                const contentEl = document.getElementById(`content-${tabId}`);
                 if (contentEl) {
                     contentEl.classList.remove('hidden');
                 } else {
                     console.error(`Content element not found for tab: ${tabId}`);
                     return; // Stop if content area doesn't exist
                 }
                
                // Update sidebar button styles
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('nav-btn-active'));
                 navBtnEl.classList.add('nav-btn-active'); // We know it exists now


                // Update title
                if (contentTitle) {
                     contentTitle.textContent = title;
                }
                
                // Trigger render for the newly active tab if necessary
                renderAll(); // Re-render content after changing tab
                
                // Special case for time header
                if (tabId === 'daily-list') updateDateTimeHeader();
            } catch (e) { console.error("changeTab failed:", e, tabId); }
        }

        // Setup Sub-Page Navigation
        function changeSetupSubPage(subPageId) { 
             console.log("Changing setup subpage to:", subPageId); // Log
             try {
                currentSetupSubPage = subPageId;
                renderSetup(); // Re-render the setup tab content
            } catch (e) { console.error("changeSetupSubPage failed:", e, subPageId); }
        }

        // Toggle Adhoc Form
        const toggleAdhocBtn = document.getElementById('toggle-adhoc-form');
         if (toggleAdhocBtn) {
             toggleAdhocBtn.addEventListener('click', (e) => {
                try {
                    const form = document.getElementById('adhoc-chore-form');
                    const button = e.currentTarget; 
                    const icon = button.querySelector('span');
                    if (!form || !icon) return; // Add checks
                    form.classList.toggle('form-open');
                    if (form.classList.contains('form-open')) {
                        icon.textContent = '✕'; 
                        button.classList.add('rotate-180'); 
                    } else {
                        icon.textContent = '＋';
                        button.classList.remove('rotate-180');
                    }
                } catch (e) { console.error("toggle-adhoc-form click failed:", e); }
            });
         }


        // Add Member
        const addMemberForm = document.getElementById('add-member-form');
         if (addMemberForm) addMemberForm.addEventListener('submit', async (e) => { /* ... unchanged ... */ }); 

        // Edit/Delete/Modify Points Member (with delegation)
        const editMembersListContainer = document.getElementById('edit-members-list');
        if (editMembersListContainer) { /* ... unchanged ... */ }


        // Add Reusable Chore
         const addChoreForm = document.getElementById('add-chore-form');
         if (addChoreForm) addChoreForm.addEventListener('submit', async (e) => { /* ... unchanged ... */ }); 

        // Add One-Time (Adhoc) Chore
         const adhocChoreForm = document.getElementById('adhoc-chore-form');
         if (adhocChoreForm) adhocChoreForm.addEventListener('submit', async (e) => { /* ... unchanged ... */ }); 

        // Delete Chore/Reward (Using delegation on Setup content)
        const setupContent = document.getElementById('content-setup');
         if(setupContent){ /* ... unchanged ... */ }


        // Add Reward
         const addRewardForm = document.getElementById('add-reward-form');
         if (addRewardForm) addRewardForm.addEventListener('submit', async (e) => { /* ... unchanged ... */ }); 

        // --- Redeem Reward Logic ---
        if (redeemMemberSelector) redeemMemberSelector.addEventListener('change', () => { /* ... unchanged ... */ }); // Add null check
        function attachRedeemButtonListeners() { /* ... unchanged ... */ }
        async function handleRedeemClick(e) { /* ... unchanged ... */ }

        // --- Mark Reward Delivered Logic ---
        function attachDeliveredButtonListeners() { /* ... unchanged ... */ }
         async function handleMarkDeliveredClick(e) { /* ... unchanged ... */ }


        // Complete/Uncomplete Chore (Event delegation)
        const mainElement = document.querySelector('main');
         if (mainElement) {
             mainElement.addEventListener('click', (e) => {
                try {
                    const completeButton = e.target.closest('.chore-complete-btn');
                    const assignButton = e.target.closest('.assign-chore-btn');

                    if (completeButton) {
                        handleChoreCompletionToggle(completeButton, e); 
                    } else if (assignButton) {
                         openAssignmentModal(assignButton.closest('.chore-item'));
                    }
                } catch (e) { console.error("Main click delegate failed:", e); }
            });
         }


        // Updated function to handle both complete and uncomplete
        async function handleChoreCompletionToggle(button, e) {
             let newCompletionState; 
             const choreItem = button.closest('.chore-item'); 
             if (!choreItem) {
                  console.error("Could not find parent chore item for button:", button);
                  return; 
             }

             // Wrap in try...catch
            try {
                 const assigneeId = choreItem.dataset.currentAssignee; 

                 if (!assigneeId || assigneeId === 'unassigned') {
                     showSnackbar("Assign chore to a member first.", true);
                     return;
                 }


                const isCurrentlyComplete = choreItem.dataset.isComplete === 'true'; 
                newCompletionState = !isCurrentlyComplete; 

                const points = parseInt(choreItem.dataset.points); 
                
                const completionDocId = choreItem.dataset.completionDocId;
                const isAdhoc = choreItem.dataset.isAdhoc === 'true';
                const choreDefId = choreItem.dataset.choreDefId === 'null' ? null : choreItem.dataset.choreDefId;


                const member = appData.members.find(m => m.id === assigneeId);
                if (!member) {
                     showSnackbar("Cannot find assigned member.", true); 
                     console.error("Member data not found for assigneeId:", assigneeId, appData.members);
                     return;
                }
                const memberColor = member.color || '#3b82f6';
                const clickX = e.clientX;
                const clickY = e.clientY;

                const actionLabel = isCurrentlyComplete ? 'Uncompleting' : 'Completing';
                showLoading(`${actionLabel} chore...`);

                await runTransaction(db, async (transaction) => {
                    let completionRef;
                    let memberRef = paths.member(assigneeId); 

                    // --- Perform Reads FIRST ---
                    const memberDoc = await transaction.get(memberRef); 
                    if (!memberDoc.exists()) throw new Error("Member not found.");
                    const currentPoints = memberDoc.data().points || 0;

                    let existingCompletionDoc = null; 
                    if (completionDocId && completionDocId !== 'null') {
                        completionRef = paths.completion(completionDocId);
                        existingCompletionDoc = await transaction.get(completionRef); 
                    }
                    // --- End Reads ---

                    // --- Calculate New State and Prepare Writes ---
                    const pointChange = newCompletionState ? points : -points; 
                    const newPoints = currentPoints + pointChange;

                    if (existingCompletionDoc?.exists()) {
                        transaction.update(completionRef, { isComplete: newCompletionState });
                    } else if (newCompletionState) { 
                        completionRef = doc(collection(db, paths.completions().path)); 
                        transaction.set(completionRef, {
                            name: choreItem.dataset.name,
                            emoji: choreItem.dataset.emoji,
                            points: parseInt(choreItem.dataset.points),
                            assigneeId: assigneeId,
                            date: getTodayString(),
                            isComplete: true, 
                            isAdhoc: isAdhoc, 
                            choreDefId: choreDefId,
                            timestamp: Timestamp.now() 
                        });
                    } else {
                         console.warn("Attempted to uncomplete chore with no existing completion doc:", choreItem.dataset);
                    }

                    transaction.update(memberRef, { points: newPoints }); 
                });
                
                // --- Success Actions ---
                hideLoading(); 
                 showSnackbar(`Chore ${newCompletionState ? 'completed' : 'marked incomplete'}!`); 
                if (newCompletionState) {
                    createConfetti(clickX, clickY, memberColor);
                    playSound('C5', '16n'); 
                } else {
                     playSound('C4', '16n'); 
                }

            } catch (error) { 
                console.error("Chore completion/uncompletion failed:", error);
                 const failedActionLabel = newCompletionState === undefined ? (choreItem.dataset.isComplete === 'true' ? 'Uncompleting' : 'Completing') : (newCompletionState ? 'Completing' : 'Uncompleting');
                showSnackbar(`${failedActionLabel} failed: ${error.message}`, true);
                hideLoading(); 
            } 
        }



       // --- Assignment Modal Logic ---
        function openAssignmentModal(choreItem) {
             console.log("Opening assignment modal for:", choreItem?.dataset); // Log opening
            try {
                if (!choreItem) {
                     console.warn("openAssignmentModal called without choreItem");
                     return;
                }
                currentChoreToAssign = {
                    completionDocId: choreItem.dataset.completionDocId,
                    choreDefId: choreItem.dataset.choreDefId,
                    currentAssigneeId: choreItem.dataset.currentAssignee,
                    isAdhoc: choreItem.dataset.isAdhoc === 'true',
                    name: choreItem.dataset.name,
                    emoji: choreItem.dataset.emoji,
                    points: parseInt(choreItem.dataset.points)
                };

                 if (!assignmentOptionsContainer || !assignmentModal) {
                     console.error("Assignment modal elements not found.");
                     return;
                 }

                assignmentOptionsContainer.innerHTML = ''; 

                const unassignedButton = document.createElement('button');
                unassignedButton.className = 'assign-option';
                unassignedButton.textContent = '⚪ Unassigned';
                unassignedButton.dataset.assigneeId = 'unassigned';
                assignmentOptionsContainer.appendChild(unassignedButton);

                appData.members.forEach(member => {
                    const button = document.createElement('button');
                    button.className = 'assign-option';
                    button.innerHTML = `
                        <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${member.color};"></span>
                        ${member.emoji || ''} ${member.name}
                    `;
                    button.dataset.assigneeId = member.id;
                    assignmentOptionsContainer.appendChild(button);
                });

                assignmentModal.classList.remove('hidden'); // Show the modal
            } catch (e) { console.error("openAssignmentModal failed:", e); }
        }

        function closeAssignmentModal() {
            try {
                if(assignmentModal) assignmentModal.classList.add('hidden'); // Hide the modal
                currentChoreToAssign = null; 
            } catch (e) { console.error("closeAssignmentModal failed:", e); }
        }

        // Attach listeners using event delegation *once* in DOMContentLoaded
        
       

        // --- Touch Drag and Drop Logic ---
        let dragElement = null;
        let ghostElement = null;
        function addTouchDragListeners() { /* ... unchanged ... */ }
        function handleTouchStart(e) { /* ... unchanged ... */ }
        function handleTouchMove(e) { /* ... unchanged ... */ }
        function handleTouchEnd(e) { /* ... unchanged ... */ }
        
        // Handle Chore Assignment (called from modal)
        async function handleChoreAssignment(choreData, newAssigneeId) { 
             console.log("Handling chore assignment:", choreData, newAssigneeId); // Log assignment start
             try {
                const { 
                    completionDocId, 
                    choreDefId, 
                    currentAssigneeId, 
                    isAdhoc, 
                    name, 
                    emoji, 
                    points 
                } = choreData;

                if (newAssigneeId === currentAssigneeId) {
                    console.log("Assignment skipped: Assignee is the same.");
                    return; 
                }

                showLoading('Reassigning...');
                try {
                    if (completionDocId && completionDocId !== 'null') {
                        console.log(`Updating existing completion doc ${completionDocId} for ${isAdhoc ? 'adhoc' : 'recurring'} chore.`);
                        await updateDoc(paths.completion(completionDocId), {
                            assigneeId: newAssigneeId
                        });
                    
                    } else if (!isAdhoc && choreDefId && choreDefId !== 'null') {
                        // Create a NEW completion doc when assigning a recurring chore for the first time today
                         console.log(`Creating new completion doc for recurring chore ${choreDefId}.`);
                        await addDoc(paths.completions(), {
                            name: name,
                            emoji: emoji,
                            points: points,
                            assigneeId: newAssigneeId, // Use the new assignee
                            date: getTodayString(),
                            isComplete: false, // Starts incomplete
                            isAdhoc: false,
                            choreDefId: choreDefId,
                            timestamp: Timestamp.now()
                        });
                    } else if (isAdhoc && (!completionDocId || completionDocId === 'null')) {
                         // Create a NEW completion doc for an adhoc chore being assigned for the first time
                         console.log(`Creating new completion doc for new adhoc chore ${name}.`);
                          await addDoc(paths.completions(), {
                            name: name, emoji: emoji, points: points, assigneeId: newAssigneeId,
                            date: getTodayString(), isComplete: false, isAdhoc: true, choreDefId: null,
                            timestamp: Timestamp.now()
                        });
                    }
                     else {
                        console.error("Unhandled chore assignment case:", choreData, newAssigneeId);
                        throw new Error("Could not determine how to assign this chore.");
                    }
                    showSnackbar("Chore reassigned!");
                     console.log("Chore reassignment successful."); // Log success

                } catch (error) {
                    console.error("Failed to reassign chore in Firestore:", error);
                    showSnackbar("Failed to reassign chore.", true);
                } finally { 
                    hideLoading();
                }
            } catch (e) { console.error("handleChoreAssignment failed:", e); }
        }


        // Calendar Navigation Removed

        // --- Global Error Handlers ---
        window.addEventListener('unhandledrejection', (event) => { /* ... */ });
        window.addEventListener('error', (event) => { /* ... */ });

        // --- App Initialization ---
        window.changeTab = changeTab;
        window.changeSetupSubPage = changeSetupSubPage; 
        
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed");
             try { // Wrap DOMContentLoaded content
                 // Populate emoji dropdowns now that elements exist
                 populateEmojiSelect(document.getElementById('adhoc-chore-emoji'), choreEmojis);
                 populateEmojiSelect(document.getElementById('chore-emoji'), choreEmojis);
                 populateEmojiSelect(document.getElementById('reward-emoji'), choreEmojis, '🎉');
                 
                 // Attach modal listeners here AFTER elements exist
                  if (assignmentOptionsContainer) {
                     assignmentOptionsContainer.addEventListener('click', (e) => {
                        const button = e.target.closest('.assign-option');
                        if (button && currentChoreToAssign) {
                           const newAssigneeId = button.dataset.assigneeId;
                           handleChoreAssignment(currentChoreToAssign, newAssigneeId); 
                           closeAssignmentModal();
                        }
                     });
                 }
                 if (cancelAssignmentButton) cancelAssignmentButton.addEventListener('click', closeAssignmentModal); 
                 if (assignmentModal) {
                     assignmentModal.addEventListener('click', (e) => { 
                         if (e.target === assignmentModal) {
                             closeAssignmentModal();
                         }
                     }); 
                 }


                 initializeFirebase(); // Initialize Firebase after populating static elements
             } catch (e) {
                 console.error("Error during DOMContentLoaded setup:", e);
                 // Display a user-friendly error if critical setup fails
                 document.body.innerHTML = '<div class="p-8 text-center text-red-600">Failed to initialize the application. Please check the console for errors.</div>';
             }
        });


    </script>
</body>
</html>

