<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub Organizer</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Firebase JS SDKs (using modules) -->
    <!-- This block has been removed. Imports are handled in the main script at the bottom. -->
    
    <!-- 3. Helper Libraries: Tone.js (sound) & Confetti.js (animation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- 4. Icons (Lucide) - FIXED SCRIPT URL -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Suppress favicon.ico 404 error -->
    <link rel="icon" href="data:,">

    <!-- 5. Custom Styles -->
    <style>
        /* Smooth transitions for UI elements */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4c4c4;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        /* Style for completed chore */
        .chore-complete {
            text-decoration: line-through;
            opacity: 0.6;
        }
        /* Simple rotate animation for loading icon */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Draggable style */
        .chore-dragging {
            opacity: 0.5;
            border: 2px dashed #0ea5e9;
        }
        .drag-over-target {
            background-color: #f0f9ff; /* light-blue-50 */
            border: 2px dashed #0ea5e9;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm z-[999] flex flex-col items-center justify-center">
        <div data-lucide="loader-circle" class="animate-spin text-blue-600 h-16 w-16"></div>
        <p class="mt-4 text-lg font-medium text-gray-700">Connecting to Family Hub...</p>
        <p id="loading-error" class="mt-2 text-red-600 hidden"></p>
    </div>

    <div class="flex h-full">
        <!-- ==== Sidebar Navigation ==== -->
        <nav class="w-20 md:w-64 bg-gray-800 text-white flex flex-col shadow-lg">
            <div class="flex items-center justify-center md:justify-start md:pl-6 h-20 border-b border-gray-700">
                <span data-lucide="home" class="h-8 w-8 text-blue-400"></span>
                <span class="hidden md:block ml-3 text-2xl font-bold">Family Hub</span>
            </div>
            
            <ul class="flex flex-col py-4 space-y-2">
                <!-- Navigation Links -->
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="daily">
                        <span data-lucide="clipboard-list"></span>
                        <span class="hidden md:block ml-4">Daily List</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="weekly">
                        <span data-lucide="calendar-days"></span>
                        <span class="hidden md:block ml-4">Weekly Schedule</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="rewards">
                        <span data-lucide="star"></span>
                        <span class="hidden md:block ml-4">Points & Rewards</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="setup">
                        <span data-lucide="settings"></span>
                        <span class="hidden md:block ml-4">Setup</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- ==== Main Content Area ==== -->
        <main class="flex-1 flex flex-col h-screen">
            <!-- Header Bar -->
            <header class="flex items-center justify-between h-20 bg-white shadow-md px-6 z-10">
                <h2 id="view-title" class="text-3xl font-bold text-gray-800">Daily List</h2>
                <div class="text-right">
                    <div id="current-time" class="text-2xl font-semibold text-gray-700"></div>
                    <div id="current-date" class="text-sm text-gray-500"></div>
                </div>
            </header>

            <!-- Content Views (overflow-y-auto is key) -->
            <div class="flex-1 p-6 md:p-8 overflow-y-auto">
                
                <!-- ==== 1. Daily List View ==== -->
                <div id="view-daily" class="view-content space-y-6">
                    <!-- Ad-Hoc Chore Collapsible -->
                    <details class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <summary class="p-4 cursor-pointer font-medium text-lg text-blue-600 flex items-center justify-between">
                            <span>Add Ad-Hoc Chore</span>
                            <span data-lucide="plus-circle" class="h-5 w-5"></span>
                        </summary>
                        <form id="add-adhoc-chore-form" class="p-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-5 gap-4">
                            <input type="text" id="adhoc-name" placeholder="Chore Name" class="md:col-span-2 form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="text" id="adhoc-emoji" placeholder="Emoji (e.g., âœ¨)" class="form-input px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                            <input type="number" id="adhoc-points" placeholder="Points" class="form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <select id="adhoc-assignee" class="form-select px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="unassigned">Unassigned</option>
                                <!-- Member options will be populated by JS -->
                            </select>
                            <button type="submit" class="md:col-span-5 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                <span data-lucide="plus"></span> Add Chore
                            </button>
                        </form>
                    </details>
                    
                    <!-- Chore Lists Container -->
                    <div id="daily-chores-container" class="space-y-6">
                        <!-- Content generated by JS -->
                    </div>
                </div>

                <!-- ==== 2. Weekly Schedule View ==== -->
                <div id="view-weekly" class="view-content hidden">
                    <div id="weekly-schedule-grid" class="grid grid-cols-1 md:grid-cols-7 gap-4">
                        <!-- Day columns generated by JS -->
                    </div>
                </div>

                <!-- ==== 3. Points & Rewards View ==== -->
                <div id="view-rewards" class="view-content hidden space-y-6">
                    <!-- Member Point Totals -->
                    <div>
                        <h3 class="text-2xl font-semibold mb-4">Point Totals</h3>
                        <div id="member-points-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Member point cards generated by JS -->
                        </div>
                    </div>
                    
                    <!-- Reward Redemption -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-2xl font-semibold mb-4">Redeem Rewards</h3>
                        <div class="flex items-center gap-4 mb-6">
                            <label for="redeem-member-select" class="text-lg font-medium">I am:</label>
                            <select id="redeem-member-select" class="form-select px-4 py-2 border border-gray-300 rounded-lg w-full md:w-1/3">
                                <option value="">Select a member...</option>
                                <!-- Member options populated by JS -->
                            </select>
                        </div>
                        <div id="available-rewards-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Reward cards generated by JS -->
                        </div>
                    </div>

                    <!-- Claimed (Not Delivered) Rewards -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-2xl font-semibold mb-4">Pending Rewards</h3>
                        <div id="claimed-rewards-list" class="space-y-3">
                            <!-- Claimed rewards list generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ==== 4. Setup View ==== -->
                <div id="view-setup" class="view-content hidden">
                    <!-- Setup Sub-Navigation -->
                    <div class="mb-6 flex space-x-2 border-b border-gray-300">
                        <button class="setup-nav-link py-3 px-5 font-medium text-gray-500 hover:text-gray-800" data-setup-view="members">Members</button>
                        <button class="setup-nav-link py-3 px-5 font-medium text-gray-500 hover:text-gray-800" data-setup-view="chores">Chores</button>
                        <button class="setup-nav-link py-3 px-5 font-medium text-gray-500 hover:text-gray-800" data-setup-view="rewards">Rewards</button>
                    </div>

                    <!-- Setup Content Panes -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- ==== Setup: Members ==== -->
                        <div id="setup-view-members" class="setup-view-content lg:col-span-1 space-y-6">
                            <!-- Add Member -->
                            <form id="add-member-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Add New Member</h4>
                                <input type="text" id="member-name" placeholder="Member Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="member-emoji" placeholder="Emoji (e.g., ðŸ‘¨â€ðŸ‘©â€ðŸ‘§)" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                                <select id="member-color" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Select Color</option>
                                    <option value="bg-red-500">Red</option>
                                    <option value="bg-blue-500">Blue</option>
                                    <option value="bg-green-500">Green</option>
                                    <option value="bg-yellow-500">Yellow</option>
                                    <option value="bg-purple-500">Purple</option>
                                    <option value="bg-pink-500">Pink</option>
                                    <option value="bg-indigo-500">Indigo</option>
                                    <option value="bg-teal-500">Teal</option>
                                </select>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="user-plus"></span> Add Member
                                </button>
                            </form>
                            
                            <!-- Adjust Points -->
                            <form id="adjust-points-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Adjust Points (Admin)</h4>
                                <select id="adjust-points-member" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Select Member</option>
                                </select>
                                <input type="number" id="adjust-points-amount" placeholder="Points to Add/Subtract" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="password" id="adjust-points-password" placeholder="Admin Password" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <button type="submit" class="w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="edit"></span> Adjust Points
                                </button>
                            </form>
                        </div>
                        <div id="member-list-container" class="setup-view-content lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="text-xl font-semibold mb-4">Existing Members</h4>
                            <div id="setup-members-list" class="space-y-3">
                                <!-- Member list generated by JS -->
                            </div>
                        </div>

                        <!-- ==== Setup: Chores ==== -->
                        <div id="setup-view-chores" class="setup-view-content hidden lg:col-span-1 space-y-6">
                            <form id="add-chore-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Add Recurring Chore</h4>
                                <input type="text" id="chore-name" placeholder="Chore Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="chore-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                                <input type="number" id="chore-points" placeholder="Points" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <select id="chore-default-assignee" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="unassigned">Default: Unassigned</option>
                                </select>
                                <div class="space-y-2">
                                    <label class="font-medium">Schedule (Recurring Days):</label>
                                    <div class="grid grid-cols-4 gap-2 text-sm">
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="mon" class="form-checkbox rounded"> Mon</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="tue" class="form-checkbox rounded"> Tue</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="wed" class="form-checkbox rounded"> Wed</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="thu" class="form-checkbox rounded"> Thu</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="fri" class="form-checkbox rounded"> Fri</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="sat" class="form-checkbox rounded"> Sat</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="sun" class="form-checkbox rounded"> Sun</label>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="plus-circle"></span> Add Chore Template
                                </button>
                            </form>
                        </div>
                        <div id="chore-list-container" class="setup-view-content hidden lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="text-xl font-semibold mb-4">Existing Chore Templates</h4>
                            <div id="setup-chores-list" class="space-y-3">
                                <!-- Chore list generated by JS -->
                            </div>
                        </div>

                        <!-- ==== Setup: Rewards ==== -->
                        <div id="setup-view-rewards" class="setup-view-content hidden lg:col-span-1 space-y-6">
                            <form id="add-reward-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Add New Reward</h4>
                                <input type="text" id="reward-name" placeholder="Reward Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="reward-emoji" placeholder="Emoji (e.g., ðŸ¦)" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                                <input type="number" id="reward-cost" placeholder="Point Cost" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="award"></span> Add Reward
                                </button>
                            </form>
                        </div>
                        <div id="reward-list-container" class="setup-view-content hidden lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="text-xl font-semibold mb-4">Available Rewards</h4>
                            <div id="setup-rewards-list" class="space-y-3">
                                <!-- Reward list generated by JS -->
                            </div>
                        </div>
                    </div>
                </div> <!-- End Setup View -->
            </div> <!-- End Content Views Container -->
        </main>
    </div> <!-- End Main Flex Container -->


    <!-- ==== Modals ==== -->

    <!-- Global Message/Toast -->
    <div id="toast-message" class="fixed bottom-6 right-6 p-4 rounded-lg shadow-xl text-white transition-all translate-x-[120%]" role="alert">
        <span id="toast-text"></span>
    </div>

    <!-- Assign Chore Modal -->
    <div id="assign-chore-modal" class_ ="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-2xl font-semibold mb-4">Assign Chore</h3>
            <p class="mb-4">Assign "<span id="assign-chore-name" class="font-medium"></span>" to:</p>
            <select id="assign-chore-select" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg mb-6">
                <!-- Options populated by JS -->
            </select>
            <div class="flex justify-end gap-3">
                <button onclick="hideModal('assign-chore-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button id="assign-chore-submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Assignment</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-2xl font-semibold mb-4">Admin Access</h3>
            <p class="mb-4 text-gray-600">Please enter the admin password to continue.</p>
            <input type="password" id="password-input" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" placeholder="Password">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password. Please try again.</p>
            <div class="flex justify-end gap-3">
                <button onclick="hideModal('password-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button id="password-submit" class="py-2 px-5 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition-all">Submit</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <div class="flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mx-auto mb-4">
                <span data-lucide="trash-2" class="h-8 w-8 text-red-600"></span>
            </div>
            <h3 class="text-2xl font-semibold mb-2 text-center">Are you sure?</h3>
            <p class="mb-6 text-gray-600 text-center">This action cannot be undone. This will permanently delete <strong id="delete-item-name"></strong>.</p>
            <div class="flex justify-center gap-3">
                <button onclick="hideModal('confirm-delete-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button id="confirm-delete-button" class="py-2 px-5 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-all">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Modals (for Setup) -->
    <!-- Edit Member Modal -->
    <div id="edit-member-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="edit-member-form" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-semibold">Edit Member</h3>
            <input type="hidden" id="edit-member-id">
            <input type="text" id="edit-member-name" placeholder="Member Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <input type="text" id="edit-member-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
            <select id="edit-member-color" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                <option value="bg-red-500">Red</option>
                <option value="bg-blue-500">Blue</option>
                <option value="bg-green-500">Green</option>
                <option value="bg-yellow-500">Yellow</option>
                <option value="bg-purple-500">Purple</option>
                <option value="bg-pink-500">Pink</option>
                <option value="bg-indigo-500">Indigo</option>
                <option value="bg-teal-500">Teal</option>
            </select>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('edit-member-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Changes</button>
            </div>
        </form>
    </div>
    
    <!-- Edit Chore Modal -->
    <div id="edit-chore-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="edit-chore-form" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg space-y-4">
            <h3 class="text-2xl font-semibold">Edit Chore Template</h3>
            <input type="hidden" id="edit-chore-id">
            <input type="text" id="edit-chore-name" placeholder="Chore Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <input type="text" id="edit-chore-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
            <input type="number" id="edit-chore-points" placeholder="Points" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <select id="edit-chore-default-assignee" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg">
                <!-- options populated by JS -->
            </select>
            <div class="space-y-2">
                <label class="font-medium">Schedule (Recurring Days):</label>
                <div id="edit-chore-schedule-container" class="grid grid-cols-4 gap-2 text-sm">
                    <!-- checkboxes populated by JS -->
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('edit-chore-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Edit Reward Modal -->
    <div id="edit-reward-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="edit-reward-form" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-semibold">Edit Reward</h3>
            <input type="hidden" id="edit-reward-id">
            <input type="text" id="edit-reward-name" placeholder="Reward Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <input type="text" id="edit-reward-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
            <input type="number" id="edit-reward-cost" placeholder="Point Cost" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('edit-reward-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // === Firebase SDK Imports (CONSOLIDATED & FIXED) ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === Global State ===
        let db, auth, userId, appId;
        let localState = {
            members: [],
            chores: [], // Reusable chore templates
            rewards: [],
            dailyChores: [], // Instances of chores for specific days
            claimedRewards: []
        };
        let currentView = 'daily';
        let currentSetupView = 'members';
        let selectedChoreForAssignment = null;
        let selectedRedeemerId = null;
        let passwordSuccessCallback = null;
        let deleteSuccessCallback = null;
        let hasCheckedDailyChores = false; // Flag to prevent re-generation
        
        // Flags to track initial data load
        let hasLoaded = {
            members: false,
            chores: false,
            rewards: false,
            dailyChores: false,
            claimedRewards: false
        };
        
        const PASSWORD = '3281555';
        const DAYS_OF_WEEK = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        const WEEK_DAYS_FULL = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        // === Sound Effects ===
        let sounds;
        function initSounds() {
            if (window.Tone) {
                sounds = {
                    complete: new Tone.Synth().toDestination(),
                    uncomplete: new Tone.Synth().toDestination(),
                    redeem: new Tone.PluckSynth().toDestination(),
                    error: new Tone.MembraneSynth().toDestination(),
                    success: new Tone.Synth().toDestination(),
                };
                // Pre-connect to avoid audio context issues
                Tone.start();
            }
        }
        function playSound(soundName) {
            if (!sounds) return;
            try {
                if (soundName === 'complete') {
                    sounds.complete.triggerAttackRelease("C5", "8n", Tone.now());
                } else if (soundName === 'uncomplete') {
                    sounds.uncomplete.triggerAttackRelease("C4", "8n", Tone.now());
                } else if (soundName === 'redeem') {
                    // Fanfare
                    const now = Tone.now();
                    sounds.redeem.triggerAttackRelease("C5", "8n", now);
                    sounds.redeem.triggerAttackRelease("E5", "8n", now + 0.2);
                    sounds.redeem.triggerAttackRelease("G5", "8n", now + 0.4);
                } else if (soundName === 'success') {
                    sounds.success.triggerAttackRelease("G5", "8n", Tone.now());
                } else if (soundName === 'error') {
                    sounds.error.triggerAttackRelease("C3", "4n", Tone.now());
                }
            } catch (e) {
                console.error("Sound error:", e);
            }
        }

        // === Date & Time ===
        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            if(timeEl) timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if(dateEl) dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // === Firebase Initialization ===
        async function initFirebase() {
            try {
                // 1. Get App ID and Config from USER
                appId = 'family-hub-organizer';
                const firebaseConfig = {
                    apiKey: "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M",
                    authDomain: "family-hub-organizer.firebaseapp.com",
                    projectId: "family-hub-organizer",
                    storageBucket: "family-hub-organizer.firebasestorage.app",
                    messagingSenderId: "468888595189",
                    appId: "1:468888595189:web:eb6f33ee8e62cdc489b3bc"
                };

                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase config is missing.");
                }

                // 2. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Enable Firestore logs

                // 3. Handle Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        console.log('Firebase Authenticated. User ID:', userId);
                        // User is authenticated, now load data
                        await loadData();
                        // Hide loading overlay
                        document.getElementById('loading-overlay').classList.add('hidden');
                    } else {
                        // User is signed out, try to sign in
                        console.log('No user. Attempting sign-in...');
                        try {
                            // Use Anonymous sign-in directly
                            await signInAnonymously(auth);
                        } catch (authError) {
                            console.error('Firebase sign-in error:', authError);
                            showLoadingError('Could not sign in. Please refresh.');
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                showLoadingError('Failed to initialize. Check console.');
            }
        }
        
        function showLoadingError(message) {
            const errorEl = document.getElementById('loading-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            document.getElementById('loading-overlay').querySelector('[data-lucide="loader-circle"]').classList.add('hidden');
        }

        // === Firestore Data Loading (Real-time) ===
        async function loadData() {
            if (!db || !userId) return;

            const F_BASE_PATH = `/artifacts/${appId}/public/data`;
            const F_MEMBERS_COL = `${F_BASE_PATH}/members`;
            const F_CHORES_COL = `${F_BASE_PATH}/chores`;
            const F_REWARDS_COL = `${F_BASE_PATH}/rewards`;
            const F_DAILY_CHORES_COL = `${F_BASE_PATH}/dailyChores`;
            const F_CLAIMED_REWARDS_COL = `${F_BASE_PATH}/claimedRewards`;

            // Expose collection paths for handlers
            window.F_MEMBERS_COL = F_MEMBERS_COL;
            window.F_CHORES_COL = F_CHORES_COL;
            window.F_REWARDS_COL = F_REWARDS_COL;
            window.F_DAILY_CHORES_COL = F_DAILY_CHORES_COL;
            window.F_CLAIMED_REWARDS_COL = F_CLAIMED_REWARDS_COL;

            // 1. Listen for Members
            onSnapshot(collection(db, F_MEMBERS_COL), (snapshot) => {
                localState.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.members = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to members:", error));

            // 2. Listen for Chore Templates
            onSnapshot(collection(db, F_CHORES_COL), (snapshot) => {
                localState.chores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.chores = true;
                hasCheckedDailyChores = false; // New templates, allow re-check
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to chores:", error));

            // 3. Listen for Rewards
            onSnapshot(collection(db, F_REWARDS_COL), (snapshot) => {
                localState.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.rewards = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to rewards:", error));

            // 4. Listen for Daily Chores (for today)
            const todayISO = new Date().toISOString().split('T')[0];
            const qDaily = query(collection(db, F_DAILY_CHORES_COL), where("date", "==", todayISO));
            
            onSnapshot(qDaily, (snapshot) => {
                localState.dailyChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.dailyChores = true;
                // Removed hasCheckedDailyChores = false; and checkAndGenerateDailyChores() to fix loop
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to daily chores:", error));

            // 5. Listen for Claimed (not delivered) Rewards
            const qClaimed = query(collection(db, F_CLAIMED_REWARDS_COL), where("delivered", "==", false));
            onSnapshot(qClaimed, (snapshot) => {
                localState.claimedRewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.claimedRewards = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to claimed rewards:", error));
        }

        // === Core Logic: Check if all data is loaded, then run generation ===
        function checkInitialLoad() {
            // Check if all data streams have loaded at least once
            if (Object.values(hasLoaded).every(Boolean)) {
                // Only run the generation if it hasn't been run successfully yet
                if (!hasCheckedDailyChores) {
                    checkAndGenerateDailyChores();
                }
            }
        }
        
        // === Core Logic: Daily Chore Generation ===
        async function checkAndGenerateDailyChores() {
            // Only run if we have chore templates
            if (localState.chores.length === 0) {
                hasCheckedDailyChores = true; // Mark as "checked" even if no chores
                return;
            }
            
            console.log("Checking if daily chores need generation...");
            
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            const todayDayString = DAYS_OF_WEEK[today.getDay()];
            
            // Find which template chores *should* exist today
            const choresToGenerate = localState.chores.filter(chore =>
                chore.schedule && chore.schedule.includes(todayDayString)
            );
            
            // Find which template chores *already exist* for today
            const existingTemplateChoreIds = new Set(
                localState.dailyChores
                    .filter(dc => !dc.isAdHoc && dc.choreTemplateId)
                    .map(dc => dc.choreTemplateId)
            );

            // Generate the ones that are missing
            for (const choreTemplate of choresToGenerate) {
                if (!existingTemplateChoreIds.has(choreTemplate.id)) {
                    console.log(`Generating daily chore for: ${choreTemplate.name}`);
                    try {
                        await addDoc(collection(db, F_DAILY_CHORES_COL), {
                            choreTemplateId: choreTemplate.id,
                            name: choreTemplate.name,
                            emoji: choreTemplate.emoji,
                            points: choreTemplate.points,
                            assignedTo: choreTemplate.defaultAssignee === 'unassigned' ? null : (choreTemplate.defaultAssignee || null),
                            date: todayISO,
                            isComplete: false,
                            isAdHoc: false,
                            createdAt: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error generating daily chore:", e);
                    }
                }
            }
            
            // Mark as checked *after* successful run
            hasCheckedDailyChores = true;
        }
        
        // === Master Render Function ===

