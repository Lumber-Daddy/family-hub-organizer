<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub Organizer</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'hub-navy': '#1A237E',
                        'hub-blue': '#283593',
                        'hub-light-blue': '#3F51B5',
                    }
                }
            }
        }
    </script>

    <!-- 2. Firebase -->
    <!-- All imports are now in the main module script -->

    <!-- 3. Helper Libraries -->
    <!-- Tone.js (Sound Effects) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- canvas-confetti (Reward Animation) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- 4. Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Suppress favicon.ico 404 error -->
    <link rel="icon" href="data:,">

    <!-- 5. Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for chore completion */
        .chore-complete p {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .chore-complete {
            background-color: #f8fafc; /* bg-cool-gray-50 */
        }
        /* Custom style for dragging */
        .chore-dragging {
            opacity: 0.5;
            border: 2px dashed #3F51B5;
        }
        .drag-over-target {
            outline: 2px dashed #3F51B5;
            background-color: #E8EAF6; /* indigo-100 */
        }
    </style>
</head>
<body class="h-full flex overflow-hidden">
    <!-- Static Sidebar -->
    <div class="flex-shrink-0 w-64 bg-hub-navy text-gray-200 flex flex-col">
        <!-- Logo -->
        <div class="h-16 flex-shrink-0 flex items-center justify-center px-4 bg-hub-blue">
            <span data-lucide="home" class="h-8 w-8 text-white"></span>
            <span class="ml-3 text-2xl font-bold text-white">Family Hub</span>
        </div>
        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <a href="#" class="nav-link flex items-center px-3 py-3 rounded-lg text-lg font-medium text-gray-200 hover:bg-hub-blue hover:text-white" data-view="daily">
                <span data-lucide="sun" class="h-6 w-6 mr-3"></span>
                <span class="hidden sm:inline">Daily List</span>
            </a>
            <a href="#" class="nav-link flex items-center px-3 py-3 rounded-lg text-lg font-medium text-gray-200 hover:bg-hub-blue hover:text-white" data-view="weekly">
                <span data-lucide="calendar-days" class="h-6 w-6 mr-3"></span>
                <span class="hidden sm:inline">Weekly Schedule</span>
            </a>
            <a href="#" class="nav-link flex items-center px-3 py-3 rounded-lg text-lg font-medium text-gray-200 hover:bg-hub-blue hover:text-white" data-view="rewards">
                <span data-lucide="star" class="h-6 w-6 mr-3"></span>
                <span class="hidden sm:inline">Points & Rewards</span>
            </a>
            <a href="#" class="nav-link flex items-center px-3 py-3 rounded-lg text-lg font-medium text-gray-200 hover:bg-hub-blue hover:text-white" data-view="setup">
                <span data-lucide="settings" class="h-6 w-6 mr-3"></span>
                <span class="hidden sm:inline">Setup</span>
            </a>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header class="h-16 bg-white shadow-sm border-b border-gray-200 flex-shrink-0">
            <div class="h-full px-6 flex items-center justify-between">
                <!-- View Title -->
                <h1 id="view-title" class="text-2xl font-bold text-gray-800">Daily List</h1>
                <!-- Live Date/Time -->
                <div class="text-right">
                    <p id="live-time" class="text-xl font-medium text-gray-700">12:00:00 PM</p>
                    <p id="live-date" class="text-sm text-gray-500">Monday, January 1, 2024</p>
                </div>
            </div>
        </header>

        <!-- Main Scrolling Content -->
        <main class="flex-1 overflow-y-auto p-6">
            
            <!-- Loading Screen -->
            <div id="loading-screen" class="w-full h-full flex flex-col items-center justify-center">
                <span data-lucide="loader-2" class="h-12 w-12 text-blue-600 animate-spin"></span>
                <p class="mt-4 text-xl font-medium text-gray-600">Connecting to Family Hub...</p>
            </div>

            <!-- ===== View: Daily List ===== -->
            <div id="view-daily" class="view-content space-y-6 hidden">
                <!-- Ad-Hoc Chore Form -->
                <details class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <summary class="cursor-pointer text-lg font-medium text-blue-600 flex items-center">
                        <span data-lucide="plus-circle" class="mr-2 h-5 w-5"></span>
                        Add One-Time Chore
                    </summary>
                    <form id="add-adhoc-chore-form" class="mt-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="adhoc-name" placeholder="Chore Name" class="col-span-1 md:col-span-2 form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="text" id="adhoc-emoji" placeholder="Emoji (e.g., ðŸ—‘ï¸)" maxlength="2" class="col-span-1 form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="number" id="adhoc-points" placeholder="Points" min="0" class="col-span-1 form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <select id="adhoc-assignee" class="form-select px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="unassigned">Unassigned</option>
                                <!-- Members populated by JS -->
                            </select>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Chore</button>
                        </div>
                    </form>
                </details>

                <!-- Chore Lists Container -->
                <div id="daily-chores-container" class="space-y-6">
                    <!-- Member sections populated by JS -->
                </div>
            </div>

            <!-- ===== View: Weekly Schedule ===== -->
            <div id="view-weekly" class="view-content hidden">
                <div id="weekly-schedule-grid" class="grid grid-cols-1 md:grid-cols-7 gap-4">
                    <!-- Day columns populated by JS -->
                </div>
            </div>

            <!-- ===== View: Points & Rewards ===== -->
            <div id="view-rewards" class="view-content space-y-6 hidden">
                <!-- Member Points -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Member Points</h2>
                    <div id="member-points-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Member point cards populated by JS -->
                    </div>
                </section>
                
                <!-- Redeem Rewards -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Redeem Rewards</h2>
                    <div class="mb-4 max-w-sm">
                        <label for="redeem-member-select" class="block text-sm font-medium text-gray-700 mb-1">Who is redeeming?</label>
                        <select id="redeem-member-select" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select a member...</option>
                            <!-- Members populated by JS -->
                        </select>
                    </div>
                    <div id="available-rewards-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Reward cards populated by JS -->
                    </div>
                </section>
                
                <!-- Claimed (Pending) Rewards -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pending Rewards</h2>
                    <div id="claimed-rewards-list" class="space-y-2">
                        <!-- Claimed rewards populated by JS -->
                    </div>
                </section>
            </div>

            <!-- ===== View: Setup ===== -->
            <div id="view-setup" class="view-content space-y-6 hidden">
                <!-- Setup Sub-Navigation -->
                <nav class="flex border-b border-gray-300">
                    <a href="#" class="setup-nav-link -mb-px py-3 px-6 text-lg font-medium text-gray-500 hover:text-blue-600" data-setup-view="members">
                        <span data-lucide="users" class="h-5 w-5 mr-2 inline-block"></span> Members
                    </a>
                    <a href="#" class="setup-nav-link -mb-px py-3 px-6 text-lg font-medium text-gray-500 hover:text-blue-600" data-setup-view="chores">
                        <span data-lucide="clipboard-list" class="h-5 w-5 mr-2 inline-block"></span> Chores
                    </a>
                    <a href="#" class="setup-nav-link -mb-px py-3 px-6 text-lg font-medium text-gray-500 hover:text-blue-600" data-setup-view="rewards">
                        <span data-lucide="gift" class="h-5 w-5 mr-2 inline-block"></span> Rewards
                    </a>
                </nav>

                <!-- Setup View: Members -->
                <div id="setup-view-members" class="setup-view-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Add & Adjust -->
                    <div class="space-y-6">
                        <!-- Add Member Form -->
                        <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Add New Member</h3>
                            <form id="add-member-form" class="space-y-4">
                                <input type="text" id="member-name" placeholder="Member Name" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="member-emoji" placeholder="Emoji (e.g., ðŸ‘©)" maxlength="2" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                                <select id="member-color" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Select a color...</option>
                                    <option value="bg-red-500">Red</option>
                                    <option value="bg-pink-500">Pink</option>
                                    <option value="bg-purple-500">Purple</option>
                                    <option value="bg-blue-500">Blue</option>
                                    <option value="bg-green-500">Green</option>
                                    <option value="bg-yellow-500">Yellow</option>
                                    <option value="bg-orange-500">Orange</option>
                                </select>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Member</button>
                            </form>
                        </section>
                        
                        <!-- Adjust Points Form -->
                        <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Adjust Points (Admin)</h3>
                            <form id="adjust-points-form" class="space-y-4">
                                <select id="adjust-points-member" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Select Member</option>
                                    <!-- Members populated by JS -->
                                </select>
                                <input type="number" id="adjust-points-amount" placeholder="Amount (e.g., 50 or -10)" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="password" id="adjust-points-password" placeholder="Admin Password" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                                <button type="submit" class="w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600">Adjust Points</button>
                            </form>
                        </section>
                    </div>
                    <!-- Right Column: List -->
                    <div id="members-list-container" class="setup-list-container bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Current Members</h3>
                        <div id="setup-members-list" class="space-y-3">
                            <!-- Member list populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Setup View: Chores -->
                <div id="setup-view-chores" class="setup-view-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Add -->
                    <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Add Reusable Chore</h3>
                        <form id="add-chore-form" class="space-y-4">
                            <input type="text" id="chore-name" placeholder="Chore Name" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="text" id="chore-emoji" placeholder="Emoji (e.g., ðŸ§¹)" maxlength="2" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="number" id="chore-points" placeholder="Points" min="0" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Schedule (optional)</label>
                                <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="mon" class="form-checkbox rounded"> Mon</label>
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="tue" class="form-checkbox rounded"> Tue</label>
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="wed" class="form-checkbox rounded"> Wed</label>
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="thu" class="form-checkbox rounded"> Thu</label>
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="fri" class="form-checkbox rounded"> Fri</label>
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="sat" class="form-checkbox rounded"> Sat</label>
                                    <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="sun" class="form-checkbox rounded"> Sun</label>
                                </div>
                            </div>
                            
                            <select id="chore-default-assignee" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="unassigned">Default: Unassigned</option>
                                <!-- Members populated by JS -->
                            </select>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Chore</button>
                        </form>
                    </section>
                    <!-- Right Column: List -->
                    <div id="chores-list-container" class="setup-list-container bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Current Chore Templates</h3>
                        <div id="setup-chores-list" class="space-y-3">
                            <!-- Chore list populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Setup View: Rewards -->
                <div id="setup-view-rewards" class="setup-view-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Add -->
                    <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Add New Reward</h3>
                        <form id="add-reward-form" class="space-y-4">
                            <input type="text" id="reward-name" placeholder="Reward Name" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="text" id="reward-emoji" placeholder="Emoji (e.g., ðŸ¦)" maxlength="2" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="number" id="reward-cost" placeholder="Point Cost" min="1" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Reward</button>
                        </form>
                    </section>
                    <!-- Right Column: List -->
                    <div id="rewards-list-container" class="setup-list-container bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Available Rewards</h3>
                        <div id="setup-rewards-list" class="space-y-3">
                            <!-- Reward list populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== Modals ===== -->
    
    <!-- Assign Chore Modal -->
    <div id="assign-chore-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Assign Chore: <span id="assign-chore-name" class="font-bold"></span></h3>
            <label for="assign-chore-select" class="block text-sm font-medium text-gray-700 mb-2">Assign to:</label>
            <select id="assign-chore-select" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg">
                <option value="unassigned">Unassigned</option>
                <!-- Members populated by JS -->
            </select>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="hideModal('assign-chore-modal')" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="assign-chore-submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Member Modal -->
    <div id="edit-member-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Edit Member</h3>
            <form id="edit-member-form" class="space-y-4">
                <input type="hidden" id="edit-member-id">
                <input type="text" id="edit-member-name" placeholder="Member Name" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="text" id="edit-member-emoji" placeholder="Emoji (e.g., ðŸ‘©)" maxlength="2" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <select id="edit-member-color" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg" required>
                    <option value="">Select a color...</option>
                    <option value="bg-red-500">Red</option>
                    <option value="bg-pink-500">Pink</option>
                    <option value="bg-purple-500">Purple</option>
                    <option value="bg-blue-500">Blue</option>
                    <option value="bg-green-500">Green</option>
                    <option value="bg-yellow-500">Yellow</option>
                    <option value="bg-orange-500">Orange</option>
                </select>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="hideModal('edit-member-modal')" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Chore Modal -->
    <div id="edit-chore-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Edit Chore Template</h3>
            <form id="edit-chore-form" class="space-y-4">
                <input type="hidden" id="edit-chore-id">
                <input type="text" id="edit-chore-name" placeholder="Chore Name" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="text" id="edit-chore-emoji" placeholder="Emoji (e.g., ðŸ§¹)" maxlength="2" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="number" id="edit-chore-points" placeholder="Points" min="0" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule</label>
                    <div id="edit-chore-schedule-container" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                        <!-- Schedule checkboxes populated by JS -->
                    </div>
                </div>
                
                <select id="edit- chore-default-assignee" class="w-full form-select px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="unassigned">Default: Unassigned</option>
                    <!-- Members populated by JS -->
                </select>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="hideModal('edit-chore-modal')" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Reward Modal -->
    <div id="edit-reward-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Edit Reward</h3>
            <form id="edit-reward-form" class="space-y-4">
                <input type="hidden" id="edit-reward-id">
                <input type="text" id="edit-reward-name" placeholder="Reward Name" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="text" id="edit-reward-emoji" placeholder="Emoji (e.g., ðŸ¦)" maxlength="2" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="number" id="edit-reward-cost" placeholder="Point Cost" min="1" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="hideModal('edit-reward-modal')" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Admin Access Required</h3>
            <p class="text-gray-600 mb-4">Please enter the admin password to continue.</p>
            <input type="password" id="password-input" class="w-full form-input px-4 py-2 border border-gray-300 rounded-lg">
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="hideModal('password-modal')" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="password-submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Submit</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Deletion</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to permanently delete <strong id="delete-item-name" class="font-bold"></strong>? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="hideModal('confirm-delete-modal')" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-button" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-message" class="fixed bottom-6 right-6 p-4 rounded-lg shadow-xl text-white transition-all transform translate-x-[120%]">
        <p id="toast-text">Success!</p>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // === Firebase SDK Imports ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc,
            onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === Global State ===
        let db, auth, userId, appId;
        let F_MEMBERS_COL, F_CHORES_COL, F_REWARDS_COL, F_DAILY_CHORES_COL, F_CLAIMED_REWARDS_COL;
        
        let sounds = {};
        let isAudioReady = false;
        
        const WEEK_DAYS_FULL = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let selectedRedeemerId = null;

        let localState = {
            members: [],
            chores: [],
            rewards: [],
            dailyChores: [],
            claimedRewards: []
        };
        let currentView = 'daily';
        let currentSetupView = 'members';
        let selectedChoreForAssignment = null;
        let passwordSuccessCallback = null;
        let deleteSuccessCallback = null;
        let hasCheckedDailyChores = false; // Flag to prevent re-generation
        
        // Flags to track initial data load
        let hasLoaded = {
            members: false,
            chores: false,
            rewards: false,
            dailyChores: false,
            claimedRewards: false
        };
        
        const PASSWORD = '3281555';
        const DAYS_OF_WEEK = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        const DAY_TO_NUM = { 'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6 };
        
        // === Sound Feedback ===
        function initSounds() {
            if (isAudioReady) return;
            Tone.start();
            sounds.complete = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
            }).toDestination();
            sounds.uncomplete = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
            }).toDestination();
            sounds.redeem = new Tone.PolySynth(Tone.Synth, {
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
            }).toDestination();
            sounds.success = sounds.complete; // Alias
            sounds.error = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }
            }).toDestination();
            
            isAudioReady = true;
            console.log("Audio context started.");
        }

        function playSound(soundName) {
            if (!isAudioReady || !sounds[soundName]) return;
            
            try {
                if (soundName === 'complete') {
                    sounds.complete.triggerAttackRelease('C5', '8n', Tone.now());
                } else if (soundName === 'uncomplete') {
                    sounds.uncomplete.triggerAttackRelease('C4', '8n', Tone.now());
                } else if (soundName === 'redeem') {
                    const now = Tone.now();
                    sounds.redeem.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '4n', now);
                    sounds.redeem.triggerAttackRelease(['E4', 'G4', 'C5', 'E5'], '4n', now + 0.2);
                    sounds.redeem.triggerAttackRelease(['G4', 'C5', 'E5', 'G5'], '4n', now + 0.4);
                } else if (soundName === 'error') {
                    sounds.error.triggerAttackRelease('F#3', '8n', Tone.now());
                }
            } catch (e) {
                console.warn("Tone.js error:", e);
            }
        }

        // === UI: Live Time ===
        function updateTime() {
            const now = new Date();
            document.getElementById('live-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('live-date').textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // === Firebase Initialization ===
        async function initFirebase() {
            try {
                // Manually set config from user
                appId = 'family-hub-organizer'; 
                const firebaseConfig = {
                    apiKey: "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M",
                    authDomain: "family-hub-organizer.firebaseapp.com",
                    projectId: "family-hub-organizer",
                    storageBucket: "family-hub-organizer.firebasestorage.app",
                    messagingSenderId: "468888595189",
                    appId: "1:468888595189:web:eb6f33ee8e62cdc489b3bc"
                };

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing!");
                    document.getElementById('loading-screen').innerHTML = '<p class="text-red-500">Error: Firebase configuration is missing.</p>';
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                // Define collection paths
                const F_BASE_PATH = `artifacts/${appId}/public/data`;
                F_MEMBERS_COL = `${F_BASE_PATH}/members`;
                F_CHORES_COL = `${F_BASE_PATH}/chores`;
                F_REWARDS_COL = `${F_BASE_PATH}/rewards`;
                F_DAILY_CHORES_COL = `${F_BASE_PATH}/daily_chores`;
                F_CLAIMED_REWARDS_COL = `${F_BASE_PATH}/claimed_rewards`;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        // User is authenticated, load data
                        await loadData();
                        document.getElementById('loading-screen').classList.add('hidden');
                    } else {
                        console.log("User is not signed in, attempting anonymous sign-in...");
                        try {
                            // Use anonymous sign-in directly
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                            document.getElementById('loading-screen').innerHTML = '<p class="text-red-500">Error: Could not connect to the database.</p>';
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-500">Fatal Error: Could not initialize app.</p>';
            }
        }
        
        // === Data: Load & Listen ===
        async function loadData() {
            if (!db || !userId) return;

            // Log collection paths for debugging
            console.log("Listening to collections at base path:", `artifacts/${appId}/public/data`);
            window.F_MEMBERS_COL = F_MEMBERS_COL;
            window.F_CHORES_COL = F_CHORES_COL;
            window.F_REWARDS_COL = F_REWARDS_COL;
            window.F_DAILY_CHORES_COL = F_DAILY_CHORES_COL;
            window.F_CLAIMED_REWARDS_COL = F_CLAIMED_REWARDS_COL;

            // 1. Listen for Members
            onSnapshot(collection(db, F_MEMBERS_COL), (snapshot) => {
                localState.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.members = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to members:", error));

            // 2. Listen for Chore Templates
            onSnapshot(collection(db, F_CHORES_COL), (snapshot) => {
                localState.chores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.chores = true;
                hasCheckedDailyChores = false; // New templates, allow re-check
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to chores:", error));

            // 3. Listen for Rewards
            onSnapshot(collection(db, F_REWARDS_COL), (snapshot) => {
                localState.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.rewards = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to rewards:", error));

            // 4. Listen for Daily Chores (for today)
            const todayISO = new Date().toISOString().split('T')[0];
            const qDaily = query(collection(db, F_DAILY_CHORES_COL), where("date", "==", todayISO));
            
            onSnapshot(qDaily, (snapshot) => {
                localState.dailyChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.dailyChores = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to daily chores:", error));

            // 5. Listen for Claimed (not delivered) Rewards
            const qClaimed = query(collection(db, F_CLAIMED_REWARDS_COL), where("delivered", "==", false));
            onSnapshot(qClaimed, (snapshot) => {
                localState.claimedRewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.claimedRewards = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to claimed rewards:", error));
        }

        // === Core Logic: Check if all data is loaded, then run generation ===
        function checkInitialLoad() {
            // Check if all data streams have loaded at least once
            if (Object.values(hasLoaded).every(Boolean)) {
                // Only run the generation if it hasn't been run successfully yet
                if (!hasCheckedDailyChores) {
                    checkAndGenerateDailyChores();
                }
            }
        }
        
        // === Core Logic: Daily Chore Generation (for Today) ===
        async function checkAndGenerateDailyChores() {
            // This function checks ONCE on load if *today's* chores are generated.
            if (hasCheckedDailyChores || localState.chores.length === 0) {
                if (localState.chores.length === 0) hasCheckedDailyChores = true;
                return;
            }
            
            console.log("Checking if daily chores need generation for *today*...");
            
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            const todayDay = DAYS_OF_WEEK[today.getDay()]; // e.g., 'mon'

            // Find chores scheduled for today
            const choresForToday = localState.chores.filter(chore => 
                chore.schedule && chore.schedule.includes(todayDay)
            );

            if (choresForToday.length === 0) {
                 hasCheckedDailyChores = true; // Mark as "checked"
                 return;
            }

            // Check which of these are *already* in dailyChores
            const existingTemplateIds = new Set(
                localState.dailyChores.map(dc => dc.templateId)
            );

            for (const chore of choresForToday) {
                if (!existingTemplateIds.has(chore.id)) {
                    // This chore is missing for today. Create it.
                    console.log(`Generating chore "${chore.name}" for today.`);
                    try {
                        await addDoc(collection(db, F_DAILY_CHORES_COL), {
                            templateId: chore.id,
                            name: chore.name,
                            emoji: chore.emoji,
                            points: chore.points,
                            assignedTo: chore.defaultAssignee || null,
                            date: todayISO,
                            isComplete: false,
                            isAdHoc: false,
                            createdAt: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error generating daily chore:", e);
                    }
                }
            }
            
            // Mark as checked *after* successful run
            hasCheckedDailyChores = true;
        }

        /**
         * Populates daily chores for a given template for the entire current week.
         * Also cleans up chores if a day is removed from the schedule.
         * @param {object} choreTemplate - The chore template object.
         * @param {string} choreId - The ID of the chore template.
         */
        async function generateDailyChoresForTemplate(choreTemplate, choreId) {
            console.log(`Syncing weekly schedule for chore: ${choreTemplate.name}`);
            
            // 1. Get start of the current week (Monday)
            const today = new Date();
            const startOfWeek = new Date(today);
            const dayOfWeek = today.getDay(); // 0 = Sun, 1 = Mon
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Get to Monday
            startOfWeek.setDate(today.getDate() + diff);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const weekDates = [];
            const weekDatesISO = [];
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                weekDates.push(day);
                weekDatesISO.push(day.toISOString().split('T')[0]);
            }
            
            // 2. Get all existing daily chores for this template for this week
            const q = query(
                collection(db, F_DAILY_CHORES_COL),
                where("templateId", "==", choreId),
                where("date", "in", weekDatesISO)
            );
            
            const snapshot = await getDocs(q);
            const existingChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const existingChoresMap = new Map(existingChores.map(chore => [chore.date, chore]));

            // 3. Loop through the week and sync
            for (const date of weekDates) {
                const dateISO = date.toISOString().split('T')[0];
                const dayName = DAYS_OF_WEEK[date.getDay()];
                
                const shouldExist = choreTemplate.schedule && choreTemplate.schedule.includes(dayName);
                const doesExist = existingChoresMap.has(dateISO);
                const existingChore = existingChoresMap.get(dateISO);

                if (shouldExist && !doesExist) {
                    // A. Create missing chore
                    console.log(`  -> Creating "${choreTemplate.name}" for ${dayName} (${dateISO})`);
                    try {
                        await addDoc(collection(db, F_DAILY_CHORES_COL), {
                            templateId: choreId,
                            name: choreTemplate.name,
                            emoji: choreTemplate.emoji,
                            points: choreTemplate.points,
                            assignedTo: choreTemplate.defaultAssignee || null,
                            date: dateISO,
                            isComplete: false,
                            isAdHoc: false,
                            createdAt: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error creating daily chore:", e);
                    }
                } else if (!shouldExist && doesExist) {
                    // B. Delete chore that shouldn't exist
                    // Only delete if it's not completed (don't delete history)
                    if (!existingChore.isComplete) {
                        console.log(`  -> Deleting "${choreTemplate.name}" for ${dayName} (${dateISO})`);
                        try {
                            await deleteDoc(doc(db, F_DAILY_CHORES_COL, existingChore.id));
                        } catch (e) {
                            console.error("Error deleting daily chore:", e);
                        }
                    }
                } else if (shouldExist && doesExist) {
                    // C. Update existing chore if details (name, points, etc.) changed
                    // This also handles re-assigning to default if it's currently unassigned
                    const choreRef = doc(db, F_DAILY_CHORES_COL, existingChore.id);
                    const updates = {};
                    if (existingChore.name !== choreTemplate.name) updates.name = choreTemplate.name;
                    if (existingChore.emoji !== choreTemplate.emoji) updates.emoji = choreTemplate.emoji;
                    if (existingChore.points !== choreTemplate.points) updates.points = choreTemplate.points;
                    
                    // Only reset assignment if it's currently unassigned OR if the chore is not yet done
                    const newDefault = choreTemplate.defaultAssignee || null;
                    if (!existingChore.isComplete && existingChore.assignedTo !== newDefault) {
                         updates.assignedTo = newDefault;
                    }
                    
                    if (Object.keys(updates).length > 0) {
                        console.log(`  -> Updating "${choreTemplate.name}" for ${dayName} (${dateISO})`);
                        try {
                            await updateDoc(choreRef, updates);
                        } catch (e) {
                            console.error("Error updating daily chore:", e);
                        }
                    }
                }
            }
        }
        
        // === Master Render Function ===
        function renderAll() {
            if (!lucide) return; // Don't render if icons aren't loaded

            // 1. Render main views
            renderDailyChores();
            renderWeeklySchedule(); // Note: This is async and fetches its own data
            renderPointsAndRewards();
            renderSetup();
            
            // 2. Populate shared elements
            populateMemberDropdowns();

            // 3. Render icons
            lucide.createIcons();
        }

        // === View: Daily List ===
        function renderDailyChores() {
            const container = document.getElementById('daily-chores-container');
            if (!container) return;
            container.innerHTML = ''; // Clear existing
            
            // Create a map for quick member lookup
            const memberMap = new Map(localState.members.map(m => [m.id, m]));

            // 1. Create sections for each member
            localState.members.forEach(member => {
                const memberChores = localState.dailyChores.filter(chore => chore.assignedTo === member.id);
                const section = document.createElement('section');
                section.id = `member-section-${member.id}`;
                section.classList.add('member-chore-list', 'bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                
                // Add drag-and-drop target attributes
                section.dataset.memberId = member.id;
                section.addEventListener('dragover', dragOver);
                section.addEventListener('dragenter', dragEnter);
                section.addEventListener('dragleave', dragLeave);
                section.addEventListener('drop', drop);

                section.innerHTML = `
                    <h3 class="text-xl font-semibold mb-3 flex items-center">
                        <span class="text-2xl mr-2">${member.emoji || 'ðŸ‘¤'}</span>
                        ${member.name}'s Chores
                    </h3>
                    <div class="space-y-2">
                        ${memberChores.length > 0 ? memberChores.map(chore => renderChoreItem(chore, memberMap)).join('') : '<p class="text-gray-500 text-sm">No chores assigned for today.</p>'}
                    </div>
                `;
                container.appendChild(section);
            });

            // 2. Create section for Unassigned Chores
            const unassignedChores = localState.dailyChores.filter(chore => !chore.assignedTo);
            const unassignedSection = document.createElement('section');
            unassignedSection.id = 'member-section-unassigned';
            unassignedSection.classList.add('member-chore-list', 'bg-gray-50', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
            
            // Add drag-and-drop target attributes
            unassignedSection.dataset.memberId = 'unassigned';
            unassignedSection.addEventListener('dragover', dragOver);
            unassignedSection.addEventListener('dragenter', dragEnter);
            unassignedSection.addEventListener('dragleave', dragLeave);
            unassignedSection.addEventListener('drop', drop);
            
            unassignedSection.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 flex items-center text-gray-700">
                    <span data-lucide="list-todo" class="mr-2"></span>
                    Unassigned Pool
                </h3>
                <div class="space-y-2">
                    ${unassignedChores.length > 0 ? unassignedChores.map(chore => renderChoreItem(chore, memberMap)).join('') : '<p class="text-gray-500 text-sm">No unassigned chores for today.</p>'}
                </div>
            `;
            container.appendChild(unassignedSection);
        }

        function renderChoreItem(chore, memberMap) {
            const member = chore.assignedTo ? memberMap.get(chore.assignedTo) : null;
            const memberColor = member ? (member.color || 'bg-gray-500') : 'bg-gray-500';
            const memberInitial = member ? member.name[0].toUpperCase() : '?';

            return `
                <div id="chore-${chore.id}" 
                     class="chore-item flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm ${chore.isComplete ? 'chore-complete' : ''}"
                     draggable="true" 
                     data-chore-id="${chore.id}">
                    <div class="flex items-center">
                        <button class="chore-toggle-btn text-3xl mr-3 cursor-pointer" data-chore-id="${chore.id}" data-member-id="${chore.assignedTo || ''}" data-points="${chore.points}">
                            ${chore.isComplete ? 'âœ…' : chore.emoji}
                        </button>
                        <div>
                            <p class="font-medium text-lg">${chore.name}</p>
                            <span class="text-sm font-semibold text-green-600">+${chore.points} pts</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${member ? 
                            `<div class="flex items-center gap-2" title="Assigned to ${member.name}">
                                <span class="hidden sm:block text-sm font-medium text-gray-600">${member.name}</span>
                                <div class="h-8 w-8 rounded-full ${memberColor} flex items-center justify-center text-white font-bold text-sm">
                                    ${member.emoji ? member.emoji : memberInitial}
                                </div>
                            </div>` : 
                            `<span class="text-sm italic text-gray-500">Unassigned</span>`
                        }
                        <button class="assign-chore-btn p-2 rounded-full hover:bg-gray-100" data-chore-id="${chore.id}" title="Assign Chore">
                            <span data-lucide="user-cog" class="h-5 w-5 text-gray-600"></span>
                        </button>
                    </div>
                </div>
            `;
        }

        function getMemberById(memberId) {
            return localState.members.find(m => m.id === memberId);
        }
        
        function getMemberColor(memberId) {
            if (!memberId) return 'bg-gray-400';
            const member = getMemberById(memberId);
            return member ? member.color : 'bg-gray-400';
        }

        // === View: Weekly Schedule ===
        async function renderWeeklySchedule() {
            const container = document.getElementById('weekly-schedule-grid');
            if (!container) return;
            container.innerHTML = ''; // Clear for loading

            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            const startOfWeek = new Date(today);
            const dayOfWeek = today.getDay(); // 0 = Sun, 1 = Mon
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Get to Monday
            startOfWeek.setDate(today.getDate() + diff);
            startOfWeek.setHours(0, 0, 0, 0);

            // Get all daily chores for the *entire current week*
            const weekDatesISO = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                weekDatesISO.push(day.toISOString().split('T')[0]);
            }
            
            const qWeek = query(collection(db, F_DAILY_CHORES_COL), where("date", "in", weekDatesISO));
            let weeklyChores = [];
            try {
                const snapshot = await getDocs(qWeek);
                weeklyChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error("Error fetching weekly chores:", e);
                container.innerHTML = `<p class="text-red-500">Error loading weekly schedule.</p>`;
                return;
            }

            // Group chores by date
            const choresByDate = new Map(weekDatesISO.map(date => [date, []]));
            weeklyChores.forEach(chore => {
                if (choresByDate.has(chore.date)) {
                    choresByDate.get(chore.date).push(chore);
                }
            });

            // Render 7 day columns
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                
                const dayISO = day.toISOString().split('T')[0];
                const dayName = WEEK_DAYS_FULL[day.getDay()];
                const dayNum = day.getDate();
                const isToday = (dayISO === todayISO);
                
                const dayChores = choresByDate.get(dayISO) || [];

                const col = document.createElement('div');
                col.className = `p-3 rounded-lg border ${isToday ? 'bg-blue-50 border-blue-300' : 'bg-white border-gray-200'} space-y-2`;
                col.innerHTML = `
                    <h4 class="font-bold text-lg ${isToday ? 'text-blue-700' : 'text-gray-800'}">${dayName}</h4>
                    <p class="text-sm text-gray-500 mb-3">${day.toLocaleDateString([], { month: 'long' })} ${dayNum}</p>
                    <div class="space-y-2">
                        ${dayChores.length > 0 ? dayChores.map(chore => {
                            const member = getMemberById(chore.assignedTo);
                            const color = member ? member.color : 'bg-gray-400';
                            const initial = member ? (member.emoji || member.name[0]) : '?';
                            return `
                                <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-md ${chore.isComplete ? 'chore-complete' : ''}">
                                    <span class="h-6 w-6 rounded-full ${color} flex-shrink-0 flex items-center justify-center text-white text-xs font-bold" title="${member ? member.name : 'Unassigned'}">
                                        ${initial}
                                    </span>
                                    <span class="text-sm truncate">${chore.emoji} ${chore.name}</span>
                                </div>
                            `;
                        }).join('') : '<p class="text-xs text-gray-400">No chores.</p>'}
                    </div>
                `;
                container.appendChild(col);
            }
        }

        // === View: Points & Rewards ===
        function renderPointsAndRewards() {
            const pointsGrid = document.getElementById('member-points-grid');
            const rewardsGrid = document.getElementById('available-rewards-grid');
            const claimedList = document.getElementById('claimed-rewards-list');
            if (!pointsGrid || !rewardsGrid || !claimedList) return;

            // 1. Render Point Totals
            pointsGrid.innerHTML = '';
            localState.members.forEach(member => {
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg shadow-md flex items-center gap-4 ${member.color} text-white`;
                card.innerHTML = `
                    <span class="text-4xl">${member.emoji || 'ðŸ‘¤'}</span>
                    <div>
                        <p class="text-xl font-bold">${member.name}</p>
                        <p class="text-3xl font-light">${member.points || 0} <span class="text-base opacity-80">pts</span></p>
                    </div>
                `;
                pointsGrid.appendChild(card);
            });
            if (localState.members.length === 0) {
                pointsGrid.innerHTML = `<p class="text-gray-500 col-span-full">Add members in the Setup tab to see points.</p>`;
            }

            // 2. Render Available Rewards
            rewardsGrid.innerHTML = '';
            const selectedMember = getMemberById(selectedRedeemerId);
            const memberPoints = selectedMember ? (selectedMember.points || 0) : 0;
            
            localState.rewards.forEach(reward => {
                const canAfford = selectedMember && memberPoints >= reward.cost;
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg border shadow-sm flex flex-col items-center justify-between gap-2 ${selectedMember && !canAfford ? 'opacity-40 bg-gray-100' : 'bg-white'}`;
                card.innerHTML = `
                    <span class="text-5xl">${reward.emoji || 'ðŸŽ'}</span>
                    <p class="font-medium text-center">${reward.name}</p>
                    <p class="font-bold text-xl text-green-600">${reward.cost} pts</p>
                    <button 
                        class="redeem-reward-btn w-full py-2 px-4 rounded-lg text-white font-semibold ${canAfford ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed'}"
                        data-reward-id="${reward.id}"
                        data-cost="${reward.cost}"
                        ${canAfford ? '' : 'disabled'}>
                        Redeem
                    </button>
                `;
                rewardsGrid.appendChild(card);
            });
            if (localState.rewards.length === 0) {
                rewardsGrid.innerHTML = `<p class="text-gray-500 col-span-full">Add rewards in the Setup tab.</p>`;
            }

            // 3. Render Claimed (Not Delivered) Rewards
            claimedList.innerHTML = '';
            if (localState.claimedRewards.length > 0) {
                localState.claimedRewards.forEach(claimed => {
                    const member = getMemberById(claimed.memberId);
                    const reward = localState.rewards.find(r => r.id === claimed.rewardId);
                    if (!member || !reward) return; // Data integrity check

                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${reward.emoji || 'ðŸŽ'}</span>
                            <div>
                                <p class="font-medium">${reward.name}</p>
                                <p class="text-sm text-gray-600">Claimed by <strong class="font-semibold ${member.color.replace('bg-', 'text-')}">${member.name}</strong> for ${reward.cost} pts</p>
                            </div>
                        </div>
                        <button class="deliver-reward-btn py-2 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 text-sm" data-claimed-id="${claimed.id}">
                            Mark Delivered
                        </button>
                    `;
                    claimedList.appendChild(item);
                });
            } else {
                claimedList.innerHTML = `<p class="text-gray-500">No pending rewards.</p>`;
            }
        }

        // === View: Setup ===
        function renderSetup() {
            // 1. Render Member List
            renderSetupMembersList();
            
            // 2. Render Chore Template List
            renderSetupChoresList();
            
            // 3. Render Reward List
            renderSetupRewardsList();
        }

        function populateMemberDropdowns() {
            const dropdowns = [
                document.getElementById('adhoc-assignee'),
                document.getElementById('adjust-points-member'),
                document.getElementById('chore-default-assignee'),
                document.getElementById('assign-chore-select'),
                document.getElementById('redeem-member-select'),
                document.getElementById('edit-chore-default-assignee')
            ];

            const memberOptions = localState.members.map(member => 
                `<option value="${member.id}">${member.emoji} ${member.name}</option>`
            ).join('');

            dropdowns.forEach(select => {
                if (!select) return;
                
                let currentVal = select.value; // Preserve selection
                
                if (select.id === 'redeem-member-select') {
                    select.innerHTML = '<option value="">Select a member...</option>' + memberOptions;
                    select.value = selectedRedeemerId || "";
                } else if (select.id === 'assign-chore-select') {
                    select.innerHTML = '<option value="unassigned">Unassigned</option>' + memberOptions;
                } else if (select.id === 'adhoc-assignee') {
                    select.innerHTML = '<option value="unassigned">Unassigned</option>' + memberOptions;
                } else if (select.id === 'chore-default-assignee' || select.id === 'edit-chore-default-assignee') {
                    select.innerHTML = '<option value="unassigned">Default: Unassigned</option>' + memberOptions;
                } else if (select.id === 'adjust-points-member') {
                     select.innerHTML = '<option value="">Select Member</option>' + memberOptions;
                } else {
                    select.innerHTML = memberOptions;
                }
                
                // Restore previous selection if it still exists
                if (Array.from(select.options).some(opt => opt.value === currentVal)) {
                    select.value = currentVal;
                }
            });
        }
        
        function renderSetupMembersList() {
            const listContainer = document.getElementById('setup-members-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            
            localState.members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="h-8 w-8 rounded-full ${member.color} flex items-center justify-center text-white font-bold text-sm">
                            ${member.emoji || member.name[0]}
                        </span>
                        <div>
                            <p class="font-medium text-lg">${member.name}</p>
                            <p class="text-sm text-green-600">${member.points || 0} pts</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-member-btn p-2 rounded-full hover:bg-gray-200" data-member-id="${member.id}" title="Edit Member">
                            <span data-lucide="edit-2" class="h-5 w-5 text-blue-600"></span>
                        </button>
                        <button class="delete-member-btn p-2 rounded-full hover:bg-gray-200" data-member-id="${member.id}" data-member-name="${member.name}" title="Delete Member">
                            <span data-lucide="trash-2" class="h-5 w-5 text-red-600"></span>
                        </button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            
            if (localState.members.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-500">No members added yet.</p>`;
            }
        }

        function renderSetupChoresList() {
            const listContainer = document.getElementById('setup-chores-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            
            localState.chores.forEach(chore => {
                const member = getMemberById(chore.defaultAssignee);
                const schedule = chore.schedule ? chore.schedule.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ') : 'None';
                
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">${chore.emoji || 'ðŸ“‹'}</span>
                        <div>
                            <p class="font-medium text-lg">${chore.name} (+${chore.points} pts)</p>
                            <p class="text-sm text-gray-600">Schedule: ${schedule}</p>
                            <p class="text-sm text-gray-600">Default: ${member ? member.name : 'Unassigned'}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-chore-btn p-2 rounded-full hover:bg-gray-200" data-chore-id="${chore.id}" title="Edit Chore">
                            <span data-lucide="edit-2" class="h-5 w-5 text-blue-600"></span>
                        </button>
                        <button class="delete-chore-btn p-2 rounded-full hover:bg-gray-200" data-chore-id="${chore.id}" data-chore-name="${chore.name}" title="Delete Chore">
                            <span data-lucide="trash-2" class="h-5 w-5 text-red-600"></span>
                        </button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            
            if (localState.chores.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-500">No recurring chore templates added yet.</p>`;
            }
        }
        
        function renderSetupRewardsList() {
            const listContainer = document.getElementById('setup-rewards-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';

            localState.rewards.forEach(reward => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">${reward.emoji || 'ðŸŽ'}</span>
                        <div>
                            <p class="font-medium text-lg">${reward.name}</p>
                            <p class="text-sm text-green-600">${reward.cost} pts</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-reward-btn p-2 rounded-full hover:bg-gray-200" data-reward-id="${reward.id}" title="Edit Reward">
                            <span data-lucide="edit-2" class="h-5 w-5 text-blue-600"></span>
                        </button>
                        <button class="delete-reward-btn p-2 rounded-full hover:bg-gray-200" data-reward-id="${reward.id}" data-reward-name="${reward.name}" title="Delete Reward">
                            <span data-lucide="trash-2" class="h-5 w-5 text-red-600"></span>
                        </button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            
            if (localState.rewards.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-500">No rewards added yet.</p>`;
            }
        }
        
        function renderEditChoreSchedule(schedule = []) {
            const container = document.getElementById('edit-chore-schedule-container');
            container.innerHTML = '';
            DAYS_OF_WEEK.forEach(day => {
                const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);
                const isChecked = schedule.includes(day);
                container.innerHTML += `
                    <label class="flex items-center gap-2 p-2 border rounded-lg">
                        <input type="checkbox" name="edit-chore-schedule" value="${day}" class="form-checkbox rounded" ${isChecked ? 'checked' : ''}> ${dayLabel}
                    </label>
                `;
            });
        }


        // === UI Helpers (Toast, Modals, Confetti) ===
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-message');
            const text = document.getElementById('toast-text');
            if (!toast || !text) return;

            text.textContent = message;
            toast.className = 'fixed bottom-6 right-6 p-4 rounded-lg shadow-xl text-white transition-all'; // Reset
            
            if (isError) {
                toast.classList.add('bg-red-600');
                playSound('error');
            } else {
                toast.classList.add('bg-green-600');
                playSound('success');
            }

            toast.classList.remove('translate-x-[120%]');
            
            setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
            }, 3000);
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        // Make hideModal globally accessible
        window.hideModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                
                // Clear password modal state
                if(modalId === 'password-modal') {
                    document.getElementById('password-input').value = '';
                    document.getElementById('password-error').classList.add('hidden');
                    passwordSuccessCallback = null;
                }
                // Clear delete modal state
                if(modalId === 'confirm-delete-modal') {
                    document.getElementById('delete-item-name').textContent = '';
                    deleteSuccessCallback = null;
                }
            }
        }

        function showPasswordModal(callback) {
            passwordSuccessCallback = callback;
            showModal('password-modal');
        }

        function showDeleteModal(itemName, callback) {
            document.getElementById('delete-item-name').textContent = itemName;
            deleteSuccessCallback = callback;
            showModal('confirm-delete-modal');
        }

        function runConfetti() {
            if (!window.confetti) return;
            
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);

                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        // === Event Handlers (Setup) ===

        // --- Member Handlers ---
        async function handleAddMember(e) {
            e.preventDefault();
            const name = document.getElementById('member-name').value.trim();
            const emoji = document.getElementById('member-emoji').value.trim();
            const color = document.getElementById('member-color').value;

            if (!name || !emoji || !color) {
                showToast("Please fill out all member fields.", true);
                return;
            }
            
            try {
                await addDoc(collection(db, F_MEMBERS_COL), {
                    name,
                    emoji,
                    color,
                    points: 0,
                    createdAt: serverTimestamp()
                });
                showToast("Member added successfully!");
                e.target.reset();
            } catch (error) {
                console.error("Error adding member: ", error);
                showToast("Failed to add member.", true);
            }
        }

        function handleAdjustPoints(e) {
            e.preventDefault();
            const memberId = document.getElementById('adjust-points-member').value;
            const amount = parseInt(document.getElementById('adjust-points-amount').value, 10);
            const password = document.getElementById('adjust-points-password').value;

            if (!memberId || !amount) {
                showToast("Please select a member and enter an amount.", true);
                return;
            }
            if (password !== PASSWORD) {
                showToast("Incorrect admin password.", true);
                return;
            }
            
            const member = getMemberById(memberId);
            if (!member) return;
            
            const newPoints = (member.points || 0) + amount;
            
            try {
                const memberRef = doc(db, F_MEMBERS_COL, memberId);
                updateDoc(memberRef, { points: newPoints });
                showToast(`Points adjusted for ${member.name}. New total: ${newPoints}`);
                e.target.reset();
            } catch (error) {
                console.error("Error adjusting points: ", error);
                showToast("Failed to adjust points.", true);
            }
        }

        function handleOpenEditMember(e) {
            const memberId = e.target.closest('.edit-member-btn').dataset.memberId;
            const member = getMemberById(memberId);
            if (!member) return;
            
            document.getElementById('edit-member-id').value = member.id;
            document.getElementById('edit-member-name').value = member.name;
            document.getElementById('edit-member-emoji').value = member.emoji;
            document.getElementById('edit-member-color').value = member.color;
            
            showModal('edit-member-modal');
        }
        
        async function handleEditMember(e) {
            e.preventDefault();
            const memberId = document.getElementById('edit-member-id').value;
            const name = document.getElementById('edit-member-name').value.trim();
            const emoji = document.getElementById('edit-member-emoji').value.trim();
            const color = document.getElementById('edit-member-color').value;
            
            if (!memberId || !name || !emoji || !color) {
                showToast("Please fill out all fields.", true);
                return;
            }
            
            try {
                const memberRef = doc(db, F_MEMBERS_COL, memberId);
                await updateDoc(memberRef, { name, emoji, color });
                showToast("Member updated successfully!");
                hideModal('edit-member-modal');
            } catch (error) {
                console.error("Error updating member: ", error);
                showToast("Failed to update member.", true);
            }
        }

        function handleDeleteMember(e) {
            const btn = e.target.closest('.delete-member-btn');
            const memberId = btn.dataset.memberId;
            const memberName = btn.dataset.memberName;
            
            showPasswordModal(() => {
                showDeleteModal(memberName, async () => {
                    try {
                        // TODO: Handle reassignment of chores, etc.
                        // For now, just delete the member.
                        await deleteDoc(doc(db, F_MEMBERS_COL, memberId));
                        showToast(`Member ${memberName} deleted.`);
                        hideModal('confirm-delete-modal');
                    } catch (error) {
                        console.error("Error deleting member: ", error);
                        showToast("Failed to delete member.", true);
                    }
                });
            });
        }

        // --- Chore Handlers ---
        async function handleAddChore(e) {
            e.preventDefault();
            const name = document.getElementById('chore-name').value.trim();
            const emoji = document.getElementById('chore-emoji').value.trim();
            const points = parseInt(document.getElementById('chore-points').value, 10);
            const defaultAssignee = document.getElementById('chore-default-assignee').value;
            const scheduleCheckboxes = document.querySelectorAll('input[name="chore-schedule"]:checked');
            const schedule = Array.from(scheduleCheckboxes).map(cb => cb.value);

            if (!name || !emoji || !points || points < 0) {
                showToast("Please fill out name, emoji, and points.", true);
                return;
            }
            
            const newChoreTemplate = {
                name,
                emoji,
                points,
                defaultAssignee: defaultAssignee === 'unassigned' ? null : defaultAssignee,
                schedule,
                createdAt: serverTimestamp()
            };
            
            try {
                const docRef = await addDoc(collection(db, F_CHORES_COL), newChoreTemplate);
                showToast("Chore template added!");
                e.target.reset();
                
                // Now, generate the daily chores for this new template for the week
                await generateDailyChoresForTemplate(newChoreTemplate, docRef.id);
                
            } catch (error) {
                console.error("Error adding chore: ", error);
                showToast("Failed to add chore.", true);
            }
        }
        
        function handleOpenEditChore(e) {
            const choreId = e.target.closest('.edit-chore-btn').dataset.choreId;
            const chore = localState.chores.find(c => c.id === choreId);
            if (!chore) return;
            
            document.getElementById('edit-chore-id').value = chore.id;
            document.getElementById('edit-chore-name').value = chore.name;
            document.getElementById('edit-chore-emoji').value = chore.emoji;
            document.getElementById('edit-chore-points').value = chore.points;
            document.getElementById('edit-chore-default-assignee').value = chore.defaultAssignee || 'unassigned';
            
            renderEditChoreSchedule(chore.schedule);
            
            showModal('edit-chore-modal');
        }
        
        async function handleEditChore(e) {
            e.preventDefault();
            const choreId = document.getElementById('edit-chore-id').value;
            const name = document.getElementById('edit-chore-name').value.trim();
            const emoji = document.getElementById('edit-chore-emoji').value.trim();
            const points = parseInt(document.getElementById('edit-chore-points').value, 10);
            const defaultAssignee = document.getElementById('edit-chore-default-assignee').value;
            const scheduleCheckboxes = document.querySelectorAll('input[name="edit-chore-schedule"]:checked');
            const schedule = Array.from(scheduleCheckboxes).map(cb => cb.value);
            
            if (!choreId || !name || !emoji || !points || points < 0) {
                showToast("Please fill out all fields correctly.", true);
                return;
            }
            
            const updatedChoreTemplate = {
                name,
                emoji,
                points,
                schedule,
                defaultAssignee: defaultAssignee === 'unassigned' ? null : defaultAssignee
            };
            
            try {
                const choreRef = doc(db, F_CHORES_COL, choreId);
                await updateDoc(choreRef, updatedChoreTemplate);
                
                // Now, re-sync the weekly chores based on this updated template
                await generateDailyChoresForTemplate(updatedChoreTemplate, choreId);
                
                showToast("Chore template updated!");
                hideModal('edit-chore-modal');
            } catch (error) {
                console.error("Error updating chore: ", error);
                showToast("Failed to update chore.", true);
            }
        }

        function handleDeleteChore(e) {
            const btn = e.target.closest('.delete-chore-btn');
            const choreId = btn.dataset.choreId;
            const choreName = btn.dataset.choreName;
            
            showPasswordModal(() => {
                showDeleteModal(choreName, async () => {
                    try {
                        // 1. Delete the chore template
                        await deleteDoc(doc(db, F_CHORES_COL, choreId));
                        
                        // 2. Delete all *future, non-completed* daily chores from this template
                        const todayISO = new Date().toISOString().split('T')[0];
                        const q = query(
                            collection(db, F_DAILY_CHORES_COL),
                            where("templateId", "==", choreId),
                            where("date", ">=", todayISO),
                            where("isComplete", "==", false)
                        );
                        const snapshot = await getDocs(q);
                        for (const d of snapshot.docs) {
                            await deleteDoc(doc(db, F_DAILY_CHORES_COL, d.id));
                        }
                        
                        showToast(`Chore template ${choreName} and future tasks deleted.`);
                        hideModal('confirm-delete-modal');
                    } catch (error) {
                        console.error("Error deleting chore: ", error);
                        showToast("Failed to delete chore.", true);
                    }
                });
            });
        }

        // --- Reward Handlers ---
        async function handleAddReward(e) {
            e.preventDefault();
            const name = document.getElementById('reward-name').value.trim();
            const emoji = document.getElementById('reward-emoji').value.trim();
            const cost = parseInt(document.getElementById('reward-cost').value, 10);

            if (!name || !emoji || !cost || cost <= 0) {
                showToast("Please fill out all fields with a valid cost.", true);
                return;
            }
            
            try {
                await addDoc(collection(db, F_REWARDS_COL), {
                    name,
                    emoji,
                    cost,
                    createdAt: serverTimestamp()
                });
                showToast("Reward added!");
                e.target.reset();
            } catch (error) {
                console.error("Error adding reward: ", error);
                showToast("Failed to add reward.", true);
            }
        }
        
        function handleOpenEditReward(e) {
            const rewardId = e.target.closest('.edit-reward-btn').dataset.rewardId;
            const reward = localState.rewards.find(r => r.id === rewardId);
            if (!reward) return;
            
            document.getElementById('edit-reward-id').value = reward.id;
            document.getElementById('edit-reward-name').value = reward.name;
            document.getElementById('edit-reward-emoji').value = reward.emoji;
            document.getElementById('edit-reward-cost').value = reward.cost;
            
            showModal('edit-reward-modal');
        }
        
        async function handleEditReward(e) {
            e.preventDefault();
            const rewardId = document.getElementById('edit-reward-id').value;
            const name = document.getElementById('edit-reward-name').value.trim();
            const emoji = document.getElementById('edit-reward-emoji').value.trim();
            const cost = parseInt(document.getElementById('edit-reward-cost').value, 10);

            if (!rewardId || !name || !emoji || !cost || cost <= 0) {
                showToast("Please fill out all fields with a valid cost.", true);
                return;
            }
            
            try {
                const rewardRef = doc(db, F_REWARDS_COL, rewardId);
                await updateDoc(rewardRef, { name, emoji, cost });
                showToast("Reward updated!");
                hideModal('edit-reward-modal');
            } catch (error) {
                console.error("Error updating reward: ", error);
                showToast("Failed to update reward.", true);
            }
        }

        function handleDeleteReward(e) {
            const btn = e.target.closest('.delete-reward-btn');
            const rewardId = btn.dataset.rewardId;
            const rewardName = btn.dataset.rewardName;
            
            showPasswordModal(() => {
                showDeleteModal(rewardName, async () => {
                    try {
                        await deleteDoc(doc(db, F_REWARDS_COL, rewardId));
                        // TODO: What about claimed rewards? For now, they will just show "Deleted Reward"
                        showToast(`Reward ${rewardName} deleted.`);
                        hideModal('confirm-delete-modal');
                    } catch (error) {
                        console.error("Error deleting reward: ", error);
                        showToast("Failed to delete reward.", true);
                    }
                });
            });
        }
        
        // === Event Handlers (Daily List) ===
        
        async function handleAddAdHocChore(e) {
            e.preventDefault();
            const name = document.getElementById('adhoc-name').value.trim();
            const emoji = document.getElementById('adhoc-emoji').value.trim();
            const points = parseInt(document.getElementById('adhoc-points').value, 10);
            const assignedTo = document.getElementById('adhoc-assignee').value;
            
            if (!name || !emoji || !points || points <= 0) {
                showToast("Please fill out name, emoji, and points.", true);
                return;
            }

            const todayISO = new Date().toISOString().split('T')[0];
            
            try {
                await addDoc(collection(db, F_DAILY_CHORES_COL), {
                    name,
                    emoji,
                    points,
                    assignedTo: assignedTo === 'unassigned' ? null : assignedTo,
                    date: todayISO,
                    isComplete: false,
                    isAdHoc: true,
                    createdAt: serverTimestamp()
                });
                showToast("Ad-hoc chore added!");
                e.target.reset();
                document.getElementById('add-adhoc-chore-form').closest('details').open = false;
            } catch (error) {
                console.error("Error adding ad-hoc chore: ", error);
                showToast("Failed to add ad-hoc chore.", true);
            }
        }

        async function handleToggleChoreComplete(e) {
            const btn = e.target.closest('.chore-toggle-btn');
            if (!btn) return;
            
            const choreId = btn.dataset.choreId;
            const memberId = btn.dataset.memberId;
            const points = parseInt(btn.dataset.points, 10);
            
            const chore = localState.dailyChores.find(c => c.id === choreId);
            if (!chore) return;
            
            const newIsComplete = !chore.isComplete;
            
            try {
                // 1. Update the chore
                const choreRef = doc(db, F_DAILY_CHORES_COL, choreId);
                await updateDoc(choreRef, { isComplete: newIsComplete });
                
                // 2. Update member points (if assigned)
                if (memberId && memberId !== 'unassigned') {
                    const member = getMemberById(memberId);
                    if (member) {
                        const pointsChange = newIsComplete ? points : -points;
                        const newPoints = (member.points || 0) + pointsChange;
                        const memberRef = doc(db, F_MEMBERS_COL, memberId);
                        await updateDoc(memberRef, { points: newPoints });
                    }
                }
                
                // 3. Play sound
                playSound(newIsComplete ? 'complete' : 'uncomplete');
                
            } catch (error) {
                console.error("Error toggling chore: ", error);
                showToast("Failed to update chore.", true);
            }
        }
        
        function handleOpenAssignChoreModal(e) {
            const btn = e.target.closest('.assign-chore-btn');
            if (!btn) return;
            
            const choreId = btn.dataset.choreId;
            const chore = localState.dailyChores.find(c => c.id === choreId);
            if (!chore) return;
            
            selectedChoreForAssignment = chore;
            
            document.getElementById('assign-chore-name').textContent = chore.name;
            document.getElementById('assign-chore-select').value = chore.assignedTo || 'unassigned';
            
            showModal('assign-chore-modal');
        }
        
        async function handleAssignChore() {
            if (!selectedChoreForAssignment) return;
            
            const newAssigneeId = document.getElementById('assign-chore-select').value;
            const choreRef = doc(db, F_DAILY_CHORES_COL, selectedChoreForAssignment.id);
            
            try {
                await updateDoc(choreRef, {
                    assignedTo: newAssigneeId === 'unassigned' ? null : newAssigneeId
                });
                showToast("Chore reassigned!");
                hideModal('assign-chore-modal');
                selectedChoreForAssignment = null;
            } catch (error) {
                console.error("Error assigning chore: ", error);
                showToast("Failed to assign chore.", true);
            }
        }
        
        // === Event Handlers (Rewards) ===
        
        function handleRedeemerChange(e) {
            selectedRedeemerId = e.target.value;
            renderPointsAndRewards(); // Re-render to update card states
        }
        
        async function handleRedeemReward(e) {
            const btn = e.target.closest('.redeem-reward-btn');
            if (!btn || !selectedRedeemerId) return;
            
            const rewardId = btn.dataset.rewardId;
            const cost = parseInt(btn.dataset.cost, 10);
            
            const member = getMemberById(selectedRedeemerId);
            const reward = localState.rewards.find(r => r.id === rewardId);
            
            if (!member || !reward) {
                showToast("Error finding member or reward.", true);
                return;
            }
            
            if (member.points < cost) {
                showToast("Not enough points!", true);
                return;
            }
            
            try {
                // 1. Deduct points
                const newPoints = member.points - cost;
                const memberRef = doc(db, F_MEMBERS_COL, member.id);
                await updateDoc(memberRef, { points: newPoints });
                
                // 2. Create a "claimed reward" record
                await addDoc(collection(db, F_CLAIMED_REWARDS_COL), {
                    memberId: member.id,
                    rewardId: reward.id,
                    cost: cost,
                    delivered: false,
                    claimedAt: serverTimestamp()
                });
                
                showToast(`${reward.name} redeemed by ${member.name}!`);
                playSound('redeem');
                runConfetti();
                
            } catch (error) {
                console.error("Error redeeming reward: ", error);
                showToast("Failed to redeem reward.", true);
            }
        }
        
        async function handleDeliverReward(e) {
            const btn = e.target.closest('.deliver-reward-btn');
            if (!btn) return;
            
            const claimedId = btn.dataset.claimedId;
            
            try {
                const claimedRef = doc(db, F_CLAIMED_REWARDS_COL, claimedId);
                await updateDoc(claimedRef, { delivered: true });
                showToast("Reward marked as delivered!");
            } catch (error) {
                console.error("Error delivering reward: ", error);
                showToast("Failed to mark as delivered.", true);
            }
        }

        // === Drag & Drop Handlers ===
        let draggedChoreId = null;

        function initDragAndDrop() {
            // Listen on the document for drag start/end
            document.addEventListener('dragstart', dragStart);
            document.addEventListener('dragend', dragEnd);
        }

        function dragStart(e) {
            const choreItem = e.target.closest('.chore-item');
            if (!choreItem) {
                e.preventDefault();
                return;
            }
            draggedChoreId = choreItem.dataset.choreId;
            setTimeout(() => choreItem.classList.add('chore-dragging'), 0);
        }

        function dragEnd(e) {
            const choreItem = document.getElementById(`chore-${draggedChoreId}`);
            if (choreItem) {
                choreItem.classList.remove('chore-dragging');
            }
            // Remove all drop target highlights
            document.querySelectorAll('.drag-over-target').forEach(el => el.classList.remove('drag-over-target'));
            draggedChoreId = null;
        }
        
        function dragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const targetList = e.target.closest('.member-chore-list');
            if (targetList) {
                e.dataTransfer.dropEffect = 'move';
            }
        }
        
        function dragEnter(e) {
            e.preventDefault();
            const targetList = e.target.closest('.member-chore-list');
            if (targetList) {
                targetList.classList.add('drag-over-target');
            }
        }
        
        function dragLeave(e) {
            const targetList = e.target.closest('.member-chore-list');
            if (targetList) {
                targetList.classList.remove('drag-over-target');
            }
        }

        async function drop(e) {
            e.preventDefault();
            const targetList = e.target.closest('.member-chore-list');
            if (!targetList || !draggedChoreId) return;
            
            targetList.classList.remove('drag-over-target');
            const newMemberId = targetList.dataset.memberId;
            const chore = localState.dailyChores.find(c => c.id === draggedChoreId);
            
            // Only update if the assignment is different
            if (chore && (chore.assignedTo || 'unassigned') !== newMemberId) {
                console.log(`Dropping chore ${draggedChoreId} onto ${newMemberId}`);
                const choreRef = doc(db, F_DAILY_CHORES_COL, draggedChoreId);
                try {
                    await updateDoc(choreRef, {
                        assignedTo: newMemberId === 'unassigned' ? null : newMemberId
                    });
                    showToast("Chore assigned!");
                    playSound('success');
                } catch (error) {
                    console.error("Error assigning chore via drop: ", error);
                    showToast("Failed to assign chore.", true);
                }
            }
            draggedChoreId = null;
        }

        // === App Initialization ===
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Firebase (which handles auth and data load)
            initFirebase();
            
            // 2. Start clock
            updateTime();
            setInterval(updateTime, 1000); // Update time every second
            
            // 3. Initialize Sounds (on first user interaction)
            document.body.addEventListener('click', initSounds, { once: true });
            
            // 4. Initialize Icons
            if (window.lucide) {
                lucide.createIcons();
            } else {
                console.error("Lucide icons failed to load.");
            }

            // 5. Setup Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.view-content');
            const viewTitle = document.getElementById('view-title');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.dataset.view;
                    
                    // Update content
                    views.forEach(v => v.classList.add('hidden'));
                    document.getElementById(`view-${view}`).classList.remove('hidden');
                    
                    // Update title
                    viewTitle.textContent = link.querySelector('.hidden').textContent;
                    
                    // Update active link
                    navLinks.forEach(l => l.classList.remove('bg-gray-700', 'text-white'));
                    link.classList.add('bg-gray-700', 'text-white');
                    
                    currentView = view;
                    
                    // Re-fetch weekly data if switching to that view
                    if (currentView === 'weekly') {
                        renderWeeklySchedule();
                    }
                });
            });
            // Set initial view
            document.querySelector('.nav-link[data-view="daily"]').classList.add('bg-gray-700', 'text-white');
            document.getElementById('view-daily').classList.remove('hidden');

            // 6. Setup Tab (Sub-navigation)
            const setupNavLinks = document.querySelectorAll('.setup-nav-link');
            const setupViews = document.querySelectorAll('.setup-view-content');
            
            setupNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.dataset.setupView;
                    
                    // Update content panes
                    setupViews.forEach(v => v.classList.add('hidden'));
                    document.getElementById(`setup-view-${view}`).classList.remove('hidden');
                    document.getElementById(`${view}-list-container`).classList.remove('hidden');
                    
                    // Update active link
                    setupNavLinks.forEach(l => l.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600'));
                    link.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                    
                    currentSetupView = view;
                });
            });
            // Set initial setup view
            document.querySelector('.setup-nav-link[data-setup-view="members"]').click();
            
            // 7. Attach Global Event Listeners (using delegation)
            document.body.addEventListener('click', (e) => {
                // Daily List
                if (e.target.closest('.chore-toggle-btn')) handleToggleChoreComplete(e);
                if (e.target.closest('.assign-chore-btn')) handleOpenAssignChoreModal(e);
                
                // Rewards
                if (e.target.closest('.redeem-reward-btn')) handleRedeemReward(e);
                if (e.target.closest('.deliver-reward-btn')) handleDeliverReward(e);

                // Setup: Edit/Delete
                if (e.target.closest('.edit-member-btn')) handleOpenEditMember(e);
                if (e.target.closest('.delete-member-btn')) handleDeleteMember(e);
                if (e.target.closest('.edit-chore-btn')) handleOpenEditChore(e);
                if (e.target.closest('.delete-chore-btn')) handleDeleteChore(e);
                if (e.target.closest('.edit-reward-btn')) handleOpenEditReward(e);
                if (e.target.closest('.delete-reward-btn')) handleDeleteReward(e);
            });
            
            // 8. Attach Form Submit Handlers
            document.getElementById('add-member-form').addEventListener('submit', handleAddMember);
            document.getElementById('adjust-points-form').addEventListener('submit', handleAdjustPoints);
            document.getElementById('add-chore-form').addEventListener('submit', handleAddChore);
            document.getElementById('add-reward-form').addEventListener('submit', handleAddReward);
            document.getElementById('add-adhoc-chore-form').addEventListener('submit', handleAddAdHocChore);
            
            // Modals
            document.getElementById('assign-chore-submit').addEventListener('click', handleAssignChore);
            document.getElementById('password-submit').addEventListener('click', () => {
                const password = document.getElementById('password-input').value;
                if (password === PASSWORD) {
                    if (passwordSuccessCallback) passwordSuccessCallback();
                    hideModal('password-modal');
                } else {
                    document.getElementById('password-error').classList.remove('hidden');
                }
            });
            document.getElementById('confirm-delete-button').addEventListener('click', () => {
                if (deleteSuccessCallback) deleteSuccessCallback();
                // hideModal is called by the callback on success
            });
            
            // Edit Modals
            document.getElementById('edit-member-form').addEventListener('submit', handleEditMember);
            document.getElementById('edit-chore-form').addEventListener('submit', handleEditChore);
            document.getElementById('edit-reward-form').addEventListener('submit', handleEditReward);
            
            // 9. Other Listeners
            document.getElementById('redeem-member-select').addEventListener('change', handleRedeemerChange);

            // 10. Init Drag and Drop
            initDragAndDrop();
        });
    </script>
</body>
</html>


