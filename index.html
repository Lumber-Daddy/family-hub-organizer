<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub Organizer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hub-blue': '#3F51B5', // Indigo 600
                        'hub-light': '#E8EAF6', // Indigo 100
                        'hub-dark': '#303F9F', // Indigo 700
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        // ... existing keyframes
                        popIn: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '80%': { transform: 'scale(1.1)', opacity: '1' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        bounceIn: { // New animation for checkmark
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.1)', opacity: '1' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        pulseError: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '.5' },
                        },
                        growAndSpin: {
                            '0%': { transform: 'scale(1) rotate(0deg)' },
                            '50%': { transform: 'scale(1.5) rotate(180deg)' },
                            '100%': { transform: 'scale(1) rotate(360deg)' },
                        },
                        // --- ⭐️ REMOVED hopAndWiggle FROM HERE ---
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.4s ease-out',
                        'pulse-error': 'pulseError 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'grow-and-spin': 'growAndSpin 0.6s ease-out',
                        // --- ⭐️ REMOVED 'hop-and-wiggle' FROM HERE ---
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="icon" href="data:,">

    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Strikethrough for completed chores */
        .chore-complete {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Password modal */
        #password-modal, #delete-modal {
            display: none;
        }
        
        /* Drag and Drop visual styles */
        .dragging {
            opacity: 0.5;
            background: #fff;
            border: 2px dashed #3F51B5;
        }
        .drag-over-target {
            outline: 2px dashed #3F51B5;
            background-color: #E8EAF6; /* indigo-100 */
        }
        
        /* Animation class for checkmark */
        .animate-bounce-in {
             animation: bounceIn 0.4s ease-out;
        }
        /* Keep pop-in if needed elsewhere, maybe rename */
        .animate-pop-in {
             animation: popIn 0.3s ease-out;
        }
        
        /* --- ⭐️ ADDED CURSOR FOR TAPPABLE EMOJI --- */
        [id^="member-emoji-"] {
            cursor: pointer;
        }

        /* --- ⭐️ MOVED ANIMATION DEFINITION HERE --- */
        @keyframes hopAndWiggle {
            0%, 100% { transform: 'translateY(0) rotate(0)' }
            20% { transform: 'translateY(-10px) rotate(-8deg)' }
            40% { transform: 'translateY(0) rotate(8deg)' }
            60% { transform: 'translateY(-5px) rotate(-5deg)' }
            80% { transform: 'translateY(0) rotate(5deg)' }
        }
        
        .animate-hop-and-wiggle {
            animation: hopAndWiggle 0.7s ease-in-out;
        }
        /* --- ⭐️ END MOVED ANIMATION --- */
    </style>
</head>
<body class="h-full flex overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <svg class="animate-spin h-12 w-12 text-hub-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-lg font-medium text-hub-dark">Connecting to Family Hub...</p>
    </div>
    
    <div id="error-bar" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white p-3 text-center z-40 animate-pulse-error">
        <span id="error-message">Could not connect to Family Hub. Retrying...</span>
    </div>

    <nav class="w-20 md:w-64 bg-hub-blue text-white flex flex-col flex-shrink-0">
        <div class="flex items-center justify-center md:justify-start md:pl-6 h-20 border-b border-hub-dark">
            <i data-lucide="home" class="h-8 w-8 md:h-6 md:w-6"></i>
            <span class="hidden md:block ml-3 text-2xl font-bold">Family Hub</span>
        </div>
        <ul class="flex-grow py-4">
            <li class="nav-item" data-view="daily">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="clipboard-list" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Daily List</span>
                </a>
            </li>
            <li class="nav-item" data-view="weekly">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="calendar-days" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Weekly Schedule</span>
                </a>
            </li>
            <li class="nav-item" data-view="rewards">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="award" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Points & Rewards</span>
                </a>
            </li>
            <li class="nav-item" data-view="setup">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="settings" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Setup</span>
                </a>
            </li>
        </ul>
        <div class="p-4 border-t border-hub-dark text-center">
            <p class="text-xs text-indigo-200">User: <span id="user-id-display" class="font-mono">...</span></p>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto bg-gray-100">
        
        <div id="view-daily" class="view p-4 md:p-8">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <p id="current-time" class="text-3xl md:text-5xl font-bold text-hub-dark"></p>
                <p id="current-date" class="text-lg md:text-2xl text-gray-600"></p>
            </div>

            <div class="mb-6">
                <details class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <summary class="p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 flex items-center justify-between">
                        <span>Add One-Time Chore</span>
                        <i data-lucide="plus-circle" class="h-5 w-5"></i>
                    </summary>
                    <form id="adhoc-chore-form" class="p-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="adhoc-name" placeholder="Chore Name" class="col-span-1 md:col-span-2 p-2 border rounded" required>
                            <input type="number" id="adhoc-points" placeholder="Points" class="p-2 border rounded" required>
                            <select id="adhoc-emoji" class="p-2 border rounded">
                                </select>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <select id="adhoc-assignee" class="p-2 border rounded">
                                <option value="unassigned">Unassigned</option>
                                </select>
                            <button type="submit" class="bg-hub-blue text-white px-4 py-2 rounded-lg font-medium hover:bg-hub-dark">Add Chore</button>
                        </div>
                    </form>
                </details>
            </div>

            <div id="daily-chores-container" class="grid grid-cols-2 gap-4 md:gap-6">
                </div>
        </div>

        <div id="view-weekly" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Weekly Schedule</h1>
            <div id="weekly-schedule-container" class="grid grid-cols-1 md:grid-cols-7 gap-4 bg-white p-4 rounded-lg shadow-sm">
                </div>
        </div>

        <div id="view-rewards" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Points & Rewards</h1>
            
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Member Totals</h2>
            <div id="member-points-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Redeem Rewards</h2>
            <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <label for="redeem-member-select" class="font-medium">Who is redeeming?</label>
                    <select id="redeem-member-select" class="p-2 border rounded-lg">
                        </select>
                </div>
                <div id="rewards-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Claimed (Pending Delivery)</h2>
            <div id="claimed-rewards-container" class="bg-white p-6 rounded-lg shadow-sm">
                <p id="no-claimed-rewards" class="text-gray-500">No rewards have been claimed yet.</p>
            </div>
        </div>
        
        <div id="view-setup" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Setup</h1>
            
            <div class="mb-6">
                <div class="border-b border-gray-300">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button class="setup-nav-item" data-view="members">Members</button>
                        <button class="setup-nav-item" data-view="chores">Chores</button>
                        <button class="setup-nav-item" data-view="rewards">Rewards</button>
                    </nav>
                </div>
            </div>

            <div id="setup-view-members" class="setup-view grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="member-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Member</h2>
                    <form id="member-form">
                        <input type="hidden" id="member-id">
                        <div class="mb-4">
                            <label for="member-name" class="block font-medium mb-1">Name</label>
                            <input type="text" id="member-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="member-color" class="block font-medium mb-1">Color</label>
                            <select id="member-color" class="w-full p-2 border rounded-lg">
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="member-emoji" class="block font-medium mb-1">Emoji (or initial)</label>
                            <input type="text" id="member-emoji" placeholder="e.g., 🧑‍🚀 or J" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="member-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Member</button>
                            <button type="button" id="member-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div>
                    <div id="member-list-container" class="bg-white p-6 rounded-lg shadow-sm mb-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Members</h2>
                        <div id="member-list" class="space-y-3">
                            </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Set Member Points</h2>
                        <form id="adjust-points-form" class="space-y-4">
                            <select id="adjust-member-select" class="w-full p-2 border rounded-lg">
                                </select>
                            <input type="number" id="adjust-points-amount" placeholder="New Point Total" class="w-full p-2 border rounded-lg" required min="0">
                            <button type="submit" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-600">Set Points</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="setup-view-chores" class="setup-view hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="chore-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Recurring Chore</h2>
                    <form id="chore-form">
                        <input type="hidden" id="chore-id">
                        <div class="mb-4">
                            <label for="chore-name" class="block font-medium mb-1">Chore Name</label>
                            <input type="text" id="chore-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="chore-points" class="block font-medium mb-1">Points</label>
                                <input type="number" id="chore-points" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="chore-emoji" class="block font-medium mb-1">Emoji</label>
                                <select id="chore-emoji" class="w-full p-2 border rounded-lg">
                                    </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block font-medium mb-1">Schedule (Days of Week)</label>
                            <div class="grid grid-cols-4 md:grid-cols-7 gap-2">
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="mon"><span>Mon</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="tue"><span>Tue</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="wed"><span>Wed</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="thu"><span>Thu</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="fri"><span>Fri</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="sat"><span>Sat</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="sun"><span>Sun</span></label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="chore-assignee" class="block font-medium mb-1">Default Assignee (Optional)</label>
                            <select id="chore-assignee" class="w-full p-2 border rounded-lg">
                                <option value="unassigned">Unassigned</option>
                                </select>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="chore-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Chore</button>
                            <button type="button" id="chore-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Recurring Chores List</h2>
                    <div id="chore-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div id="setup-view-rewards" class="setup-view hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="reward-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Reward</h2>
                    <form id="reward-form">
                        <input type="hidden" id="reward-id">
                                    },
                        growAndSpin: {
                            '0%': { transform: 'scale(1) rotate(0deg)' },
                            '50%': { transform: 'scale(1.5) rotate(180deg)' },
                            '100%': { transform: 'scale(1) rotate(360deg)' },
                        },
                        // --- ⭐️ ADDED KEYFRAME FOR EMOJI HOP ---
                        hopAndWiggle: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0)' },
                            '20%': { transform: 'translateY(-10px) rotate(-8deg)' },
                            '40%': { transform: 'translateY(0) rotate(8deg)' },
                            '60%': { transform: 'translateY(-5px) rotate(-5deg)' },
                            '80%': { transform: 'translateY(0) rotate(5deg)' },
                        },
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.4s ease-out',
                        'pulse-error': 'pulseError 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'grow-and-spin': 'growAndSpin 0.6s ease-out',
                        // --- ⭐️ ADDED ANIMATION FOR EMOJI HOP ---
                        'hop-and-wiggle': 'hopAndWiggle 0.7s ease-in-out',
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="icon" href="data:,">

    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Strikethrough for completed chores */
        .chore-complete {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Password modal */
        #password-modal, #delete-modal {
            display: none;
        }
        
        /* Drag and Drop visual styles */
        .dragging {
            opacity: 0.5;
            background: #fff;
            border: 2px dashed #3F51B5;
        }
        .drag-over-target {
            outline: 2px dashed #3F51B5;
            background-color: #E8EAF6; /* indigo-100 */
        }
        
        /* Animation class for checkmark */
        .animate-bounce-in {
             animation: bounceIn 0.4s ease-out;
        }
        /* Keep pop-in if needed elsewhere, maybe rename */
        .animate-pop-in {
             animation: popIn 0.3s ease-out;
        }
        
        /* --- ⭐️ ADDED CURSOR FOR TAPPABLE EMOJI --- */
        [id^="member-emoji-"] {
            cursor: pointer;
        }
    </style>
</head>
<body class="h-full flex overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <svg class="animate-spin h-12 w-12 text-hub-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-lg font-medium text-hub-dark">Connecting to Family Hub...</p>
    </div>
    
    <div id="error-bar" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white p-3 text-center z-40 animate-pulse-error">
        <span id="error-message">Could not connect to Family Hub. Retrying...</span>
    </div>

    <nav class="w-20 md:w-64 bg-hub-blue text-white flex flex-col flex-shrink-0">
        <div class="flex items-center justify-center md:justify-start md:pl-6 h-20 border-b border-hub-dark">
            <i data-lucide="home" class="h-8 w-8 md:h-6 md:w-6"></i>
            <span class="hidden md:block ml-3 text-2xl font-bold">Family Hub</span>
        </div>
        <ul class="flex-grow py-4">
            <li class="nav-item" data-view="daily">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="clipboard-list" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Daily List</span>
                </a>
            </li>
            <li class="nav-item" data-view="weekly">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="calendar-days" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Weekly Schedule</span>
                </a>
            </li>
            <li class="nav-item" data-view="rewards">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="award" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Points & Rewards</span>
                </a>
            </li>
            <li class="nav-item" data-view="setup">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="settings" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Setup</span>
                </a>
            </li>
        </ul>
        <div class="p-4 border-t border-hub-dark text-center">
            <p class="text-xs text-indigo-200">User: <span id="user-id-display" class="font-mono">...</span></p>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto bg-gray-100">
        
        <div id="view-daily" class="view p-4 md:p-8">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <p id="current-time" class="text-3xl md:text-5xl font-bold text-hub-dark"></p>
                <p id="current-date" class="text-lg md:text-2xl text-gray-600"></p>
            </div>

            <div class="mb-6">
                <details class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <summary class="p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 flex items-center justify-between">
                        <span>Add One-Time Chore</span>
                        <i data-lucide="plus-circle" class="h-5 w-5"></i>
                    </summary>
                    <form id="adhoc-chore-form" class="p-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="adhoc-name" placeholder="Chore Name" class="col-span-1 md:col-span-2 p-2 border rounded" required>
                            <input type="number" id="adhoc-points" placeholder="Points" class="p-2 border rounded" required>
                            <select id="adhoc-emoji" class="p-2 border rounded">
                                </select>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <select id="adhoc-assignee" class="p-2 border rounded">
                                <option value="unassigned">Unassigned</option>
                                </select>
                            <button type="submit" class="bg-hub-blue text-white px-4 py-2 rounded-lg font-medium hover:bg-hub-dark">Add Chore</button>
                        </div>
                    </form>
                </details>
            </div>

            <div id="daily-chores-container" class="grid grid-cols-2 gap-4 md:gap-6">
                </div>
        </div>

        <div id="view-weekly" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Weekly Schedule</h1>
            <div id="weekly-schedule-container" class="grid grid-cols-1 md:grid-cols-7 gap-4 bg-white p-4 rounded-lg shadow-sm">
                </div>
        </div>

        <div id="view-rewards" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Points & Rewards</h1>
            
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Member Totals</h2>
            <div id="member-points-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Redeem Rewards</h2>
            <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <label for="redeem-member-select" class="font-medium">Who is redeeming?</label>
                    <select id="redeem-member-select" class="p-2 border rounded-lg">
                        </select>
                </div>
                <div id="rewards-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Claimed (Pending Delivery)</h2>
            <div id="claimed-rewards-container" class="bg-white p-6 rounded-lg shadow-sm">
                <p id="no-claimed-rewards" class="text-gray-500">No rewards have been claimed yet.</p>
            </div>
        </div>
        
        <div id="view-setup" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Setup</h1>
            
            <div class="mb-6">
                <div class="border-b border-gray-300">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button class="setup-nav-item" data-view="members">Members</button>
                        <button class="setup-nav-item" data-view="chores">Chores</button>
                        <button class="setup-nav-item" data-view="rewards">Rewards</button>
                    </nav>
                </div>
            </div>

            <div id="setup-view-members" class="setup-view grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="member-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Member</h2>
                    <form id="member-form">
                        <input type="hidden" id="member-id">
                        <div class="mb-4">
                            <label for="member-name" class="block font-medium mb-1">Name</label>
                            <input type="text" id="member-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="member-color" class="block font-medium mb-1">Color</label>
                            <select id="member-color" class="w-full p-2 border rounded-lg">
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="member-emoji" class="block font-medium mb-1">Emoji (or initial)</label>
                            <input type="text" id="member-emoji" placeholder="e.g., 🧑‍🚀 or J" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="member-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Member</button>
                            <button type="button" id="member-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div>
                    <div id="member-list-container" class="bg-white p-6 rounded-lg shadow-sm mb-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Members</h2>
                        <div id="member-list" class="space-y-3">
                            </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Set Member Points</h2>
                        <form id="adjust-points-form" class="space-y-4">
                            <select id="adjust-member-select" class="w-full p-2 border rounded-lg">
                                </select>
                            <input type="number" id="adjust-points-amount" placeholder="New Point Total" class="w-full p-2 border rounded-lg" required min="0">
                            <button type="submit" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-600">Set Points</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="setup-view-chores" class="setup-view hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="chore-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Recurring Chore</h2>
                    <form id="chore-form">
                        <input type="hidden" id="chore-id">
                        <div class="mb-4">
                            <label for="chore-name" class="block font-medium mb-1">Chore Name</label>
                            <input type="text" id="chore-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="chore-points" class="block font-medium mb-1">Points</label>
                                <input type="number" id="chore-points" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="chore-emoji" class="block font-medium mb-1">Emoji</label>
                                <select id="chore-emoji" class="w-full p-2 border rounded-lg">
                                    </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block font-medium mb-1">Schedule (Days of Week)</label>
                            <div class="grid grid-cols-4 md:grid-cols-7 gap-2">
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="mon"><span>Mon</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="tue"><span>Tue</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="wed"><span>Wed</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="thu"><span>Thu</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="fri"><span>Fri</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="sat"><span>Sat</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="sun"><span>Sun</span></label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="chore-assignee" class="block font-medium mb-1">Default Assignee (Optional)</label>
                            <select id="chore-assignee" class="w-full p-2 border rounded-lg">
                                <option value="unassigned">Unassigned</option>
                                </select>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="chore-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Chore</button>
                            <button type="button" id="chore-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Recurring Chores List</h2>
                    <div id="chore-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div id="setup-view-rewards" class="setup-view hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="reward-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Reward</h2>
                    <form id="reward-form">
                        <input type="hidden" id="reward-id">
                        <div cl                        },
                        // --- ⭐️ ADDED KEYFRAME FOR EMOJI ---
                        growAndSpin: {
                            '0%': { transform: 'scale(1) rotate(0deg)' },
                            '50%': { transform: 'scale(1.5) rotate(180deg)' },
                            '100%': { transform: 'scale(1) rotate(360deg)' },
                        },
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.4s ease-out',
                        'pulse-error': 'pulseError 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        // --- ⭐️ ADDED ANIMATION FOR EMOJI ---
                        'grow-and-spin': 'growAndSpin 0.6s ease-out',
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="icon" href="data:,">

    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Strikethrough for completed chores */
        .chore-complete {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Password modal */
        #password-modal, #delete-modal {
            display: none;
        }
        
        /* Drag and Drop visual styles */
        .dragging {
            opacity: 0.5;
            background: #fff;
            border: 2px dashed #3F51B5;
        }
        .drag-over-target {
            outline: 2px dashed #3F51B5;
            background-color: #E8EAF6; /* indigo-100 */
        }
        
        /* Animation class for checkmark */
        .animate-bounce-in {
             animation: bounceIn 0.4s ease-out;
        }
        /* Keep pop-in if needed elsewhere, maybe rename */
        .animate-pop-in {
             animation: popIn 0.3s ease-out;
        }
    </style>
</head>
<body class="h-full flex overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <svg class="animate-spin h-12 w-12 text-hub-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-lg font-medium text-hub-dark">Connecting to Family Hub...</p>
    </div>
    
    <div id="error-bar" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white p-3 text-center z-40 animate-pulse-error">
        <span id="error-message">Could not connect to Family Hub. Retrying...</span>
    </div>

    <nav class="w-20 md:w-64 bg-hub-blue text-white flex flex-col flex-shrink-0">
        <div class="flex items-center justify-center md:justify-start md:pl-6 h-20 border-b border-hub-dark">
            <i data-lucide="home" class="h-8 w-8 md:h-6 md:w-6"></i>
            <span class="hidden md:block ml-3 text-2xl font-bold">Family Hub</span>
        </div>
        <ul class="flex-grow py-4">
            <li class="nav-item" data-view="daily">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="clipboard-list" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Daily List</span>
                </a>
            </li>
            <li class="nav-item" data-view="weekly">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="calendar-days" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Weekly Schedule</span>
                </a>
            </li>
            <li class="nav-item" data-view="rewards">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="award" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Points & Rewards</span>
                </a>
            </li>
            <li class="nav-item" data-view="setup">
                <a href="#" class="flex items-center justify-center md:justify-start py-4 px-6 text-indigo-100 hover:bg-hub-dark hover:text-white">
                    <i data-lucide="settings" class="h-6 w-6"></i>
                    <span class="hidden md:block ml-4 text-lg">Setup</span>
                </a>
            </li>
        </ul>
        <div class="p-4 border-t border-hub-dark text-center">
            <p class="text-xs text-indigo-200">User: <span id="user-id-display" class="font-mono">...</span></p>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto bg-gray-100">
        
        <div id="view-daily" class="view p-4 md:p-8">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <p id="current-time" class="text-3xl md:text-5xl font-bold text-hub-dark"></p>
                <p id="current-date" class="text-lg md:text-2xl text-gray-600"></p>
            </div>

            <div class="mb-6">
                <details class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <summary class="p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-50 flex items-center justify-between">
                        <span>Add One-Time Chore</span>
                        <i data-lucide="plus-circle" class="h-5 w-5"></i>
                    </summary>
                    <form id="adhoc-chore-form" class="p-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="adhoc-name" placeholder="Chore Name" class="col-span-1 md:col-span-2 p-2 border rounded" required>
                            <input type="number" id="adhoc-points" placeholder="Points" class="p-2 border rounded" required>
                            <select id="adhoc-emoji" class="p-2 border rounded">
                                </select>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <select id="adhoc-assignee" class="p-2 border rounded">
                                <option value="unassigned">Unassigned</option>
                                </select>
                            <button type="submit" class="bg-hub-blue text-white px-4 py-2 rounded-lg font-medium hover:bg-hub-dark">Add Chore</button>
                        </div>
                    </form>
                </details>
            </div>

            <div id="daily-chores-container" class="grid grid-cols-2 gap-4 md:gap-6">
                </div>
        </div>

        <div id="view-weekly" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Weekly Schedule</h1>
            <div id="weekly-schedule-container" class="grid grid-cols-1 md:grid-cols-7 gap-4 bg-white p-4 rounded-lg shadow-sm">
                </div>
        </div>

        <div id="view-rewards" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Points & Rewards</h1>
            
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Member Totals</h2>
            <div id="member-points-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Redeem Rewards</h2>
            <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <label for="redeem-member-select" class="font-medium">Who is redeeming?</label>
                    <select id="redeem-member-select" class="p-2 border rounded-lg">
                        </select>
                </div>
                <div id="rewards-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Claimed (Pending Delivery)</h2>
            <div id="claimed-rewards-container" class="bg-white p-6 rounded-lg shadow-sm">
                <p id="no-claimed-rewards" class="text-gray-500">No rewards have been claimed yet.</p>
            </div>
        </div>
        
        <div id="view-setup" class="view hidden p-4 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Setup</h1>
            
            <div class="mb-6">
                <div class="border-b border-gray-300">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button class="setup-nav-item" data-view="members">Members</button>
                        <button class="setup-nav-item" data-view="chores">Chores</button>
                        <button class="setup-nav-item" data-view="rewards">Rewards</button>
                    </nav>
                </div>
            </div>

            <div id="setup-view-members" class="setup-view grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="member-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Member</h2>
                    <form id="member-form">
                        <input type="hidden" id="member-id">
                        <div class="mb-4">
                            <label for="member-name" class="block font-medium mb-1">Name</label>
                            <input type="text" id="member-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="member-color" class="block font-medium mb-1">Color</label>
                            <select id="member-color" class="w-full p-2 border rounded-lg">
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="member-emoji" class="block font-medium mb-1">Emoji (or initial)</label>
                            <input type="text" id="member-emoji" placeholder="e.g., 🧑‍🚀 or J" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="member-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Member</button>
                            <button type="button" id="member-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div>
                    <div id="member-list-container" class="bg-white p-6 rounded-lg shadow-sm mb-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Members</h2>
                        <div id="member-list" class="space-y-3">
                            </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Set Member Points</h2>
                        <form id="adjust-points-form" class="space-y-4">
                            <select id="adjust-member-select" class="w-full p-2 border rounded-lg">
                                </select>
                            <input type="number" id="adjust-points-amount" placeholder="New Point Total" class="w-full p-2 border rounded-lg" required min="0">
                            <button type="submit" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-600">Set Points</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="setup-view-chores" class="setup-view hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="chore-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Recurring Chore</h2>
                    <form id="chore-form">
                        <input type="hidden" id="chore-id">
                        <div class="mb-4">
                            <label for="chore-name" class="block font-medium mb-1">Chore Name</label>
                            <input type="text" id="chore-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="chore-points" class="block font-medium mb-1">Points</label>
                                <input type="number" id="chore-points" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="chore-emoji" class="block font-medium mb-1">Emoji</label>
                                <select id="chore-emoji" class="w-full p-2 border rounded-lg">
                                    </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block font-medium mb-1">Schedule (Days of Week)</label>
                            <div class="grid grid-cols-4 md:grid-cols-7 gap-2">
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="mon"><span>Mon</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="tue"><span>Tue</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="wed"><span>Wed</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="thu"><span>Thu</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="fri"><span>Fri</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="sat"><span>Sat</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded-lg"><input type="checkbox" class="day-check" value="sun"><span>Sun</span></label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="chore-assignee" class="block font-medium mb-1">Default Assignee (Optional)</label>
                            <select id="chore-assignee" class="w-full p-2 border rounded-lg">
                                <option value="unassigned">Unassigned</option>
                                </select>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="chore-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Chore</button>
                            <button type="button" id="chore-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Recurring Chores List</h2>
                    <div id="chore-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div id="setup-view-rewards" class="setup-view hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="reward-form-title" class="text-2xl font-semibold text-gray-800 mb-4">Add New Reward</h2>
                    <form id="reward-form">
                        <input type="hidden" id="reward-id">
                        <div class="mb-4">
                            <label for="reward-name" class="block font-medium mb-1">Reward Name</label>
                            <input type="text" id="reward-name" class="w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="reward-cost" class="block font-medium mb-1">Point Cost</label>
                                <input type="number" id="reward-cost" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="reward-emoji" class="block font-medium mb-1">Emoji</label>
                                <select id="reward-emoji" class="w-full p-2 border rounded-lg">
                                    </select>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" id="reward-submit-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Reward</button>
                            <button type="button" id="reward-cancel-btn" class="hidden flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Available Rewards</h2>
                    <div id="reward-list" class="space-y-3">
                        </div>
                </div>
            </div>

        </div>
    </main>

    <div id="assign-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-semibold mb-4">Assign Chore</h2>
            <p class="mb-4">Assign "<span id="assign-chore-name" class="font-bold">...</span>" to:</p>
            <select id="assign-member-select" class="w-full p-2 border rounded-lg mb-6">
                <option value="unassigned">Unassigned</option>
                </select>
            <div class="flex justify-end gap-4">
                <button id="assign-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                <button id="assign-save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    
    <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-semibold mb-4">Admin Access Required</h2>
            <p id="password-prompt" class="mb-4">Please enter the admin password.</p>
            <input type="password" id="password-input" class="w-full p-2 border rounded-lg mb-4">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password. Try again.</p>
            <div class="flex justify-end gap-4">
                <button id="password-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                <button id="password-submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Submit</button>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <div class="ml-4">
                    <h2 class="text-xl font-semibold mb-1" id="delete-title">Delete Item</h2>
                    <p id="delete-prompt" class="text-gray-600">Are you sure? This action cannot be undone.</p>
                </div>
            </div>
            <p id="delete-password-prompt" class="text-sm text-gray-500 mt-4 mb-2 hidden">Please enter admin password to confirm:</p>
            <input type="password" id="delete-password-input" class="w-full p-2 border rounded-lg mb-4 hidden">
            <p id="delete-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="delete-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        // === Firebase SDK Imports ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === Global State ===
        let db, auth, userId, appId;
        let sounds = {};
        let confettiEffect;
        let localState = {
            members: [],
            chores: [],
            rewards: [],
            dailyChores: [],
            claimedRewards: []
        };
        let currentView = 'daily';
        let currentSetupView = 'members';
        let selectedChoreForAssignment = null;
        let selectedMemberForPoints = null;
        let passwordSuccessCallback = null;
        let deleteSuccessCallback = null;
        let hasCheckedDailyChores = false; // Flag to prevent re-generation
        
        // Flags to track initial data load
        let hasLoaded = {
            members: false,
            chores: false,
            rewards: false,
            dailyChores: false,
            claimedRewards: false
        };
        
        const PASSWORD = '3281555';
        const DAYS_OF_WEEK = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        // Expanded Emoji List
        const EMOJI_LIST = [
            // Chores
            '🧹', '🧼', '🧺', '🛏️', '🍽️', '🗑️', '♻️', '🐾', '🌱', '🥦', 
            '🛒', '🐶', '🐱', '🧑‍🍳', '🚽', '🛁', '🧽', '📚', '🎒', '👟', 
            '👔', '🚗', '🛠️', '📦', '📬', '💰', '🧾', '💻', '🪴', '🍁', 
            '🍃', '🍂', '💪', '🧑‍🌾', '🔧', '⚙️', '📁', '🗄️', '📌', '📎','🦷','🪥',
            // Rewards
            '🎉', '🎈', '🎁', '🍦', '🍕', '🍔', '🎮', '📱', '💻', '💵', 
            '💰', '🪙', '💳', '🚲', '🛴', '🛹', '🍿', '🎬', '🎭', '🎨', 
            '🎯', '🚀', '🌟', '🏆', '🏅', '🥇', '🍓', '🍩', '🍪', '🍰', 
            '🧁', '🍭', '🍫', '🍬'
        ];
        // Added hex values
        const COLOR_LIST = [
            { name: 'Red', bg: 'bg-red-500', border: 'border-red-500', hex: '#EF4444' },
            { name: 'Blue', bg: 'bg-blue-500', border: 'border-blue-500', hex: '#3B82F6' },
            { name: 'Green', bg: 'bg-green-500', border: 'border-green-500', hex: '#22C55E' },
            { name: 'Yellow', bg: 'bg-yellow-500', border: 'border-yellow-500', hex: '#EAB308' },
            { name: 'Purple', bg: 'bg-purple-500', border: 'border-purple-500', hex: '#A855F7' },
            { name: 'Pink', bg: 'bg-pink-500', border: 'border-pink-500', hex: '#EC4899' },
            { name: 'Indigo', bg: 'bg-indigo-500', border: 'border-indigo-500', hex: '#6366F1' },
            { name: 'Teal', bg: 'bg-teal-500', border: 'border-teal-500', hex: '#14B8A6' }
        ];

        // === Sound Initialization ===
        function initSounds(event) {
            // Check if Tone.js is available
            if (typeof Tone === 'undefined') {
                console.warn("Tone.js not loaded, sounds disabled.");
                return;
            }
            
            // Resume audio context on first user gesture
            Tone.start();

            // --- ⭐️ UPDATED SOUNDS ---

            // Chore Completion Sound (Ascending chime)
            // Use PolySynth to allow for overlapping notes if clicked fast
            sounds.complete = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 },
                volume: -10
            }).toDestination();
            
            sounds.uncomplete = new Tone.Synth({
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 },
                volume: -15
            }).toDestination();
            
            // Reward Redemption Sound (Richer arpeggio)
            sounds.redeem = new Tone.FMSynth({
                harmonicity: 2, // Richer sound
                modulationIndex: 10,
                modulationEnvelope: { attack: 0.2, decay: 0.3 },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.3 },
                volume: -8
            }).toDestination();

             sounds.sparkle = new Tone.Synth({ // Kept sparkle sound
                 oscillator: { type: "sine" },
                 envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 },
                 volume: -18
             }).toDestination();


            sounds.click = new Tone.MembraneSynth({
                pitchDecay: 0.01,
                octaves: 2,
                envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.01 },
                volume: -18
            }).toDestination();
            
            console.log("Sounds initialized");
            // Remove this listener after it runs once
            document.body.removeEventListener('click', initSounds);
        }

        function playSound(soundName) {
            // Note: Removed the random 'complete' logic as we now have one better sound
             if (sounds[soundName] && Tone.context.state === 'running') {
                 try {
                     const now = Tone.now();
                     // --- ⭐️ UPDATED SOUND TRIGGERS ---
                     if (soundName === 'complete') {
                        // Play a quick ascending chime
                        sounds.complete.triggerAttackRelease('C5', '16n', now);
                        sounds.complete.triggerAttackRelease('G5', '16n', now + 0.1);
                     } else if (soundName === 'uncomplete') {
                         sounds.uncomplete.triggerAttackRelease('C4', '8n', now);
                     } else if (soundName === 'redeem') {
                         // Play a major arpeggio + Sparkle
                         sounds.redeem.triggerAttackRelease('C5', '16n', now);
                         sounds.redeem.triggerAttackRelease('E5', '16n', now + 0.1);
                         sounds.redeem.triggerAttackRelease('G5', '16n', now + 0.2);
                         sounds.redeem.triggerAttackRelease('C6', '8n', now + 0.3);
                         
                         // Play sparkle slightly offset
                         sounds.sparkle.triggerAttackRelease('C7', '32n', now + 0.05);
                         sounds.sparkle.triggerAttackRelease('E7', '32n', now + 0.15);
                         sounds.sparkle.triggerAttackRelease('G7', '32n', now + 0.25);
                    } else if (soundName === 'click') {
                        sounds.click.triggerAttackRelease("C2", "8n", now);
                    }
                 } catch (e) {
                     console.error("Error playing sound:", e);
                 }
             }
         }
        
        // === Confetti Initialization ===
        function initConfetti() {
            const canvas = document.createElement('canvas');
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '100';
            document.body.appendChild(canvas);
            confettiEffect = confetti.create(canvas, { resize: true });
        }

        function triggerConfetti(type = 'default', origin = { y: 0.6 }) {
             if (!confettiEffect) return;

             // Map origin coords if provided (e.g., from click event)
             const originCoords = origin.x !== undefined && origin.y !== undefined
                 ? { x: origin.x / window.innerWidth, y: origin.y / window.innerHeight }
                 : { y: 0.6 }; // Default origin

             if (type === 'fireworks') {
                 // Increased duration slightly
                 const duration = 2.5 * 1000;
                 const animationEnd = Date.now() + duration;
                 // Slightly more intense defaults
                 const defaults = { startVelocity: 35, spread: 360, ticks: 70, zIndex: 100, particleCount: 60 };

                 function randomInRange(min, max) {
                     return Math.random() * (max - min) + min;
                 }

                 const interval = setInterval(function() {
                     const timeLeft = animationEnd - Date.now();
                     if (timeLeft <= 0) {
                         return clearInterval(interval);
                     }
                     const particleCount = defaults.particleCount * (timeLeft / duration);
                     // Fire from multiple points for bigger effect
                     confettiEffect({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                     confettiEffect({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                 }, 250);
             } else if (type === 'burst') {
                 // Small burst for chore completion
                 confettiEffect({
                     particleCount: 30, // Fewer particles
                     spread: 60,      // Narrower spread
                     origin: originCoords,
                     startVelocity: 20, // Less velocity
                     scalar: 0.6,     // Smaller particles
                     ticks: 40        // Shorter life
                 });
             } else { // Default (used to be reward redeem, now separate)
                 confettiEffect({
                     particleCount: 150,
                     spread: 90,
                     origin: originCoords // Use calculated origin or default
                 });
             }
         }


        // === Firebase Initialization ===
        async function initFirebase() {
            try {
                // Manually configured based on user input
                appId = 'family-hub-organizer';
                const firebaseConfig = {
                    apiKey: "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M",
                    authDomain: "family-hub-organizer.firebaseapp.com",
                    projectId: "family-hub-organizer",
                    storageBucket: "family-hub-organizer.firebasestorage.app",
                    messagingSenderId: "468888595189",
                    appId: "1:468888595189:web:eb6f33ee8e62cdc489b3bc"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set Firestore log level
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...';
                        await loadData(); // Load data once authenticated
                        
                        // Hide loading overlay
                        document.getElementById('loading-overlay').classList.add('opacity-0');
                        setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 300);
                        
                    } else {
                        console.log("User is signed out, signing in anonymously...");
                        // Use anonymous sign-in directly
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('loading-text').textContent = 'Connection Failed.';
                document.getElementById('error-message').textContent = `Firebase Error: ${error.message}`;
                document.getElementById('error-bar').classList.remove('hidden');
            }
        }

        // === Data Loading ===
        async function loadData() {
            if (!db || !userId) return;

            // Define collection paths
            const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
            const F_CHORES_COL = `/artifacts/${appId}/public/data/choreTemplates`;
            const F_REWARDS_COL = `/artifacts/${appId}/public/data/rewards`;
            const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
            const F_CLAIMED_REWARDS_COL = `/artifacts/${appId}/public/data/claimedRewards`;
            
            // For debugging
            window.F_MEMBERS_COL = F_MEMBERS_COL;
            window.F_DAILY_CHORES_COL = F_DAILY_CHORES_COL;
            window.F_CLAIMED_REWARDS_COL = F_CLAIMED_REWARDS_COL;

            // 1. Listen for Members
            onSnapshot(collection(db, F_MEMBERS_COL), (snapshot) => {
                localState.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.members = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to members:", error));

            // 2. Listen for Chore Templates
            onSnapshot(collection(db, F_CHORES_COL), (snapshot) => {
                localState.chores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.chores = true;
                // hasCheckedDailyChores = false; // New templates, allow re-check - This caused a loop
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to chores:", error));

            // 3. Listen for Rewards
            onSnapshot(collection(db, F_REWARDS_COL), (snapshot) => {
                localState.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.rewards = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to rewards:", error));

            // 4. Listen for Daily Chores (for today)
            const todayISO = getLocalISODate(); // TIMEZONE FIX
            const qDaily = query(collection(db, F_DAILY_CHORES_COL), where("date", "==", todayISO));
            
            onSnapshot(qDaily, (snapshot) => {
                localState.dailyChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.dailyChores = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to daily chores:", error));

            // 5. Listen for Claimed (not delivered) Rewards
            const qClaimed = query(collection(db, F_CLAIMED_REWARDS_COL), where("delivered", "==", false));
            onSnapshot(qClaimed, (snapshot) => {
                localState.claimedRewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasLoaded.claimedRewards = true;
                checkInitialLoad();
                renderAll();
            }, (error) => console.error("Error listening to claimed rewards:", error));
        }

        // === Core Logic: Check if all data is loaded, then run generation ===
        function checkInitialLoad() {
            // Check if all data streams have loaded at least once
            if (Object.values(hasLoaded).every(Boolean)) {
                // Only run the generation if it hasn't been run successfully yet
                if (!hasCheckedDailyChores) {
                    checkAndGenerateDailyChores();
                }
            }
        }
        
        // === Core Logic: Daily Chore Generation ===
        async function checkAndGenerateDailyChores() {
            // Only run if we have chore templates
            if (localState.chores.length === 0) {
                hasCheckedDailyChores = true; // Mark as "checked" even if no chores
                console.log("No chore templates found. Skipping generation.");
                return;
            }
            
            console.log("Checking if daily chores need generation...");
            
            const today = new Date();
            const todayDay = DAYS_OF_WEEK[today.getDay()]; // 'mon', 'tue', etc.
            const todayISO = getLocalISODate(today); // TIMEZONE FIX
            
            // Find chores scheduled for today
            const choresForToday = localState.chores.filter(chore => chore.schedule.includes(todayDay));
            
            if (choresForToday.length === 0) {
                 console.log("No chores scheduled for today.");
                 hasCheckedDailyChores = true; // Mark as checked
                 return;
            }

            // Find which chores *already exist* for today
            const existingChores = localState.dailyChores;
            
            const choresToCreate = choresForToday.filter(template => 
                !existingChores.some(existing => existing.templateId === template.id)
            );

            if (choresToCreate.length === 0) {
                console.log("All daily chores for today already exist.");
                hasCheckedDailyChores = true; // Mark as checked
                return;
            }

            console.log(`Generating ${choresToCreate.length} missing chores for today...`);
            
            const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
            const batch = writeBatch(db);

            for (const chore of choresToCreate) {
                const newChore = {
                    templateId: chore.id,
                    name: chore.name,
                    emoji: chore.emoji,
                    points: chore.points,
                    date: todayISO,
                    isComplete: false,
                    isAdHoc: false,
                    assignedTo: chore.defaultAssignee || 'unassigned',
                    completedBy: null
                };
                const docRef = doc(collection(db, F_DAILY_CHORES_COL)); // Create new doc ref
                batch.set(docRef, newChore);
            }

            try {
                await batch.commit();
                console.log("Successfully generated daily chores.");
            } catch (e) {
                console.error("Error generating daily chores in batch:", e);
            }
            
            // Mark as checked *after* successful run
            hasCheckedDailyChores = true;
        }

        // === Core Logic: Sync Daily Chores for a Template (NEW) ===
        // This function syncs the *current week* for a specific chore template
        async function generateDailyChoresForTemplate(choreTemplate) {
            console.log(`Syncing daily chores for template: ${choreTemplate.name}`);
            const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
            
            const weekDates = getWeekDates(); // Get [ { day: 'mon', date: '2023-10-30' }, ... ]
            const scheduledDays = choreTemplate.schedule; // ['mon', 'wed']

            // 1. Find all days this chore is scheduled for in the current week
            const targetChores = weekDates
                .filter(weekDay => scheduledDays.includes(weekDay.day))
                .map(weekDay => ({
                    date: weekDay.date,
                    day: weekDay.day
                }));

            // 2. Query Firestore for *all* existing daily chores for this template in the current week
            const weekISODates = weekDates.map(d => d.date);
            const q = query(
                collection(db, F_DAILY_CHORES_COL),
                where("templateId", "==", choreTemplate.id),
                where("date", "in", weekISODates)
            );
            
            const querySnapshot = await getDocs(q);
            const existingChores = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const batch = writeBatch(db);
            
            // 3. Create missing chores
            for (const target of targetChores) {
                const alreadyExists = existingChores.some(existing => existing.date === target.date);
                if (!alreadyExists) {
                    console.log(`Creating chore for date: ${target.date}`);
                    const newChore = {
                        templateId: choreTemplate.id,
                        name: choreTemplate.name,
                        emoji: choreTemplate.emoji,
                        points: choreTemplate.points,
                        date: target.date,
                        isComplete: false,
                        isAdHoc: false,
                        assignedTo: choreTemplate.defaultAssignee || 'unassigned',
                        completedBy: null
                    };
                    const docRef = doc(collection(db, F_DAILY_CHORES_COL));
                    batch.set(docRef, newChore);
                }
            }
            
            // 4. Delete chores that are no longer scheduled
            // (Only delete if they are in the future and not completed)
            const todayISO = getLocalISODate(); // TIMEZONE FIX
            for (const existing of existingChores) {
                // Must parse date with timezone context to get correct day
                const [year, month, day] = existing.date.split('-').map(Number);
                const existingDate = new Date(year, month - 1, day); // Local date
                const isStillScheduled = scheduledDays.includes(DAYS_OF_WEEK[existingDate.getDay()]);
                
                if (!isStillScheduled && !existing.isComplete && existing.date >= todayISO) {
                    console.log(`Deleting chore for date: ${existing.date}`);
                    const docRef = doc(db, F_DAILY_CHORES_COL, existing.id);
                    batch.delete(docRef);
                }
            }

            try {
                await batch.commit();
                console.log(`Successfully synced chores for template: ${choreTemplate.name}`);
            } catch (e) {
                console.error("Error syncing daily chores:", e);
            }
        }

        
        // === Master Render Function ===
        function renderAll() {
            if (!hasLoaded.members) return; // Wait for members at least
            
            // Populate shared dropdowns
            populateEmojiSelects();
            populateColorSelects();
            populateMemberSelects();
            
            // Render current view
            switch (currentView) {
                case 'daily': renderDailyList(); break;
                case 'weekly': renderWeeklySchedule(); break;
                case 'rewards': renderRewards(); break;
                case 'setup': renderSetup(); break;
            }
            
            // Render setup sub-view if visible
            if (currentView === 'setup') {
                switch (currentSetupView) {
                    case 'members': renderSetupMembers(); break;
                    case 'chores': renderSetupChores(); break;
                    case 'rewards': renderSetupRewards(); break;
                }
            }
        }

        // === Render: Daily List ===
        function renderDailyList() {
            const container = document.getElementById('daily-chores-container');
            container.innerHTML = ''; // Clear existing
            
            // Sort members by displayOrder
            const sortedMembers = [...localState.members].sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            
            // 1. Create sections for each member
            sortedMembers.forEach(member => {
                const memberChores = localState.dailyChores.filter(chore => chore.assignedTo === member.id);
                const section = document.createElement('div');
                section.className = `p-4 rounded-lg shadow-sm chore-list-droppable" data-member-id="${member.id}`;
                
                // Apply background tint using hex
                const colorInfo = COLOR_LIST.find(c => c.bg === member.color);
                const bgColor = colorInfo ? colorInfo.hex + '20' : '#FFFFFF'; // Add '20' for ~12% alpha
                section.style.backgroundColor = bgColor;
                
                section.innerHTML = `
                    <h2 class="text-xl font-semibold mb-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <span id="member-emoji-${member.id}" class="h-8 w-8 rounded-full ${member.color} flex items-center justify-center text-white text-lg font-bold mr-3">${member.emoji || member.name[0]}</span>
                            <span>${member.name}</span>
                        </div>
                        <span id="member-points-${member.id}" class="text-2xl font-bold text-green-600">${member.points || 0}</span>
                    </h2>
                    <div class="space-y-3">
                        ${memberChores.length > 0 ? memberChores.map(chore => renderChoreItem(chore)).join('') : '<p class="text-sm text-gray-400">No chores assigned.</p>'}
                    </div>
                `;
                container.appendChild(section);
            });
            
            // 2. Create section for unassigned chores
            const unassignedChores = localState.dailyChores.filter(chore => chore.assignedTo === 'unassigned');
            const unassignedSection = document.createElement('div');
            // Unassigned remains white
            unassignedSection.className = 'bg-white p-4 rounded-lg shadow-sm chore-list-droppable" data-member-id="unassigned';
            unassignedSection.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 flex items-center text-gray-600">
                    <i data-lucide="list" class="h-8 w-8 text-gray-400 mr-3"></i>
                    Unassigned
                </h2>
                <div class="space-y-3">
                    ${unassignedChores.length > 0 ? unassignedChores.map(chore => renderChoreItem(chore)).join('') : '<p class="text-sm text-gray-400">No unassigned chores.</p>'}
                </div>
            `;
            container.appendChild(unassignedSection);
            
            // 3. Render icons
            lucide.createIcons();
            
            // 4. Attach drag/drop listeners (after rendering)
            attachDragAndDropListeners();
        }

        function renderChoreItem(chore) {
            // Use bg-white for chore items regardless of member card color
            // Use animate-bounce-in for checkmark
             // Disable toggle button if unassigned
            const disabledAttr = chore.assignedTo === 'unassigned' ? 'disabled' : '';
            const disabledClass = chore.assignedTo === 'unassigned' ? 'opacity-50 cursor-not-allowed' : '';
            return `
                <div id="chore-${chore.id}" class="flex items-center justify-between p-3 bg-white rounded-lg chore-item-draggable shadow-sm" draggable="true" data-chore-id="${chore.id}">
                    <div class="flex items-center">
                        <button class="chore-toggle-btn text-2xl mr-3 ${chore.isComplete ? 'animate-bounce-in' : ''} ${disabledClass}" data-chore-id="${chore.id}" ${disabledAttr}>
                            ${chore.isComplete ? '✅' : chore.emoji}
                        </button>
                        <span class="font-medium ${chore.isComplete ? 'chore-complete' : ''}">${chore.name}</span>
                    </div>
                    <div class="flex items-center gap-1"> <span class="text-sm font-bold text-green-600">+${chore.points}</span>
                        <button class="assign-chore-btn p-1 text-gray-400 hover:text-blue-600" data-chore-id="${chore.id}">
                            <i data-lucide="user-plus" class="h-5 w-5"></i>
                        </button>
                        <button class="duplicate-chore-btn p-1 text-gray-400 hover:text-green-600" data-chore-id="${chore.id}">
                             <i data-lucide="copy" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // === Render: Weekly Schedule ===
        async function renderWeeklySchedule() {
            const container = document.getElementById('weekly-schedule-container');
            container.innerHTML = '';
            
            const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
            
            const weekDates = getWeekDates(); // Get ISO dates for Mon-Sun
            const weekISODates = weekDates.map(d => d.date);
            const todayISO = getLocalISODate(); // TIMEZONE FIX

            // Query all chores for the *entire* current week
            const q = query(
                collection(db, F_DAILY_CHORES_COL),
                where("date", "in", weekISODates)
            );
            
            let allWeeklyChores = [];
            try {
                const querySnapshot = await getDocs(q);
                allWeeklyChores = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching weekly chores:", error);
            }
            
            weekDates.forEach(({ day, date }) => {
                const dayChores = allWeeklyChores.filter(chore => chore.date === date);
                // Sort chores: by completion, then by name
                dayChores.sort((a, b) => {
                    if (a.isComplete !== b.isComplete) return a.isComplete ? 1 : -1;
                    return a.name.localeCompare(b.name);
                });
                
                const isToday = (date === todayISO);
                // Must parse date with timezone context to get correct day
                const [year, month, dayNum] = date.split('-').map(Number);
                const dateObj = new Date(year, month - 1, dayNum); // Local date
                
                const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                
                const col = document.createElement('div');
                col.className = 'bg-gray-50 p-3 rounded-lg min-h-[200px] weekly-day-droppable';
                col.dataset.date = date; // '2023-10-30'
                col.dataset.day = day;   // 'mon'
                
                col.innerHTML = `
                    <h4 class="font-bold text-lg ${isToday ? 'text-blue-700' : 'text-gray-800'}">${dayName}</h4>
                    <p class="text-sm text-gray-500 mb-3">${dateObj.toLocaleDateString([], { month: 'long' })} ${dateObj.getDate()}</p>
                    <div class="space-y-2">
                        ${dayChores.length > 0 ? dayChores.map(chore => {
                            const member = getMemberById(chore.assignedTo);
                            const colorClass = member ? member.color : 'bg-gray-400'; // Tailwind class
                            const borderColorClass = member ? member.color.replace('bg-', 'border-') : 'border-gray-400'; // Tailwind border class
                            const initial = member ? (member.emoji || member.name[0]) : '?';
                            
                            // Add delete button only for ad-hoc chores
                            const deleteButton = chore.isAdHoc ? 
                                `<button class="delete-adhoc-chore-btn text-gray-400 hover:text-red-500" data-chore-id="${chore.id}" data-chore-name="${chore.name}">
                                    <i data-lucide="x" class="h-4 w-4"></i>
                                 </button>` : '';

                            return `
                                <div class="flex items-center justify-between gap-2 p-2 bg-white rounded-md border-l-4 ${borderColorClass} ${chore.isComplete ? 'chore-complete' : ''} shadow-sm weekly-chore-draggable" draggable="true" data-chore-id="${chore.id}">
                                    <span class="text-sm truncate" title="${chore.name}">${chore.emoji} ${chore.name}</span>
                                    <div class="flex items-center flex-shrink-0">
                                        <span class="h-6 w-6 rounded-full ${colorClass} flex-shrink-0 flex items-center justify-center text-white text-xs font-bold" title="${member ? member.name : 'Unassigned'}">
                                            ${initial}
                                        </span>
                                        ${deleteButton}
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p class="text-xs text-gray-400">No chores.</p>'}
                    </div>
                `;
                container.appendChild(col);
            });
            
            lucide.createIcons();
            attachWeeklyDragAndDropListeners();
        }

        // === Render: Rewards ===
        function renderRewards() {
            const pointsContainer = document.getElementById('member-points-container');
            const rewardsContainer = document.getElementById('rewards-list-container');
            const claimedContainer = document.getElementById('claimed-rewards-container');
            const noClaimedMsg = document.getElementById('no-claimed-rewards');
            const selectedMemberId = document.getElementById('redeem-member-select').value;
            const selectedMember = getMemberById(selectedMemberId);
            const memberPoints = selectedMember ? selectedMember.points : 0;

            // 1. Render Member Point Totals (Add ID for animation)
            pointsContainer.innerHTML = localState.members.map(member => {
                const colorInfo = COLOR_LIST.find(c => c.bg === member.color);
                const bgColor = colorInfo ? colorInfo.hex + '20' : '#FFFFFF';
                return `
                <div class="p-4 rounded-lg shadow-sm flex items-center" style="background-color: ${bgColor}">
                    <span class="h-12 w-12 rounded-full ${member.color} flex items-center justify-center text-white text-2xl font-bold mr-4">${member.emoji || member.name[0]}</span>
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${member.name}</p>
                        <p id="member-points-display-${member.id}" class="text-3xl font-bold text-green-600">${member.points || 0}</p> 
                    </div>
                </div>
            `}).join('');
            
            // 2. Render Available Rewards
            rewardsContainer.innerHTML = localState.rewards.map(reward => {
                const canAfford = memberPoints >= reward.cost;
                return `
                    <div class="border rounded-lg p-3 text-center ${!canAfford ? 'opacity-50 bg-gray-100' : 'bg-white shadow-sm'}">
                        <span class="text-4xl">${reward.emoji}</span>
                        <p class="font-medium truncate" title="${reward.name}">${reward.name}</p>
                        <p class="font-bold text-green-600 mb-2">${reward.cost} pts</p>
                        <button 
                            class="redeem-reward-btn w-full px-3 py-1 rounded-lg font-medium text-sm ${canAfford ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            data-reward-id="${reward.id}"
                            ${!canAfford ? 'disabled' : ''}
                        >
                            Redeem
                        </button>
                    </div>
                `;
            }).join('');
            
            // 3. Render Claimed Rewards
            const claimedItems = localState.claimedRewards;
            if (claimedItems.length > 0) {
                noClaimedMsg.classList.add('hidden');
                claimedContainer.innerHTML = claimedItems.map(item => {
                    const member = getMemberById(item.claimedBy);
                    const memberColorClass = member ? member.color.replace('bg-', 'text-') : 'text-gray-500'; // Get text color class
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${item.emoji}</span>
                                <div>
                                    <p class="font-medium">${item.name}</p>
                                    <p class="text-sm text-gray-500">Claimed by <span class="font-medium ${memberColorClass}">${member ? member.name : '...'}</span> for ${item.cost} pts</p>
                                </div>
                            </div>
                            <button class="deliver-reward-btn bg-blue-600 text-white px-3 py-1 rounded-lg font-medium text-sm hover:bg-blue-700" data-claimed-id="${item.id}">
                                Mark Delivered
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                noClaimedMsg.classList.remove('hidden');
                claimedContainer.innerHTML = ''; // Clear old items
                claimedContainer.appendChild(noClaimedMsg);
            }
        }

        // === Render: Setup (Main) ===
        function renderSetup() {
            // Highlight active tab
            document.querySelectorAll('.setup-nav-item').forEach(btn => {
                const isActive = btn.dataset.view === currentSetupView;
                btn.className = `setup-nav-item py-4 px-1 border-b-2 font-medium text-sm ${
                    isActive 
                    ? 'border-blue-600 text-blue-700' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`;
            });
            
            // Show active view
            document.querySelectorAll('.setup-view').forEach(view => {
                view.classList.toggle('hidden', view.id !== `setup-view-${currentSetupView}`);
                view.classList.toggle('grid', view.id === `setup-view-${currentSetupView}`);
            });
            
            lucide.createIcons(); // Re-run for any icons in setup views
        }
        
        // === Render: Setup Members ===
        function renderSetupMembers() {
            const listContainer = document.getElementById('member-list');
            
            // Sort by displayOrder before rendering
            const sortedMembers = [...localState.members].sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            
            listContainer.innerHTML = sortedMembers.map((member, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <span class="h-8 w-8 rounded-full ${member.color} flex items-center justify-center text-white text-lg font-bold mr-3">${member.emoji || member.name[0]}</span>
                        <span class="font-medium">${member.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="move-member-btn p-1 text-gray-400 hover:text-blue-600 ${index === 0 ? 'opacity-25 cursor-not-allowed' : ''}" data-member-id="${member.id}" data-direction="up" ${index === 0 ? 'disabled' : ''}>
                            <i data-lucide="arrow-up-circle" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                        <button class="move-member-btn p-1 text-gray-400 hover:text-blue-600 ${index === sortedMembers.length - 1 ? 'opacity-25 cursor-not-allowed' : ''}" data-member-id="${member.id}" data-direction="down" ${index === sortedMembers.length - 1 ? 'disabled' : ''}>
                            <i data-lucide="arrow-down-circle" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                        <button class="edit-member-btn p-1 text-gray-400 hover:text-blue-600" data-member-id="${member.id}">
                            <i data-lucide="edit-2" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                        <button class="delete-member-btn p-1 text-gray-400 hover:text-red-600" data-member-id="${member.id}" data-member-name="${member.name}">
                            <i data-lucide="trash-2" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // === Render: Setup Chores ===
        function renderSetupChores() {
            const listContainer = document.getElementById('chore-list');
            listContainer.innerHTML = localState.chores.map(chore => {
                const schedule = DAYS_OF_WEEK
                    .filter(day => chore.schedule.includes(day))
                    .map(day => day.charAt(0).toUpperCase() + day.slice(1))
                    .join(', ');
                const assignee = getMemberById(chore.defaultAssignee);
                const assigneeColorClass = assignee ? assignee.color.replace('bg-','text-') : 'text-gray-500'; // text color
                
                return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium">${chore.emoji} ${chore.name} (+${chore.points} pts)</p>
                        <p class="text-sm text-gray-500">
                            Schedule: ${schedule || 'None'} | 
                            Default: <span class="font-medium ${assigneeColorClass}">${assignee ? assignee.name : 'Unassigned'}</span>
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-chore-btn p-1 text-gray-400 hover:text-blue-600" data-chore-id="${chore.id}">
                            <i data-lucide="edit-2" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                        <button class="delete-chore-btn p-1 text-gray-400 hover:text-red-600" data-chore-id="${chore.id}" data-chore-name="${chore.name}">
                            <i data-lucide="trash-2" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        // === Render: Setup Rewards ===
        function renderSetupRewards() {
            const listContainer = document.getElementById('reward-list');
            listContainer.innerHTML = localState.rewards.map(reward => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${reward.emoji}</span>
                        <span class="font-medium">${reward.name}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-green-600">${reward.cost} pts</span>
                        <button class="edit-reward-btn p-1 text-gray-400 hover:text-blue-600" data-reward-id="${reward.id}">
                            <i data-lucide="edit-2" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                        <button class="delete-reward-btn p-1 text-gray-400 hover:text-red-600" data-reward-id="${reward.id}" data-reward-name="${reward.name}">
                            <i data-lucide="trash-2" class="h-5 w-5 pointer-events-none"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        // === Render: Populate Dropdowns (Emojis, Colors, Members) ===
        function populateEmojiSelects() {
            const selects = document.querySelectorAll('#adhoc-emoji, #chore-emoji, #reward-emoji');
            const currentValues = {};
            selects.forEach(sel => { currentValues[sel.id] = sel.value; });
            
            const options = EMOJI_LIST.map(emoji => `<option value="${emoji}">${emoji}</option>`).join('');
            
            selects.forEach(sel => {
                sel.innerHTML = options;
                sel.value = currentValues[sel.id] || EMOJI_LIST[0]; // Restore or default
            });
        }
        
        function populateColorSelects() {
            const select = document.getElementById('member-color');
            const currentValue = select.value;
            select.innerHTML = COLOR_LIST.map(color => `<option value="${color.bg}">${color.name}</option>`).join('');
            select.value = currentValue || COLOR_LIST[0].bg;
        }

        function populateMemberSelects() {
            const selects = document.querySelectorAll('#adhoc-assignee, #chore-assignee, #assign-member-select, #adjust-member-select, #redeem-member-select');
            const currentValues = {};
            selects.forEach(sel => { currentValues[sel.id] = sel.value; });
            
            // Sort members by displayOrder for dropdowns
            const sortedMembers = [...localState.members].sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            const options = sortedMembers.map(member => `<option value="${member.id}">${member.name}</option>`).join('');
            
            selects.forEach(sel => {
                if (sel.id === 'adhoc-assignee' || sel.id === 'chore-assignee' || sel.id === 'assign-member-select') {
                    sel.innerHTML = `<option value="unassigned">Unassigned</option>` + options;
                } else {
                    sel.innerHTML = options;
                }
                
                // Restore selected value if possible
                if (currentValues[sel.id] && (currentValues[sel.id] === 'unassigned' || getMemberById(currentValues[sel.id]))) {
                    sel.value = currentValues[sel.id];
                } else if (localState.members.length > 0) {
                    // Default to first member or unassigned
                    if (sel.id === 'adhoc-assignee' || sel.id === 'chore-assignee' || sel.id === 'assign-member-select') {
                         sel.value = 'unassigned';
                    } else {
                         sel.value = sortedMembers[0].id; // Default to first *sorted* member
                    }
                }
            });
        }

        // === Event Handlers: Navigation ===
        function handleNavClick(e) {
            e.preventDefault();
            const navItem = e.target.closest('.nav-item');
            if (!navItem) return;
            
            playSound('click');
            
            currentView = navItem.dataset.view;
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(item => {
                const link = item.querySelector('a');
                if (item.dataset.view === currentView) {
                    link.classList.add('bg-hub-dark', 'text-white');
                    link.classList.remove('text-indigo-100');
                } else {
                    link.classList.remove('bg-hub-dark', 'text-white');
                    link.classList.add('text-indigo-100');
                }
            });
            
            // Show/hide views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.toggle('hidden', view.id !== `view-${currentView}`);
            });
            
            renderAll();
        }
        
        function handleSetupNavClick(e) {
             const btn = e.target.closest('.setup-nav-item');
             if (!btn) return;
             
             playSound('click');
             currentSetupView = btn.dataset.view;
             renderSetup(); // Re-render setup section
             
             switch (currentSetupView) {
                 case 'members': renderSetupMembers(); break;
                 case 'chores': renderSetupChores(); break;
                 case 'rewards': renderSetupRewards(); break;
             }
        }

        // === Event Handlers: Daily Chores ===
        async function handleToggleChore(e) {
            const btn = e.target.closest('.chore-toggle-btn');
            if (!btn) return;
            
            const choreId = btn.dataset.choreId;
            const chore = localState.dailyChores.find(c => c.id === choreId);
            if (!chore) return;
            
            const newIsComplete = !chore.isComplete;

            // Prevent completing an unassigned chore
             if (newIsComplete && chore.assignedTo === 'unassigned') {
                 console.log("Cannot complete an unassigned chore.");
                 // Optionally, add some visual feedback like a shake animation
                 btn.classList.add('animate-head-shake'); // Assuming head-shake is defined
                 setTimeout(() => btn.classList.remove('animate-head-shake'), 500);
                 playSound('uncomplete'); // Play an error/negative sound
                 return; 
             }
            
            const memberId = newIsComplete ? chore.assignedTo : chore.completedBy; // Assignee completes, last completer uncompletes
            const member = getMemberById(memberId);
            
            // Prevent un-completing if member doesn't exist (shouldn't happen)
            if (!newIsComplete && !member) {
                console.error("Cannot find member who completed this chore.");
                return;
            }
            
            // Calculate point change
            const pointsChange = newIsComplete ? chore.points : -Math.abs(chore.points);
            const startPoints = member ? (member.points || 0) : 0; // Get start points before update
            const endPoints = startPoints + pointsChange;
            
            try {
                // Update chore
                const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                const choreRef = doc(db, F_DAILY_CHORES_COL, choreId);
                await updateDoc(choreRef, {
                    isComplete: newIsComplete,
                    completedBy: newIsComplete ? memberId : null
                });
                
                // Update member points
                if (member && member.id !== 'unassigned') { // Don't award points to "unassigned"
                    const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
                    const memberRef = doc(db, F_MEMBERS_COL, member.id);
                    await updateDoc(memberRef, { points: endPoints });
                    
                     // Animate points display on daily list if visible
                     const pointsDisplayDaily = document.getElementById(`member-points-${member.id}`);
                     if (pointsDisplayDaily && currentView === 'daily') {
                         animateNumber(pointsDisplayDaily, startPoints, endPoints, 500);
                     }
                      // Also animate on reward screen if visible
                     const pointsDisplayReward = document.getElementById(`member-points-display-${member.id}`);
                     if (pointsDisplayReward && currentView === 'rewards') {
                         animateNumber(pointsDisplayReward, startPoints, endPoints, 500);
                     }
                }
                
                // 3. Play sound & Animate
                playSound(newIsComplete ? 'complete' : 'uncomplete');
                
                if (newIsComplete) {
                    // Trigger particle burst from button location
                    triggerConfetti('fireworks', { x: window.innerWidth / 2, y: window.innerHeight / 2 });
                    
                    // Animate checkmark
                    btn.classList.add('animate-bounce-in');
                    // Remove class after animation finishes to allow re-triggering
                    setTimeout(() => btn.classList.remove('animate-bounce-in'), 400); 

                    // --- ⭐️ TRIGGER EMOJI ANIMATION ---
                    const memberEmojiEl = document.getElementById(`member-emoji-${memberId}`);
                    if (memberEmojiEl) {
                        memberEmojiEl.classList.add('animate-grow-and-spin');
                        setTimeout(() => {
                            // Ensure element still exists before removing class
                            if (memberEmojiEl) {
                                memberEmojiEl.classList.remove('animate-grow-and-spin');
                            }
                        }, 600); // Must match animation duration (0.6s)
                    }

                } else {
                    // Remove bounce animation class immediately if uncompleting
                    btn.classList.remove('animate-bounce-in');
                }
                
            } catch (error) {
                console.error("Error toggling chore: ", error);
            }
        }
        
        function handleOpenAssignModal(e) {
            const btn = e.target.closest('.assign-chore-btn');
            if (!btn) return;
            
            playSound('click');
            
            selectedChoreForAssignment = btn.dataset.choreId;
            const chore = localState.dailyChores.find(c => c.id === selectedChoreForAssignment);
            if (!chore) return;
            
            document.getElementById('assign-chore-name').textContent = chore.name;
            document.getElementById('assign-member-select').value = chore.assignedTo || 'unassigned';
            document.getElementById('assign-modal').classList.remove('hidden');
        }
        
        function handleCloseAssignModal() {
            playSound('click');
            document.getElementById('assign-modal').classList.add('hidden');
            selectedChoreForAssignment = null;
        }
        
        async function handleSaveAssignment() {
            if (!selectedChoreForAssignment) return;
            
            const newAssigneeId = document.getElementById('assign-member-select').value;
            const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
            
            try {
                const choreRef = doc(db, F_DAILY_CHORES_COL, selectedChoreForAssignment);
                await updateDoc(choreRef, {
                    assignedTo: newAssigneeId
                });
                playSound('complete');
                handleCloseAssignModal();
            } catch (error) {
                console.error("Error saving assignment:", error);
            }
        }

        async function handleAddAdhocChore(e) {
            e.preventDefault();
            const name = document.getElementById('adhoc-name').value;
            const points = parseInt(document.getElementById('adhoc-points').value, 10);
            const emoji = document.getElementById('adhoc-emoji').value;
            const assignedTo = document.getElementById('adhoc-assignee').value;
            
            if (!name || isNaN(points)) return;
            
            const newChore = {
                templateId: null, // No template for ad-hoc
                name,
                emoji,
                points,
                date: getLocalISODate(), // TIMEZONE FIX
                isComplete: false,
                isAdHoc: true,
                assignedTo: assignedTo || 'unassigned',
                completedBy: null
            };
            
            try {
                const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                await addDoc(collection(db, F_DAILY_CHORES_COL), newChore);
                playSound('complete');
                document.getElementById('adhoc-chore-form').reset();
                // Close the <details> accordion
                document.getElementById('adhoc-chore-form').closest('details').open = false;
            } catch (error) {
                console.error("Error adding ad-hoc chore:", error);
            }
        }
        
         // === Event Handler: Duplicate Chore ===
        async function handleDuplicateChore(e) {
            const btn = e.target.closest('.duplicate-chore-btn');
            if (!btn) return;

            const choreId = btn.dataset.choreId;
            const originalChore = localState.dailyChores.find(c => c.id === choreId);

            if (!originalChore) {
                console.error("Could not find chore to duplicate:", choreId);
                return;
            }

            // Create a copy, reset status, make adhoc
            const newChoreData = {
                templateId: null, // Duplicates are always ad-hoc
                name: originalChore.name,
                emoji: originalChore.emoji,
                points: originalChore.points,
                date: getLocalISODate(), // Ensure it's for today
                isComplete: false,
                isAdHoc: true,
                assignedTo: 'unassigned', // Start as unassigned
                completedBy: null
            };

            try {
                const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                await addDoc(collection(db, F_DAILY_CHORES_COL), newChoreData);
                playSound('click'); // Simple click sound for duplication
                console.log("Duplicated chore:", originalChore.name);
                // No need to manually render, onSnapshot will handle it.
            } catch (error) {
                console.error("Error duplicating chore:", error);
            }
        }

        // === Event Handlers: Drag & Drop (Daily) ===
        let draggedChoreId = null;
        
        function attachDragAndDropListeners() {
            const draggables = document.querySelectorAll('.chore-item-draggable');
            const droppables = document.querySelectorAll('.chore-list-droppable');

            draggables.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedChoreId = item.dataset.choreId;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedChoreId);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    draggedChoreId = null;
                });
            });
            
            droppables.forEach(list => {
                list.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Allow drop
                    list.classList.add('drag-over-target');
                });
                
                list.addEventListener('dragleave', () => {
                    list.classList.remove('drag-over-target');
                });
                
                list.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    list.classList.remove('drag-over-target');
                    
                    const choreId = e.dataTransfer.getData('text/plain');
                    const newAssigneeId = list.dataset.memberId;
                    
                    if (!choreId || !newAssigneeId) return;
                    
                    // Optimistic UI update
                    const chore = localState.dailyChores.find(c => c.id === choreId);
                    if (chore.assignedTo !== newAssigneeId) {
                        chore.assignedTo = newAssigneeId;
                        renderDailyList(); // Re-render to move the item
                        playSound('click');
                        
                        // Update Firestore
                        try {
                            const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                            const choreRef = doc(db, F_DAILY_CHORES_COL, choreId);
                            await updateDoc(choreRef, { assignedTo: newAssigneeId });
                        } catch (error) {
                            console.error("Error updating chore assignment:", error);
                            // TODO: Revert optimistic update on error
                        }
                    }
                });
            });
        }
        
        // === Event Handlers: Drag & Drop (Weekly) ===
        let draggedWeeklyChoreId = null;

        function attachWeeklyDragAndDropListeners() {
            const draggables = document.querySelectorAll('.weekly-chore-draggable');
            const droppables = document.querySelectorAll('.weekly-day-droppable');

            draggables.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedWeeklyChoreId = item.dataset.choreId;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedWeeklyChoreId);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    draggedWeeklyChoreId = null;
                });
            });
            
            droppables.forEach(dayColumn => {
                dayColumn.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Allow drop
                    dayColumn.classList.add('drag-over-target');
                });
                
                dayColumn.addEventListener('dragleave', () => {
                    dayColumn.classList.remove('drag-over-target');
                });
                
                dayColumn.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dayColumn.classList.remove('drag-over-target');
                    
                    const choreId = e.dataTransfer.getData('text/plain');
                    const newDate = dayColumn.dataset.date;
                    
                    if (!choreId || !newDate) return;
                    
                    const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                    
                    // Find the chore (it might not be in localState.dailyChores if not today)
                    let chore;
                    try {
                        const choreRef = doc(db, F_DAILY_CHORES_COL, choreId);
                        const choreSnap = await getDoc(choreRef);
                        if (!choreSnap.exists()) return;
                        chore = choreSnap.data();
                        
                        // Check if it's a recurring chore (can't move) or already on this date
                        if (!chore.isAdHoc) {
                            console.warn("Cannot move recurring chores.");
                            // TODO: Show a visual warning
                            return;
                        }
                        if (chore.date === newDate) {
                            return; // No change
                        }

                        // Optimistic UI update
                        playSound('click');
                        renderWeeklySchedule(); // Will refetch and re-render
                        
                        // Update Firestore
                        await updateDoc(choreRef, { date: newDate });
                        console.log(`Moved ad-hoc chore ${choreId} to ${newDate}`);

                    } catch (error) {
                        console.error("Error moving weekly chore:", error);
                    }
                });
            });
            
            // Add listeners for delete buttons
            document.querySelectorAll('.delete-adhoc-chore-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const choreId = btn.dataset.choreId;
                    const choreName = btn.dataset.choreName;
                    
                    showDeleteModal({
                        title: 'Delete Ad-Hoc Chore',
                        prompt: `Are you sure you want to delete "${choreName}"?`,
                        needsPassword: false,
                        onConfirm: async () => {
                            try {
                                const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                                const choreRef = doc(db, F_DAILY_CHORES_COL, choreId);
                                await deleteDoc(choreRef);
                                playSound('uncomplete');
                                renderWeeklySchedule(); // Refresh view
                            } catch (e) {
                                console.error("Error deleting ad-hoc chore:", e);
                            }
                        }
                    });
                });
            });
        }


        // === Event Handlers: Rewards ===
        async function handleRedeemReward(e) {
            const btn = e.target.closest('.redeem-reward-btn');
            if (!btn) return;
            
            const rewardId = btn.dataset.rewardId;
            const memberId = document.getElementById('redeem-member-select').value;
            
            const reward = getRewardById(rewardId);
            const member = getMemberById(memberId);
            
            if (!reward || !member || member.points < reward.cost) return;
            
            const startPoints = member.points || 0;
            const endPoints = startPoints - reward.cost;
            
            playSound('redeem'); // Play fanfare + sparkle
            triggerConfetti('fireworks'); // Trigger fireworks!
            
            try {
                // 1. Deduct points (Firestore)
                const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
                const memberRef = doc(db, F_MEMBERS_COL, member.id);
                await updateDoc(memberRef, { points: endPoints });
                
                // 2. Create claimed reward item
                const F_CLAIMED_REWARDS_COL = `/artifacts/${appId}/public/data/claimedRewards`;
                await addDoc(collection(db, F_CLAIMED_REWARDS_COL), {
                    rewardId: reward.id,
                    name: reward.name,
                    emoji: reward.emoji,
                    cost: reward.cost,
                    claimedBy: member.id,
                    claimedAt: serverTimestamp(),
                    delivered: false
                });
                
                // 3. Animate points countdown in UI (Added check for currentView)
                const pointsDisplayReward = document.getElementById(`member-points-display-${member.id}`);
                if (pointsDisplayReward && currentView === 'rewards') {
                    animateNumber(pointsDisplayReward, startPoints, endPoints, 1000); 
                }
                 // Also update on daily list if visible
                 const pointsDisplayDaily = document.getElementById(`member-points-${member.id}`);
                 if (pointsDisplayDaily && currentView === 'daily') {
                     animateNumber(pointsDisplayDaily, startPoints, endPoints, 1000);
                 }

                // Re-render rewards list (needed to update claimed items & button states)
                // Wait slightly for animation to be noticeable
                setTimeout(() => {
                    if (currentView === 'rewards') {
                         renderRewards();
                    }
                }, 100); 
                
            } catch (error) {
                console.error("Error redeeming reward:", error);
            }
        }
        
        async function handleDeliverReward(e) {
            const btn = e.target.closest('.deliver-reward-btn');
            if (!btn) return;
            
            const claimedId = btn.dataset.claimedId;
            
            try {
                const F_CLAIMED_REWARDS_COL = `/artifacts/${appId}/public/data/claimedRewards`;
                const rewardRef = doc(db, F_CLAIMED_REWARDS_COL, claimedId);
                await updateDoc(rewardRef, {
                    delivered: true
                });
                playSound('complete');
            } catch (error) {
                console.error("Error marking reward as delivered:", error);
            }
        }
        
        function handleRedeemMemberChange() {
            // Just re-render the rewards view to update affordability
            renderRewards();
        }
        
        // === Event Handlers: Setup Members ===
        async function handleMoveMember(e) {
            // Need to target the button, not the icon inside it
            const btn = e.target.closest('.move-member-btn');
            if (!btn) return;

            const memberId = btn.dataset.memberId;
            const direction = btn.dataset.direction;
            
            // Get a fresh sorted list
            const sortedMembers = [...localState.members].sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            const currentIndex = sortedMembers.findIndex(m => m.id === memberId);
            
            if (currentIndex === -1) return;
            
            let swapIndex = -1;
            if (direction === 'up' && currentIndex > 0) {
                swapIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < sortedMembers.length - 1) {
                swapIndex = currentIndex + 1;
            }
            
            if (swapIndex === -1) return;
            
            // Swap the members in the local array
            [sortedMembers[currentIndex], sortedMembers[swapIndex]] = [sortedMembers[swapIndex], sortedMembers[currentIndex]];
            
            // Now, re-index the entire list and commit to Firestore
            const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
            const batch = writeBatch(db);
            
            sortedMembers.forEach((member, index) => {
                const docRef = doc(db, F_MEMBERS_COL, member.id);
                batch.update(docRef, { displayOrder: index });
            });
            
            try {
                await batch.commit();
                playSound('click');
                // Snapshot will re-render, no need to manually call
            } catch (e) {
                console.error("Error reordering members:", e);
            }
        }

        async function handleMemberFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('member-id').value;
            const name = document.getElementById('member-name').value;
            const color = document.getElementById('member-color').value;
            const emoji = document.getElementById('member-emoji').value;
            
            if (!name) return;
            
            const memberData = { name, color, emoji };
            const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
            
            try {
                if (id) {
                    // Update
                    const memberRef = doc(db, F_MEMBERS_COL, id);
                    await updateDoc(memberRef, memberData);
                } else {
                    // Add new (with 0 points and displayOrder)
                    memberData.points = 0;
                    // Assign order based on current count before adding
                    memberData.displayOrder = localState.members.length; 
                    await addDoc(collection(db, F_MEMBERS_COL), memberData);
                }
                playSound('complete');
                resetMemberForm();
            } catch (error) {
                console.error("Error saving member:", error);
            }
        }
        
        function handleEditMember(e) {
            // Target button, not icon
            const btn = e.target.closest('.edit-member-btn');
            if (!btn) return;
            
            playSound('click');
            const member = getMemberById(btn.dataset.memberId);
            if (!member) return;
            
            document.getElementById('member-form-title').textContent = 'Edit Member';
            document.getElementById('member-id').value = member.id;
            document.getElementById('member-name').value = member.name;
            document.getElementById('member-color').value = member.color;
            document.getElementById('member-emoji').value = member.emoji || '';
            document.getElementById('member-submit-btn').textContent = 'Save Changes';
            document.getElementById('member-cancel-btn').classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('member-form').scrollIntoView({ behavior: 'smooth' });
        }

        function resetMemberForm() {
            document.getElementById('member-form-title').textContent = 'Add New Member';
            document.getElementById('member-id').value = '';
            document.getElementById('member-form').reset();
            document.getElementById('member-submit-btn').textContent = 'Add Member';
            document.getElementById('member-cancel-btn').classList.add('hidden');
        }
        
        function handleDeleteMember(e) {
            // Target button, not icon
            const btn = e.target.closest('.delete-member-btn');
            if (!btn) return;
            
            const memberId = btn.dataset.memberId;
            const memberName = btn.dataset.memberName;
            
            showDeleteModal({
                title: 'Delete Member',
                prompt: `Are you sure you want to delete ${memberName}? This will also unassign all their chores.`,
                needsPassword: true,
                onConfirm: async () => {
                    try {
                        const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
                        const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                        const batch = writeBatch(db);

                        // 1. Delete the member
                        const memberRef = doc(db, F_MEMBERS_COL, memberId);
                        batch.delete(memberRef);

                        // 2. Unassign their daily chores
                        const q = query(collection(db, F_DAILY_CHORES_COL), where("assignedTo", "==", memberId));
                        const choreSnapshot = await getDocs(q);
                        choreSnapshot.forEach(doc => {
                            batch.update(doc.ref, { assignedTo: "unassigned" });
                        });
                        
                        // 3. Unassign default assignee from chore templates
                        const F_CHORES_COL = `/artifacts/${appId}/public/data/choreTemplates`;
                        const qTemplates = query(collection(db, F_CHORES_COL), where("defaultAssignee", "==", memberId));
                        const templateSnapshot = await getDocs(qTemplates);
                         templateSnapshot.forEach(doc => {
                             batch.update(doc.ref, { defaultAssignee: "unassigned" });
                        });


                        await batch.commit();
                        playSound('uncomplete');
                        // Re-render will happen automatically via snapshot listener
                        
                        // Also re-index remaining members displayOrder
                        await reindexMemberOrder();

                    } catch (error) {
                        console.error("Error deleting member:", error);
                    }
                }
            });
        }
        
        // Helper to re-index displayOrder after deletion
        async function reindexMemberOrder() {
            const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
            const snapshot = await getDocs(collection(db, F_MEMBERS_COL));
            const members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            members.sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));

            const batch = writeBatch(db);
            members.forEach((member, index) => {
                if (member.displayOrder !== index) {
                    const docRef = doc(db, F_MEMBERS_COL, member.id);
                    batch.update(docRef, { displayOrder: index });
                }
            });
            await batch.commit();
        }

        
        function handleAdjustPointsForm(e) {
            e.preventDefault();
            const memberId = document.getElementById('adjust-member-select').value;
            const amount = parseInt(document.getElementById('adjust-points-amount').value, 10);
            
            if (!memberId || isNaN(amount) || amount < 0) return; // Ensure positive number
            
            // Callback to run after password success
            const onConfirm = async () => {
                const member = getMemberById(memberId);
                if (!member) return;
                
                 const startPoints = member.points || 0;
                 const endPoints = amount; // SET points
                
                try {
                    const F_MEMBERS_COL = `/artifacts/${appId}/public/data/members`;
                    const memberRef = doc(db, F_MEMBERS_COL, memberId);
                    await updateDoc(memberRef, { points: endPoints });
                    
                    playSound('complete');
                    document.getElementById('adjust-points-form').reset();
                    
                     // Animate points display (Added check for currentView)
                     const pointsDisplayReward = document.getElementById(`member-points-display-${member.id}`);
                     if (pointsDisplayReward && currentView === 'rewards') {
                         animateNumber(pointsDisplayReward, startPoints, endPoints, 500);
                     }
                     const pointsDisplayDaily = document.getElementById(`member-points-${member.id}`);
                     if (pointsDisplayDaily && currentView === 'daily') {
                         animateNumber(pointsDisplayDaily, startPoints, endPoints, 500);
                     }

                } catch (error) {
                    console.error("Error adjusting points:", error);
                }
            };
            
            // Show password modal
            showPasswordModal({
                prompt: `Enter password to SET ${getMemberById(memberId)?.name}'s points to ${amount}.`,
                onSuccess: onConfirm
            });
        }
        
        // === Event Handlers: Setup Chores ===
        async function handleChoreFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('chore-id').value;
            const name = document.getElementById('chore-name').value;
            const points = parseInt(document.getElementById('chore-points').value, 10);
            const emoji = document.getElementById('chore-emoji').value;
            const defaultAssignee = document.getElementById('chore-assignee').value;
            const schedule = Array.from(document.querySelectorAll('.day-check:checked')).map(cb => cb.value);
            
            if (!name || isNaN(points)) return;
            
            const choreData = { name, points, emoji, defaultAssignee, schedule };
            const F_CHORES_COL = `/artifacts/${appId}/public/data/choreTemplates`;
            
            try {
                let templateId = id;
                if (id) {
                    // Update
                    const choreRef = doc(db, F_CHORES_COL, id);
                    await updateDoc(choreRef, choreData);
                } else {
                    // Add new
                    const docRef = await addDoc(collection(db, F_CHORES_COL), choreData);
                    templateId = docRef.id;
                }
                
                // Now, sync the weekly chores for this template
                const fullTemplateData = { ...choreData, id: templateId };
                await generateDailyChoresForTemplate(fullTemplateData);
                
                playSound('complete');
                resetChoreForm();
            } catch (error) {
                console.error("Error saving chore template:", error);
            }
        }
        
        function handleEditChore(e) {
             // Target button, not icon
            const btn = e.target.closest('.edit-chore-btn');
            if (!btn) return;

            playSound('click');
            const chore = getChoreById(btn.dataset.choreId);
            if (!chore) return;
            
            document.getElementById('chore-form-title').textContent = 'Edit Recurring Chore';
            document.getElementById('chore-id').value = chore.id;
            document.getElementById('chore-name').value = chore.name;
            document.getElementById('chore-points').value = chore.points;
            document.getElementById('chore-emoji').value = chore.emoji;
            document.getElementById('chore-assignee').value = chore.defaultAssignee || 'unassigned';
            
            document.querySelectorAll('.day-check').forEach(cb => {
                cb.checked = chore.schedule.includes(cb.value);
            });
            
            document.getElementById('chore-submit-btn').textContent = 'Save Changes';
            document.getElementById('chore-cancel-btn').classList.remove('hidden');
            
            document.getElementById('chore-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetChoreForm() {
            document.getElementById('chore-form-title').textContent = 'Add New Recurring Chore';
            document.getElementById('chore-id').value = '';
            document.getElementById('chore-form').reset();
            document.getElementById('chore-submit-btn').textContent = 'Add Chore';
            document.getElementById('chore-cancel-btn').classList.add('hidden');
        }

        function handleDeleteChore(e) {
             // Target button, not icon
            const btn = e.target.closest('.delete-chore-btn');
            if (!btn) return;
            
            const choreId = btn.dataset.choreId;
            const choreName = btn.dataset.choreName;

            showDeleteModal({
                title: 'Delete Recurring Chore',
                prompt: `Delete "${choreName}"? This will also delete all future, non-completed daily chores from this template.`,
                needsPassword: true,
                onConfirm: async () => {
                    try {
                        const F_CHORES_COL = `/artifacts/${appId}/public/data/choreTemplates`;
                        // 1. Delete template
                        await deleteDoc(doc(db, F_CHORES_COL, choreId));
                        
                        // 2. Delete future daily chores
                        const F_DAILY_CHORES_COL = `/artifacts/${appId}/public/data/dailyChores`;
                        const todayISO = getLocalISODate(); // TIMEZONE FIX
                        const q = query(
                            collection(db, F_DAILY_CHORES_COL),
                            where("templateId", "==", choreId),
                            where("date", ">=", todayISO),
                            where("isComplete", "==", false)
                        );
                        
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();

                        playSound('uncomplete');
                    } catch (error) {
                        console.error("Error deleting chore template:", error);
                    }
                }
            });
        }
        
        // === Event Handlers: Setup Rewards ===
        async function handleRewardFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('reward-id').value;
            const name = document.getElementById('reward-name').value;
            const cost = parseInt(document.getElementById('reward-cost').value, 10);
            const emoji = document.getElementById('reward-emoji').value;
            
            if (!name || isNaN(cost)) return;
            
            const rewardData = { name, cost, emoji };
            const F_REWARDS_COL = `/artifacts/${appId}/public/data/rewards`;
            
            try {
                if (id) {
                    // Update
                    const rewardRef = doc(db, F_REWARDS_COL, id);
                    await updateDoc(rewardRef, rewardData);
                } else {
                    // Add new
                    await addDoc(collection(db, F_REWARDS_COL), rewardData);
                }
                playSound('complete');
                resetRewardForm();
            } catch (error) {
                console.error("Error saving reward:", error);
            }
        }
        
        function handleEditReward(e) {
            // Target button, not icon
            const btn = e.target.closest('.edit-reward-btn');
            if (!btn) return;
            
            playSound('click');
            const reward = getRewardById(btn.dataset.rewardId);
            if (!reward) return;
            
            document.getElementById('reward-form-title').textContent = 'Edit Reward';
            document.getElementById('reward-id').value = reward.id;
            document.getElementById('reward-name').value = reward.name;
            document.getElementById('reward-cost').value = reward.cost;
            document.getElementById('reward-emoji').value = reward.emoji;
            document.getElementById('reward-submit-btn').textContent = 'Save Changes';
            document.getElementById('reward-cancel-btn').classList.remove('hidden');
            
            document.getElementById('reward-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetRewardForm() {
            document.getElementById('reward-form-title').textContent = 'Add New Reward';
            document.getElementById('reward-id').value = '';
            document.getElementById('reward-form').reset();
            document.getElementById('reward-submit-btn').textContent = 'Add Reward';
            document.getElementById('reward-cancel-btn').classList.add('hidden');
        }

        function handleDeleteReward(e) {
             // Target button, not icon
            const btn = e.target.closest('.delete-reward-btn');
            if (!btn) return;
            
            const rewardId = btn.dataset.rewardId;
            const rewardName = btn.dataset.rewardName;

            showDeleteModal({
                title: 'Delete Reward',
                prompt: `Are you sure you want to delete the reward "${rewardName}"?`,
                needsPassword: false,
                onConfirm: async () => {
                    try {
                        const F_REWARDS_COL = `/artifacts/${appId}/public/data/rewards`;
                        await deleteDoc(doc(db, F_REWARDS_COL, rewardId));
                        playSound('uncomplete');
                    } catch (error) {
                        console.error("Error deleting reward:", error);
                    }
                }
            });
        }
        
        // === Event Handlers: Modals (Password, Delete) ===
        function showPasswordModal({ prompt, onSuccess }) {
            passwordSuccessCallback = onSuccess;
            document.getElementById('password-prompt').textContent = prompt;
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-input').focus();
        }
        
        function handlePasswordSubmit() {
            const input = document.getElementById('password-input').value;
            if (input === PASSWORD) {
                document.getElementById('password-error').classList.add('hidden'); // Hide error on success
                if (passwordSuccessCallback) {
                    passwordSuccessCallback();
                }
                closePasswordModal();
            } else {
                document.getElementById('password-error').classList.remove('hidden');
            }
        }
        
        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            passwordSuccessCallback = null;
        }

        function showDeleteModal({ title, prompt, needsPassword, onConfirm }) {
            deleteSuccessCallback = onConfirm;
            
            document.getElementById('delete-title').textContent = title;
            document.getElementById('delete-prompt').textContent = prompt;
            document.getElementById('delete-error').classList.add('hidden');
            
            const passwordPrompt = document.getElementById('delete-password-prompt');
            const passwordInput = document.getElementById('delete-password-input');
            
            if (needsPassword) {
                passwordPrompt.classList.remove('hidden');
                passwordInput.classList.remove('hidden');
                passwordInput.value = '';
            } else {
                passwordPrompt.classList.add('hidden');
                passwordInput.classList.add('hidden');
            }
            
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        function handleDeleteConfirm() {
            const needsPassword = !document.getElementById('delete-password-input').classList.contains('hidden');
            
            if (needsPassword) {
                const input = document.getElementById('delete-password-input').value;
                if (input !== PASSWORD) {
                    document.getElementById('delete-error').classList.remove('hidden');
                    return;
                }
            }
            document.getElementById('delete-error').classList.add('hidden'); // Hide error on success
            
            // Password is correct or not needed
            if (deleteSuccessCallback) {
                deleteSuccessCallback();
            }
            closeDeleteModal();
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            deleteSuccessCallback = null;
        }

        // === Utility Functions ===

        /**
         * TIMEZONE FIX: Gets the local date in 'YYYY-MM-DD' format.
         * @param {Date} [date=new Date()] - The date to format.
         * @returns {string} The date string in YYYY-MM-DD format.
         */
        function getLocalISODate(date = new Date()) {
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('current-date').textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function getMemberById(id) {
            return localState.members.find(m => m.id === id);
        }
        
        function getChoreById(id) {
            return localState.chores.find(c => c.id === id);
        }
        
        function getRewardById(id) {
            return localState.rewards.find(r => r.id === id);
        }
        
        /**
         * TIMEZONE FIX: Gets the dates for the current week (Mon-Sun)
         * using local timezone.
         * @returns {Array<Object>} Array of {day: 'mon', date: 'YYYY-MM-DD'}
         */
        function getWeekDates() {
            const dates = [];
            const today = new Date(); // Local 'today'
            const currentDay = today.getDay(); // 0 (Sun) - 6 (Sat)
            
            // Adjust to get to Monday (1). If today is Sunday (0), go back 6 days.
            const diffToMonday = currentDay === 0 ? -6 : 1 - currentDay;
            
            // Create a new Date object for Monday, safely
            const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + diffToMonday);
            
            for (let i = 0; i < 7; i++) {
                // Create a new date for each day of the week
                const date = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + i);
                dates.push({
                    day: DAYS_OF_WEEK[date.getDay()],
                    date: getLocalISODate(date) // Use local ISO date
                });
            }
            return dates;
        }
        
        /**
         * Animates a number changing in an HTML element.
         * @param {HTMLElement} element - The element containing the number.
         * @param {number} start - The starting number.
         * @param {number} end - The ending number.
         * @param {number} duration - Animation duration in milliseconds.
         */
         function animateNumber(element, start, end, duration) {
             let startTime = null;

             function step(currentTime) {
                 if (!startTime) startTime = currentTime;
                 const progress = Math.min((currentTime - startTime) / duration, 1);
                 // Ease out function - starts fast, slows down
                 const easedProgress = 1 - Math.pow(1 - progress, 3); 
                 const currentNumber = Math.floor(easedProgress * (end - start) + start);
                 
                 // Ensure element still exists before updating
                 if(document.body.contains(element)) {
                     element.textContent = currentNumber;
                 } else {
                     // Stop animation if element is removed
                     console.warn("Target element for animation removed from DOM.");
                     return; 
                 }

                 if (progress < 1) {
                     window.requestAnimationFrame(step);
                 } else {
                     if(document.body.contains(element)) {
                         element.textContent = end; // Ensure final value is exact
                     }
                 }
             }
             window.requestAnimationFrame(step);
         }


        // === App Initialization ===
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Firebase
            initFirebase();
            
            // 2. Initialize UI components
            initConfetti();
            lucide.createIcons();
            
            // 3. Start clock
            updateClock();
            setInterval(updateClock, 1000); // Update every second
            
            // 4. Attach persistent event listeners
            document.querySelector('nav').addEventListener('click', handleNavClick);
            
            // Daily View Listeners (using delegation)
            document.getElementById('view-daily').addEventListener('click', (e) => {
                 if (e.target.closest('.chore-toggle-btn')) handleToggleChore(e);
                 if (e.target.closest('.assign-chore-btn')) handleOpenAssignModal(e);
                 if (e.target.closest('.duplicate-chore-btn')) handleDuplicateChore(e); // Added listener
            });
            document.getElementById('adhoc-chore-form').addEventListener('submit', handleAddAdhocChore);
            
            // Assignment Modal
            document.getElementById('assign-cancel-btn').addEventListener('click', handleCloseAssignModal);
            document.getElementById('assign-save-btn').addEventListener('click', handleSaveAssignment);
            
            // Rewards View
            document.getElementById('redeem-member-select').addEventListener('change', handleRedeemMemberChange);
            document.getElementById('view-rewards').addEventListener('click', handleRedeemReward);
            document.getElementById('view-rewards').addEventListener('click', handleDeliverReward);
            
            // Setup Nav
            document.querySelector('#view-setup nav').addEventListener('click', handleSetupNavClick);
            
            // Setup Members
            document.getElementById('member-form').addEventListener('submit', handleMemberFormSubmit);
            document.getElementById('member-cancel-btn').addEventListener('click', resetMemberForm);
            // Use event delegation for dynamic buttons within the list
            document.getElementById('member-list-container').addEventListener('click', (e) => {
                if (e.target.closest('.edit-member-btn')) handleEditMember(e);
                if (e.target.closest('.delete-member-btn')) handleDeleteMember(e);
                if (e.target.closest('.move-member-btn')) handleMoveMember(e);
            });
            document.getElementById('adjust-points-form').addEventListener('submit', handleAdjustPointsForm);
            
            // Setup Chores
            document.getElementById('chore-form').addEventListener('submit', handleChoreFormSubmit);
            document.getElementById('chore-cancel-btn').addEventListener('click', resetChoreForm);
             // Use event delegation for dynamic buttons within the list
            document.getElementById('chore-list').addEventListener('click', (e) => {
                if (e.target.closest('.edit-chore-btn')) handleEditChore(e);
                if (e.target.closest('.delete-chore-btn')) handleDeleteChore(e);
            });
            
            // Setup Rewards
            document.getElementById('reward-form').addEventListener('submit', handleRewardFormSubmit);
            document.getElementById('reward-cancel-btn').addEventListener('click', resetRewardForm);
             // Use event delegation for dynamic buttons within the list
            document.getElementById('reward-list').addEventListener('click', (e) => {
                 if (e.target.closest('.edit-reward-btn')) handleEditReward(e);
                 if (e.target.closest('.delete-reward-btn')) handleDeleteReward(e);
            });
            
            // Password Modal
            document.getElementById('password-cancel-btn').addEventListener('click', closePasswordModal);
            document.getElementById('password-submit-btn').addEventListener('click', handlePasswordSubmit);
            document.getElementById('password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handlePasswordSubmit();
            });
            
            // Delete Modal
            document.getElementById('delete-cancel-btn').addEventListener('click', closeDeleteModal);
            document.getElementById('delete-confirm-btn').addEventListener('click', handleDeleteConfirm);
            document.getElementById('delete-password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleDeleteConfirm();
            });

            // 5. Set default active nav
            document.querySelector('.nav-item[data-view="daily"] a').classList.add('bg-hub-dark', 'text-white');
            document.querySelector('.nav-item[data-view="daily"] a').classList.remove('text-indigo-100');
            document.getElementById('view-daily').classList.remove('hidden');
            
            // 6. Attach sound initializer to first click
            document.body.addEventListener('click', initSounds, { once: true });
        });

    </script>
</body>
</html>








