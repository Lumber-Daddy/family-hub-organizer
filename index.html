<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub Organizer</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Firebase JS SDKs (using modules) -->
    <!-- This block has been removed. Imports are handled in the main script at the bottom. -->
    
    <!-- 3. Helper Libraries: Tone.js (sound) & Confetti.js (animation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- 4. Icons (Lucide) -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>

    <!-- Suppress favicon.ico 404 error -->
    <link rel="icon" href="data:,">

    <!-- 5. Custom Styles -->
    <style>
        /* Smooth transitions for UI elements */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4c4c4;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        /* Style for completed chore */
        .chore-complete {
            text-decoration: line-through;
            opacity: 0.6;
        }
        /* Simple rotate animation for loading icon */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Draggable style */
        .chore-dragging {
            opacity: 0.5;
            border: 2px dashed #0ea5e9;
        }
        .drag-over-target {
            background-color: #f0f9ff; /* light-blue-50 */
            border: 2px dashed #0ea5e9;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm z-[999] flex flex-col items-center justify-center">
        <div data-lucide="loader-circle" class="animate-spin text-blue-600 h-16 w-16"></div>
        <p class="mt-4 text-lg font-medium text-gray-700">Connecting to Family Hub...</p>
        <p id="loading-error" class="mt-2 text-red-600 hidden"></p>
    </div>

    <div class="flex h-full">
        <!-- ==== Sidebar Navigation ==== -->
        <nav class="w-20 md:w-64 bg-gray-800 text-white flex flex-col shadow-lg">
            <div class="flex items-center justify-center md:justify-start md:pl-6 h-20 border-b border-gray-700">
                <span data-lucide="home" class="h-8 w-8 text-blue-400"></span>
                <span class="hidden md:block ml-3 text-2xl font-bold">Family Hub</span>
            </div>
            
            <ul class="flex flex-col py-4 space-y-2">
                <!-- Navigation Links -->
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="daily">
                        <span data-lucide="clipboard-list"></span>
                        <span class="hidden md:block ml-4">Daily List</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="weekly">
                        <span data-lucide="calendar-days"></span>
                        <span class="hidden md:block ml-4">Weekly Schedule</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="rewards">
                        <span data-lucide="star"></span>
                        <span class="hidden md:block ml-4">Points & Rewards</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center justify-center md:justify-start py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white transition-all" data-view="setup">
                        <span data-lucide="settings"></span>
                        <span class="hidden md:block ml-4">Setup</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- ==== Main Content Area ==== -->
        <main class="flex-1 flex flex-col h-screen">
            <!-- Header Bar -->
            <header class="flex items-center justify-between h-20 bg-white shadow-md px-6 z-10">
                <h2 id="view-title" class="text-3xl font-bold text-gray-800">Daily List</h2>
                <div class="text-right">
                    <div id="current-time" class="text-2xl font-semibold text-gray-700"></div>
                    <div id="current-date" class="text-sm text-gray-500"></div>
                </div>
            </header>

            <!-- Content Views (overflow-y-auto is key) -->
            <div class="flex-1 p-6 md:p-8 overflow-y-auto">
                
                <!-- ==== 1. Daily List View ==== -->
                <div id="view-daily" class="view-content space-y-6">
                    <!-- Ad-Hoc Chore Collapsible -->
                    <details class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <summary class="p-4 cursor-pointer font-medium text-lg text-blue-600 flex items-center justify-between">
                            <span>Add Ad-Hoc Chore</span>
                            <span data-lucide="plus-circle" class="h-5 w-5"></span>
                        </summary>
                        <form id="add-adhoc-chore-form" class="p-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-5 gap-4">
                            <input type="text" id="adhoc-name" placeholder="Chore Name" class="md:col-span-2 form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <input type="text" id="adhoc-emoji" placeholder="Emoji (e.g., ✨)" class="form-input px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                            <input type="number" id="adhoc-points" placeholder="Points" class="form-input px-4 py-2 border border-gray-300 rounded-lg" required>
                            <select id="adhoc-assignee" class="form-select px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="unassigned">Unassigned</option>
                                <!-- Member options will be populated by JS -->
                            </select>
                            <button type="submit" class="md:col-span-5 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                <span data-lucide="plus"></span> Add Chore
                            </button>
                        </form>
                    </details>
                    
                    <!-- Chore Lists Container -->
                    <div id="daily-chores-container" class="space-y-6">
                        <!-- Content generated by JS -->
                    </div>
                </div>

                <!-- ==== 2. Weekly Schedule View ==== -->
                <div id="view-weekly" class="view-content hidden">
                    <div id="weekly-schedule-grid" class="grid grid-cols-1 md:grid-cols-7 gap-4">
                        <!-- Day columns generated by JS -->
                    </div>
                </div>

                <!-- ==== 3. Points & Rewards View ==== -->
                <div id="view-rewards" class="view-content hidden space-y-6">
                    <!-- Member Point Totals -->
                    <div>
                        <h3 class="text-2xl font-semibold mb-4">Point Totals</h3>
                        <div id="member-points-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Member point cards generated by JS -->
                        </div>
                    </div>
                    
                    <!-- Reward Redemption -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-2xl font-semibold mb-4">Redeem Rewards</h3>
                        <div class="flex items-center gap-4 mb-6">
                            <label for="redeem-member-select" class="text-lg font-medium">I am:</label>
                            <select id="redeem-member-select" class="form-select px-4 py-2 border border-gray-300 rounded-lg w-full md:w-1/3">
                                <option value="">Select a member...</option>
                                <!-- Member options populated by JS -->
                            </select>
                        </div>
                        <div id="available-rewards-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Reward cards generated by JS -->
                        </div>
                    </div>

                    <!-- Claimed (Not Delivered) Rewards -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-2xl font-semibold mb-4">Pending Rewards</h3>
                        <div id="claimed-rewards-list" class="space-y-3">
                            <!-- Claimed rewards list generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ==== 4. Setup View ==== -->
                <div id="view-setup" class="view-content hidden">
                    <!-- Setup Sub-Navigation -->
                    <div class="mb-6 flex space-x-2 border-b border-gray-300">
                        <button class="setup-nav-link py-3 px-5 font-medium text-gray-500 hover:text-gray-800" data-setup-view="members">Members</button>
                        <button class="setup-nav-link py-3 px-5 font-medium text-gray-500 hover:text-gray-800" data-setup-view="chores">Chores</button>
                        <button class="setup-nav-link py-3 px-5 font-medium text-gray-500 hover:text-gray-800" data-setup-view="rewards">Rewards</button>
                    </div>

                    <!-- Setup Content Panes -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- ==== Setup: Members ==== -->
                        <div id="setup-view-members" class="setup-view-content lg:col-span-1 space-y-6">
                            <!-- Add Member -->
                            <form id="add-member-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Add New Member</h4>
                                <input type="text" id="member-name" placeholder="Member Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="member-emoji" placeholder="Emoji (e.g., 👨‍👩‍👧)" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                                <select id="member-color" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Select Color</option>
                                    <option value="bg-red-500">Red</option>
                                    <option value="bg-blue-500">Blue</option>
                                    <option value="bg-green-500">Green</option>
                                    <option value="bg-yellow-500">Yellow</option>
                                    <option value="bg-purple-500">Purple</option>
                                    <option value="bg-pink-500">Pink</option>
                                    <option value="bg-indigo-500">Indigo</option>
                                    <option value="bg-teal-500">Teal</option>
                                </select>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="user-plus"></span> Add Member
                                </button>
                            </form>
                            
                            <!-- Adjust Points -->
                            <form id="adjust-points-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Adjust Points (Admin)</h4>
                                <select id="adjust-points-member" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="">Select Member</option>
                                </select>
                                <input type="number" id="adjust-points-amount" placeholder="Points to Add/Subtract" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="password" id="adjust-points-password" placeholder="Admin Password" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <button type="submit" class="w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="edit"></span> Adjust Points
                                </button>
                            </form>
                        </div>
                        <div id="member-list-container" class="setup-view-content lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="text-xl font-semibold mb-4">Existing Members</h4>
                            <div id="setup-members-list" class="space-y-3">
                                <!-- Member list generated by JS -->
                            </div>
                        </div>

                        <!-- ==== Setup: Chores ==== -->
                        <div id="setup-view-chores" class="setup-view-content hidden lg:col-span-1 space-y-6">
                            <form id="add-chore-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Add Recurring Chore</h4>
                                <input type="text" id="chore-name" placeholder="Chore Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="chore-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                                <input type="number" id="chore-points" placeholder="Points" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <select id="chore-default-assignee" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="unassigned">Default: Unassigned</option>
                                </select>
                                <div class="space-y-2">
                                    <label class="font-medium">Schedule (Recurring Days):</label>
                                    <div class="grid grid-cols-4 gap-2 text-sm">
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="mon" class="form-checkbox rounded"> Mon</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="tue" class="form-checkbox rounded"> Tue</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="wed" class="form-checkbox rounded"> Wed</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="thu" class="form-checkbox rounded"> Thu</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="fri" class="form-checkbox rounded"> Fri</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="sat" class="form-checkbox rounded"> Sat</label>
                                        <label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="chore-schedule" value="sun" class="form-checkbox rounded"> Sun</label>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="plus-circle"></span> Add Chore Template
                                </button>
                            </form>
                        </div>
                        <div id="chore-list-container" class="setup-view-content hidden lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="text-xl font-semibold mb-4">Existing Chore Templates</h4>
                            <div id="setup-chores-list" class="space-y-3">
                                <!-- Chore list generated by JS -->
                            </div>
                        </div>

                        <!-- ==== Setup: Rewards ==== -->
                        <div id="setup-view-rewards" class="setup-view-content hidden lg:col-span-1 space-y-6">
                            <form id="add-reward-form" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                                <h4 class="text-xl font-semibold">Add New Reward</h4>
                                <input type="text" id="reward-name" placeholder="Reward Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="reward-emoji" placeholder="Emoji (e.g., 🍦)" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
                                <input type="number" id="reward-cost" placeholder="Point Cost" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <span data-lucide="award"></span> Add Reward
                                </button>
                            </form>
                        </div>
                        <div id="reward-list-container" class="setup-view-content hidden lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="text-xl font-semibold mb-4">Available Rewards</h4>
                            <div id="setup-rewards-list" class="space-y-3">
                                <!-- Reward list generated by JS -->
                            </div>
                        </div>
                    </div>
                </div> <!-- End Setup View -->
            </div> <!-- End Content Views Container -->
        </main>
    </div> <!-- End Main Flex Container -->


    <!-- ==== Modals ==== -->

    <!-- Global Message/Toast -->
    <div id="toast-message" class="fixed bottom-6 right-6 p-4 rounded-lg shadow-xl text-white transition-all translate-x-[120%]" role="alert">
        <span id="toast-text"></span>
    </div>

    <!-- Assign Chore Modal -->
    <div id="assign-chore-modal" class_ ="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-2xl font-semibold mb-4">Assign Chore</h3>
            <p class="mb-4">Assign "<span id="assign-chore-name" class="font-medium"></span>" to:</p>
            <select id="assign-chore-select" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg mb-6">
                <!-- Options populated by JS -->
            </select>
            <div class="flex justify-end gap-3">
                <button onclick="hideModal('assign-chore-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button id="assign-chore-submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Assignment</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-2xl font-semibold mb-4">Admin Access</h3>
            <p class="mb-4 text-gray-600">Please enter the admin password to continue.</p>
            <input type="password" id="password-input" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" placeholder="Password">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password. Please try again.</p>
            <div class="flex justify-end gap-3">
                <button onclick="hideModal('password-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button id="password-submit" class="py-2 px-5 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition-all">Submit</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <div class="flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mx-auto mb-4">
                <span data-lucide="trash-2" class="h-8 w-8 text-red-600"></span>
            </div>
            <h3 class="text-2xl font-semibold mb-2 text-center">Are you sure?</h3>
            <p class="mb-6 text-gray-600 text-center">This action cannot be undone. This will permanently delete <strong id="delete-item-name"></strong>.</p>
            <div class="flex justify-center gap-3">
                <button onclick="hideModal('confirm-delete-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button id="confirm-delete-button" class="py-2 px-5 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-all">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Modals (for Setup) -->
    <!-- Edit Member Modal -->
    <div id="edit-member-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="edit-member-form" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-semibold">Edit Member</h3>
            <input type="hidden" id="edit-member-id">
            <input type="text" id="edit-member-name" placeholder="Member Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <input type="text" id="edit-member-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
            <select id="edit-member-color" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                <option value="bg-red-500">Red</option>
                <option value="bg-blue-500">Blue</option>
                <option value="bg-green-500">Green</option>
                <option value="bg-yellow-500">Yellow</option>
                <option value="bg-purple-500">Purple</option>
                <option value="bg-pink-500">Pink</option>
                <option value="bg-indigo-500">Indigo</option>
                <option value="bg-teal-500">Teal</option>
            </select>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('edit-member-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Changes</button>
            </div>
        </form>
    </div>
    
    <!-- Edit Chore Modal -->
    <div id="edit-chore-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="edit-chore-form" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg space-y-4">
            <h3 class="text-2xl font-semibold">Edit Chore Template</h3>
            <input type="hidden" id="edit-chore-id">
            <input type="text" id="edit-chore-name" placeholder="Chore Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <input type="text" id="edit-chore-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
            <input type="number" id="edit-chore-points" placeholder="Points" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <select id="edit-chore-default-assignee" class="form-select w-full px-4 py-2 border border-gray-300 rounded-lg">
                <!-- options populated by JS -->
            </select>
            <div class="space-y-2">
                <label class="font-medium">Schedule (Recurring Days):</label>
                <div id="edit-chore-schedule-container" class="grid grid-cols-4 gap-2 text-sm">
                    <!-- checkboxes populated by JS -->
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('edit-chore-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Edit Reward Modal -->
    <div id="edit-reward-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="edit-reward-form" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-semibold">Edit Reward</h3>
            <input type="hidden" id="edit-reward-id">
            <input type="text" id="edit-reward-name" placeholder="Reward Name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <input type="text" id="edit-reward-emoji" placeholder="Emoji" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="2" required>
            <input type="number" id="edit-reward-cost" placeholder="Point Cost" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('edit-reward-modal')" class="py-2 px-5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-all">Cancel</button>
                <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // === Firebase SDK Imports (CONSOLIDATED & FIXED) ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === Global State ===
        let db, auth, userId, appId;
        let localState = {
            members: [],
            chores: [], // Reusable chore templates
            rewards: [],
            dailyChores: [], // Instances of chores for specific days
            claimedRewards: []
        };
        let currentView = 'daily';
        let currentSetupView = 'members';
        let selectedChoreForAssignment = null;
        let selectedRedeemerId = null;
        let passwordSuccessCallback = null;
        let deleteSuccessCallback = null;
        let hasCheckedDailyChores = false; // Flag to prevent re-generation
        
        const PASSWORD = '3281555';
        const DAYS_OF_WEEK = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        const WEEK_DAYS_FULL = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        // === Sound Effects ===
        let sounds;
        function initSounds() {
            if (window.Tone) {
                sounds = {
                    complete: new Tone.Synth().toDestination(),
                    uncomplete: new Tone.Synth().toDestination(),
                    redeem: new Tone.PluckSynth().toDestination(),
                    error: new Tone.MembraneSynth().toDestination(),
                    success: new Tone.Synth().toDestination(),
                };
                // Pre-connect to avoid audio context issues
                Tone.start();
            }
        }
        function playSound(soundName) {
            if (!sounds) return;
            try {
                if (soundName === 'complete') {
                    sounds.complete.triggerAttackRelease("C5", "8n", Tone.now());
                } else if (soundName === 'uncomplete') {
                    sounds.uncomplete.triggerAttackRelease("C4", "8n", Tone.now());
                } else if (soundName === 'redeem') {
                    // Fanfare
                    const now = Tone.now();
                    sounds.redeem.triggerAttackRelease("C5", "8n", now);
                    sounds.redeem.triggerAttackRelease("E5", "8n", now + 0.2);
                    sounds.redeem.triggerAttackRelease("G5", "8n", now + 0.4);
                } else if (soundName === 'success') {
                    sounds.success.triggerAttackRelease("G5", "8n", Tone.now());
                } else if (soundName === 'error') {
                    sounds.error.triggerAttackRelease("C3", "4n", Tone.now());
                }
            } catch (e) {
                console.error("Sound error:", e);
            }
        }

        // === Date & Time ===
        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            if(timeEl) timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if(dateEl) dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // === Firebase Initialization ===
        async function initFirebase() {
            try {
                // 1. Get App ID and Config from USER
                appId = 'family-hub-organizer';
                const firebaseConfig = {
                    apiKey: "AIzaSyD_piA_kA7WZFN7GgxCDPpNNxyjrVRTj3M",
                    authDomain: "family-hub-organizer.firebaseapp.com",
                    projectId: "family-hub-organizer",
                    storageBucket: "family-hub-organizer.firebasestorage.app",
                    messagingSenderId: "468888595189",
                    appId: "1:468888595189:web:eb6f33ee8e62cdc489b3bc"
                };

                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase config is missing.");
                }

                // 2. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Enable Firestore logs

                // 3. Handle Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        console.log('Firebase Authenticated. User ID:', userId);
                        // User is authenticated, now load data
                        await loadData();
                        // Hide loading overlay
                        document.getElementById('loading-overlay').classList.add('hidden');
                    } else {
                        // User is signed out, try to sign in
                        console.log('No user. Attempting sign-in...');
                        try {
                            // Use Anonymous sign-in directly
                            await signInAnonymously(auth);
                        } catch (authError) {
                            console.error('Firebase sign-in error:', authError);
                            showLoadingError('Could not sign in. Please refresh.');
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                showLoadingError('Failed to initialize. Check console.');
            }
        }
        
        function showLoadingError(message) {
            const errorEl = document.getElementById('loading-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            document.getElementById('loading-overlay').querySelector('[data-lucide="loader-circle"]').classList.add('hidden');
        }

        // === Firestore Data Loading (Real-time) ===
        async function loadData() {
            if (!db || !userId) return;

            const F_BASE_PATH = `/artifacts/${appId}/public/data`;
            const F_MEMBERS_COL = `${F_BASE_PATH}/members`;
            const F_CHORES_COL = `${F_BASE_PATH}/chores`;
            const F_REWARDS_COL = `${F_BASE_PATH}/rewards`;
            const F_DAILY_CHORES_COL = `${F_BASE_PATH}/dailyChores`;
            const F_CLAIMED_REWARDS_COL = `${F_BASE_PATH}/claimedRewards`;

            // Expose collection paths for handlers
            window.F_MEMBERS_COL = F_MEMBERS_COL;
            window.F_CHORES_COL = F_CHORES_COL;
            window.F_REWARDS_COL = F_REWARDS_COL;
            window.F_DAILY_CHORES_COL = F_DAILY_CHORES_COL;
            window.F_CLAIMED_REWARDS_COL = F_CLAIMED_REWARDS_COL;

            // 1. Listen for Members
            onSnapshot(collection(db, F_MEMBERS_COL), (snapshot) => {
                localState.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => console.error("Error listening to members:", error));

            // 2. Listen for Chore Templates
            onSnapshot(collection(db, F_CHORES_COL), (snapshot) => {
                localState.chores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                checkAndGenerateDailyChores(); // Re-check if chores are loaded
                renderAll();
            }, (error) => console.error("Error listening to chores:", error));

            // 3. Listen for Rewards
            onSnapshot(collection(db, F_REWARDS_COL), (snapshot) => {
                localState.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => console.error("Error listening to rewards:", error));

            // 4. Listen for Daily Chores (for today)
            const todayISO = new Date().toISOString().split('T')[0];
            const qDaily = query(collection(db, F_DAILY_CHORES_COL), where("date", "==", todayISO));
            
            onSnapshot(qDaily, (snapshot) => {
                localState.dailyChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                hasCheckedDailyChores = false; // Reset check flag on new data
                checkAndGenerateDailyChores(); // Check generation logic
                renderAll();
            }, (error) => console.error("Error listening to daily chores:", error));

            // 5. Listen for Claimed (not delivered) Rewards
            const qClaimed = query(collection(db, F_CLAIMED_REWARDS_COL), where("delivered", "==", false));
            onSnapshot(qClaimed, (snapshot) => {
                localState.claimedRewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => console.error("Error listening to claimed rewards:", error));
        }

        // === Core Logic: Daily Chore Generation ===
        async function checkAndGenerateDailyChores() {
            // Only run if we have chore templates and haven't run today
            if (hasCheckedDailyChores || localState.chores.length === 0) {
                return;
            }
            
            console.log("Checking if daily chores need generation...");
            hasCheckedDailyChores = true; // Mark as checked for this cycle
            
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            const todayDayString = DAYS_OF_WEEK[today.getDay()];
            
            // Find which template chores *should* exist today
            const choresToGenerate = localState.chores.filter(chore =>
                chore.schedule && chore.schedule.includes(todayDayString)
            );
            
            // Find which template chores *already exist* for today
            const existingTemplateChoreIds = new Set(
                localState.dailyChores
                    .filter(dc => !dc.isAdHoc && dc.choreTemplateId)
                    .map(dc => dc.choreTemplateId)
            );

            // Generate the ones that are missing
            for (const choreTemplate of choresToGenerate) {
                if (!existingTemplateChoreIds.has(choreTemplate.id)) {
                    console.log(`Generating daily chore for: ${choreTemplate.name}`);
                    try {
                        await addDoc(collection(db, F_DAILY_CHORES_COL), {
                            choreTemplateId: choreTemplate.id,
                            name: choreTemplate.name,
                            emoji: choreTemplate.emoji,
                            points: choreTemplate.points,
                            assignedTo: choreTemplate.defaultAssignee === 'unassigned' ? null : (choreTemplate.defaultAssignee || null),
                            date: todayISO,
                            isComplete: false,
                            isAdHoc: false,
                            createdAt: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error generating daily chore:", e);
                    }
                }
            }
        }
        
        // === Master Render Function ===
        function renderAll() {
            if (!localState.members) return; // Wait for core data
            
            // Populate shared dropdowns
            populateMemberDropdowns();
            
            // Render current view
            switch(currentView) {
                case 'daily':
                    renderDailyList();
                    break;
                case 'weekly':
                    renderWeeklySchedule();
                    break;
                case 'rewards':
                    renderRewardsPage();
                    break;
                case 'setup':
                    renderSetup();
                    break;
            }
        }

        // === Render Functions ===

        // --- Render: Daily List ---
        function renderDailyList() {
            const container = document.getElementById('daily-chores-container');
            if (!container) return;
            
            let html = '';
            
            // 1. Unassigned Chores
            const unassignedChores = localState.dailyChores.filter(c => !c.assignedTo);
            html += renderMemberChoreSection(null, unassignedChores);
            
            // 2. Member Chore Lists
            localState.members.forEach(member => {
                const memberChores = localState.dailyChores.filter(c => c.assignedTo === member.id);
                html += renderMemberChoreSection(member, memberChores);
            });
            
            container.innerHTML = html;
            attachDragDropHandlers();
        }
        
        function renderMemberChoreSection(member, chores) {
            const memberId = member ? member.id : 'unassigned';
            const color = member ? member.color : 'bg-gray-500';
            const emoji = member ? member.emoji : '❓';
            const name = member ? member.name : 'Unassigned';

            let choreListHtml = chores.length > 0
                ? chores.map(chore => renderChoreItem(chore)).join('')
                : '<p class="text-gray-500 italic p-4">No chores assigned.</p>';

            return `
                <div 
                    class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden member-drop-target" 
                    data-member-id="${memberId}"
                >
                    <h3 class="text-xl font-semibold p-4 flex items-center gap-3 ${color} text-white">
                        <span class="text-2xl">${emoji}</span>
                        <span>${name}</span>
                    </h3>
                    <div class="p-2 space-y-2">
                        ${choreListHtml}
                    </div>
                </div>
            `;
        }

        function renderChoreItem(chore) {
            const completeClass = chore.isComplete ? 'chore-complete' : '';
            const checkEmoji = chore.isComplete ? '✅' : chore.emoji;
            
            return `
                <div 
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 ${completeClass} transition-all chore-item" 
                    draggable="true" 
                    data-chore-id="${chore.id}"
                >
                    <div class="flex items-center gap-3">
                        <button 
                            class="text-2xl hover:scale-110 transition-transform" 
                            onclick="window.toggleChoreComplete('${chore.id}')"
                        >
                            ${checkEmoji}
                        </button>
                        <div>
                            <span class="font-medium">${chore.name}</span>
                            ${chore.isAdHoc ? '<span class="text-xs bg-purple-100 text-purple-700 font-medium px-2 py-0.5 rounded-full ml-2">Ad-Hoc</span>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-blue-600">${chore.points} pts</span>
                        <button 
                            class="p-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 transition-all"
                            onclick="window.openAssignModal('${chore.id}')"
                        >
                            <span data-lucide="user-cog" class="h-5 w-5"></span>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Render: Weekly Schedule ---
        async function renderWeeklySchedule() {
            const grid = document.getElementById('weekly-schedule-grid');
            if (!grid) return;
            
            // 1. Get dates for the current week (Mon-Sun)
            const today = new Date();
            const currentDay = today.getDay(); // 0 (Sun) - 6 (Sat)
            const weekStart = new Date(today);
            // Adjust to Monday (if Sun, go back 6 days, else go back currentDay-1)
            weekStart.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1));
            weekStart.setHours(0, 0, 0, 0);

            let weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                weekDates.push(date);
            }
            
            const weekStartISO = weekStart.toISOString().split('T')[0];
            const weekEnd = new Date(weekDates[6]);
            weekEnd.setHours(23, 59, 59, 999);
            const weekEndISO = weekEnd.toISOString().split('T')[0];

            // 2. Query all chores for this week
            // Note: This is a complex query that might require indexes.
            // A more robust way (if indexes are an issue) is to fetch 7 individual days.
            // For now, let's try a range query.
            let weeklyChores = [];
            try {
                const q = query(collection(db, F_DAILY_CHORES_COL), 
                    where("date", ">=", weekStartISO),
                    where("date", "<=", weekEndISO)
                );
                const snapshot = await getDocs(q);
                weeklyChores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error("Error fetching weekly chores:", e);
                grid.innerHTML = `<p class="text-red-500 col-span-7">Error loading weekly schedule. You may need to create Firestore indexes.</p>`;
                return;
            }

            // 3. Build HTML
            let html = '';
            for (const date of weekDates) {
                const dateISO = date.toISOString().split('T')[0];
                const dayName = WEEK_DAYS_FULL[date.getDay()];
                
                const choresForDay = weeklyChores.filter(c => c.date === dateISO);
                
                let choresHtml = choresForDay.length > 0
                    ? choresForDay.map(c => renderWeeklyChoreItem(c)).join('')
                    : '<p class="text-sm text-gray-500 italic p-2">No chores.</p>';

                html += `
                    <div class="bg-white rounded-lg shadow-md border border-gray-200">
                        <h4 class="text-lg font-semibold p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                            ${dayName}
                            <span class="text-sm font-normal text-gray-500 ml-2">${date.toLocaleDateString([], { month: 'numeric', day: 'numeric' })}</span>
                        </h4>
                        <div class="p-2 space-y-2">
                            ${choresHtml}
                        </div>
                    </div>
                `;
            }
            grid.innerHTML = html;
            lucide.createIcons(); // Re-render icons
        }
        
        function renderWeeklyChoreItem(chore) {
            const member = localState.members.find(m => m.id === chore.assignedTo);
            const completeClass = chore.isComplete ? 'chore-complete' : '';
            
            let assigneeHtml;
            if (member) {
                assigneeHtml = `
                    <span class="flex items-center gap-1.5 text-sm">
                        <span class="w-5 h-5 rounded-full ${member.color} text-white flex items-center justify-center text-xs font-bold">${member.name[0]}</span>
                        ${member.name}
                    </span>`;
            } else {
                assigneeHtml = `<span class="text-sm text-gray-500 italic">Unassigned</span>`;
            }
            
            return `
                <div class="p-2.5 bg-gray-100 rounded-md border border-gray-200 ${completeClass}">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-sm">${chore.emoji} ${chore.name}</span>
                        ${chore.isComplete ? '<span data-lucide="check" class="h-4 w-4 text-green-600"></span>' : ''}
                    </div>
                    ${assigneeHtml}
                </div>
            `;
        }

        // --- Render: Points & Rewards ---
        function renderRewardsPage() {
            // 1. Render Member Point Totals
            const pointsGrid = document.getElementById('member-points-grid');
            if (pointsGrid) {
                pointsGrid.innerHTML = localState.members.map(member => `
                    <div class="p-4 rounded-lg shadow-lg ${member.color} text-white">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">${member.emoji}</span>
                            <span class="text-xl font-semibold">${member.name}</span>
                        </div>
                        <div class="text-4xl font-bold text-right">${member.points || 0}</div>
                        <div class="text-sm text-right opacity-80">points</div>
                    </div>
                `).join('');
            }
            
            // 2. Render Available Rewards (based on selected redeemer)
            renderAvailableRewards();
            
            // 3. Render Claimed (but not delivered) Rewards
            const claimedList = document.getElementById('claimed-rewards-list');
            if (claimedList) {
                const pendingRewards = localState.claimedRewards.filter(r => !r.delivered);
                if (pendingRewards.length === 0) {
                    claimedList.innerHTML = '<p class="text-gray-500 italic">No rewards are pending delivery.</p>';
                    return;
                }
                
                claimedList.innerHTML = pendingRewards.map(reward => {
                    const member = localState.members.find(m => m.id === reward.memberId);
                    const memberName = member ? member.name : 'Unknown Member';
                    const claimedAt = reward.claimedAt ? reward.claimedAt.toDate().toLocaleDateString() : 'Just now';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div>
                                <span class="text-xl mr-2">${reward.emoji}</span>
                                <span class="font-medium">${reward.name}</span>
                                <span class="text-sm text-gray-600 ml-2">(Claimed by <strong>${memberName}</strong> on ${claimedAt})</span>
                            </div>
                            <button 
                                class="py-2 px-4 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-all text-sm flex items-center gap-1.5"
                                onclick="window.handleDeliverReward('${reward.id}')"
                            >
                                <span data-lucide="check-check" class="h-4 w-4"></span>
                                Mark Delivered
                            </button>
                        </div>
                    `;
                }).join('');
                lucide.createIcons(); // Re-render icons
            }
        }
        
        function renderAvailableRewards() {
            const rewardsGrid = document.getElementById('available-rewards-grid');
            if (!rewardsGrid) return;
            
            const selectedMember = localState.members.find(m => m.id === selectedRedeemerId);
            const memberPoints = selectedMember ? (selectedMember.points || 0) : -1;
            
            if (!selectedRedeemerId) {
                rewardsGrid.innerHTML = '<p class="text-gray-500 italic col-span-full">Please select a member to see available rewards.</p>';
                return;
            }
            
            if (localState.rewards.length === 0) {
                rewardsGrid.innerHTML = '<p class="text-gray-500 italic col-span-full">No rewards have been set up yet.</p>';
                return;
            }

            rewardsGrid.innerHTML = localState.rewards.map(reward => {
                const canAfford = memberPoints >= reward.cost;
                const affordClass = !canAfford ? 'opacity-50 grayscale' : 'hover:shadow-lg hover:-translate-y-1';
                const buttonDisabled = !canAfford ? 'disabled' : '';
                const buttonClass = !canAfford ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700';

                return `
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 flex flex-col items-center justify-between transition-all ${affordClass}">
                        <span class="text-5xl mb-2">${reward.emoji}</span>
                        <span class="font-semibold text-center mb-2">${reward.name}</span>
                        <span class="font-bold text-xl text-blue-600 mb-4">${reward.cost} pts</span>
                        <button 
                            class="w-full py-2 px-4 text-white font-medium rounded-lg transition-all text-sm ${buttonClass}"
                            onclick="window.handleRedeemReward('${reward.id}')"
                            ${buttonDisabled}
                        >
                            Redeem
                        </button>
                    </div>
                `;
            }).join('');
        }

        // --- Render: Setup ---
        function renderSetup() {
            // 1. Render Sub-view Content
            switch(currentSetupView) {
                case 'members':
                    renderSetupMembers();
                    break;
                case 'chores':
                    renderSetupChores();
                    break;
                case 'rewards':
                    renderSetupRewards();
                    break;
            }
            
            // 2. Highlight active sub-nav
            document.querySelectorAll('.setup-nav-link').forEach(link => {
                const isActive = link.dataset.setupView === currentSetupView;
                link.classList.toggle('text-blue-600', isActive);
                link.classList.toggle('border-b-2', isActive);
                link.classList.toggle('border-blue-600', isActive);
                link.classList.toggle('text-gray-500', !isActive);
            });
            
            // 3. Show/Hide setup panes
            document.querySelectorAll('.setup-view-content').forEach(pane => {
                pane.classList.toggle('hidden', !pane.id.includes(currentSetupView));
            });
        }
        
        function renderSetupMembers() {
            const list = document.getElementById('setup-members-list');
            if (list) {
                if (localState.members.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 italic">No members added yet.</p>';
                    return;
                }
                list.innerHTML = localState.members.map(member => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${member.emoji}</span>
                            <span class="w-4 h-4 rounded-full ${member.color}"></span>
                            <span class="font-medium">${member.name}</span>
                            <span class="text-gray-600">(${member.points || 0} pts)</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-blue-600 hover:text-blue-800 font-medium text-sm" onclick="window.openEditMemberModal('${member.id}')">Edit</button>
                            <button class="text-red-600 hover:text-red-800 font-medium text-sm" onclick="window.confirmDelete('member', '${member.id}', '${member.name}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function renderSetupChores() {
            const list = document.getElementById('setup-chores-list');
            if (list) {
                if (localState.chores.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 italic">No chore templates added yet.</p>';
                    return;
                }
                list.innerHTML = localState.chores.map(chore => {
                    const schedule = chore.schedule ? chore.schedule.join(', ').toUpperCase() : 'Not set';
                    const assignee = localState.members.find(m => m.id === chore.defaultAssignee);
                    const assigneeName = assignee ? assignee.name : 'Unassigned';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div>
                                <span class="font-medium">${chore.emoji} ${chore.name}</span>
                                <span class="text-blue-600 font-bold ml-2">(${chore.points} pts)</span>
                                <p class="text-sm text-gray-500">Schedule: ${schedule}</p>
                                <p class="text-sm text-gray-500">Default: ${assigneeName}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="text-blue-600 hover:text-blue-800 font-medium text-sm" onclick="window.openEditChoreModal('${chore.id}')">Edit</button>
                                <button class="text-red-600 hover:text-red-800 font-medium text-sm" onclick="window.confirmDelete('chore', '${chore.id}', '${chore.name}')">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderSetupRewards() {
            const list = document.getElementById('setup-rewards-list');
            if (list) {
                if (localState.rewards.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 italic">No rewards added yet.</p>';
                    return;
                }
                list.innerHTML = localState.rewards.map(reward => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                            <span class="font-medium">${reward.emoji} ${reward.name}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-blue-600">${reward.cost} pts</span>
                            <button class="text-blue-600 hover:text-blue-800 font-medium text-sm" onclick="window.openEditRewardModal('${reward.id}')">Edit</button>
                            <button class="text-red-600 hover:text-red-800 font-medium text-sm" onclick="window.confirmDelete('reward', '${reward.id}', '${reward.name}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // --- Populate Shared Dropdowns ---
        function populateMemberDropdowns() {
            const selects = [
                document.getElementById('adhoc-assignee'),
                document.getElementById('assign-chore-select'),
                document.getElementById('adjust-points-member'),
                document.getElementById('chore-default-assignee'),
                document.getElementById('edit-chore-default-assignee'),
                document.getElementById('redeem-member-select')
            ];
            
            const memberOptions = localState.members.map(m => `<option value="${m.id}">${m.emoji} ${m.name}</option>`).join('');
            
            selects.forEach(select => {
                if (select) {
                    let firstOption;
                    if (select.id === 'redeem-member-select') {
                        firstOption = '<option value="">Select a member...</option>';
                    } else if (select.id === 'adjust-points-member') {
                        firstOption = '<option value="">Select Member</option>';
                    } else {
                        firstOption = '<option value="unassigned">Unassigned</option>';
                    }
                    select.innerHTML = firstOption + memberOptions;
                }
            });
            
            // Restore selected values
            if (selectedRedeemerId) {
                document.getElementById('redeem-member-select').value = selectedRedeemerId;
            }
        }


        // === UI Interaction Functions ===

        // --- Main Navigation ---
        function showView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.toggle('hidden', view.id !== `view-${viewName}`);
            });
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                const isActive = link.dataset.view === viewName;
                link.classList.toggle('bg-gray-700', isActive);
                link.classList.toggle('text-white', isActive);
                link.classList.toggle('text-gray-300', !isActive);
            });
            
            // Update header title
            const titles = {
                daily: 'Daily List',
                weekly: 'Weekly Schedule',
                rewards: 'Points & Rewards',
                setup: 'Setup'
            };
            document.getElementById('view-title').textContent = titles[viewName];
            
            // Trigger render for the new view
            renderAll();
        }
        window.showView = showView; // Expose to global

        // --- Setup Sub-Navigation ---
        function showSetupView(viewName) {
            currentSetupView = viewName;
            renderSetup();
        }
        
        // === Modal Controls ===
        function showModal(modalId) {
            document.getElementById(modalId)?.classList.remove('hidden');
        }
        function hideModal(modalId) {
            document.getElementById(modalId)?.classList.add('hidden');
        }
        window.hideModal = hideModal;

        // --- Password Modal ---
        function showPasswordModal(callback) {
            passwordSuccessCallback = callback;
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').classList.add('hidden');
            showModal('password-modal');
        }
        
        async function handleSubmitPassword() {
            const input = document.getElementById('password-input').value;
            if (input === PASSWORD) {
                if (passwordSuccessCallback) {
                    try {
                        await passwordSuccessCallback();
                        showToast('Action successful!', 'success');
                        playSound('success');
                    } catch (e) {
                        console.error("Password callback error:", e);
                        showToast('An error occurred.', 'error');
                        playSound('error');
                    }
                }
                hideModal('password-modal');
                passwordSuccessCallback = null;
            } else {
                document.getElementById('password-error').classList.remove('hidden');
                playSound('error');
            }
        }

        // --- Confirm Delete Modal ---
        function confirmDelete(type, id, name) {
            document.getElementById('delete-item-name').textContent = name;
            deleteSuccessCallback = async () => {
                let collectionPath;
                if (type === 'member') collectionPath = F_MEMBERS_COL;
                if (type === 'chore') collectionPath = F_CHORES_COL;
                if (type === 'reward') collectionPath = F_REWARDS_COL;
                
                if (collectionPath) {
                    try {
                        await deleteDoc(doc(db, collectionPath, id));
                        // TODO: Handle cascading deletes (e.g., remove member from chores)
                        showToast(`Deleted ${name}.`, 'success');
                        playSound('success');
                    } catch (e) {
                        console.error("Delete error:", e);
                        showToast('Error deleting item.', 'error');
                        playSound('error');
                    }
                }
                hideModal('confirm-delete-modal');
                deleteSuccessCallback = null;
            };
            showModal('confirm-delete-modal');
        }
        window.confirmDelete = confirmDelete;
        
        // --- Toast Message ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-message');
            const text = document.getElementById('toast-text');
            if (!toast || !text) return;
            
            text.textContent = message;
            
            // Reset classes
            toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600', 'translate-x-[120%]', 'opacity-0');
            
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-blue-600');
            }
            
            // Animate in
            toast.classList.remove('translate-x-[120%]');
            
            // Animate out
            setTimeout(() => {
                toast.classList.add('opacity-0');
                // Reset position after animation
                setTimeout(() => {
                    toast.classList.add('translate-x-[120%]');
                    toast.classList.remove('opacity-0');
                }, 500);
            }, 3000);
        }
        
        // --- Confetti ---
        function showConfetti() {
            if (window.confetti) {
                confetti({
                    particleCount: 150,
                    spread: 90,
                    origin: { y: 0.6 },
                    zIndex: 1000
                });
            }
        }


        // === Event Handlers ===

        // --- Daily List Handlers ---
        window.toggleChoreComplete = async (dailyChoreId) => {
            const chore = localState.dailyChores.find(c => c.id === dailyChoreId);
            if (!chore) return;
            
            const newStatus = !chore.isComplete;
            const memberId = chore.assignedTo;
            
            try {
                // 1. Update chore status
                await updateDoc(doc(db, F_DAILY_CHORES_COL, dailyChoreId), {
                    isComplete: newStatus
                });
                
                // 2. Update member points (if assigned)
                if (memberId) {
                    const member = localState.members.find(m => m.id === memberId);
                    if (member) {
                        const pointsChange = newStatus ? chore.points : -chore.points;
                        const newPoints = (member.points || 0) + pointsChange;
                        await updateDoc(doc(db, F_MEMBERS_COL, memberId), {
                            points: newPoints
                        });
                    }
                }
                
                // 3. Play sound
                playSound(newStatus ? 'complete' : 'uncomplete');
                
            } catch (e) {
                console.error("Error toggling chore:", e);
                showToast('Error updating chore.', 'error');
                playSound('error');
            }
        };
        
        window.openAssignModal = (dailyChoreId) => {
            selectedChoreForAssignment = dailyChoreId;
            const chore = localState.dailyChores.find(c => c.id === dailyChoreId);
            if (!chore) return;
            
            document.getElementById('assign-chore-name').textContent = chore.name;
            document.getElementById('assign-chore-select').value = chore.assignedTo || 'unassigned';
            showModal('assign-chore-modal');
        };
        
        async function handleSubmitAssignment() {
            if (!selectedChoreForAssignment) return;
            
            const newAssigneeId = document.getElementById('assign-chore-select').value;
            const assignedTo = newAssigneeId === 'unassigned' ? null : newAssigneeId;
            
            try {
                await updateDoc(doc(db, F_DAILY_CHORES_COL, selectedChoreForAssignment), {
                    assignedTo: assignedTo
                });
                showToast('Chore reassigned!', 'success');
                playSound('success');
                hideModal('assign-chore-modal');
            } catch (e) {
                console.error("Error assigning chore:", e);
                showToast('Error reassigning chore.', 'error');
                playSound('error');
            }
            selectedChoreForAssignment = null;
        }

        async function handleAddAdHocChore(e) {
            e.preventDefault();
            const name = document.getElementById('adhoc-name').value;
            const emoji = document.getElementById('adhoc-emoji').value;
            const points = parseInt(document.getElementById('adhoc-points').value);
            const assigneeId = document.getElementById('adhoc-assignee').value;
            
            if (!name || !emoji || isNaN(points)) {
                showToast('Please fill all fields correctly.', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, F_DAILY_CHORES_COL), {
                    name: name,
                    emoji: emoji,
                    points: points,
                    assignedTo: assigneeId === 'unassigned' ? null : assigneeId,
                    date: new Date().toISOString().split('T')[0],
                    isComplete: false,
                    isAdHoc: true,
                    createdAt: serverTimestamp()
                });
                
                showToast('Ad-hoc chore added!', 'success');
                playSound('success');
                e.target.reset(); // Reset form
            } catch (e) {
                console.error("Error adding ad-hoc chore:", e);
                showToast('Error adding chore.', 'error');
                playSound('error');
            }
        }
        
        // --- Drag & Drop Handlers ---
        let draggedChoreId = null;
        
        function attachDragDropHandlers() {
            const choreItems = document.querySelectorAll('.chore-item');
            choreItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                
                // Basic touch support (less ideal than modal)
                item.addEventListener('touchstart', handleDragStart, { passive: false });
                item.addEventListener('touchend', handleDragEnd);
            });
            
            const dropTargets = document.querySelectorAll('.member-drop-target');
            dropTargets.forEach(target => {
                target.addEventListener('dragover', handleDragOver);
                target.addEventListener('dragleave', handleDragLeave);
                target.addEventListener('drop', handleDrop);

                // Touch support
                target.addEventListener('touchmove', handleDragOver, { passive: false });
                target.addEventListener('touchend', handleDrop);
            });
        }
        
        function handleDragStart(e) {
            let choreId;
            if (e.type === 'touchstart') {
                choreId = e.currentTarget.dataset.choreId;
            } else {
                e.dataTransfer.effectAllowed = 'move';
                choreId = e.target.dataset.choreId;
                e.dataTransfer.setData('text/plain', choreId);
            }
            draggedChoreId = choreId;
            e.currentTarget.classList.add('chore-dragging');
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('chore-dragging');
            document.querySelectorAll('.drag-over-target').forEach(t => t.classList.remove('drag-over-target'));
            draggedChoreId = null;
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow drop
            if (e.type === 'touchmove') {
                 // Find target under touch
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropTarget = target ? target.closest('.member-drop-target') : null;
                
                // Remove from old targets
                document.querySelectorAll('.drag-over-target').forEach(t => t.classList.remove('drag-over-target'));
                if (dropTarget) {
                    dropTarget.classList.add('drag-over-target');
                }
            } else {
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
                const dropTarget = e.currentTarget.closest('.member-drop-target');
                if (dropTarget) {
                    dropTarget.classList.add('drag-over-target');
                }
            }
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over-target');
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            
            let dropTarget, choreId;
            if(e.type === 'touchend') {
                const target = document.querySelector('.drag-over-target');
                if (!target) return;
                dropTarget = target;
                choreId = draggedChoreId; // Get from global
            } else {
                dropTarget = e.currentTarget.closest('.member-drop-target');
                choreId = e.dataTransfer.getData('text/plain');
            }

            if (!dropTarget || !choreId) return;

            dropTarget.classList.remove('drag-over-target');
            const newMemberId = dropTarget.dataset.memberId;
            const assignedTo = newMemberId === 'unassigned' ? null : newMemberId;

            // Check if it's a new assignment
            const chore = localState.dailyChores.find(c => c.id === choreId);
            if (chore && chore.assignedTo !== assignedTo) {
                try {
                    await updateDoc(doc(db, F_DAILY_CHORES_COL, choreId), {
                        assignedTo: assignedTo
                    });
                    showToast('Chore reassigned!', 'success');
                    playSound('success');
                } catch (err) {
                    console.error("Drop assign error:", err);
                    showToast('Error reassigning chore.', 'error');
                    playSound('error');
                }
            }
        }

        // --- Rewards Handlers ---
        function handleSelectRedeemer(e) {
            selectedRedeemerId = e.target.value;
            renderAvailableRewards();
        }
        
        window.handleRedeemReward = async (rewardId) => {
            if (!selectedRedeemerId) {
                showToast('Please select who you are first.', 'error');
                playSound('error');
                return;
            }
            
            const member = localState.members.find(m => m.id === selectedRedeemerId);
            const reward = localState.rewards.find(r => r.id === rewardId);
            
            if (!member || !reward) return;
            
            if ((member.points || 0) < reward.cost) {
                showToast("You don't have enough points!", 'error');
                playSound('error');
                return;
            }
            
            try {
                // 1. Subtract points
                const newPoints = member.points - reward.cost;
                await updateDoc(doc(db, F_MEMBERS_COL, member.id), {
                    points: newPoints
                });
                
                // 2. Add to claimed rewards
                await addDoc(collection(db, F_CLAIMED_REWARDS_COL), {
                    rewardId: reward.id,
                    memberId: member.id,
                    name: reward.name,
                    emoji: reward.emoji,
                    cost: reward.cost,
                    claimedAt: serverTimestamp(),
                    delivered: false
                });
                
                showToast('Reward claimed! Nice work!', 'success');
                playSound('redeem');
                showConfetti();
                
            } catch (e) {
                console.error("Error redeeming reward:", e);
                showToast('Error claiming reward.', 'error');
                playSound('error');
            }
        };
        
        window.handleDeliverReward = async (claimId) => {
            try {
                await updateDoc(doc(db, F_CLAIMED_REWARDS_COL, claimId), {
                    delivered: true
                });
                showToast('Reward marked as delivered.', 'success');
                playSound('success');
            } catch (e) {
                console.error("Error delivering reward:", e);
                showToast('Error updating reward.', 'error');
                playSound('error');
            }
        };
        
        // --- Setup Handlers (Add) ---
        async function handleAddMember(e) {
            e.preventDefault();
            const name = document.getElementById('member-name').value;
            const emoji = document.getElementById('member-emoji').value;
            const color = document.getElementById('member-color').value;
            
            if (!name || !emoji || !color) {
                showToast('Please fill all fields.', 'error'); return;
            }
            
            try {
                await addDoc(collection(db, F_MEMBERS_COL), {
                    name, emoji, color, points: 0
                });
                showToast('Member added!', 'success');
                playSound('success');
                e.target.reset();
            } catch(e) {
                console.error("Error adding member:", e);
                showToast('Error adding member.', 'error');
                playSound('error');
            }
        }

        async function handleAddChore(e) {
            e.preventDefault();
            const name = document.getElementById('chore-name').value;
            const emoji = document.getElementById('chore-emoji').value;
            const points = parseInt(document.getElementById('chore-points').value);
            const defaultAssignee = document.getElementById('chore-default-assignee').value;
            const schedule = Array.from(document.querySelectorAll('[name="chore-schedule"]:checked')).map(cb => cb.value);

            if (!name || !emoji || isNaN(points)) {
                showToast('Please fill all fields correctly.', 'error'); return;
            }
            
            try {
                await addDoc(collection(db, F_CHORES_COL), {
                    name, emoji, points, defaultAssignee, schedule
                });
                showToast('Chore template added!', 'success');
                playSound('success');
                e.target.reset();
            } catch(e) {
                console.error("Error adding chore:", e);
                showToast('Error adding chore.', 'error');
                playSound('error');
            }
        }
        
        async function handleAddReward(e) {
            e.preventDefault();
            const name = document.getElementById('reward-name').value;
            const emoji = document.getElementById('reward-emoji').value;
            const cost = parseInt(document.getElementById('reward-cost').value);

            if (!name || !emoji || isNaN(cost) || cost <= 0) {
                showToast('Please fill all fields correctly.', 'error'); return;
            }
            
            try {
                await addDoc(collection(db, F_REWARDS_COL), {
                    name, emoji, cost
                });
                showToast('Reward added!', 'success');
                playSound('success');
                e.target.reset();
            } catch(e) {
                console.error("Error adding reward:", e);
                showToast('Error adding reward.', 'error');
                playSound('error');
            }
        }
        
        // --- Setup Handlers (Admin/Edit) ---
        async function handleAdjustPoints(e) {
            e.preventDefault();
            const memberId = document.getElementById('adjust-points-member').value;
            const amount = parseInt(document.getElementById('adjust-points-amount').value);
            const password = document.getElementById('adjust-points-password').value;
            
            if (!memberId || isNaN(amount)) {
                showToast('Please select a member and enter an amount.', 'error'); return;
            }
            
            if (password !== PASSWORD) {
                showToast('Incorrect password.', 'error');
                playSound('error');
                return;
            }

            const member = localState.members.find(m => m.id === memberId);
            if (!member) return;
            
            const newPoints = (member.points || 0) + amount;
            
            try {
                await updateDoc(doc(db, F_MEMBERS_COL, memberId), {
                    points: newPoints
                });
                showToast(`Points adjusted for ${member.name}.`, 'success');
                playSound('success');
                e.target.reset();
            } catch(e) {
                console.error("Error adjusting points:", e);
                showToast('Error adjusting points.', 'error');
                playSound('error');
            }
        }

        // --- Setup Handlers (Edit Modals) ---
        window.openEditMemberModal = (memberId) => {
            const member = localState.members.find(m => m.id === memberId);
            if (!member) return;
            document.getElementById('edit-member-id').value = member.id;
            document.getElementById('edit-member-name').value = member.name;
            document.getElementById('edit-member-emoji').value = member.emoji;
            document.getElementById('edit-member-color').value = member.color;
            showModal('edit-member-modal');
        };
        
        async function handleEditMember(e) {
            e.preventDefault();
            const id = document.getElementById('edit-member-id').value;
            const name = document.getElementById('edit-member-name').value;
            const emoji = document.getElementById('edit-member-emoji').value;
            const color = document.getElementById('edit-member-color').value;
            
            try {
                await updateDoc(doc(db, F_MEMBERS_COL, id), { name, emoji, color });
                showToast('Member updated!', 'success');
                playSound('success');
                hideModal('edit-member-modal');
            } catch(e) {
                console.error("Error updating member:", e);
                showToast('Error updating member.', 'error');
                playSound('error');
            }
        }
        
        window.openEditChoreModal = (choreId) => {
            const chore = localState.chores.find(c => c.id === choreId);
            if (!chore) return;
            
            document.getElementById('edit-chore-id').value = chore.id;
            document.getElementById('edit-chore-name').value = chore.name;
            document.getElementById('edit-chore-emoji').value = chore.emoji;
            document.getElementById('edit-chore-points').value = chore.points;
            
            // Repopulate dropdown and select
            const assigneeSelect = document.getElementById('edit-chore-default-assignee');
            assigneeSelect.innerHTML = `
                <option value="unassigned">Default: Unassigned</option>
                ${localState.members.map(m => `<option value="${m.id}">${m.emoji} ${m.name}</option>`).join('')}
            `;
            assigneeSelect.value = chore.defaultAssignee || 'unassigned';
            
            // Repopulate checkboxes
            const scheduleContainer = document.getElementById('edit-chore-schedule-container');
            scheduleContainer.innerHTML = DAYS_OF_WEEK.map(day => {
                const checked = chore.schedule && chore.schedule.includes(day) ? 'checked' : '';
                return `<label class="flex items-center gap-2 p-2 border rounded-lg"><input type="checkbox" name="edit-chore-schedule" value="${day}" class="form-checkbox rounded" ${checked}> ${day.toUpperCase()}</label>`;
            }).slice(1).concat(DAYS_OF_WEEK.slice(0,1)).map(dayHtml => dayHtml.replace('SUN', 'Sun')).join(''); // Mon-Sun order
            
            showModal('edit-chore-modal');
        };
        
        async function handleEditChore(e) {
            e.preventDefault();
            const id = document.getElementById('edit-chore-id').value;
            const name = document.getElementById('edit-chore-name').value;
            const emoji = document.getElementById('edit-chore-emoji').value;
            const points = parseInt(document.getElementById('edit-chore-points').value);
            const defaultAssignee = document.getElementById('edit-chore-default-assignee').value;
            const schedule = Array.from(document.querySelectorAll('[name="edit-chore-schedule"]:checked')).map(cb => cb.value);

            try {
                await updateDoc(doc(db, F_CHORES_COL, id), {
                    name, emoji, points, defaultAssignee, schedule
                });
                showToast('Chore template updated!', 'success');
                playSound('success');
                hideModal('edit-chore-modal');
            } catch(e) {
                console.error("Error updating chore:", e);
                showToast('Error updating chore.', 'error');
                playSound('error');
            }
        }
        
        window.openEditRewardModal = (rewardId) => {
            const reward = localState.rewards.find(r => r.id === rewardId);
            if (!reward) return;
            document.getElementById('edit-reward-id').value = reward.id;
            document.getElementById('edit-reward-name').value = reward.name;
            document.getElementById('edit-reward-emoji').value = reward.emoji;
            document.getElementById('edit-reward-cost').value = reward.cost;
            showModal('edit-reward-modal');
        };
        
        async function handleEditReward(e) {
            e.preventDefault();
            const id = document.getElementById('edit-reward-id').value;
            const name = document.getElementById('edit-reward-name').value;
            const emoji = document.getElementById('edit-reward-emoji').value;
            const cost = parseInt(document.getElementById('edit-reward-cost').value);
            
            try {
                await updateDoc(doc(db, F_REWARDS_COL, id), { name, emoji, cost });
                showToast('Reward updated!', 'success');
                playSound('success');
                hideModal('edit-reward-modal');
            } catch(e) {
                console.error("Error updating reward:", e);
                showToast('Error updating reward.', 'error');
                playSound('error');
            }
        }


        // === App Initialization ===
        document.addEventListener('DOMContentLoaded', () => {
            // Init time
            updateTime();
            setInterval(updateTime, 1000); // Update time every second
            
            // Init sounds
            document.body.addEventListener('click', initSounds, { once: true });
            
            // Init Firebase
            initFirebase();
            
            // Init Icons
            lucide.createIcons();
            
            // Init default views
            showView('daily');
            showSetupView('members');

            // --- Attach Event Listeners ---
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(e.currentTarget.dataset.view);
                });
            });
            document.querySelectorAll('.setup-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSetupView(e.currentTarget.dataset.setupView);
                });
            });
            
            // Daily List
            document.getElementById('add-adhoc-chore-form').addEventListener('submit', handleAddAdHocChore);
            document.getElementById('assign-chore-submit').addEventListener('click', handleSubmitAssignment);
            
            // Rewards
            document.getElementById('redeem-member-select').addEventListener('change', handleSelectRedeemer);

            // Setup Forms (Add)
            document.getElementById('add-member-form').addEventListener('submit', handleAddMember);
            document.getElementById('add-chore-form').addEventListener('submit', handleAddChore);
            document.getElementById('add-reward-form').addEventListener('submit', handleAddReward);
            
            // Setup Forms (Edit)
            document.getElementById('edit-member-form').addEventListener('submit', handleEditMember);
            document.getElementById('edit-chore-form').addEventListener('submit', handleEditChore);
            document.getElementById('edit-reward-form').addEventListener('submit', handleEditReward);

            // Setup Admin
            document.getElementById('adjust-points-form').addEventListener('submit', handleAdjustPoints);
            
            // Modals
            document.getElementById('password-submit').addEventListener('click', handleSubmitPassword);
            document.getElementById('confirm-delete-button').addEventListener('click', () => {
                if (deleteSuccessCallback) deleteSuccessCallback();
            });
        });

    </script>
</body>
</html>



